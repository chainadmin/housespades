Get Help
Details
Build Logs
Deploy Logs
Filter and search logs

{"message":"    at Module._compile (node:internal/modules/cjs/loader:1706:14)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:15.498859757Z"}
{"message":"    at Object..js (node:internal/modules/cjs/loader:1839:10)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:15.498867538Z"}
{"message":"    at Module.load (node:internal/modules/cjs/loader:1441:32)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:15.498875571Z"}
{"message":"    at Function._load (node:internal/modules/cjs/loader:1263:12)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:15.498882649Z"}
{"message":"    at TracingChannel.traceSync (node:diagnostics_channel:328:14)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:15.498890164Z"}
{"message":"    at wrapModuleLoad (node:internal/modules/cjs/loader:237:24)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:15.498901608Z"}
{"message":"    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:171:5)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:15.498908843Z"}
{"message":"    at node:internal/main/run_main_module:36:49","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:15.498915470Z"}
{"message":"","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:15.498921574Z"}
{"message":"Node.js v22.21.1","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:15.498928093Z"}
{"message":"npm warn config production Use `--omit=dev` instead.","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:16.519453193Z"}
{"message":"","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:16.544882614Z"}
{"message":"> rest-express@1.0.0 start","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:16.544898901Z"}
{"message":"> NODE_ENV=production node dist/index.cjs","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:16.544906970Z"}
{"message":"","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:16.544914546Z"}
{"message":"/app/dist/index.cjs:100","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:16.703218937Z"}
{"message":"\t\t`;await r.execute(y`CREATE SCHEMA IF NOT EXISTS ${y.identifier(a)}`),await r.execute(s);let u=(await r.all(y`select id, hash, created_at from ${y.identifier(a)}.${y.identifier(i)} order by created_at desc limit 1`))[0];await r.transaction(async c=>{for await(let l of e)if(!u||Number(u.created_at)<l.folderMillis){for(let p of l.sql)await c.execute(y.raw(p));await c.execute(y`insert into ${y.identifier(a)}.${y.identifier(i)} (\"hash\", \"created_at\") values(${l.hash}, ${l.folderMillis})`)}})}escapeName(e){return`\"${e}\"`}escapeParam(e){return`$${e+1}`}escapeString(e){return`'${e.replace(/'/g,\"''\")}'`}buildWithCTE(e){if(!e?.length)return;let r=[y`with `];for(let[n,i]of e.entries())r.push(y`${y.identifier(i._.alias)} as (${i._.sql})`),n<e.length-1&&r.push(y`, `);return r.push(y` `),y.join(r)}buildDeleteQuery({table:e,where:r,returning:n,withList:i}){let a=this.buildWithCTE(i),s=n?y` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,o=r?y` where ${r}`:void 0;return y`${a}delete from ${e}${o}${s}`}buildUpdateSet(e,r){let n=e[P.Symbol.Columns],i=Object.keys(n).filter(s=>r[s]!==void 0||n[s]?.onUpdateFn!==void 0),a=i.length;return y.join(i.flatMap((s,o)=>{let u=n[s],c=r[s]??y.param(u.onUpdateFn(),u),l=y`${y.identifier(this.casing.getColumnCasing(u))} = ${c}`;return o<a-1?[l,y.raw(\", \")]:[l]}))}buildUpdateQuery({table:e,set:r,where:n,returning:i,withList:a,from:s,joins:o}){let u=this.buildWithCTE(a),c=e[Be.Symbol.Name],l=e[Be.Symbol.Schema],p=e[Be.Symbol.OriginalName],d=c===p?void 0:c,f=y`${l?y`${y.identifier(l)}.`:void 0}${y.identifier(p)}${d&&y` ${y.identifier(d)}`}`,h=this.buildUpdateSet(e,r),m=s&&y.join([y.raw(\" from \"),this.buildFromTable(s)]),x=this.buildJoins(o),w=i?y` returning ${this.buildSelection(i,{isSingleTable:!s})}`:void 0,C=n?y` where ${n}`:void 0;return y`${u}update ${f} set ${h}${m}${x}${C}${w}`}buildSelection(e,{isSingleTable:r=!1}={}){let n=e.length,i=e.flatMap(({field:a},s)=>{let o=[];if(b(a,N.Aliased)&&a.isSelectionField)o.push(y.identifier(a.fieldAlias));else if(b(a,N.Aliased)||b(a,N)){let u=b(a,N.Aliased)?a.sql:a;r?o.push(new N(u.queryChunks.map(c=>b(c,T)?y.identifier(this.casing.getColumnCasing(c)):c))):o.push(u),b(a,N.Aliased)&&o.push(y` as ${y.identifier(a.fieldAlias)}`)}else b(a,K)&&(r?o.push(y.identifier(this.casing.getColumnCasing(a))):o.push(a));return s<n-1&&o.push(y`, `),o});return y.join(i)}buildJoins(e){if(!e||e.length===0)return;let r=[];for(let[n,i]of e.entries()){n===0&&r.push(y` `);let a=i.table,s=i.lateral?y` lateral`:void 0;if(b(a,Be)){let o=a[Be.Symbol.Name],u=a[Be.Symbol.Schema],c=a[Be.Symbol.OriginalName],l=o===c?void 0:i.alias;r.push(y`${y.raw(i.joinType)} join${s} ${u?y`${y.identifier(u)}.`:void 0}${y.identifier(c)}${l&&y` ${y.identifier(l)}`} on ${i.on}`)}else if(b(a,et)){let o=a[se].name,u=a[se].schema,c=a[se].originalName,l=o===c?void 0:i.alias;r.push(y`${y.raw(i.joinType)} join${s} ${u?y`${y.identifier(u)}.`:void 0}${y.identifier(c)}${l&&y` ${y.identifier(l)}`} on ${i.on}`)}else r.push(y`${y.raw(i.joinType)} join${s} ${a} on ${i.on}`);n<e.length-1&&r.push(y` `)}return y.join(r)}buildFromTable(e){if(b(e,P)&&e[P.Symbol.OriginalName]!==e[P.Symbol.Name]){let r=y`${y.identifier(e[P.Symbol.OriginalName])}`;return e[P.Symbol.Schema]&&(r=y`${y.identifier(e[P.Symbol.Schema])}.${r}`),y`${r} ${y.identifier(e[P.Symbol.Name])}`}return e}buildSelectQuery({withList:e,fields:r,fieldsFlat:n,where:i,having:a,table:s,joins:o,orderBy:u,groupBy:c,limit:l,offset:p,lockingClause:d,distinct:f,setOperators:h}){let m=n??Ot(r);for(let le of m)if(b(le.field,K)&&ut(le.field.table)!==(b(s,Te)?s._.alias:b(s,$i)?s[se].name:b(s,N)?void 0:ut(s))&&!(xe=>o?.some(({alias:mt})=>mt===(xe[P.Symbol.IsAlias]?ut(xe):xe[P.Symbol.BaseName])))(le.field.table)){let xe=ut(le.field.table);throw new Error(`Your \"${le.path.join(\"->\")}\" field references a column \"${xe}\".\"${le.field.name}\", but the table \"${xe}\" is not part of the query! Did you forget to join it?`)}let x=!o||o.length===0,w=this.buildWithCTE(e),C;f&&(C=f===!0?y` distinct`:y` distinct on (${y.join(f.on,y`, `)})`);let _=this.buildSelection(m,{isSingleTable:x}),E=this.buildFromTable(s),R=this.buildJoins(o),M=i?y` where ${i}`:void 0,I=a?y` having ${a}`:void 0,D;u&&u.length>0&&(D=y` order by ${y.join(u,y`, `)}`);let Q;c&&c.length>0&&(Q=y` group by ${y.join(c,y`, `)}`);let ke=typeof l==\"object\"||typeof l==\"number\"&&l>=0?y` limit ${l}`:void 0,rt=p?y` offset ${p}`:void 0,$e=y.empty();if(d){let le=y` for ${y.raw(d.strength)}`;d.config.of&&le.append(y` of ${y.join(Array.isArray(d.config.of)?d.config.of:[d.config.of],y`, `)}`),d.config.noWait?le.append(y` no wait`):d.config.skipLocked&&le.append(y` skip locked`),$e.append(le)}let ye=y`${w}select${C} ${_} from ${E}${R}${M}${Q}${I}${D}${ke}${rt}${$e}`;return h.length>0?this.buildSetOperations(ye,h):ye}buildSetOperations(e,r){let[n,...i]=r;if(!n)throw new Error(\"Cannot pass undefined values to any set operator\");return i.length===0?this.buildSetOperationQuery({leftSelect:e,setOperator:n}):this.buildSetOperations(this.buildSetOperationQuery({leftSelect:e,setOperator:n}),i)}buildSetOperationQuery({leftSelect:e,setOperator:{type:r,isAll:n,rightSelect:i,limit:a,orderBy:s,offset:o}}){let u=y`(${e.getSQL()}) `,c=y`(${i.getSQL()})`,l;if(s&&s.length>0){let h=[];for(let m of s)if(b(m,T))h.push(y.identifier(m.name));else if(b(m,N)){for(let x=0;x<m.queryChunks.length;x++){let w=m.queryChunks[x];b(w,T)&&(m.queryChunks[x]=y.identifier(w.name))}h.push(y`${m}`)}else h.push(y`${m}`);l=y` order by ${y.join(h,y`, `)} `}let p=typeof a==\"object\"||typeof a==\"number\"&&a>=0?y` limit ${a}`:void 0,d=y.raw(`${r} ${n?\"all \":\"\"}`),f=o?y` offset ${o}`:void 0;return y`${u}${d}${c}${l}${p}${f}`}buildInsertQuery({table:e,values:r,onConflict:n,returning:i,withList:a,select:s,overridingSystemValue_:o}){let u=[],c=e[P.Symbol.Columns],l=Object.entries(c).filter(([w,C])=>!C.shouldDisableInsert()),p=l.map(([,w])=>y.identifier(this.casing.getColumnCasing(w)));if(s){let w=r;b(w,N)?u.push(w):u.push(w.getSQL())}else{let w=r;u.push(y.raw(\"values \"));for(let[C,_]of w.entries()){let E=[];for(let[R,M]of l){let I=_[R];if(I===void 0||b(I,lt)&&I.value===void 0)if(M.defaultFn!==void 0){let D=M.defaultFn(),Q=b(D,N)?D:y.param(D,M);E.push(Q)}else if(!M.default&&M.onUpdateFn!==void 0){let D=M.onUpdateFn(),Q=b(D,N)?D:y.param(D,M);E.push(Q)}else E.push(y`default`);else E.push(I)}u.push(E),C<w.length-1&&u.push(y`, `)}}let d=this.buildWithCTE(a),f=y.join(u),h=i?y` returning ${this.buildSelection(i,{isSingleTable:!0})}`:void 0,m=n?y` on conflict ${n}`:void 0,x=o===!0?y`overriding system value `:void 0;return y`${d}insert into ${e} ${p} ${x}${f}${m}${h}`}buildRefreshMaterializedViewQuery({view:e,concurrently:r,withNoData:n}){let i=r?y` concurrently`:void 0,a=n?y` with no data`:void 0;return y`refresh materialized view${i} ${e}${a}`}prepareTyping(e){return b(e,Os)||b(e,Ps)?\"json\":b(e,Is)?\"decimal\":b(e,Ns)?\"time\":b(e,qs)||b(e,js)?\"timestamp\":b(e,Ts)||b(e,As)?\"date\":b(e,Rs)?\"uuid\":\"none\"}sqlToQuery(e,r){return e.toQuery({casing:this.casing,escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString,prepareTyping:this.prepareTyping,invokeSource:r})}buildRelationalQueryWithoutPK({fullSchema:e,schema:r,tableNamesMap:n,table:i,tableConfig:a,queryConfig:s,tableAlias:o,nestedQueryRelation:u,joinOn:c}){let l=[],p,d,f=[],h,m=[];if(s===!0)l=Object.entries(a.columns).map(([C,_])=>({dbKey:_.name,tsKey:C,field:nr(_,o),relationTableTsKey:void 0,isJson:!1,selection:[]}));else{let w=Object.fromEntries(Object.entries(a.columns).map(([I,D])=>[I,nr(D,o)]));if(s.where){let I=typeof s.where==\"function\"?s.where(w,YS()):s.where;h=I&&Es(I,o)}let C=[],_=[];if(s.columns){let I=!1;for(let[D,Q]of Object.entries(s.columns))Q!==void 0&&D in a.columns&&(!I&&Q===!0&&(I=!0),_.push(D));_.length>0&&(_=I?_.filter(D=>s.columns?.[D]===!0):Object.keys(a.columns).filter(D=>!_.includes(D)))}else _=Object.keys(a.columns);for(let I of _){let D=a.columns[I];C.push({tsKey:I,value:D})}let E=[];s.with&&(E=Object.entries(s.with).filter(I=>!!I[1]).map(([I,D])=>({tsKey:I,queryConfig:D,relation:a.relations[I]})));let R;if(s.extras){R=typeof s.extras==\"function\"?s.extras(w,{sql:y}):s.extras;for(let[I,D]of Object.entries(R))C.push({tsKey:I,value:Bd(D,o)})}for(let{tsKey:I,value:D}of C)l.push({dbKey:b(D,N.Aliased)?D.fieldAlias:a.columns[I].name,tsKey:I,field:b(D,K)?nr(D,o):D,relationTableTsKey:void 0,isJson:!1,selection:[]});let M=typeof s.orderBy==\"function\"?s.orderBy(w,eE()):s.orderBy??[];Array.isArray(M)||(M=[M]),f=M.map(I=>b(I,K)?nr(I,o):Es(I,o)),p=s.limit,d=s.offset;for(let{tsKey:I,queryConfig:D,relation:Q}of E){let ke=rE(r,n,Q),rt=Rn(Q.referencedTable),$e=n[rt],ye=`${o}_${I}`,le=Bs(...ke.fields.map((Yr,oa)=>It(nr(ke.references[oa],ye),nr(Yr,o)))),xe=this.buildRelationalQueryWithoutPK({fullSchema:e,schema:r,tableNamesMap:n,table:e[$e],tableConfig:r[$e],queryConfig:b(Q,$r)?D===!0?{limit:1}:{...D,limit:1}:D,tableAlias:ye,joinOn:le,nestedQueryRelation:Q}),mt=y`${y.identifier(ye)}.${y.identifier(\"data\")}`.as(I);m.push({on:y`true`,table:new Te(xe.sql,{},ye),alias:ye,joinType:\"left\",lateral:!0}),l.push({dbKey:I,tsKey:I,field:mt,relationTableTsKey:$e,isJson:!0,selection:xe.selection})}}if(l.length===0)throw new Ms({message:`No fields selected for table \"${a.tsName}\" (\"${o}\")`});let x;if(h=Bs(c,h),u){let w=y`json_build_array(${y.join(l.map(({field:E,tsKey:R,isJson:M})=>M?y`${y.identifier(`${o}_${R}`)}.${y.identifier(\"data\")}`:b(E,N.Aliased)?E.sql:E),y`, `)})`;b(u,Fs)&&(w=y`coalesce(json_agg(${w}${f.length>0?y` order by ${y.join(f,y`, `)}`:void 0}), '[]'::json)`);let C=[{dbKey:\"data\",tsKey:\"data\",field:w.as(\"data\"),isJson:!0,relationTableTsKey:a.tsName,selection:l}];p!==void 0||d!==void 0||f.length>0?(x=this.buildSelectQuery({table:Ss(i,o),fields:{},fieldsFlat:[{path:[],field:y.raw(\"*\")}],where:h,limit:p,offset:d,orderBy:f,setOperators:[]}),h=void 0,p=void 0,d=void 0,f=[]):x=Ss(i,o),x=this.buildSelectQuery({table:b(x,Be)?x:new Te(x,{},o),fields:{},fieldsFlat:C.map(({field:E})=>({path:[],field:b(E,K)?nr(E,o):E})),joins:m,where:h,limit:p,offset:d,orderBy:f,setOperators:[]})}else x=this.buildSelectQuery({table:Ss(i,o),fields:{},fieldsFlat:l.map(({field:w})=>({path:[],field:b(w,K)?nr(w,o):w})),joins:m,where:h,limit:p,offset:d,orderBy:f,setOperators:[]});return{tableTsKey:a.tsName,sql:x,selection:l}}};var Wc=class{static[g]=\"TypedQueryBuilder\";getSelectedFields(){return this._.selectedFields}};var Ve=class{static[g]=\"PgSelectBuilder\";fields;session;dialect;withList=[];distinct;constructor(e){this.fields=e.fields,this.session=e.session,this.dialect=e.dialect,e.withList&&(this.withList=e.withList),this.distinct=e.distinct}authToken;setToken(e){return this.authToken=e,this}from(e){let r=!!this.fields,n=e,i;return this.fields?i=this.fields:b(n,Te)?i=Object.fromEntries(Object.keys(n._.selectedFields).map(a=>[a,n[a]])):b(n,$i)?i=n[se].selectedFields:b(n,N)?i={}:i=Fc(n),new Kc({table:n,fields:i,isPartialSelect:r,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct}).setToken(this.authToken)}},am=class extends Wc{static[g]=\"PgSelectQueryBuilder\";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;constructor({table:e,fields:r,isPartialSelect:n,session:i,dialect:a,withList:s,distinct:o}){super(),this.config={withList:s,table:e,fields:{...r},distinct:o,setOperators:[]},this.isPartialSelect=n,this.session=i,this.dialect=a,this._={selectedFields:r},this.tableName=yr(e),this.joinsNotNullableMap=typeof this.tableName==\"string\"?{[this.tableName]:!0}:{}}createJoin(e){return(r,n)=>{let i=this.tableName,a=yr(r);if(typeof a==\"string\"&&this.config.joins?.some(s=>s.alias===a))throw new Error(`Alias \"${a}\" is already used in this query`);if(!this.isPartialSelect&&(Object.keys(this.joinsNotNullableMap).length===1&&typeof i==\"string\"&&(this.config.fields={[i]:this.config.fields}),typeof a==\"string\"&&!b(r,N))){let s=b(r,Te)?r._.selectedFields:b(r,et)?r[se].selectedFields:r[P.Symbol.Columns];this.config.fields[a]=s}if(typeof n==\"function\"&&(n=n(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.joins||(this.config.joins=[]),this.config.joins.push({on:n,table:r,joinType:e,alias:a}),typeof a==\"string\")switch(e){case\"left\":{this.joinsNotNullableMap[a]=!1;break}case\"right\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([s])=>[s,!1])),this.joinsNotNullableMap[a]=!0;break}case\"inner\":{this.joinsNotNullableMap[a]=!0;break}case\"full\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([s])=>[s,!1])),this.joinsNotNullableMap[a]=!1;break}}return this}}leftJoin=this.createJoin(\"left\");rightJoin=this.createJoin(\"right\");innerJoin=this.createJoin(\"inner\");fullJoin=this.createJoin(\"full\");createSetOperator(e,r){return n=>{let i=typeof n==\"function\"?n(Tj()):n;if(!ks(this.getSelectedFields(),i.getSelectedFields()))throw new Error(\"Set operator error (union / intersect / except): selected fields are not the same or are in a different order\");return this.config.setOperators.push({type:e,isAll:r,rightSelect:i}),this}}union=this.createSetOperator(\"union\",!1);unionAll=this.createSetOperator(\"union\",!0);intersect=this.createSetOperator(\"intersect\",!1);intersectAll=this.createSetOperator(\"intersect\",!0);except=this.createSetOperator(\"except\",!1);exceptAll=this.createSetOperator(\"except\",!0);addSetOperators(e){return this.config.setOperators.push(...e),this}where(e){return typeof e==\"function\"&&(e=e(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.where=e,this}having(e){return typeof e==\"function\"&&(e=e(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.having=e,this}groupBy(...e){if(typeof e[0]==\"function\"){let r=e[0](new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"alias\",sqlBehavior:\"sql\"})));this.config.groupBy=Array.isArray(r)?r:[r]}else this.config.groupBy=e;return this}orderBy(...e){if(typeof e[0]==\"function\"){let r=e[0](new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"alias\",sqlBehavior:\"sql\"}))),n=Array.isArray(r)?r:[r];this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=n:this.config.orderBy=n}else{let r=e;this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=r:this.config.orderBy=r}return this}limit(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).limit=e:this.config.limit=e,this}offset(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).offset=e:this.config.offset=e,this}for(e,r={}){return this.config.lockingClause={strength:e,config:r},this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}as(e){return new Proxy(new Te(this.getSQL(),this.config.fields,e),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"}))}getSelectedFields(){return new Proxy(this.config.fields,new _e({alias:this.tableName,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"}))}$dynamic(){return this}},Kc=class extends am{static[g]=\"PgSelect\";_prepare(e){let{session:r,config:n,dialect:i,joinsNotNullableMap:a,authToken:s}=this;if(!r)throw new Error(\"Cannot execute a query on a query builder. Please use a database instance instead.\");return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>{let o=Ot(n.fields),u=r.prepareQuery(i.sqlToQuery(this.getSQL()),o,e,!0);return u.joinsNotNullableMap=a,u.setToken(s)})}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken))};Y_(Kc,[Ge]);function Ui(t,e){return(r,n,...i)=>{let a=[n,...i].map(s=>({type:t,isAll:e,rightSelect:s}));for(let s of a)if(!ks(r.getSelectedFields(),s.rightSelect.getSelectedFields()))throw new Error(\"Set operator error (union / intersect / except): selected fields are not the same or are in a different order\");return r.addSetOperators(a)}}var Tj=()=>({union:Aj,unionAll:Pj,intersect:Oj,intersectAll:Ij,except:Nj,exceptAll:qj}),Aj=Ui(\"union\",!1),Pj=Ui(\"union\",!0),Oj=Ui(\"intersect\",!1),Ij=Ui(\"intersect\",!0),Nj=Ui(\"except\",!1),qj=Ui(\"except\",!0);var Qi=class{static[g]=\"PgQueryBuilder\";dialect;dialectConfig;constructor(e){this.dialect=b(e,Ur)?e:void 0,this.dialectConfig=b(e,Ur)?void 0:e}$with=(e,r)=>{let n=this;return{as:a=>(typeof a==\"function\"&&(a=a(n)),new Proxy(new Bi(a.getSQL(),r??(\"getSelectedFields\"in a?a.getSelectedFields()??{}:{}),e,!0),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})))}};with(...e){let r=this;function n(s){return new Ve({fields:s??void 0,session:void 0,dialect:r.getDialect(),withList:e})}function i(s){return new Ve({fields:s??void 0,session:void 0,dialect:r.getDialect(),distinct:!0})}function a(s,o){return new Ve({fields:o??void 0,session:void 0,dialect:r.getDialect(),distinct:{on:s}})}return{select:n,selectDistinct:i,selectDistinctOn:a}}select(e){return new Ve({fields:e??void 0,session:void 0,dialect:this.getDialect()})}selectDistinct(e){return new Ve({fields:e??void 0,session:void 0,dialect:this.getDialect(),distinct:!0})}selectDistinctOn(e,r){return new Ve({fields:r??void 0,session:void 0,dialect:this.getDialect(),distinct:{on:e}})}getDialect(){return this.dialect||(this.dialect=new Ur(this.dialectConfig)),this.dialect}};var zs=class{constructor(e,r,n,i,a){this.table=e,this.session=r,this.dialect=n,this.withList=i,this.overridingSystemValue_=a}static[g]=\"PgInsertBuilder\";authToken;setToken(e){return this.authToken=e,this}overridingSystemValue(){return this.overridingSystemValue_=!0,this}values(e){if(e=Array.isArray(e)?e:[e],e.length===0)throw new Error(\"values() must be called with at least one value\");let r=e.map(n=>{let i={},a=this.table[P.Symbol.Columns];for(let s of Object.keys(n)){let o=n[s];i[s]=b(o,N)?o:new lt(o,a[s])}return i});return new Zc(this.table,r,this.session,this.dialect,this.withList,!1,this.overridingSystemValue_).setToken(this.authToken)}select(e){let r=typeof e==\"function\"?e(new Qi):e;if(!b(r,N)&&!ks(this.table[Lc],r._.selectedFields))throw new Error(\"Insert select error: selected fields are not the same or are in a different order compared to the table definition\");return new Zc(this.table,r,this.session,this.dialect,this.withList,!0)}},Zc=class extends Ge{constructor(e,r,n,i,a,s,o){super(),this.session=n,this.dialect=i,this.config={table:e,values:r,withList:a,select:s,overridingSystemValue_:o}}static[g]=\"PgInsert\";config;returning(e=this.config.table[P.Symbol.Columns]){return this.config.returningFields=e,this.config.returning=Ot(e),this}onConflictDoNothing(e={}){if(e.target===void 0)this.config.onConflict=y`do nothing`;else{let r=\"\";r=Array.isArray(e.target)?e.target.map(i=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(i))).join(\",\"):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target));let n=e.where?y` where ${e.where}`:void 0;this.config.onConflict=y`(${y.raw(r)})${n} do nothing`}return this}onConflictDoUpdate(e){if(e.where&&(e.targetWhere||e.setWhere))throw new Error('You cannot use both \"where\" and \"targetWhere\"/\"setWhere\" at the same time - \"where\" is deprecated, use \"targetWhere\" or \"setWhere\" instead.');let r=e.where?y` where ${e.where}`:void 0,n=e.targetWhere?y` where ${e.targetWhere}`:void 0,i=e.setWhere?y` where ${e.setWhere}`:void 0,a=this.dialect.buildUpdateSet(this.config.table,Bc(this.config.table,e.set)),s=\"\";return s=Array.isArray(e.target)?e.target.map(o=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(o))).join(\",\"):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target)),this.config.onConflict=y`(${y.raw(s)})${n} do update set ${a}${r}${i}`,this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken));getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new _e({alias:ut(this.config.table),sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})):void 0}$dynamic(){return this}};var Jc=class extends Ge{constructor(e,r,n){super(),this.session=r,this.dialect=n,this.config={view:e}}static[g]=\"PgRefreshMaterializedView\";config;concurrently(){if(this.config.withNoData!==void 0)throw new Error(\"Cannot use concurrently and withNoData together\");return this.config.concurrently=!0,this}withNoData(){if(this.config.concurrently!==void 0)throw new Error(\"Cannot use concurrently and withNoData together\");return this.config.withNoData=!0,this}getSQL(){return this.dialect.buildRefreshMaterializedViewQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),void 0,e,!0))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken))};var $s=class{constructor(e,r,n,i){this.table=e,this.session=r,this.dialect=n,this.withList=i}static[g]=\"PgUpdateBuilder\";authToken;setToken(e){return this.authToken=e,this}set(e){return new sm(this.table,Bc(this.table,e),this.session,this.dialect,this.withList).setToken(this.authToken)}},sm=class extends Ge{constructor(e,r,n,i,a){super(),this.session=n,this.dialect=i,this.config={set:r,table:e,withList:a,joins:[]},this.tableName=yr(e),this.joinsNotNullableMap=typeof this.tableName==\"string\"?{[this.tableName]:!0}:{}}static[g]=\"PgUpdate\";config;tableName;joinsNotNullableMap;from(e){let r=e,n=yr(r);return typeof n==\"string\"&&(this.joinsNotNullableMap[n]=!0),this.config.from=r,this}getTableLikeFields(e){return b(e,Be)?e[P.Symbol.Columns]:b(e,Te)?e._.selectedFields:e[se].selectedFields}createJoin(e){return(r,n)=>{let i=yr(r);if(typeof i==\"string\"&&this.config.joins.some(a=>a.alias===i))throw new Error(`Alias \"${i}\" is already used in this query`);if(typeof n==\"function\"){let a=this.config.from&&!b(this.config.from,N)?this.getTableLikeFields(this.config.from):void 0;n=n(new Proxy(this.config.table[P.Symbol.Columns],new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})),a&&new Proxy(a,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))}if(this.config.joins.push({on:n,table:r,joinType:e,alias:i}),typeof i==\"string\")switch(e){case\"left\":{this.joinsNotNullableMap[i]=!1;break}case\"right\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([a])=>[a,!1])),this.joinsNotNullableMap[i]=!0;break}case\"inner\":{this.joinsNotNullableMap[i]=!0;break}case\"full\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([a])=>[a,!1])),this.joinsNotNullableMap[i]=!1;break}}return this}}leftJoin=this.createJoin(\"left\");rightJoin=this.createJoin(\"right\");innerJoin=this.createJoin(\"inner\");fullJoin=this.createJoin(\"full\");where(e){return this.config.where=e,this}returning(e){if(!e&&(e=Object.assign({},this.config.table[P.Symbol.Columns]),this.config.from)){let r=yr(this.config.from);if(typeof r==\"string\"&&this.config.from&&!b(this.config.from,N)){let n=this.getTableLikeFields(this.config.from);e[r]=n}for(let n of this.config.joins){let i=yr(n.table);if(typeof i==\"string\"&&!b(n.table,N)){let a=this.getTableLikeFields(n.table);e[i]=a}}}return this.config.returningFields=e,this.config.returning=Ot(e),this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){let r=this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0);return r.joinsNotNullableMap=this.joinsNotNullableMap,r}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>this._prepare().execute(e,this.authToken);getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new _e({alias:ut(this.config.table),sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})):void 0}$dynamic(){return this}};var Xc=class t extends N{constructor(e){super(t.buildEmbeddedCount(e.source,e.filters).queryChunks),this.params=e,this.mapWith(Number),this.session=e.session,this.sql=t.buildCount(e.source,e.filters)}sql;token;static[g]=\"PgCountBuilder\";[Symbol.toStringTag]=\"PgCountBuilder\";session;static buildEmbeddedCount(e,r){return y`(select count(*) from ${e}${y.raw(\" where \").if(r)}${r})`}static buildCount(e,r){return y`select count(*) as count from ${e}${y.raw(\" where \").if(r)}${r};`}setToken(e){return this.token=e,this}then(e,r){return Promise.resolve(this.session.count(this.sql,this.token)).then(e,r)}catch(e){return this.then(void 0,e)}finally(e){return this.then(r=>(e?.(),r),r=>{throw e?.(),r})}};var Yc=class{constructor(e,r,n,i,a,s,o){this.fullSchema=e,this.schema=r,this.tableNamesMap=n,this.table=i,this.tableConfig=a,this.dialect=s,this.session=o}static[g]=\"PgRelationalQueryBuilder\";findMany(e){return new eu(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},\"many\")}findFirst(e){return new eu(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},\"first\")}},eu=class extends Ge{constructor(e,r,n,i,a,s,o,u,c){super(),this.fullSchema=e,this.schema=r,this.tableNamesMap=n,this.table=i,this.tableConfig=a,this.dialect=s,this.session=o,this.config=u,this.mode=c}static[g]=\"PgRelationalQuery\";_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>{let{query:r,builtQuery:n}=this._toSQL();return this.session.prepareQuery(n,void 0,e,!0,(i,a)=>{let s=i.map(o=>Vc(this.schema,this.tableConfig,o,r.selection,a));return this.mode===\"first\"?s[0]:s})})}prepare(e){return this._prepare(e)}_getQuery(){return this.dialect.buildRelationalQueryWithoutPK({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName})}getSQL(){return this._getQuery().sql}_toSQL(){let e=this._getQuery(),r=this.dialect.sqlToQuery(e.sql);return{query:e,builtQuery:r}}toSQL(){return this._toSQL().builtQuery}authToken;setToken(e){return this.authToken=e,this}execute(){return ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(void 0,this.authToken))}};var tu=class extends Ge{constructor(e,r,n,i){super(),this.execute=e,this.sql=r,this.query=n,this.mapBatchResult=i}static[g]=\"PgRaw\";getSQL(){return this.sql}getQuery(){return this.query}mapResult(e,r){return r?this.mapBatchResult(e):e}_prepare(){return this}isResponseInArrayMode(){return!1}};var Gi=class{constructor(e,r,n){if(this.dialect=e,this.session=r,this._=n?{schema:n.schema,fullSchema:n.fullSchema,tableNamesMap:n.tableNamesMap,session:r}:{schema:void 0,fullSchema:{},tableNamesMap:{},session:r},this.query={},this._.schema)for(let[i,a]of Object.entries(this._.schema))this.query[i]=new Yc(n.fullSchema,this._.schema,this._.tableNamesMap,n.fullSchema[i],a,e,r)}static[g]=\"PgDatabase\";query;$with=(e,r)=>{let n=this;return{as:a=>(typeof a==\"function\"&&(a=a(new Qi(n.dialect))),new Proxy(new Bi(a.getSQL(),r??(\"getSelectedFields\"in a?a.getSelectedFields()??{}:{}),e,!0),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})))}};$count(e,r){return new Xc({source:e,filters:r,session:this.session})}with(...e){let r=this;function n(c){return new Ve({fields:c??void 0,session:r.session,dialect:r.dialect,withList:e})}function i(c){return new Ve({fields:c??void 0,session:r.session,dialect:r.dialect,withList:e,distinct:!0})}function a(c,l){return new Ve({fields:l??void 0,session:r.session,dialect:r.dialect,withList:e,distinct:{on:c}})}function s(c){return new $s(c,r.session,r.dialect,e)}function o(c){return new zs(c,r.session,r.dialect,e)}function u(c){return new Ds(c,r.session,r.dialect,e)}return{select:n,selectDistinct:i,selectDistinctOn:a,update:s,insert:o,delete:u}}select(e){return new Ve({fields:e??void 0,session:this.session,dialect:this.dialect})}selectDistinct(e){return new Ve({fields:e??void 0,session:this.session,dialect:this.dialect,distinct:!0})}selectDistinctOn(e,r){return new Ve({fields:r??void 0,session:this.session,dialect:this.dialect,distinct:{on:e}})}update(e){return new $s(e,this.session,this.dialect)}insert(e){return new zs(e,this.session,this.dialect)}delete(e){return new Ds(e,this.session,this.dialect)}refreshMaterializedView(e){return new Jc(e,this.session,this.dialect)}authToken;execute(e){let r=typeof e==\"string\"?y.raw(e):e.getSQL(),n=this.dialect.sqlToQuery(r),i=this.session.prepareQuery(n,void 0,void 0,!1);return new tu(()=>i.execute(void 0,this.authToken),r,n,a=>i.mapResult(a,!0))}transaction(e,r){return this.session.transaction(e,r)}};var ru=class{constructor(e){this.query=e}authToken;getQuery(){return this.query}mapResult(e,r){return e}setToken(e){return this.authToken=e,this}static[g]=\"PgPreparedQuery\";joinsNotNullableMap},nu=class{constructor(e){this.dialect=e}static[g]=\"PgSession\";execute(e,r){return ae.startActiveSpan(\"drizzle.operation\",()=>ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1)).setToken(r).execute(void 0,r))}all(e){return this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1).all()}async count(e,r){let n=await this.execute(e,r);return Number(n[0].count)}},iu=class extends Gi{constructor(e,r,n,i=0){super(e,r,n),this.schema=n,this.nestedIndex=i}static[g]=\"PgTransaction\";rollback(){throw new $c}getTransactionConfigSQL(e){let r=[];return e.isolationLevel&&r.push(`isolation level ${e.isolationLevel}`),e.accessMode&&r.push(e.accessMode),typeof e.deferrable==\"boolean\"&&r.push(e.deferrable?\"deferrable\":\"not deferrable\"),y.raw(r.join(\" \"))}setTransaction(e){return this.session.execute(y`set transaction ${this.getTransactionConfigSQL(e)}`)}};var om=class{static[g]=\"ConsoleLogWriter\";write(e){console.log(e)}},au=class{static[g]=\"DefaultLogger\";writer;constructor(e){this.writer=e?.writer??new om}logQuery(e,r){let n=r.map(a=>{try{return JSON.stringify(a)}catch{return String(a)}}),i=n.length?` -- params: [${n.join(\", \")}]`:\"\";this.writer.write(`Query: ${e}${i}`)}},su=class{static[g]=\"NoopLogger\";logQuery(){}};var he={INT8_MIN:-128,INT8_MAX:127,INT8_UNSIGNED_MAX:255,INT16_MIN:-32768,INT16_MAX:32767,INT16_UNSIGNED_MAX:65535,INT24_MIN:-8388608,INT24_MAX:8388607,INT24_UNSIGNED_MAX:16777215,INT32_MIN:-2147483648,INT32_MAX:2147483647,INT32_UNSIGNED_MAX:4294967295,INT48_MIN:-0x800000000000,INT48_MAX:0x7fffffffffff,INT48_UNSIGNED_MAX:0xffffffffffff,INT64_MIN:-9223372036854775808n,INT64_MAX:9223372036854775807n,INT64_UNSIGNED_MAX:18446744073709551615n};function Se(t,e){return e.includes(t.columnType)}function jj(t){return\"enumValues\"in t&&Array.isArray(t.enumValues)&&t.enumValues.length>0}var Rj=k.union([k.string(),k.number(),k.boolean(),k.null()]),Dj=k.union([Rj,k.record(k.any()),k.array(k.any())]),Mj=k.custom(t=>t instanceof Buffer);function iE(t,e){let r=e?.zodInstance??k,n=e?.coerce??{},i;return jj(t)&&(i=t.enumValues.length?r.enum(t.enumValues):r.string()),i||(Se(t,[\"PgGeometry\",\"PgPointTuple\"])?i=r.tuple([r.number(),r.number()]):Se(t,[\"PgGeometryObject\",\"PgPointObject\"])?i=r.object({x:r.number(),y:r.number()}):Se(t,[\"PgHalfVector\",\"PgVector\"])?(i=r.array(r.number()),i=t.dimensions?i.length(t.dimensions):i):Se(t,[\"PgLine\"])?i=r.tuple([r.number(),r.number(),r.number()]):Se(t,[\"PgLineABC\"])?i=r.object({a:r.number(),b:r.number(),c:r.number()}):Se(t,[\"PgArray\"])?(i=r.array(iE(t.baseColumn,r)),i=t.size?i.length(t.size):i):t.dataType===\"array\"?i=r.array(r.any()):t.dataType===\"number\"?i=Lj(t,r,n):t.dataType===\"bigint\"?i=Bj(t,r,n):t.dataType===\"boolean\"?i=n===!0||n.boolean?r.coerce.boolean():r.boolean():t.dataType===\"date\"?i=n===!0||n.date?r.coerce.date():r.date():t.dataType===\"string\"?i=Fj(t,r,n):t.dataType===\"json\"?i=Dj:t.dataType===\"custom\"?i=r.any():t.dataType===\"buffer\"&&(i=Mj)),i||(i=r.any()),i}function Lj(t,e,r){let n=t.getSQLType().includes(\"unsigned\"),i,a,s=!1;Se(t,[\"MySqlTinyInt\",\"SingleStoreTinyInt\"])?(i=n?0:he.INT8_MIN,a=n?he.INT8_UNSIGNED_MAX:he.INT8_MAX,s=!0):Se(t,[\"PgSmallInt\",\"PgSmallSerial\",\"MySqlSmallInt\",\"SingleStoreSmallInt\"])?(i=n?0:he.INT16_MIN,a=n?he.INT16_UNSIGNED_MAX:he.INT16_MAX,s=!0):Se(t,[\"PgReal\",\"MySqlFloat\",\"MySqlMediumInt\",\"SingleStoreMediumInt\",\"SingleStoreFloat\"])?(i=n?0:he.INT24_MIN,a=n?he.INT24_UNSIGNED_MAX:he.INT24_MAX,s=Se(t,[\"MySqlMediumInt\",\"SingleStoreMediumInt\"])):Se(t,[\"PgInteger\",\"PgSerial\",\"MySqlInt\",\"SingleStoreInt\"])?(i=n?0:he.INT32_MIN,a=n?he.INT32_UNSIGNED_MAX:he.INT32_MAX,s=!0):Se(t,[\"PgDoublePrecision\",\"MySqlReal\",\"MySqlDouble\",\"SingleStoreReal\",\"SingleStoreDouble\",\"SQLiteReal\"])?(i=n?0:he.INT48_MIN,a=n?he.INT48_UNSIGNED_MAX:he.INT48_MAX):Se(t,[\"PgBigInt53\",\"PgBigSerial53\",\"MySqlBigInt53\",\"MySqlSerial\",\"SingleStoreBigInt53\",\"SingleStoreSerial\",\"SQLiteInteger\"])?(n=n||Se(t,[\"MySqlSerial\",\"SingleStoreSerial\"]),i=n?0:Number.MIN_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER,s=!0):Se(t,[\"MySqlYear\",\"SingleStoreYear\"])?(i=1901,a=2155,s=!0):(i=Number.MIN_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER);let o=r===!0||r?.number?e.coerce.number():e.number();return o=o.min(i).max(a),s?o.int():o}function Bj(t,e,r){let n=t.getSQLType().includes(\"unsigned\"),i=n?0n:he.INT64_MIN,a=n?he.INT64_UNSIGNED_MAX:he.INT64_MAX;return(r===!0||r?.bigint?e.coerce.bigint():e.bigint()).min(i).max(a)}function Fj(t,e,r){if(Se(t,[\"PgUUID\"]))return e.string().uuid();let n,i,a=!1;Se(t,[\"PgVarchar\",\"SQLiteText\"])?n=t.length:Se(t,[\"MySqlVarChar\",\"SingleStoreVarChar\"])?n=t.length??he.INT16_UNSIGNED_MAX:Se(t,[\"MySqlText\",\"SingleStoreText\"])&&(t.textType===\"longtext\"?n=he.INT32_UNSIGNED_MAX:t.textType===\"mediumtext\"?n=he.INT24_UNSIGNED_MAX:t.textType===\"text\"?n=he.INT16_UNSIGNED_MAX:n=he.INT8_UNSIGNED_MAX),Se(t,[\"PgChar\",\"MySqlChar\",\"SingleStoreChar\"])&&(n=t.length,a=!0),Se(t,[\"PgBinaryVector\"])&&(i=/^[01]+$/,n=t.dimensions);let s=r===!0||r?.string?e.coerce.string():e.string();return s=i?s.regex(i):s,n&&a?s.length(n):n?s.max(n):s}function aE(t){return Dd(t)?Fc(t):eS(t)}function sE(t,e,r,n){let i={};for(let[a,s]of Object.entries(t)){if(!b(s,K)&&!b(s,N)&&!b(s,N.Aliased)&&typeof s==\"object\"){let p=Dd(s)||Z_(s)?aE(s):s;i[a]=sE(p,e[a]??{},r,n);continue}let o=e[a];if(o!==void 0&&typeof o!=\"function\"){i[a]=o;continue}let u=b(s,K)?s:void 0,c=u?iE(u,n):k.any(),l=typeof o==\"function\"?o(c):c;r.never(u)||(i[a]=l,u&&(r.nullable(u)&&(i[a]=i[a].nullable()),r.optional(u)&&(i[a]=i[a].optional())))}return k.object(i)}var zj={never:t=>t?.generated?.type===\"always\"||t?.generatedIdentity?.type===\"always\",optional:t=>!t.notNull||t.notNull&&t.hasDefault,nullable:t=>!t.notNull};var oE=(t,e)=>{let r=aE(t);return sE(r,e??{},zj)};var Ie=Ls(\"users\",{id:Mn(\"id\").primaryKey(),username:br(\"username\").notNull().unique(),email:br(\"email\").notNull().unique(),passwordHash:br(\"password_hash\").notNull(),rating:wt(\"rating\").notNull().default(1e3),gamesPlayed:wt(\"games_played\").notNull().default(0),gamesWon:wt(\"games_won\").notNull().default(0),createdAt:zi(\"created_at\").defaultNow().notNull()}),$j=oE(Ie).omit({id:!0,rating:!0,gamesPlayed:!0,gamesWon:!0,createdAt:!0}),Gr=Ls(\"password_resets\",{id:Mn(\"id\").primaryKey(),userId:wt(\"user_id\").notNull().references(()=>Ie.id),token:br(\"token\").notNull().unique(),expiresAt:zi(\"expires_at\").notNull(),used:Cs(\"used\").notNull().default(!1)}),Ln=Ls(\"match_history\",{id:Mn(\"id\").primaryKey(),gameMode:br(\"game_mode\").notNull(),pointGoal:br(\"point_goal\").notNull(),winningTeamScore:wt(\"winning_team_score\").notNull(),losingTeamScore:wt(\"losing_team_score\").notNull(),completedAt:zi(\"completed_at\").defaultNow().notNull()}),Qr=Ls(\"match_players\",{id:Mn(\"id\").primaryKey(),matchId:wt(\"match_id\").notNull().references(()=>Ln.id),userId:wt(\"user_id\").references(()=>Ie.id),isBot:Cs(\"is_bot\").notNull().default(!1),teamIndex:wt(\"team_index\").notNull(),ratingChange:wt(\"rating_change\").notNull().default(0)}),Uj=Hc(Ie,({many:t})=>({matchPlayers:t(Qr),passwordResets:t(Gr)})),Qj=Hc(Ln,({many:t})=>({players:t(Qr)})),Gj=Hc(Qr,({one:t})=>({match:t(Ln,{fields:[Qr.matchId],references:[Ln.id]}),user:t(Ie,{fields:[Qr.userId],references:[Ie.id]})})),cm=[\"spades\",\"hearts\",\"diamonds\",\"clubs\"],cE=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"],Vj=[...cE,\"LJ\",\"BJ\"],um=[\"ace_high\",\"joker_joker_deuce_deuce\"],lm=[\"100\",\"300\",\"500\"],pm={100:100,300:300,500:500},uE=[\"south\",\"west\",\"north\",\"east\"],dm=k.object({suit:k.enum(cm),value:k.string(),id:k.string()}),lE=k.object({id:k.string(),name:k.string(),isBot:k.boolean(),position:k.enum(uE),hand:k.array(dm),bid:k.number().nullable(),tricks:k.number(),isReady:k.boolean()}),pE=k.object({id:k.string(),players:k.array(k.string()),score:k.number(),bags:k.number(),totalBid:k.number().nullable(),tricksWon:k.number()}),dE=k.object({cards:k.array(k.object({playerId:k.string(),card:dm})),leadSuit:k.enum(cm).nullable(),winnerId:k.string().nullable()}),fE=[\"waiting\",\"bidding\",\"playing\",\"round_end\",\"game_over\"],Hj=k.object({id:k.string(),mode:k.enum(um),pointGoal:k.enum(lm),phase:k.enum(fE),players:k.array(lE),teams:k.array(pE),currentTrick:dE,currentPlayerIndex:k.number(),dealerIndex:k.number(),roundNumber:k.number(),spadesBroken:k.boolean(),winningScore:k.number()}),Wj=k.object({id:k.string(),mode:k.enum(um),pointGoal:k.enum(lm),players:k.array(k.object({id:k.string(),name:k.string(),isBot:k.boolean(),isReady:k.boolean()})),hostId:k.string(),status:k.enum([\"waiting\",\"starting\",\"in_game\"])}),Kj=k.object({id:k.number(),username:k.string(),email:k.string(),rating:k.number(),gamesPlayed:k.number(),gamesWon:k.number()}),mE=[\"join_lobby\",\"leave_lobby\",\"start_game\",\"place_bid\",\"play_card\",\"game_state_update\",\"lobby_update\",\"error\",\"player_joined\",\"player_left\",\"chat_message\"],Zj=k.object({type:k.enum(mE),payload:k.any()});function wr(t,e,r){let n=t.suit===\"spades\",i=t.suit===r;if(e===\"ace_high\"){let s=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);return n?100+s:i?50+s:s}else{if(t.value===\"BJ\")return 200;if(t.value===\"LJ\")return 199;if(n&&t.value===\"2\")return 198;if(t.suit===\"diamonds\"&&t.value===\"2\")return 197;if(n)return 100+[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);let s=[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);return i?50+s:s}}function ou(t,e){return t.suit===\"spades\"||e===\"joker_joker_deuce_deuce\"&&(t.value===\"LJ\"||t.value===\"BJ\"||t.suit===\"diamonds\"&&t.value===\"2\")}function Jj(t){if(t.value===\"LJ\")return\"Little Joker\";if(t.value===\"BJ\")return\"Big Joker\";let e={J:\"Jack\",Q:\"Queen\",K:\"King\",A:\"Ace\"},r={spades:\"Spades\",hearts:\"Hearts\",diamonds:\"Diamonds\",clubs:\"Clubs\"};return`${e[t.value]||t.value} of ${r[t.suit]}`}var _t=ht(fh(),1),YW=_t.default.Client,eK=_t.default.Pool,tK=_t.default.Connection,rK=_t.default.types,nK=_t.default.Query,iK=_t.default.DatabaseError,aK=_t.default.escapeIdentifier,sK=_t.default.escapeLiteral,oK=_t.default.Result,cK=_t.default.TypeOverrides,uK=_t.default.defaults,Kr=_t.default;var{Pool:r4,types:ar}=Kr,gh=class extends ru{constructor(e,r,n,i,a,s,o,u){super({sql:r,params:n}),this.client=e,this.params=n,this.logger=i,this.fields=a,this._isResponseInArrayMode=o,this.customResultMapper=u,this.rawQueryConfig={name:s,text:r,types:{getTypeParser:(c,l)=>c===ar.builtins.TIMESTAMPTZ?p=>p:c===ar.builtins.TIMESTAMP?p=>p:c===ar.builtins.DATE?p=>p:c===ar.builtins.INTERVAL?p=>p:ar.getTypeParser(c,l)}},this.queryConfig={name:s,text:r,rowMode:\"array\",types:{getTypeParser:(c,l)=>c===ar.builtins.TIMESTAMPTZ?p=>p:c===ar.builtins.TIMESTAMP?p=>p:c===ar.builtins.DATE?p=>p:c===ar.builtins.INTERVAL?p=>p:ar.getTypeParser(c,l)}}}static[g]=\"NodePgPreparedQuery\";rawQueryConfig;queryConfig;async execute(e={}){return ae.startActiveSpan(\"drizzle.execute\",async()=>{let r=Ld(this.params,e);this.logger.logQuery(this.rawQueryConfig.text,r);let{fields:n,rawQueryConfig:i,client:a,queryConfig:s,joinsNotNullableMap:o,customResultMapper:u}=this;if(!n&&!u)return ae.startActiveSpan(\"drizzle.driver.execute\",async l=>(l?.setAttributes({\"drizzle.query.name\":i.name,\"drizzle.query.text\":i.text,\"drizzle.query.params\":JSON.stringify(r)}),a.query(i,r)));let c=await ae.startActiveSpan(\"drizzle.driver.execute\",l=>(l?.setAttributes({\"drizzle.query.name\":s.name,\"drizzle.query.text\":s.text,\"drizzle.query.params\":JSON.stringify(r)}),a.query(s,r)));return ae.startActiveSpan(\"drizzle.mapResponse\",()=>u?u(c.rows):c.rows.map(l=>X_(n,l,o)))})}all(e={}){return ae.startActiveSpan(\"drizzle.execute\",()=>{let r=Ld(this.params,e);return this.logger.logQuery(this.rawQueryConfig.text,r),ae.startActiveSpan(\"drizzle.driver.execute\",n=>(n?.setAttributes({\"drizzle.query.name\":this.rawQueryConfig.name,\"drizzle.query.text\":this.rawQueryConfig.text,\"drizzle.query.params\":JSON.stringify(r)}),this.client.query(this.rawQueryConfig,r).then(i=>i.rows)))})}isResponseInArrayMode(){return this._isResponseInArrayMode}},Su=class t extends nu{constructor(e,r,n,i={}){super(r),this.client=e,this.schema=n,this.options=i,this.logger=i.logger??new su}static[g]=\"NodePgSession\";logger;prepareQuery(e,r,n,i,a){return new gh(this.client,e.sql,e.params,this.logger,r,n,i,a)}async transaction(e,r){let n=this.client instanceof r4?new t(await this.client.connect(),this.dialect,this.schema,this.options):this,i=new yh(this.dialect,n,this.schema);await i.execute(y`begin${r?y` ${i.getTransactionConfigSQL(r)}`:void 0}`);try{let a=await e(i);return await i.execute(y`commit`),a}catch(a){throw await i.execute(y`rollback`),a}finally{this.client instanceof r4&&n.client.release()}}async count(e){let r=await this.execute(e);return Number(r.rows[0].count)}},yh=class t extends iu{static[g]=\"NodePgTransaction\";async transaction(e){let r=`sp${this.nestedIndex+1}`,n=new t(this.dialect,this.session,this.schema,this.nestedIndex+1);await n.execute(y.raw(`savepoint ${r}`));try{let i=await e(n);return await n.execute(y.raw(`release savepoint ${r}`)),i}catch(i){throw await n.execute(y.raw(`rollback to savepoint ${r}`)),i}}};var xh=class{constructor(e,r,n={}){this.client=e,this.dialect=r,this.options=n}static[g]=\"NodePgDriver\";createSession(e){return new Su(this.client,this.dialect,e,{logger:this.options.logger})}},bh=class extends Gi{static[g]=\"NodePgDatabase\"};function Ys(t,e={}){let r=new Ur({casing:e.casing}),n;e.logger===!0?n=new au:e.logger!==!1&&(n=e.logger);let i;if(e.schema){let u=tE(e.schema,nE);i={fullSchema:e.schema,schema:u.tables,tableNamesMap:u.tableNamesMap}}let s=new xh(t,r,{logger:n}).createSession(i),o=new bh(r,s,i);return o.$client=t,o}function Eu(...t){if(typeof t[0]==\"string\"){let e=new Kr.Pool({connectionString:t[0]});return Ys(e,t[1])}if(tS(t[0])){let{connection:e,client:r,...n}=t[0];if(r)return Ys(r,n);let i=typeof e==\"string\"?new Kr.Pool({connectionString:e}):new Kr.Pool(e);return Ys(i,n)}return Ys(t[0],t[1])}(t=>{function e(r){return Ys({},r)}t.mock=e})(Eu||(Eu={}));var{Pool:sL}=Kr;if(!process.env.DATABASE_URL)throw new Error(\"DATABASE_URL must be set. Did you forget to provision a database?\");var oL=new sL({connectionString:process.env.DATABASE_URL}),jt=Eu(oL,{schema:fm});var n4=require(\"crypto\"),wh=class{lobbies;games;constructor(){this.lobbies=new Map,this.games=new Map}async getUser(e){let[r]=await jt.select().from(Ie).where(It(Ie.id,e));return r||void 0}async getUserByEmail(e){let[r]=await jt.select().from(Ie).where(It(Ie.email,e));return r||void 0}async getUserByUsername(e){let[r]=await jt.select().from(Ie).where(It(Ie.username,e));return r||void 0}async createUser(e){let[r]=await jt.insert(Ie).values(e).returning();return r}async updateUserStats(e,r,n){let i=await this.getUser(e);if(!i)return;let[a]=await jt.update(Ie).set({gamesPlayed:i.gamesPlayed+1,gamesWon:i.gamesWon+(r?1:0),rating:Math.max(0,i.rating+n)}).where(It(Ie.id,e)).returning();return a}async updateUserPassword(e,r){let[n]=await jt.update(Ie).set({passwordHash:r}).where(It(Ie.id,e)).returning();return n||void 0}async createPasswordReset(e,r,n){await jt.insert(Gr).values({userId:e,token:r,expiresAt:n})}async getPasswordReset(e){let[r]=await jt.select().from(Gr).where(It(Gr.token,e));return r||void 0}async markPasswordResetUsed(e){await jt.update(Gr).set({used:!0}).where(It(Gr.token,e))}async getLobby(e){return this.lobbies.get(e)}async createLobby(e){let r=(0,n4.randomUUID)(),n={...e,id:r};return this.lobbies.set(r,n),n}async updateLobby(e,r){let n=this.lobbies.get(e);if(!n)return;let i={...n,...r};return this.lobbies.set(e,i),i}async deleteLobby(e){return this.lobbies.delete(e)}async getActiveLobbies(){return Array.from(this.lobbies.values()).filter(e=>e.status===\"waiting\")}async getGame(e){return this.games.get(e)}async saveGame(e){return this.games.set(e.id,e),e}async deleteGame(e){return this.games.delete(e)}async recordMatch(e,r,n,i,a){let[s]=await jt.insert(Ln).values({gameMode:e,pointGoal:r,winningTeamScore:n,losingTeamScore:i}).returning();for(let o of a)await jt.insert(Qr).values({matchId:s.id,userId:o.userId,isBot:o.isBot,teamIndex:o.teamIndex,ratingChange:o.ratingChange})}},Ee=new wh;var jB=ht(o4(),1),RB=ht(Fh(),1),DB=ht(Uh(),1),Xh=ht(Zh(),1),Yh=ht(Tk(),1);var Ik=require(\"crypto\"),MB=[\"south\",\"west\",\"north\",\"east\"];function ev(){let t=[\"spades\",\"hearts\",\"diamonds\",\"clubs\"],e=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"],r=[];for(let n of t)for(let i of e)r.push({suit:n,value:i,id:`${i}-${n}`});return r}function Ak(){let e=ev().filter(r=>!(r.value===\"2\"&&(r.suit===\"hearts\"||r.suit===\"clubs\")));return e.push({suit:\"spades\",value:\"LJ\",id:\"LJ-joker\"},{suit:\"spades\",value:\"BJ\",id:\"BJ-joker\"}),e}function Pk(t){let e=[...t];for(let r=e.length-1;r>0;r--){let n=Math.floor(Math.random()*(r+1));[e[r],e[n]]=[e[n],e[r]]}return e}function Ok(t,e){let r=[\"spades\",\"hearts\",\"clubs\",\"diamonds\"],n=e===\"ace_high\"?[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"]:[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\",\"2\",\"LJ\",\"BJ\"],i=a=>a.value===\"LJ\"||a.value===\"BJ\";return[...t].sort((a,s)=>{if(i(a)&&!i(s))return-1;if(!i(a)&&i(s))return 1;if(i(a)&&i(s))return a.value===\"BJ\"?-1:1;let o=r.indexOf(a.suit)-r.indexOf(s.suit);return o!==0?o:n.indexOf(s.value)-n.indexOf(a.value)})}var Mt=class{static createGame(e,r,n){if(e.length!==4)throw new Error(\"Spades requires exactly 4 players\");let i=r===\"ace_high\"?ev():Ak(),a=Pk(i),s=e.map((u,c)=>({id:u.id,name:u.name,isBot:u.isBot,position:MB[c],hand:Ok(a.slice(c*13,(c+1)*13),r),bid:null,tricks:0,isReady:!0})),o=[{id:\"team-1\",players:[s[0].id,s[2].id],score:0,bags:0,totalBid:null,tricksWon:0},{id:\"team-2\",players:[s[1].id,s[3].id],score:0,bags:0,totalBid:null,tricksWon:0}];return{id:(0,Ik.randomUUID)(),mode:r,pointGoal:n,phase:\"bidding\",players:s,teams:o,currentTrick:{cards:[],leadSuit:null,winnerId:null},currentPlayerIndex:0,dealerIndex:0,roundNumber:1,spadesBroken:!1,winningScore:pm[n]}}static getPlayableCards(e,r){let n=e.players[r];if(!n)return[];let i=n.hand,a=e.currentTrick.leadSuit;if(!a){if(!e.spadesBroken){let o=i.filter(u=>!ou(u,e.mode));if(o.length>0)return o}return i}let s=i.filter(o=>o.suit===a);return s.length>0?s:i}static placeBid(e,r,n){let i=e.players.findIndex(c=>c.id===r);if(i===-1)throw new Error(\"Player not found\");if(e.phase!==\"bidding\")throw new Error(\"Not in bidding phase\");if(i!==e.currentPlayerIndex)throw new Error(\"Not your turn\");let a=e.players.map((c,l)=>l===i?{...c,bid:n}:c),s=a.every(c=>c.bid!==null),o=e.teams,u=e.phase;return s&&(o=e.teams.map(c=>{let l=c.players.reduce((p,d)=>{let f=a.find(h=>h.id===d);return p+(f?.bid||0)},0);return{...c,totalBid:l}}),u=\"playing\"),{...e,players:a,teams:o,phase:u,currentPlayerIndex:s?0:(e.currentPlayerIndex+1)%4}}static playCard(e,r,n){let i=e.players.findIndex(d=>d.id===r);if(i===-1)throw new Error(\"Player not found\");if(e.phase!==\"playing\")throw new Error(\"Not in playing phase\");if(i!==e.currentPlayerIndex)throw new Error(\"Not your turn\");let s=e.players[i].hand.find(d=>d.id===n);if(!s)throw new Error(\"Card not in hand\");if(!this.getPlayableCards(e,i).some(d=>d.id===n))throw new Error(\"Card is not playable\");let u=e.players.map((d,f)=>f===i?{...d,hand:d.hand.filter(h=>h.id!==n)}:d),c=[...e.currentTrick.cards,{playerId:r,card:s}],l=e.currentTrick.leadSuit||s.suit,p=e.spadesBroken;return ou(s,e.mode)&&(p=!0),c.length===4?this.completeTrick(e,u,c,l,p):{...e,players:u,currentTrick:{cards:c,leadSuit:l,winnerId:null},currentPlayerIndex:(e.currentPlayerIndex+1)%4,spadesBroken:p}}static completeTrick(e,r,n,i,a){let s=0,o=0;n.forEach(({card:f},h)=>{let m=wr(f,e.mode,i);m>o&&(o=m,s=h)});let u=n[s].playerId,c=r.findIndex(f=>f.id===u),l=r.map(f=>f.id===u?{...f,tricks:f.tricks+1}:f),p=e.teams.map(f=>f.players.includes(u)?{...f,tricksWon:f.tricksWon+1}:f);return l.reduce((f,h)=>f+h.hand.length,0)===0?this.completeRound(e,l,p,u,c):{...e,players:l,teams:p,currentTrick:{cards:n,leadSuit:i,winnerId:u},currentPlayerIndex:c,spadesBroken:a}}static completeRound(e,r,n,i,a){let s=n.map(p=>{let d=p.totalBid||0,f=p.tricksWon,h=0,m=p.bags,x=p.players.map(E=>r.find(R=>R.id===E)),w=0;x.forEach(E=>{E.bid===0&&(E.tricks===0?w+=100:(w-=100,m+=E.tricks))});let C=x.reduce((E,R)=>E+(R.bid===0?0:R.bid||0),0),_=f-x.reduce((E,R)=>E+(R.bid===0?R.tricks:0),0);if(C>0)if(_>=C){let E=_-C;h=C*10+E,m+=E}else h=-C*10;return m>=10&&(h-=100,m=m%10),h+=w,{...p,score:p.score+h,bags:m,tricksWon:0,totalBid:null}});if(s.findIndex(p=>p.score>=e.winningScore)!==-1)return{...e,players:r.map(p=>({...p,bid:null,tricks:0})),teams:s,currentTrick:{cards:[],leadSuit:null,winnerId:i},phase:\"game_over\",currentPlayerIndex:a};let u=e.mode===\"ace_high\"?ev():Ak(),c=Pk(u),l=r.map((p,d)=>({...p,hand:Ok(c.slice(d*13,(d+1)*13),e.mode),bid:null,tricks:0}));return{...e,players:l,teams:s,currentTrick:{cards:[],leadSuit:null,winnerId:null},phase:\"bidding\",currentPlayerIndex:(e.dealerIndex+1)%4,dealerIndex:(e.dealerIndex+1)%4,roundNumber:e.roundNumber+1,spadesBroken:!1}}static clearTrick(e){return{...e,currentTrick:{cards:[],leadSuit:null,winnerId:null}}}};var uo=class{static calculateBid(e,r){let n=0;e.forEach(a=>{a.value===\"A\"&&(n+=1),a.value===\"K\"&&(n+=.5),a.value===\"Q\"&&(n+=.25),a.suit===\"spades\"&&(n+=.5),a.value===\"BJ\"&&(n+=2),a.value===\"LJ\"&&(n+=1.5),a.suit===\"spades\"&&a.value===\"2\"&&r===\"joker_joker_deuce_deuce\"&&(n+=1.5)});let i=e.filter(a=>a.suit===\"spades\"||a.value===\"LJ\"||a.value===\"BJ\").length;return n+=Math.max(0,i-2)*.5,n+=Math.random()-.5,Math.max(1,Math.min(6,Math.round(n)))}static selectCard(e,r){let i=e.players[r].hand,a=Mt.getPlayableCards(e,r);if(a.length===1)return a[0];let s=e.currentTrick,o=s.leadSuit,u=!o,c=e.players[(r+2)%4],l=s.cards.find(m=>m.playerId===c.id),p=[...a].sort((m,x)=>wr(m,e.mode,o)-wr(x,e.mode,o));if(u){let m={spades:0,hearts:0,diamonds:0,clubs:0};i.forEach(w=>{w.suit in m&&m[w.suit]++});let x=[\"hearts\",\"diamonds\",\"clubs\"].filter(w=>m[w]>0);if(x.length>0){let w=x.reduce((_,E)=>m[_]>=m[E]?_:E),C=a.filter(_=>_.suit===w);if(C.length>0){let _=C.filter(E=>[\"A\",\"K\",\"Q\"].includes(E.value));return _.length>0?_[0]:C[Math.floor(C.length/2)]}}return p[Math.floor(p.length/2)]}let d=s.cards.reduce((m,{card:x})=>Math.max(m,wr(x,e.mode,o)),0),f=!1;l&&(f=wr(l.card,e.mode,o)>=d);let h=p.filter(m=>wr(m,e.mode,o)>d);return f&&s.cards.length===3?p[0]:h.length>0?h[0]:p[0]}static shouldBreakSpades(e,r){return e.filter(i=>i.suit===\"spades\"||i.value===\"LJ\"||i.value===\"BJ\").length>=5}};var Lu=class{wss;clients=new Map;gameRooms=new Map;constructor(e){this.wss=new Yh.default({server:e,path:\"/ws\"}),this.setupConnectionHandler()}setupConnectionHandler(){this.wss.on(\"connection\",e=>{let r=`player-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,n={ws:e,playerId:r,gameId:null,lobbyId:null};this.clients.set(e,n),this.sendMessage(e,{type:\"player_joined\",payload:{playerId:r}}),e.on(\"message\",i=>{try{let a=JSON.parse(i.toString());this.handleMessage(e,a)}catch{this.sendError(e,\"Invalid message format\")}}),e.on(\"close\",()=>{this.handleDisconnect(e)}),e.on(\"error\",i=>{console.error(\"WebSocket error:\",i)})})}handleMessage(e,r){if(this.clients.get(e))switch(r.type){case\"start_game\":this.handleStartGame(e,r.payload);break;case\"place_bid\":this.handleBid(e,r.payload);break;case\"play_card\":this.handlePlayCard(e,r.payload);break;case\"leave_lobby\":this.handleLeaveLobby(e);break}}handleStartGame(e,r){let n=this.clients.get(e);if(!n)return;let{mode:i,pointGoal:a,players:s}=r;try{let o=s.map((d,f)=>f===0&&!d.isBot?{...d,id:n.playerId}:d),u=Mt.createGame(o,i,a),l=o.filter(d=>!d.isBot&&d.userId).length>=2,p={gameState:u,clients:new Map,botTimer:null,statsSaved:!1,isRanked:l};p.clients.set(n.playerId,n),n.gameId=u.id,this.gameRooms.set(u.id,p),this.broadcastGameState(u.id),this.scheduleBotMove(u.id)}catch(o){this.sendError(e,o.message)}}handleBid(e,r){let n=this.clients.get(e);if(!n||!n.gameId)return;let i=this.gameRooms.get(n.gameId);if(i)try{i.gameState=Mt.placeBid(i.gameState,n.playerId,r.bid),this.broadcastGameState(n.gameId),this.scheduleBotMove(n.gameId)}catch(a){this.sendError(e,a.message)}}handlePlayCard(e,r){let n=this.clients.get(e);if(!n||!n.gameId)return;let i=this.gameRooms.get(n.gameId);if(i)try{i.gameState=Mt.playCard(i.gameState,n.playerId,r.cardId),this.broadcastGameState(n.gameId),i.gameState.currentTrick.cards.length===4?setTimeout(()=>{let a=this.gameRooms.get(n.gameId);a&&a.gameState.currentTrick.cards.length===4&&(a.gameState=Mt.clearTrick(a.gameState),this.broadcastGameState(n.gameId),this.scheduleBotMove(n.gameId))},1500):this.scheduleBotMove(n.gameId)}catch(a){this.sendError(e,a.message)}}handleLeaveLobby(e){let r=this.clients.get(e);if(r&&r.gameId){let n=this.gameRooms.get(r.gameId);n&&(n.clients.delete(r.playerId),n.clients.size===0&&(n.botTimer&&clearTimeout(n.botTimer),this.gameRooms.delete(r.gameId))),r.gameId=null}}handleDisconnect(e){this.clients.get(e)&&(this.handleLeaveLobby(e),this.clients.delete(e))}scheduleBotMove(e){let r=this.gameRooms.get(e);if(!r)return;let{gameState:n}=r,i=n.players[n.currentPlayerIndex];if(!i||!i.isBot||n.phase!==\"bidding\"&&n.phase!==\"playing\")return;r.botTimer&&clearTimeout(r.botTimer);let a=800+Math.random()*700;r.botTimer=setTimeout(()=>{let s=this.gameRooms.get(e);if(!s)return;let{gameState:o}=s,u=o.players[o.currentPlayerIndex];if(!(!u||!u.isBot))try{if(o.phase===\"bidding\"){let c=uo.calculateBid(u.hand,o.mode);s.gameState=Mt.placeBid(o,u.id,c)}else if(o.phase===\"playing\"){let c=uo.selectCard(o,o.currentPlayerIndex);s.gameState=Mt.playCard(o,u.id,c.id)}this.broadcastGameState(e),s.gameState.currentTrick.cards.length===4?setTimeout(()=>{let c=this.gameRooms.get(e);c&&c.gameState.currentTrick.cards.length===4&&(c.gameState=Mt.clearTrick(c.gameState),this.broadcastGameState(e),this.scheduleBotMove(e))},1500):this.scheduleBotMove(e)}catch(c){console.error(\"Bot move error:\",c)}},a)}broadcastGameState(e){let r=this.gameRooms.get(e);r&&(r.clients.forEach(n=>{let i=this.sanitizeGameState(r.gameState,n.playerId);this.sendMessage(n.ws,{type:\"game_state_update\",payload:i})}),r.gameState.phase===\"game_over\"&&!r.statsSaved&&r.isRanked&&(r.statsSaved=!0,this.saveGameStats(r.gameState)))}async saveGameStats(e){try{let r=e.teams.findIndex(s=>s.score>=e.winningScore);if(r===-1)return;let n=e.teams[r],i=e.teams[r===0?1:0],a=[];for(let s of e.players){let o=n.players.includes(s.id),u=n.players.includes(s.id)?r:r===0?1:0,c=o?25:-20;a.push({userId:null,isBot:s.isBot,teamIndex:u,ratingChange:s.isBot?0:c})}await Ee.recordMatch(e.mode,e.pointGoal,n.score,i.score,a),console.log(`Game ${e.id} stats saved - Winner: Team ${r+1}`)}catch(r){console.error(\"Failed to save game stats:\",r)}}sanitizeGameState(e,r){let n=e.players.map(i=>i.id===r?i:{...i,hand:i.hand.map(()=>({suit:\"spades\",value:\"?\",id:\"hidden\"}))});return{...e,players:n}}sendMessage(e,r){e.readyState===Xh.default.OPEN&&e.send(JSON.stringify(r))}sendError(e,r){this.sendMessage(e,{type:\"error\",payload:{message:r}})}};var tv=class{queue=new Map;matchingInterval=null;onMatchFound=null;start(e){this.onMatchFound=e,this.matchingInterval=setInterval(()=>this.tryMatch(),5e3)}stop(){this.matchingInterval&&(clearInterval(this.matchingInterval),this.matchingInterval=null)}addToQueue(e,r,n){let i={id:e.id,username:e.username,rating:e.rating,queuedAt:Date.now(),gameMode:r,pointGoal:n};this.queue.set(e.id,i)}removeFromQueue(e){this.queue.delete(e)}getQueueSize(){return this.queue.size}tryMatch(){let e=Array.from(this.queue.values()),r=new Map;for(let n of e){let i=`${n.gameMode}-${n.pointGoal}`;r.has(i)||r.set(i,[]),r.get(i).push(n)}for(let[,n]of Array.from(r.entries()))if(n.length>=4){let i=this.selectBestMatch(n);if(i&&this.onMatchFound){for(let a of i.players)this.queue.delete(a.id);this.onMatchFound(i)}}}selectBestMatch(e){if(e.length<4)return null;e.sort((a,s)=>a.rating-s.rating);let r=e.filter(a=>Date.now()-a.queuedAt>6e4),n;if(r.length>=4)n=r.slice(0,4);else{let a=this.groupByRatingTier(e),s=null;for(let o of a)o.length>=4&&(!s||o.length>s.length)&&(s=o);s?n=s.slice(0,4):n=e.slice(0,4)}let i=this.balanceTeams(n);return{players:n,teams:i,gameMode:n[0].gameMode,pointGoal:n[0].pointGoal}}groupByRatingTier(e){let r=[];for(let a of e){let s=Math.floor(a.rating/300);for(;r.length<=s;)r.push([]);r[s].push(a)}let i=[];for(let a=0;a<r.length;a++){let s=[...r[a]];a>0&&s.push(...r[a-1]),a<r.length-1&&s.push(...r[a+1]),s.length>=4&&i.push(s)}return i}balanceTeams(e){let r=[...e].sort((a,s)=>s.rating-a.rating),n=[r[0],r[3]],i=[r[1],r[2]];return[n,i]}fillWithBots(e){let r=[\"SpadeMaster\",\"TrickTaker\",\"CardShark\",\"AceHunter\"],n=new Set(e.map(o=>o.username)),i=e.length>0?Math.round(e.reduce((o,u)=>o+u.rating,0)/e.length):1e3,a=[...e],s=0;for(;a.length<4;){let o=r[s%r.length];for(;n.has(o);)s++,o=`Bot${s}`;n.add(o),a.push({id:-1*(s+1),username:o,rating:i+Math.floor(Math.random()*200)-100,queuedAt:Date.now(),gameMode:e[0]?.gameMode||\"ace_high\",pointGoal:e[0]?.pointGoal||\"300\"}),s++}return a}},lo=new tv;var LB={from:process.env.EMAIL_FROM||\"noreply@housespades.com\",apiKey:process.env.EMAIL_API_KEY,domain:process.env.EMAIL_DOMAIN};async function BB(t){let{to:e,subject:r,text:n,html:i}=t;if(!LB.apiKey)return console.log(\"=== Email would be sent (DEV MODE) ===\"),console.log(`To: ${e}`),console.log(`Subject: ${r}`),console.log(`Body: ${n}`),console.log(\"======================================\"),console.log(\"Configure EMAIL_API_KEY to enable real email sending\"),{success:!0,devMode:!0};try{return console.log(`Email sent to ${e}: ${r}`),{success:!0,devMode:!1}}catch(a){return console.error(\"Failed to send email:\",a),{success:!1,devMode:!1}}}async function Nk(t,e,r){let n=`${r}/reset-password?token=${e}`,i=await BB({to:t,subject:\"Reset Your House Spades Password\",text:`","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:16.729649909Z"}
{"message":"\t\t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:16.729664292Z"}
{"message":"","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:16.733907635Z"}
{"message":"Error: DATABASE_URL must be set. Did you forget to provision a database?","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:16.733921663Z"}
{"message":"    at Object.<anonymous> (/app/dist/index.cjs:100:43241)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:16.733930601Z"}
{"message":"    at Module._compile (node:internal/modules/cjs/loader:1706:14)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:16.733938564Z"}
{"message":"    at Object..js (node:internal/modules/cjs/loader:1839:10)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:16.733946337Z"}
{"message":"    at Module.load (node:internal/modules/cjs/loader:1441:32)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:16.733954263Z"}
{"message":"    at Function._load (node:internal/modules/cjs/loader:1263:12)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:16.733962135Z"}
{"message":"    at TracingChannel.traceSync (node:diagnostics_channel:328:14)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:16.733970251Z"}
{"message":"    at wrapModuleLoad (node:internal/modules/cjs/loader:237:24)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:16.733978328Z"}
{"message":"    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:171:5)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:16.733986541Z"}
{"message":"    at node:internal/main/run_main_module:36:49","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:16.733993979Z"}
{"message":"","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:16.734001940Z"}
{"message":"Node.js v22.21.1","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:16.734009742Z"}
{"message":"npm warn config production Use `--omit=dev` instead.","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:18.533949900Z"}
{"message":"","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:18.534278335Z"}
{"message":"> rest-express@1.0.0 start","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:18.534291755Z"}
{"message":"> NODE_ENV=production node dist/index.cjs","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:18.534304173Z"}
{"message":"","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:18.534320540Z"}
{"message":"/app/dist/index.cjs:100","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:18.534328498Z"}
{"message":"\t\t`;await r.execute(y`CREATE SCHEMA IF NOT EXISTS ${y.identifier(a)}`),await r.execute(s);let u=(await r.all(y`select id, hash, created_at from ${y.identifier(a)}.${y.identifier(i)} order by created_at desc limit 1`))[0];await r.transaction(async c=>{for await(let l of e)if(!u||Number(u.created_at)<l.folderMillis){for(let p of l.sql)await c.execute(y.raw(p));await c.execute(y`insert into ${y.identifier(a)}.${y.identifier(i)} (\"hash\", \"created_at\") values(${l.hash}, ${l.folderMillis})`)}})}escapeName(e){return`\"${e}\"`}escapeParam(e){return`$${e+1}`}escapeString(e){return`'${e.replace(/'/g,\"''\")}'`}buildWithCTE(e){if(!e?.length)return;let r=[y`with `];for(let[n,i]of e.entries())r.push(y`${y.identifier(i._.alias)} as (${i._.sql})`),n<e.length-1&&r.push(y`, `);return r.push(y` `),y.join(r)}buildDeleteQuery({table:e,where:r,returning:n,withList:i}){let a=this.buildWithCTE(i),s=n?y` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,o=r?y` where ${r}`:void 0;return y`${a}delete from ${e}${o}${s}`}buildUpdateSet(e,r){let n=e[P.Symbol.Columns],i=Object.keys(n).filter(s=>r[s]!==void 0||n[s]?.onUpdateFn!==void 0),a=i.length;return y.join(i.flatMap((s,o)=>{let u=n[s],c=r[s]??y.param(u.onUpdateFn(),u),l=y`${y.identifier(this.casing.getColumnCasing(u))} = ${c}`;return o<a-1?[l,y.raw(\", \")]:[l]}))}buildUpdateQuery({table:e,set:r,where:n,returning:i,withList:a,from:s,joins:o}){let u=this.buildWithCTE(a),c=e[Be.Symbol.Name],l=e[Be.Symbol.Schema],p=e[Be.Symbol.OriginalName],d=c===p?void 0:c,f=y`${l?y`${y.identifier(l)}.`:void 0}${y.identifier(p)}${d&&y` ${y.identifier(d)}`}`,h=this.buildUpdateSet(e,r),m=s&&y.join([y.raw(\" from \"),this.buildFromTable(s)]),x=this.buildJoins(o),w=i?y` returning ${this.buildSelection(i,{isSingleTable:!s})}`:void 0,C=n?y` where ${n}`:void 0;return y`${u}update ${f} set ${h}${m}${x}${C}${w}`}buildSelection(e,{isSingleTable:r=!1}={}){let n=e.length,i=e.flatMap(({field:a},s)=>{let o=[];if(b(a,N.Aliased)&&a.isSelectionField)o.push(y.identifier(a.fieldAlias));else if(b(a,N.Aliased)||b(a,N)){let u=b(a,N.Aliased)?a.sql:a;r?o.push(new N(u.queryChunks.map(c=>b(c,T)?y.identifier(this.casing.getColumnCasing(c)):c))):o.push(u),b(a,N.Aliased)&&o.push(y` as ${y.identifier(a.fieldAlias)}`)}else b(a,K)&&(r?o.push(y.identifier(this.casing.getColumnCasing(a))):o.push(a));return s<n-1&&o.push(y`, `),o});return y.join(i)}buildJoins(e){if(!e||e.length===0)return;let r=[];for(let[n,i]of e.entries()){n===0&&r.push(y` `);let a=i.table,s=i.lateral?y` lateral`:void 0;if(b(a,Be)){let o=a[Be.Symbol.Name],u=a[Be.Symbol.Schema],c=a[Be.Symbol.OriginalName],l=o===c?void 0:i.alias;r.push(y`${y.raw(i.joinType)} join${s} ${u?y`${y.identifier(u)}.`:void 0}${y.identifier(c)}${l&&y` ${y.identifier(l)}`} on ${i.on}`)}else if(b(a,et)){let o=a[se].name,u=a[se].schema,c=a[se].originalName,l=o===c?void 0:i.alias;r.push(y`${y.raw(i.joinType)} join${s} ${u?y`${y.identifier(u)}.`:void 0}${y.identifier(c)}${l&&y` ${y.identifier(l)}`} on ${i.on}`)}else r.push(y`${y.raw(i.joinType)} join${s} ${a} on ${i.on}`);n<e.length-1&&r.push(y` `)}return y.join(r)}buildFromTable(e){if(b(e,P)&&e[P.Symbol.OriginalName]!==e[P.Symbol.Name]){let r=y`${y.identifier(e[P.Symbol.OriginalName])}`;return e[P.Symbol.Schema]&&(r=y`${y.identifier(e[P.Symbol.Schema])}.${r}`),y`${r} ${y.identifier(e[P.Symbol.Name])}`}return e}buildSelectQuery({withList:e,fields:r,fieldsFlat:n,where:i,having:a,table:s,joins:o,orderBy:u,groupBy:c,limit:l,offset:p,lockingClause:d,distinct:f,setOperators:h}){let m=n??Ot(r);for(let le of m)if(b(le.field,K)&&ut(le.field.table)!==(b(s,Te)?s._.alias:b(s,$i)?s[se].name:b(s,N)?void 0:ut(s))&&!(xe=>o?.some(({alias:mt})=>mt===(xe[P.Symbol.IsAlias]?ut(xe):xe[P.Symbol.BaseName])))(le.field.table)){let xe=ut(le.field.table);throw new Error(`Your \"${le.path.join(\"->\")}\" field references a column \"${xe}\".\"${le.field.name}\", but the table \"${xe}\" is not part of the query! Did you forget to join it?`)}let x=!o||o.length===0,w=this.buildWithCTE(e),C;f&&(C=f===!0?y` distinct`:y` distinct on (${y.join(f.on,y`, `)})`);let _=this.buildSelection(m,{isSingleTable:x}),E=this.buildFromTable(s),R=this.buildJoins(o),M=i?y` where ${i}`:void 0,I=a?y` having ${a}`:void 0,D;u&&u.length>0&&(D=y` order by ${y.join(u,y`, `)}`);let Q;c&&c.length>0&&(Q=y` group by ${y.join(c,y`, `)}`);let ke=typeof l==\"object\"||typeof l==\"number\"&&l>=0?y` limit ${l}`:void 0,rt=p?y` offset ${p}`:void 0,$e=y.empty();if(d){let le=y` for ${y.raw(d.strength)}`;d.config.of&&le.append(y` of ${y.join(Array.isArray(d.config.of)?d.config.of:[d.config.of],y`, `)}`),d.config.noWait?le.append(y` no wait`):d.config.skipLocked&&le.append(y` skip locked`),$e.append(le)}let ye=y`${w}select${C} ${_} from ${E}${R}${M}${Q}${I}${D}${ke}${rt}${$e}`;return h.length>0?this.buildSetOperations(ye,h):ye}buildSetOperations(e,r){let[n,...i]=r;if(!n)throw new Error(\"Cannot pass undefined values to any set operator\");return i.length===0?this.buildSetOperationQuery({leftSelect:e,setOperator:n}):this.buildSetOperations(this.buildSetOperationQuery({leftSelect:e,setOperator:n}),i)}buildSetOperationQuery({leftSelect:e,setOperator:{type:r,isAll:n,rightSelect:i,limit:a,orderBy:s,offset:o}}){let u=y`(${e.getSQL()}) `,c=y`(${i.getSQL()})`,l;if(s&&s.length>0){let h=[];for(let m of s)if(b(m,T))h.push(y.identifier(m.name));else if(b(m,N)){for(let x=0;x<m.queryChunks.length;x++){let w=m.queryChunks[x];b(w,T)&&(m.queryChunks[x]=y.identifier(w.name))}h.push(y`${m}`)}else h.push(y`${m}`);l=y` order by ${y.join(h,y`, `)} `}let p=typeof a==\"object\"||typeof a==\"number\"&&a>=0?y` limit ${a}`:void 0,d=y.raw(`${r} ${n?\"all \":\"\"}`),f=o?y` offset ${o}`:void 0;return y`${u}${d}${c}${l}${p}${f}`}buildInsertQuery({table:e,values:r,onConflict:n,returning:i,withList:a,select:s,overridingSystemValue_:o}){let u=[],c=e[P.Symbol.Columns],l=Object.entries(c).filter(([w,C])=>!C.shouldDisableInsert()),p=l.map(([,w])=>y.identifier(this.casing.getColumnCasing(w)));if(s){let w=r;b(w,N)?u.push(w):u.push(w.getSQL())}else{let w=r;u.push(y.raw(\"values \"));for(let[C,_]of w.entries()){let E=[];for(let[R,M]of l){let I=_[R];if(I===void 0||b(I,lt)&&I.value===void 0)if(M.defaultFn!==void 0){let D=M.defaultFn(),Q=b(D,N)?D:y.param(D,M);E.push(Q)}else if(!M.default&&M.onUpdateFn!==void 0){let D=M.onUpdateFn(),Q=b(D,N)?D:y.param(D,M);E.push(Q)}else E.push(y`default`);else E.push(I)}u.push(E),C<w.length-1&&u.push(y`, `)}}let d=this.buildWithCTE(a),f=y.join(u),h=i?y` returning ${this.buildSelection(i,{isSingleTable:!0})}`:void 0,m=n?y` on conflict ${n}`:void 0,x=o===!0?y`overriding system value `:void 0;return y`${d}insert into ${e} ${p} ${x}${f}${m}${h}`}buildRefreshMaterializedViewQuery({view:e,concurrently:r,withNoData:n}){let i=r?y` concurrently`:void 0,a=n?y` with no data`:void 0;return y`refresh materialized view${i} ${e}${a}`}prepareTyping(e){return b(e,Os)||b(e,Ps)?\"json\":b(e,Is)?\"decimal\":b(e,Ns)?\"time\":b(e,qs)||b(e,js)?\"timestamp\":b(e,Ts)||b(e,As)?\"date\":b(e,Rs)?\"uuid\":\"none\"}sqlToQuery(e,r){return e.toQuery({casing:this.casing,escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString,prepareTyping:this.prepareTyping,invokeSource:r})}buildRelationalQueryWithoutPK({fullSchema:e,schema:r,tableNamesMap:n,table:i,tableConfig:a,queryConfig:s,tableAlias:o,nestedQueryRelation:u,joinOn:c}){let l=[],p,d,f=[],h,m=[];if(s===!0)l=Object.entries(a.columns).map(([C,_])=>({dbKey:_.name,tsKey:C,field:nr(_,o),relationTableTsKey:void 0,isJson:!1,selection:[]}));else{let w=Object.fromEntries(Object.entries(a.columns).map(([I,D])=>[I,nr(D,o)]));if(s.where){let I=typeof s.where==\"function\"?s.where(w,YS()):s.where;h=I&&Es(I,o)}let C=[],_=[];if(s.columns){let I=!1;for(let[D,Q]of Object.entries(s.columns))Q!==void 0&&D in a.columns&&(!I&&Q===!0&&(I=!0),_.push(D));_.length>0&&(_=I?_.filter(D=>s.columns?.[D]===!0):Object.keys(a.columns).filter(D=>!_.includes(D)))}else _=Object.keys(a.columns);for(let I of _){let D=a.columns[I];C.push({tsKey:I,value:D})}let E=[];s.with&&(E=Object.entries(s.with).filter(I=>!!I[1]).map(([I,D])=>({tsKey:I,queryConfig:D,relation:a.relations[I]})));let R;if(s.extras){R=typeof s.extras==\"function\"?s.extras(w,{sql:y}):s.extras;for(let[I,D]of Object.entries(R))C.push({tsKey:I,value:Bd(D,o)})}for(let{tsKey:I,value:D}of C)l.push({dbKey:b(D,N.Aliased)?D.fieldAlias:a.columns[I].name,tsKey:I,field:b(D,K)?nr(D,o):D,relationTableTsKey:void 0,isJson:!1,selection:[]});let M=typeof s.orderBy==\"function\"?s.orderBy(w,eE()):s.orderBy??[];Array.isArray(M)||(M=[M]),f=M.map(I=>b(I,K)?nr(I,o):Es(I,o)),p=s.limit,d=s.offset;for(let{tsKey:I,queryConfig:D,relation:Q}of E){let ke=rE(r,n,Q),rt=Rn(Q.referencedTable),$e=n[rt],ye=`${o}_${I}`,le=Bs(...ke.fields.map((Yr,oa)=>It(nr(ke.references[oa],ye),nr(Yr,o)))),xe=this.buildRelationalQueryWithoutPK({fullSchema:e,schema:r,tableNamesMap:n,table:e[$e],tableConfig:r[$e],queryConfig:b(Q,$r)?D===!0?{limit:1}:{...D,limit:1}:D,tableAlias:ye,joinOn:le,nestedQueryRelation:Q}),mt=y`${y.identifier(ye)}.${y.identifier(\"data\")}`.as(I);m.push({on:y`true`,table:new Te(xe.sql,{},ye),alias:ye,joinType:\"left\",lateral:!0}),l.push({dbKey:I,tsKey:I,field:mt,relationTableTsKey:$e,isJson:!0,selection:xe.selection})}}if(l.length===0)throw new Ms({message:`No fields selected for table \"${a.tsName}\" (\"${o}\")`});let x;if(h=Bs(c,h),u){let w=y`json_build_array(${y.join(l.map(({field:E,tsKey:R,isJson:M})=>M?y`${y.identifier(`${o}_${R}`)}.${y.identifier(\"data\")}`:b(E,N.Aliased)?E.sql:E),y`, `)})`;b(u,Fs)&&(w=y`coalesce(json_agg(${w}${f.length>0?y` order by ${y.join(f,y`, `)}`:void 0}), '[]'::json)`);let C=[{dbKey:\"data\",tsKey:\"data\",field:w.as(\"data\"),isJson:!0,relationTableTsKey:a.tsName,selection:l}];p!==void 0||d!==void 0||f.length>0?(x=this.buildSelectQuery({table:Ss(i,o),fields:{},fieldsFlat:[{path:[],field:y.raw(\"*\")}],where:h,limit:p,offset:d,orderBy:f,setOperators:[]}),h=void 0,p=void 0,d=void 0,f=[]):x=Ss(i,o),x=this.buildSelectQuery({table:b(x,Be)?x:new Te(x,{},o),fields:{},fieldsFlat:C.map(({field:E})=>({path:[],field:b(E,K)?nr(E,o):E})),joins:m,where:h,limit:p,offset:d,orderBy:f,setOperators:[]})}else x=this.buildSelectQuery({table:Ss(i,o),fields:{},fieldsFlat:l.map(({field:w})=>({path:[],field:b(w,K)?nr(w,o):w})),joins:m,where:h,limit:p,offset:d,orderBy:f,setOperators:[]});return{tableTsKey:a.tsName,sql:x,selection:l}}};var Wc=class{static[g]=\"TypedQueryBuilder\";getSelectedFields(){return this._.selectedFields}};var Ve=class{static[g]=\"PgSelectBuilder\";fields;session;dialect;withList=[];distinct;constructor(e){this.fields=e.fields,this.session=e.session,this.dialect=e.dialect,e.withList&&(this.withList=e.withList),this.distinct=e.distinct}authToken;setToken(e){return this.authToken=e,this}from(e){let r=!!this.fields,n=e,i;return this.fields?i=this.fields:b(n,Te)?i=Object.fromEntries(Object.keys(n._.selectedFields).map(a=>[a,n[a]])):b(n,$i)?i=n[se].selectedFields:b(n,N)?i={}:i=Fc(n),new Kc({table:n,fields:i,isPartialSelect:r,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct}).setToken(this.authToken)}},am=class extends Wc{static[g]=\"PgSelectQueryBuilder\";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;constructor({table:e,fields:r,isPartialSelect:n,session:i,dialect:a,withList:s,distinct:o}){super(),this.config={withList:s,table:e,fields:{...r},distinct:o,setOperators:[]},this.isPartialSelect=n,this.session=i,this.dialect=a,this._={selectedFields:r},this.tableName=yr(e),this.joinsNotNullableMap=typeof this.tableName==\"string\"?{[this.tableName]:!0}:{}}createJoin(e){return(r,n)=>{let i=this.tableName,a=yr(r);if(typeof a==\"string\"&&this.config.joins?.some(s=>s.alias===a))throw new Error(`Alias \"${a}\" is already used in this query`);if(!this.isPartialSelect&&(Object.keys(this.joinsNotNullableMap).length===1&&typeof i==\"string\"&&(this.config.fields={[i]:this.config.fields}),typeof a==\"string\"&&!b(r,N))){let s=b(r,Te)?r._.selectedFields:b(r,et)?r[se].selectedFields:r[P.Symbol.Columns];this.config.fields[a]=s}if(typeof n==\"function\"&&(n=n(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.joins||(this.config.joins=[]),this.config.joins.push({on:n,table:r,joinType:e,alias:a}),typeof a==\"string\")switch(e){case\"left\":{this.joinsNotNullableMap[a]=!1;break}case\"right\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([s])=>[s,!1])),this.joinsNotNullableMap[a]=!0;break}case\"inner\":{this.joinsNotNullableMap[a]=!0;break}case\"full\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([s])=>[s,!1])),this.joinsNotNullableMap[a]=!1;break}}return this}}leftJoin=this.createJoin(\"left\");rightJoin=this.createJoin(\"right\");innerJoin=this.createJoin(\"inner\");fullJoin=this.createJoin(\"full\");createSetOperator(e,r){return n=>{let i=typeof n==\"function\"?n(Tj()):n;if(!ks(this.getSelectedFields(),i.getSelectedFields()))throw new Error(\"Set operator error (union / intersect / except): selected fields are not the same or are in a different order\");return this.config.setOperators.push({type:e,isAll:r,rightSelect:i}),this}}union=this.createSetOperator(\"union\",!1);unionAll=this.createSetOperator(\"union\",!0);intersect=this.createSetOperator(\"intersect\",!1);intersectAll=this.createSetOperator(\"intersect\",!0);except=this.createSetOperator(\"except\",!1);exceptAll=this.createSetOperator(\"except\",!0);addSetOperators(e){return this.config.setOperators.push(...e),this}where(e){return typeof e==\"function\"&&(e=e(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.where=e,this}having(e){return typeof e==\"function\"&&(e=e(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.having=e,this}groupBy(...e){if(typeof e[0]==\"function\"){let r=e[0](new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"alias\",sqlBehavior:\"sql\"})));this.config.groupBy=Array.isArray(r)?r:[r]}else this.config.groupBy=e;return this}orderBy(...e){if(typeof e[0]==\"function\"){let r=e[0](new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"alias\",sqlBehavior:\"sql\"}))),n=Array.isArray(r)?r:[r];this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=n:this.config.orderBy=n}else{let r=e;this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=r:this.config.orderBy=r}return this}limit(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).limit=e:this.config.limit=e,this}offset(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).offset=e:this.config.offset=e,this}for(e,r={}){return this.config.lockingClause={strength:e,config:r},this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}as(e){return new Proxy(new Te(this.getSQL(),this.config.fields,e),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"}))}getSelectedFields(){return new Proxy(this.config.fields,new _e({alias:this.tableName,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"}))}$dynamic(){return this}},Kc=class extends am{static[g]=\"PgSelect\";_prepare(e){let{session:r,config:n,dialect:i,joinsNotNullableMap:a,authToken:s}=this;if(!r)throw new Error(\"Cannot execute a query on a query builder. Please use a database instance instead.\");return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>{let o=Ot(n.fields),u=r.prepareQuery(i.sqlToQuery(this.getSQL()),o,e,!0);return u.joinsNotNullableMap=a,u.setToken(s)})}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken))};Y_(Kc,[Ge]);function Ui(t,e){return(r,n,...i)=>{let a=[n,...i].map(s=>({type:t,isAll:e,rightSelect:s}));for(let s of a)if(!ks(r.getSelectedFields(),s.rightSelect.getSelectedFields()))throw new Error(\"Set operator error (union / intersect / except): selected fields are not the same or are in a different order\");return r.addSetOperators(a)}}var Tj=()=>({union:Aj,unionAll:Pj,intersect:Oj,intersectAll:Ij,except:Nj,exceptAll:qj}),Aj=Ui(\"union\",!1),Pj=Ui(\"union\",!0),Oj=Ui(\"intersect\",!1),Ij=Ui(\"intersect\",!0),Nj=Ui(\"except\",!1),qj=Ui(\"except\",!0);var Qi=class{static[g]=\"PgQueryBuilder\";dialect;dialectConfig;constructor(e){this.dialect=b(e,Ur)?e:void 0,this.dialectConfig=b(e,Ur)?void 0:e}$with=(e,r)=>{let n=this;return{as:a=>(typeof a==\"function\"&&(a=a(n)),new Proxy(new Bi(a.getSQL(),r??(\"getSelectedFields\"in a?a.getSelectedFields()??{}:{}),e,!0),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})))}};with(...e){let r=this;function n(s){return new Ve({fields:s??void 0,session:void 0,dialect:r.getDialect(),withList:e})}function i(s){return new Ve({fields:s??void 0,session:void 0,dialect:r.getDialect(),distinct:!0})}function a(s,o){return new Ve({fields:o??void 0,session:void 0,dialect:r.getDialect(),distinct:{on:s}})}return{select:n,selectDistinct:i,selectDistinctOn:a}}select(e){return new Ve({fields:e??void 0,session:void 0,dialect:this.getDialect()})}selectDistinct(e){return new Ve({fields:e??void 0,session:void 0,dialect:this.getDialect(),distinct:!0})}selectDistinctOn(e,r){return new Ve({fields:r??void 0,session:void 0,dialect:this.getDialect(),distinct:{on:e}})}getDialect(){return this.dialect||(this.dialect=new Ur(this.dialectConfig)),this.dialect}};var zs=class{constructor(e,r,n,i,a){this.table=e,this.session=r,this.dialect=n,this.withList=i,this.overridingSystemValue_=a}static[g]=\"PgInsertBuilder\";authToken;setToken(e){return this.authToken=e,this}overridingSystemValue(){return this.overridingSystemValue_=!0,this}values(e){if(e=Array.isArray(e)?e:[e],e.length===0)throw new Error(\"values() must be called with at least one value\");let r=e.map(n=>{let i={},a=this.table[P.Symbol.Columns];for(let s of Object.keys(n)){let o=n[s];i[s]=b(o,N)?o:new lt(o,a[s])}return i});return new Zc(this.table,r,this.session,this.dialect,this.withList,!1,this.overridingSystemValue_).setToken(this.authToken)}select(e){let r=typeof e==\"function\"?e(new Qi):e;if(!b(r,N)&&!ks(this.table[Lc],r._.selectedFields))throw new Error(\"Insert select error: selected fields are not the same or are in a different order compared to the table definition\");return new Zc(this.table,r,this.session,this.dialect,this.withList,!0)}},Zc=class extends Ge{constructor(e,r,n,i,a,s,o){super(),this.session=n,this.dialect=i,this.config={table:e,values:r,withList:a,select:s,overridingSystemValue_:o}}static[g]=\"PgInsert\";config;returning(e=this.config.table[P.Symbol.Columns]){return this.config.returningFields=e,this.config.returning=Ot(e),this}onConflictDoNothing(e={}){if(e.target===void 0)this.config.onConflict=y`do nothing`;else{let r=\"\";r=Array.isArray(e.target)?e.target.map(i=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(i))).join(\",\"):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target));let n=e.where?y` where ${e.where}`:void 0;this.config.onConflict=y`(${y.raw(r)})${n} do nothing`}return this}onConflictDoUpdate(e){if(e.where&&(e.targetWhere||e.setWhere))throw new Error('You cannot use both \"where\" and \"targetWhere\"/\"setWhere\" at the same time - \"where\" is deprecated, use \"targetWhere\" or \"setWhere\" instead.');let r=e.where?y` where ${e.where}`:void 0,n=e.targetWhere?y` where ${e.targetWhere}`:void 0,i=e.setWhere?y` where ${e.setWhere}`:void 0,a=this.dialect.buildUpdateSet(this.config.table,Bc(this.config.table,e.set)),s=\"\";return s=Array.isArray(e.target)?e.target.map(o=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(o))).join(\",\"):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target)),this.config.onConflict=y`(${y.raw(s)})${n} do update set ${a}${r}${i}`,this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken));getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new _e({alias:ut(this.config.table),sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})):void 0}$dynamic(){return this}};var Jc=class extends Ge{constructor(e,r,n){super(),this.session=r,this.dialect=n,this.config={view:e}}static[g]=\"PgRefreshMaterializedView\";config;concurrently(){if(this.config.withNoData!==void 0)throw new Error(\"Cannot use concurrently and withNoData together\");return this.config.concurrently=!0,this}withNoData(){if(this.config.concurrently!==void 0)throw new Error(\"Cannot use concurrently and withNoData together\");return this.config.withNoData=!0,this}getSQL(){return this.dialect.buildRefreshMaterializedViewQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),void 0,e,!0))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken))};var $s=class{constructor(e,r,n,i){this.table=e,this.session=r,this.dialect=n,this.withList=i}static[g]=\"PgUpdateBuilder\";authToken;setToken(e){return this.authToken=e,this}set(e){return new sm(this.table,Bc(this.table,e),this.session,this.dialect,this.withList).setToken(this.authToken)}},sm=class extends Ge{constructor(e,r,n,i,a){super(),this.session=n,this.dialect=i,this.config={set:r,table:e,withList:a,joins:[]},this.tableName=yr(e),this.joinsNotNullableMap=typeof this.tableName==\"string\"?{[this.tableName]:!0}:{}}static[g]=\"PgUpdate\";config;tableName;joinsNotNullableMap;from(e){let r=e,n=yr(r);return typeof n==\"string\"&&(this.joinsNotNullableMap[n]=!0),this.config.from=r,this}getTableLikeFields(e){return b(e,Be)?e[P.Symbol.Columns]:b(e,Te)?e._.selectedFields:e[se].selectedFields}createJoin(e){return(r,n)=>{let i=yr(r);if(typeof i==\"string\"&&this.config.joins.some(a=>a.alias===i))throw new Error(`Alias \"${i}\" is already used in this query`);if(typeof n==\"function\"){let a=this.config.from&&!b(this.config.from,N)?this.getTableLikeFields(this.config.from):void 0;n=n(new Proxy(this.config.table[P.Symbol.Columns],new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})),a&&new Proxy(a,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))}if(this.config.joins.push({on:n,table:r,joinType:e,alias:i}),typeof i==\"string\")switch(e){case\"left\":{this.joinsNotNullableMap[i]=!1;break}case\"right\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([a])=>[a,!1])),this.joinsNotNullableMap[i]=!0;break}case\"inner\":{this.joinsNotNullableMap[i]=!0;break}case\"full\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([a])=>[a,!1])),this.joinsNotNullableMap[i]=!1;break}}return this}}leftJoin=this.createJoin(\"left\");rightJoin=this.createJoin(\"right\");innerJoin=this.createJoin(\"inner\");fullJoin=this.createJoin(\"full\");where(e){return this.config.where=e,this}returning(e){if(!e&&(e=Object.assign({},this.config.table[P.Symbol.Columns]),this.config.from)){let r=yr(this.config.from);if(typeof r==\"string\"&&this.config.from&&!b(this.config.from,N)){let n=this.getTableLikeFields(this.config.from);e[r]=n}for(let n of this.config.joins){let i=yr(n.table);if(typeof i==\"string\"&&!b(n.table,N)){let a=this.getTableLikeFields(n.table);e[i]=a}}}return this.config.returningFields=e,this.config.returning=Ot(e),this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){let r=this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0);return r.joinsNotNullableMap=this.joinsNotNullableMap,r}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>this._prepare().execute(e,this.authToken);getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new _e({alias:ut(this.config.table),sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})):void 0}$dynamic(){return this}};var Xc=class t extends N{constructor(e){super(t.buildEmbeddedCount(e.source,e.filters).queryChunks),this.params=e,this.mapWith(Number),this.session=e.session,this.sql=t.buildCount(e.source,e.filters)}sql;token;static[g]=\"PgCountBuilder\";[Symbol.toStringTag]=\"PgCountBuilder\";session;static buildEmbeddedCount(e,r){return y`(select count(*) from ${e}${y.raw(\" where \").if(r)}${r})`}static buildCount(e,r){return y`select count(*) as count from ${e}${y.raw(\" where \").if(r)}${r};`}setToken(e){return this.token=e,this}then(e,r){return Promise.resolve(this.session.count(this.sql,this.token)).then(e,r)}catch(e){return this.then(void 0,e)}finally(e){return this.then(r=>(e?.(),r),r=>{throw e?.(),r})}};var Yc=class{constructor(e,r,n,i,a,s,o){this.fullSchema=e,this.schema=r,this.tableNamesMap=n,this.table=i,this.tableConfig=a,this.dialect=s,this.session=o}static[g]=\"PgRelationalQueryBuilder\";findMany(e){return new eu(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},\"many\")}findFirst(e){return new eu(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},\"first\")}},eu=class extends Ge{constructor(e,r,n,i,a,s,o,u,c){super(),this.fullSchema=e,this.schema=r,this.tableNamesMap=n,this.table=i,this.tableConfig=a,this.dialect=s,this.session=o,this.config=u,this.mode=c}static[g]=\"PgRelationalQuery\";_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>{let{query:r,builtQuery:n}=this._toSQL();return this.session.prepareQuery(n,void 0,e,!0,(i,a)=>{let s=i.map(o=>Vc(this.schema,this.tableConfig,o,r.selection,a));return this.mode===\"first\"?s[0]:s})})}prepare(e){return this._prepare(e)}_getQuery(){return this.dialect.buildRelationalQueryWithoutPK({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName})}getSQL(){return this._getQuery().sql}_toSQL(){let e=this._getQuery(),r=this.dialect.sqlToQuery(e.sql);return{query:e,builtQuery:r}}toSQL(){return this._toSQL().builtQuery}authToken;setToken(e){return this.authToken=e,this}execute(){return ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(void 0,this.authToken))}};var tu=class extends Ge{constructor(e,r,n,i){super(),this.execute=e,this.sql=r,this.query=n,this.mapBatchResult=i}static[g]=\"PgRaw\";getSQL(){return this.sql}getQuery(){return this.query}mapResult(e,r){return r?this.mapBatchResult(e):e}_prepare(){return this}isResponseInArrayMode(){return!1}};var Gi=class{constructor(e,r,n){if(this.dialect=e,this.session=r,this._=n?{schema:n.schema,fullSchema:n.fullSchema,tableNamesMap:n.tableNamesMap,session:r}:{schema:void 0,fullSchema:{},tableNamesMap:{},session:r},this.query={},this._.schema)for(let[i,a]of Object.entries(this._.schema))this.query[i]=new Yc(n.fullSchema,this._.schema,this._.tableNamesMap,n.fullSchema[i],a,e,r)}static[g]=\"PgDatabase\";query;$with=(e,r)=>{let n=this;return{as:a=>(typeof a==\"function\"&&(a=a(new Qi(n.dialect))),new Proxy(new Bi(a.getSQL(),r??(\"getSelectedFields\"in a?a.getSelectedFields()??{}:{}),e,!0),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})))}};$count(e,r){return new Xc({source:e,filters:r,session:this.session})}with(...e){let r=this;function n(c){return new Ve({fields:c??void 0,session:r.session,dialect:r.dialect,withList:e})}function i(c){return new Ve({fields:c??void 0,session:r.session,dialect:r.dialect,withList:e,distinct:!0})}function a(c,l){return new Ve({fields:l??void 0,session:r.session,dialect:r.dialect,withList:e,distinct:{on:c}})}function s(c){return new $s(c,r.session,r.dialect,e)}function o(c){return new zs(c,r.session,r.dialect,e)}function u(c){return new Ds(c,r.session,r.dialect,e)}return{select:n,selectDistinct:i,selectDistinctOn:a,update:s,insert:o,delete:u}}select(e){return new Ve({fields:e??void 0,session:this.session,dialect:this.dialect})}selectDistinct(e){return new Ve({fields:e??void 0,session:this.session,dialect:this.dialect,distinct:!0})}selectDistinctOn(e,r){return new Ve({fields:r??void 0,session:this.session,dialect:this.dialect,distinct:{on:e}})}update(e){return new $s(e,this.session,this.dialect)}insert(e){return new zs(e,this.session,this.dialect)}delete(e){return new Ds(e,this.session,this.dialect)}refreshMaterializedView(e){return new Jc(e,this.session,this.dialect)}authToken;execute(e){let r=typeof e==\"string\"?y.raw(e):e.getSQL(),n=this.dialect.sqlToQuery(r),i=this.session.prepareQuery(n,void 0,void 0,!1);return new tu(()=>i.execute(void 0,this.authToken),r,n,a=>i.mapResult(a,!0))}transaction(e,r){return this.session.transaction(e,r)}};var ru=class{constructor(e){this.query=e}authToken;getQuery(){return this.query}mapResult(e,r){return e}setToken(e){return this.authToken=e,this}static[g]=\"PgPreparedQuery\";joinsNotNullableMap},nu=class{constructor(e){this.dialect=e}static[g]=\"PgSession\";execute(e,r){return ae.startActiveSpan(\"drizzle.operation\",()=>ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1)).setToken(r).execute(void 0,r))}all(e){return this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1).all()}async count(e,r){let n=await this.execute(e,r);return Number(n[0].count)}},iu=class extends Gi{constructor(e,r,n,i=0){super(e,r,n),this.schema=n,this.nestedIndex=i}static[g]=\"PgTransaction\";rollback(){throw new $c}getTransactionConfigSQL(e){let r=[];return e.isolationLevel&&r.push(`isolation level ${e.isolationLevel}`),e.accessMode&&r.push(e.accessMode),typeof e.deferrable==\"boolean\"&&r.push(e.deferrable?\"deferrable\":\"not deferrable\"),y.raw(r.join(\" \"))}setTransaction(e){return this.session.execute(y`set transaction ${this.getTransactionConfigSQL(e)}`)}};var om=class{static[g]=\"ConsoleLogWriter\";write(e){console.log(e)}},au=class{static[g]=\"DefaultLogger\";writer;constructor(e){this.writer=e?.writer??new om}logQuery(e,r){let n=r.map(a=>{try{return JSON.stringify(a)}catch{return String(a)}}),i=n.length?` -- params: [${n.join(\", \")}]`:\"\";this.writer.write(`Query: ${e}${i}`)}},su=class{static[g]=\"NoopLogger\";logQuery(){}};var he={INT8_MIN:-128,INT8_MAX:127,INT8_UNSIGNED_MAX:255,INT16_MIN:-32768,INT16_MAX:32767,INT16_UNSIGNED_MAX:65535,INT24_MIN:-8388608,INT24_MAX:8388607,INT24_UNSIGNED_MAX:16777215,INT32_MIN:-2147483648,INT32_MAX:2147483647,INT32_UNSIGNED_MAX:4294967295,INT48_MIN:-0x800000000000,INT48_MAX:0x7fffffffffff,INT48_UNSIGNED_MAX:0xffffffffffff,INT64_MIN:-9223372036854775808n,INT64_MAX:9223372036854775807n,INT64_UNSIGNED_MAX:18446744073709551615n};function Se(t,e){return e.includes(t.columnType)}function jj(t){return\"enumValues\"in t&&Array.isArray(t.enumValues)&&t.enumValues.length>0}var Rj=k.union([k.string(),k.number(),k.boolean(),k.null()]),Dj=k.union([Rj,k.record(k.any()),k.array(k.any())]),Mj=k.custom(t=>t instanceof Buffer);function iE(t,e){let r=e?.zodInstance??k,n=e?.coerce??{},i;return jj(t)&&(i=t.enumValues.length?r.enum(t.enumValues):r.string()),i||(Se(t,[\"PgGeometry\",\"PgPointTuple\"])?i=r.tuple([r.number(),r.number()]):Se(t,[\"PgGeometryObject\",\"PgPointObject\"])?i=r.object({x:r.number(),y:r.number()}):Se(t,[\"PgHalfVector\",\"PgVector\"])?(i=r.array(r.number()),i=t.dimensions?i.length(t.dimensions):i):Se(t,[\"PgLine\"])?i=r.tuple([r.number(),r.number(),r.number()]):Se(t,[\"PgLineABC\"])?i=r.object({a:r.number(),b:r.number(),c:r.number()}):Se(t,[\"PgArray\"])?(i=r.array(iE(t.baseColumn,r)),i=t.size?i.length(t.size):i):t.dataType===\"array\"?i=r.array(r.any()):t.dataType===\"number\"?i=Lj(t,r,n):t.dataType===\"bigint\"?i=Bj(t,r,n):t.dataType===\"boolean\"?i=n===!0||n.boolean?r.coerce.boolean():r.boolean():t.dataType===\"date\"?i=n===!0||n.date?r.coerce.date():r.date():t.dataType===\"string\"?i=Fj(t,r,n):t.dataType===\"json\"?i=Dj:t.dataType===\"custom\"?i=r.any():t.dataType===\"buffer\"&&(i=Mj)),i||(i=r.any()),i}function Lj(t,e,r){let n=t.getSQLType().includes(\"unsigned\"),i,a,s=!1;Se(t,[\"MySqlTinyInt\",\"SingleStoreTinyInt\"])?(i=n?0:he.INT8_MIN,a=n?he.INT8_UNSIGNED_MAX:he.INT8_MAX,s=!0):Se(t,[\"PgSmallInt\",\"PgSmallSerial\",\"MySqlSmallInt\",\"SingleStoreSmallInt\"])?(i=n?0:he.INT16_MIN,a=n?he.INT16_UNSIGNED_MAX:he.INT16_MAX,s=!0):Se(t,[\"PgReal\",\"MySqlFloat\",\"MySqlMediumInt\",\"SingleStoreMediumInt\",\"SingleStoreFloat\"])?(i=n?0:he.INT24_MIN,a=n?he.INT24_UNSIGNED_MAX:he.INT24_MAX,s=Se(t,[\"MySqlMediumInt\",\"SingleStoreMediumInt\"])):Se(t,[\"PgInteger\",\"PgSerial\",\"MySqlInt\",\"SingleStoreInt\"])?(i=n?0:he.INT32_MIN,a=n?he.INT32_UNSIGNED_MAX:he.INT32_MAX,s=!0):Se(t,[\"PgDoublePrecision\",\"MySqlReal\",\"MySqlDouble\",\"SingleStoreReal\",\"SingleStoreDouble\",\"SQLiteReal\"])?(i=n?0:he.INT48_MIN,a=n?he.INT48_UNSIGNED_MAX:he.INT48_MAX):Se(t,[\"PgBigInt53\",\"PgBigSerial53\",\"MySqlBigInt53\",\"MySqlSerial\",\"SingleStoreBigInt53\",\"SingleStoreSerial\",\"SQLiteInteger\"])?(n=n||Se(t,[\"MySqlSerial\",\"SingleStoreSerial\"]),i=n?0:Number.MIN_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER,s=!0):Se(t,[\"MySqlYear\",\"SingleStoreYear\"])?(i=1901,a=2155,s=!0):(i=Number.MIN_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER);let o=r===!0||r?.number?e.coerce.number():e.number();return o=o.min(i).max(a),s?o.int():o}function Bj(t,e,r){let n=t.getSQLType().includes(\"unsigned\"),i=n?0n:he.INT64_MIN,a=n?he.INT64_UNSIGNED_MAX:he.INT64_MAX;return(r===!0||r?.bigint?e.coerce.bigint():e.bigint()).min(i).max(a)}function Fj(t,e,r){if(Se(t,[\"PgUUID\"]))return e.string().uuid();let n,i,a=!1;Se(t,[\"PgVarchar\",\"SQLiteText\"])?n=t.length:Se(t,[\"MySqlVarChar\",\"SingleStoreVarChar\"])?n=t.length??he.INT16_UNSIGNED_MAX:Se(t,[\"MySqlText\",\"SingleStoreText\"])&&(t.textType===\"longtext\"?n=he.INT32_UNSIGNED_MAX:t.textType===\"mediumtext\"?n=he.INT24_UNSIGNED_MAX:t.textType===\"text\"?n=he.INT16_UNSIGNED_MAX:n=he.INT8_UNSIGNED_MAX),Se(t,[\"PgChar\",\"MySqlChar\",\"SingleStoreChar\"])&&(n=t.length,a=!0),Se(t,[\"PgBinaryVector\"])&&(i=/^[01]+$/,n=t.dimensions);let s=r===!0||r?.string?e.coerce.string():e.string();return s=i?s.regex(i):s,n&&a?s.length(n):n?s.max(n):s}function aE(t){return Dd(t)?Fc(t):eS(t)}function sE(t,e,r,n){let i={};for(let[a,s]of Object.entries(t)){if(!b(s,K)&&!b(s,N)&&!b(s,N.Aliased)&&typeof s==\"object\"){let p=Dd(s)||Z_(s)?aE(s):s;i[a]=sE(p,e[a]??{},r,n);continue}let o=e[a];if(o!==void 0&&typeof o!=\"function\"){i[a]=o;continue}let u=b(s,K)?s:void 0,c=u?iE(u,n):k.any(),l=typeof o==\"function\"?o(c):c;r.never(u)||(i[a]=l,u&&(r.nullable(u)&&(i[a]=i[a].nullable()),r.optional(u)&&(i[a]=i[a].optional())))}return k.object(i)}var zj={never:t=>t?.generated?.type===\"always\"||t?.generatedIdentity?.type===\"always\",optional:t=>!t.notNull||t.notNull&&t.hasDefault,nullable:t=>!t.notNull};var oE=(t,e)=>{let r=aE(t);return sE(r,e??{},zj)};var Ie=Ls(\"users\",{id:Mn(\"id\").primaryKey(),username:br(\"username\").notNull().unique(),email:br(\"email\").notNull().unique(),passwordHash:br(\"password_hash\").notNull(),rating:wt(\"rating\").notNull().default(1e3),gamesPlayed:wt(\"games_played\").notNull().default(0),gamesWon:wt(\"games_won\").notNull().default(0),createdAt:zi(\"created_at\").defaultNow().notNull()}),$j=oE(Ie).omit({id:!0,rating:!0,gamesPlayed:!0,gamesWon:!0,createdAt:!0}),Gr=Ls(\"password_resets\",{id:Mn(\"id\").primaryKey(),userId:wt(\"user_id\").notNull().references(()=>Ie.id),token:br(\"token\").notNull().unique(),expiresAt:zi(\"expires_at\").notNull(),used:Cs(\"used\").notNull().default(!1)}),Ln=Ls(\"match_history\",{id:Mn(\"id\").primaryKey(),gameMode:br(\"game_mode\").notNull(),pointGoal:br(\"point_goal\").notNull(),winningTeamScore:wt(\"winning_team_score\").notNull(),losingTeamScore:wt(\"losing_team_score\").notNull(),completedAt:zi(\"completed_at\").defaultNow().notNull()}),Qr=Ls(\"match_players\",{id:Mn(\"id\").primaryKey(),matchId:wt(\"match_id\").notNull().references(()=>Ln.id),userId:wt(\"user_id\").references(()=>Ie.id),isBot:Cs(\"is_bot\").notNull().default(!1),teamIndex:wt(\"team_index\").notNull(),ratingChange:wt(\"rating_change\").notNull().default(0)}),Uj=Hc(Ie,({many:t})=>({matchPlayers:t(Qr),passwordResets:t(Gr)})),Qj=Hc(Ln,({many:t})=>({players:t(Qr)})),Gj=Hc(Qr,({one:t})=>({match:t(Ln,{fields:[Qr.matchId],references:[Ln.id]}),user:t(Ie,{fields:[Qr.userId],references:[Ie.id]})})),cm=[\"spades\",\"hearts\",\"diamonds\",\"clubs\"],cE=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"],Vj=[...cE,\"LJ\",\"BJ\"],um=[\"ace_high\",\"joker_joker_deuce_deuce\"],lm=[\"100\",\"300\",\"500\"],pm={100:100,300:300,500:500},uE=[\"south\",\"west\",\"north\",\"east\"],dm=k.object({suit:k.enum(cm),value:k.string(),id:k.string()}),lE=k.object({id:k.string(),name:k.string(),isBot:k.boolean(),position:k.enum(uE),hand:k.array(dm),bid:k.number().nullable(),tricks:k.number(),isReady:k.boolean()}),pE=k.object({id:k.string(),players:k.array(k.string()),score:k.number(),bags:k.number(),totalBid:k.number().nullable(),tricksWon:k.number()}),dE=k.object({cards:k.array(k.object({playerId:k.string(),card:dm})),leadSuit:k.enum(cm).nullable(),winnerId:k.string().nullable()}),fE=[\"waiting\",\"bidding\",\"playing\",\"round_end\",\"game_over\"],Hj=k.object({id:k.string(),mode:k.enum(um),pointGoal:k.enum(lm),phase:k.enum(fE),players:k.array(lE),teams:k.array(pE),currentTrick:dE,currentPlayerIndex:k.number(),dealerIndex:k.number(),roundNumber:k.number(),spadesBroken:k.boolean(),winningScore:k.number()}),Wj=k.object({id:k.string(),mode:k.enum(um),pointGoal:k.enum(lm),players:k.array(k.object({id:k.string(),name:k.string(),isBot:k.boolean(),isReady:k.boolean()})),hostId:k.string(),status:k.enum([\"waiting\",\"starting\",\"in_game\"])}),Kj=k.object({id:k.number(),username:k.string(),email:k.string(),rating:k.number(),gamesPlayed:k.number(),gamesWon:k.number()}),mE=[\"join_lobby\",\"leave_lobby\",\"start_game\",\"place_bid\",\"play_card\",\"game_state_update\",\"lobby_update\",\"error\",\"player_joined\",\"player_left\",\"chat_message\"],Zj=k.object({type:k.enum(mE),payload:k.any()});function wr(t,e,r){let n=t.suit===\"spades\",i=t.suit===r;if(e===\"ace_high\"){let s=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);return n?100+s:i?50+s:s}else{if(t.value===\"BJ\")return 200;if(t.value===\"LJ\")return 199;if(n&&t.value===\"2\")return 198;if(t.suit===\"diamonds\"&&t.value===\"2\")return 197;if(n)return 100+[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);let s=[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);return i?50+s:s}}function ou(t,e){return t.suit===\"spades\"||e===\"joker_joker_deuce_deuce\"&&(t.value===\"LJ\"||t.value===\"BJ\"||t.suit===\"diamonds\"&&t.value===\"2\")}function Jj(t){if(t.value===\"LJ\")return\"Little Joker\";if(t.value===\"BJ\")return\"Big Joker\";let e={J:\"Jack\",Q:\"Queen\",K:\"King\",A:\"Ace\"},r={spades:\"Spades\",hearts:\"Hearts\",diamonds:\"Diamonds\",clubs:\"Clubs\"};return`${e[t.value]||t.value} of ${r[t.suit]}`}var _t=ht(fh(),1),YW=_t.default.Client,eK=_t.default.Pool,tK=_t.default.Connection,rK=_t.default.types,nK=_t.default.Query,iK=_t.default.DatabaseError,aK=_t.default.escapeIdentifier,sK=_t.default.escapeLiteral,oK=_t.default.Result,cK=_t.default.TypeOverrides,uK=_t.default.defaults,Kr=_t.default;var{Pool:r4,types:ar}=Kr,gh=class extends ru{constructor(e,r,n,i,a,s,o,u){super({sql:r,params:n}),this.client=e,this.params=n,this.logger=i,this.fields=a,this._isResponseInArrayMode=o,this.customResultMapper=u,this.rawQueryConfig={name:s,text:r,types:{getTypeParser:(c,l)=>c===ar.builtins.TIMESTAMPTZ?p=>p:c===ar.builtins.TIMESTAMP?p=>p:c===ar.builtins.DATE?p=>p:c===ar.builtins.INTERVAL?p=>p:ar.getTypeParser(c,l)}},this.queryConfig={name:s,text:r,rowMode:\"array\",types:{getTypeParser:(c,l)=>c===ar.builtins.TIMESTAMPTZ?p=>p:c===ar.builtins.TIMESTAMP?p=>p:c===ar.builtins.DATE?p=>p:c===ar.builtins.INTERVAL?p=>p:ar.getTypeParser(c,l)}}}static[g]=\"NodePgPreparedQuery\";rawQueryConfig;queryConfig;async execute(e={}){return ae.startActiveSpan(\"drizzle.execute\",async()=>{let r=Ld(this.params,e);this.logger.logQuery(this.rawQueryConfig.text,r);let{fields:n,rawQueryConfig:i,client:a,queryConfig:s,joinsNotNullableMap:o,customResultMapper:u}=this;if(!n&&!u)return ae.startActiveSpan(\"drizzle.driver.execute\",async l=>(l?.setAttributes({\"drizzle.query.name\":i.name,\"drizzle.query.text\":i.text,\"drizzle.query.params\":JSON.stringify(r)}),a.query(i,r)));let c=await ae.startActiveSpan(\"drizzle.driver.execute\",l=>(l?.setAttributes({\"drizzle.query.name\":s.name,\"drizzle.query.text\":s.text,\"drizzle.query.params\":JSON.stringify(r)}),a.query(s,r)));return ae.startActiveSpan(\"drizzle.mapResponse\",()=>u?u(c.rows):c.rows.map(l=>X_(n,l,o)))})}all(e={}){return ae.startActiveSpan(\"drizzle.execute\",()=>{let r=Ld(this.params,e);return this.logger.logQuery(this.rawQueryConfig.text,r),ae.startActiveSpan(\"drizzle.driver.execute\",n=>(n?.setAttributes({\"drizzle.query.name\":this.rawQueryConfig.name,\"drizzle.query.text\":this.rawQueryConfig.text,\"drizzle.query.params\":JSON.stringify(r)}),this.client.query(this.rawQueryConfig,r).then(i=>i.rows)))})}isResponseInArrayMode(){return this._isResponseInArrayMode}},Su=class t extends nu{constructor(e,r,n,i={}){super(r),this.client=e,this.schema=n,this.options=i,this.logger=i.logger??new su}static[g]=\"NodePgSession\";logger;prepareQuery(e,r,n,i,a){return new gh(this.client,e.sql,e.params,this.logger,r,n,i,a)}async transaction(e,r){let n=this.client instanceof r4?new t(await this.client.connect(),this.dialect,this.schema,this.options):this,i=new yh(this.dialect,n,this.schema);await i.execute(y`begin${r?y` ${i.getTransactionConfigSQL(r)}`:void 0}`);try{let a=await e(i);return await i.execute(y`commit`),a}catch(a){throw await i.execute(y`rollback`),a}finally{this.client instanceof r4&&n.client.release()}}async count(e){let r=await this.execute(e);return Number(r.rows[0].count)}},yh=class t extends iu{static[g]=\"NodePgTransaction\";async transaction(e){let r=`sp${this.nestedIndex+1}`,n=new t(this.dialect,this.session,this.schema,this.nestedIndex+1);await n.execute(y.raw(`savepoint ${r}`));try{let i=await e(n);return await n.execute(y.raw(`release savepoint ${r}`)),i}catch(i){throw await n.execute(y.raw(`rollback to savepoint ${r}`)),i}}};var xh=class{constructor(e,r,n={}){this.client=e,this.dialect=r,this.options=n}static[g]=\"NodePgDriver\";createSession(e){return new Su(this.client,this.dialect,e,{logger:this.options.logger})}},bh=class extends Gi{static[g]=\"NodePgDatabase\"};function Ys(t,e={}){let r=new Ur({casing:e.casing}),n;e.logger===!0?n=new au:e.logger!==!1&&(n=e.logger);let i;if(e.schema){let u=tE(e.schema,nE);i={fullSchema:e.schema,schema:u.tables,tableNamesMap:u.tableNamesMap}}let s=new xh(t,r,{logger:n}).createSession(i),o=new bh(r,s,i);return o.$client=t,o}function Eu(...t){if(typeof t[0]==\"string\"){let e=new Kr.Pool({connectionString:t[0]});return Ys(e,t[1])}if(tS(t[0])){let{connection:e,client:r,...n}=t[0];if(r)return Ys(r,n);let i=typeof e==\"string\"?new Kr.Pool({connectionString:e}):new Kr.Pool(e);return Ys(i,n)}return Ys(t[0],t[1])}(t=>{function e(r){return Ys({},r)}t.mock=e})(Eu||(Eu={}));var{Pool:sL}=Kr;if(!process.env.DATABASE_URL)throw new Error(\"DATABASE_URL must be set. Did you forget to provision a database?\");var oL=new sL({connectionString:process.env.DATABASE_URL}),jt=Eu(oL,{schema:fm});var n4=require(\"crypto\"),wh=class{lobbies;games;constructor(){this.lobbies=new Map,this.games=new Map}async getUser(e){let[r]=await jt.select().from(Ie).where(It(Ie.id,e));return r||void 0}async getUserByEmail(e){let[r]=await jt.select().from(Ie).where(It(Ie.email,e));return r||void 0}async getUserByUsername(e){let[r]=await jt.select().from(Ie).where(It(Ie.username,e));return r||void 0}async createUser(e){let[r]=await jt.insert(Ie).values(e).returning();return r}async updateUserStats(e,r,n){let i=await this.getUser(e);if(!i)return;let[a]=await jt.update(Ie).set({gamesPlayed:i.gamesPlayed+1,gamesWon:i.gamesWon+(r?1:0),rating:Math.max(0,i.rating+n)}).where(It(Ie.id,e)).returning();return a}async updateUserPassword(e,r){let[n]=await jt.update(Ie).set({passwordHash:r}).where(It(Ie.id,e)).returning();return n||void 0}async createPasswordReset(e,r,n){await jt.insert(Gr).values({userId:e,token:r,expiresAt:n})}async getPasswordReset(e){let[r]=await jt.select().from(Gr).where(It(Gr.token,e));return r||void 0}async markPasswordResetUsed(e){await jt.update(Gr).set({used:!0}).where(It(Gr.token,e))}async getLobby(e){return this.lobbies.get(e)}async createLobby(e){let r=(0,n4.randomUUID)(),n={...e,id:r};return this.lobbies.set(r,n),n}async updateLobby(e,r){let n=this.lobbies.get(e);if(!n)return;let i={...n,...r};return this.lobbies.set(e,i),i}async deleteLobby(e){return this.lobbies.delete(e)}async getActiveLobbies(){return Array.from(this.lobbies.values()).filter(e=>e.status===\"waiting\")}async getGame(e){return this.games.get(e)}async saveGame(e){return this.games.set(e.id,e),e}async deleteGame(e){return this.games.delete(e)}async recordMatch(e,r,n,i,a){let[s]=await jt.insert(Ln).values({gameMode:e,pointGoal:r,winningTeamScore:n,losingTeamScore:i}).returning();for(let o of a)await jt.insert(Qr).values({matchId:s.id,userId:o.userId,isBot:o.isBot,teamIndex:o.teamIndex,ratingChange:o.ratingChange})}},Ee=new wh;var jB=ht(o4(),1),RB=ht(Fh(),1),DB=ht(Uh(),1),Xh=ht(Zh(),1),Yh=ht(Tk(),1);var Ik=require(\"crypto\"),MB=[\"south\",\"west\",\"north\",\"east\"];function ev(){let t=[\"spades\",\"hearts\",\"diamonds\",\"clubs\"],e=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"],r=[];for(let n of t)for(let i of e)r.push({suit:n,value:i,id:`${i}-${n}`});return r}function Ak(){let e=ev().filter(r=>!(r.value===\"2\"&&(r.suit===\"hearts\"||r.suit===\"clubs\")));return e.push({suit:\"spades\",value:\"LJ\",id:\"LJ-joker\"},{suit:\"spades\",value:\"BJ\",id:\"BJ-joker\"}),e}function Pk(t){let e=[...t];for(let r=e.length-1;r>0;r--){let n=Math.floor(Math.random()*(r+1));[e[r],e[n]]=[e[n],e[r]]}return e}function Ok(t,e){let r=[\"spades\",\"hearts\",\"clubs\",\"diamonds\"],n=e===\"ace_high\"?[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"]:[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\",\"2\",\"LJ\",\"BJ\"],i=a=>a.value===\"LJ\"||a.value===\"BJ\";return[...t].sort((a,s)=>{if(i(a)&&!i(s))return-1;if(!i(a)&&i(s))return 1;if(i(a)&&i(s))return a.value===\"BJ\"?-1:1;let o=r.indexOf(a.suit)-r.indexOf(s.suit);return o!==0?o:n.indexOf(s.value)-n.indexOf(a.value)})}var Mt=class{static createGame(e,r,n){if(e.length!==4)throw new Error(\"Spades requires exactly 4 players\");let i=r===\"ace_high\"?ev():Ak(),a=Pk(i),s=e.map((u,c)=>({id:u.id,name:u.name,isBot:u.isBot,position:MB[c],hand:Ok(a.slice(c*13,(c+1)*13),r),bid:null,tricks:0,isReady:!0})),o=[{id:\"team-1\",players:[s[0].id,s[2].id],score:0,bags:0,totalBid:null,tricksWon:0},{id:\"team-2\",players:[s[1].id,s[3].id],score:0,bags:0,totalBid:null,tricksWon:0}];return{id:(0,Ik.randomUUID)(),mode:r,pointGoal:n,phase:\"bidding\",players:s,teams:o,currentTrick:{cards:[],leadSuit:null,winnerId:null},currentPlayerIndex:0,dealerIndex:0,roundNumber:1,spadesBroken:!1,winningScore:pm[n]}}static getPlayableCards(e,r){let n=e.players[r];if(!n)return[];let i=n.hand,a=e.currentTrick.leadSuit;if(!a){if(!e.spadesBroken){let o=i.filter(u=>!ou(u,e.mode));if(o.length>0)return o}return i}let s=i.filter(o=>o.suit===a);return s.length>0?s:i}static placeBid(e,r,n){let i=e.players.findIndex(c=>c.id===r);if(i===-1)throw new Error(\"Player not found\");if(e.phase!==\"bidding\")throw new Error(\"Not in bidding phase\");if(i!==e.currentPlayerIndex)throw new Error(\"Not your turn\");let a=e.players.map((c,l)=>l===i?{...c,bid:n}:c),s=a.every(c=>c.bid!==null),o=e.teams,u=e.phase;return s&&(o=e.teams.map(c=>{let l=c.players.reduce((p,d)=>{let f=a.find(h=>h.id===d);return p+(f?.bid||0)},0);return{...c,totalBid:l}}),u=\"playing\"),{...e,players:a,teams:o,phase:u,currentPlayerIndex:s?0:(e.currentPlayerIndex+1)%4}}static playCard(e,r,n){let i=e.players.findIndex(d=>d.id===r);if(i===-1)throw new Error(\"Player not found\");if(e.phase!==\"playing\")throw new Error(\"Not in playing phase\");if(i!==e.currentPlayerIndex)throw new Error(\"Not your turn\");let s=e.players[i].hand.find(d=>d.id===n);if(!s)throw new Error(\"Card not in hand\");if(!this.getPlayableCards(e,i).some(d=>d.id===n))throw new Error(\"Card is not playable\");let u=e.players.map((d,f)=>f===i?{...d,hand:d.hand.filter(h=>h.id!==n)}:d),c=[...e.currentTrick.cards,{playerId:r,card:s}],l=e.currentTrick.leadSuit||s.suit,p=e.spadesBroken;return ou(s,e.mode)&&(p=!0),c.length===4?this.completeTrick(e,u,c,l,p):{...e,players:u,currentTrick:{cards:c,leadSuit:l,winnerId:null},currentPlayerIndex:(e.currentPlayerIndex+1)%4,spadesBroken:p}}static completeTrick(e,r,n,i,a){let s=0,o=0;n.forEach(({card:f},h)=>{let m=wr(f,e.mode,i);m>o&&(o=m,s=h)});let u=n[s].playerId,c=r.findIndex(f=>f.id===u),l=r.map(f=>f.id===u?{...f,tricks:f.tricks+1}:f),p=e.teams.map(f=>f.players.includes(u)?{...f,tricksWon:f.tricksWon+1}:f);return l.reduce((f,h)=>f+h.hand.length,0)===0?this.completeRound(e,l,p,u,c):{...e,players:l,teams:p,currentTrick:{cards:n,leadSuit:i,winnerId:u},currentPlayerIndex:c,spadesBroken:a}}static completeRound(e,r,n,i,a){let s=n.map(p=>{let d=p.totalBid||0,f=p.tricksWon,h=0,m=p.bags,x=p.players.map(E=>r.find(R=>R.id===E)),w=0;x.forEach(E=>{E.bid===0&&(E.tricks===0?w+=100:(w-=100,m+=E.tricks))});let C=x.reduce((E,R)=>E+(R.bid===0?0:R.bid||0),0),_=f-x.reduce((E,R)=>E+(R.bid===0?R.tricks:0),0);if(C>0)if(_>=C){let E=_-C;h=C*10+E,m+=E}else h=-C*10;return m>=10&&(h-=100,m=m%10),h+=w,{...p,score:p.score+h,bags:m,tricksWon:0,totalBid:null}});if(s.findIndex(p=>p.score>=e.winningScore)!==-1)return{...e,players:r.map(p=>({...p,bid:null,tricks:0})),teams:s,currentTrick:{cards:[],leadSuit:null,winnerId:i},phase:\"game_over\",currentPlayerIndex:a};let u=e.mode===\"ace_high\"?ev():Ak(),c=Pk(u),l=r.map((p,d)=>({...p,hand:Ok(c.slice(d*13,(d+1)*13),e.mode),bid:null,tricks:0}));return{...e,players:l,teams:s,currentTrick:{cards:[],leadSuit:null,winnerId:null},phase:\"bidding\",currentPlayerIndex:(e.dealerIndex+1)%4,dealerIndex:(e.dealerIndex+1)%4,roundNumber:e.roundNumber+1,spadesBroken:!1}}static clearTrick(e){return{...e,currentTrick:{cards:[],leadSuit:null,winnerId:null}}}};var uo=class{static calculateBid(e,r){let n=0;e.forEach(a=>{a.value===\"A\"&&(n+=1),a.value===\"K\"&&(n+=.5),a.value===\"Q\"&&(n+=.25),a.suit===\"spades\"&&(n+=.5),a.value===\"BJ\"&&(n+=2),a.value===\"LJ\"&&(n+=1.5),a.suit===\"spades\"&&a.value===\"2\"&&r===\"joker_joker_deuce_deuce\"&&(n+=1.5)});let i=e.filter(a=>a.suit===\"spades\"||a.value===\"LJ\"||a.value===\"BJ\").length;return n+=Math.max(0,i-2)*.5,n+=Math.random()-.5,Math.max(1,Math.min(6,Math.round(n)))}static selectCard(e,r){let i=e.players[r].hand,a=Mt.getPlayableCards(e,r);if(a.length===1)return a[0];let s=e.currentTrick,o=s.leadSuit,u=!o,c=e.players[(r+2)%4],l=s.cards.find(m=>m.playerId===c.id),p=[...a].sort((m,x)=>wr(m,e.mode,o)-wr(x,e.mode,o));if(u){let m={spades:0,hearts:0,diamonds:0,clubs:0};i.forEach(w=>{w.suit in m&&m[w.suit]++});let x=[\"hearts\",\"diamonds\",\"clubs\"].filter(w=>m[w]>0);if(x.length>0){let w=x.reduce((_,E)=>m[_]>=m[E]?_:E),C=a.filter(_=>_.suit===w);if(C.length>0){let _=C.filter(E=>[\"A\",\"K\",\"Q\"].includes(E.value));return _.length>0?_[0]:C[Math.floor(C.length/2)]}}return p[Math.floor(p.length/2)]}let d=s.cards.reduce((m,{card:x})=>Math.max(m,wr(x,e.mode,o)),0),f=!1;l&&(f=wr(l.card,e.mode,o)>=d);let h=p.filter(m=>wr(m,e.mode,o)>d);return f&&s.cards.length===3?p[0]:h.length>0?h[0]:p[0]}static shouldBreakSpades(e,r){return e.filter(i=>i.suit===\"spades\"||i.value===\"LJ\"||i.value===\"BJ\").length>=5}};var Lu=class{wss;clients=new Map;gameRooms=new Map;constructor(e){this.wss=new Yh.default({server:e,path:\"/ws\"}),this.setupConnectionHandler()}setupConnectionHandler(){this.wss.on(\"connection\",e=>{let r=`player-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,n={ws:e,playerId:r,gameId:null,lobbyId:null};this.clients.set(e,n),this.sendMessage(e,{type:\"player_joined\",payload:{playerId:r}}),e.on(\"message\",i=>{try{let a=JSON.parse(i.toString());this.handleMessage(e,a)}catch{this.sendError(e,\"Invalid message format\")}}),e.on(\"close\",()=>{this.handleDisconnect(e)}),e.on(\"error\",i=>{console.error(\"WebSocket error:\",i)})})}handleMessage(e,r){if(this.clients.get(e))switch(r.type){case\"start_game\":this.handleStartGame(e,r.payload);break;case\"place_bid\":this.handleBid(e,r.payload);break;case\"play_card\":this.handlePlayCard(e,r.payload);break;case\"leave_lobby\":this.handleLeaveLobby(e);break}}handleStartGame(e,r){let n=this.clients.get(e);if(!n)return;let{mode:i,pointGoal:a,players:s}=r;try{let o=s.map((d,f)=>f===0&&!d.isBot?{...d,id:n.playerId}:d),u=Mt.createGame(o,i,a),l=o.filter(d=>!d.isBot&&d.userId).length>=2,p={gameState:u,clients:new Map,botTimer:null,statsSaved:!1,isRanked:l};p.clients.set(n.playerId,n),n.gameId=u.id,this.gameRooms.set(u.id,p),this.broadcastGameState(u.id),this.scheduleBotMove(u.id)}catch(o){this.sendError(e,o.message)}}handleBid(e,r){let n=this.clients.get(e);if(!n||!n.gameId)return;let i=this.gameRooms.get(n.gameId);if(i)try{i.gameState=Mt.placeBid(i.gameState,n.playerId,r.bid),this.broadcastGameState(n.gameId),this.scheduleBotMove(n.gameId)}catch(a){this.sendError(e,a.message)}}handlePlayCard(e,r){let n=this.clients.get(e);if(!n||!n.gameId)return;let i=this.gameRooms.get(n.gameId);if(i)try{i.gameState=Mt.playCard(i.gameState,n.playerId,r.cardId),this.broadcastGameState(n.gameId),i.gameState.currentTrick.cards.length===4?setTimeout(()=>{let a=this.gameRooms.get(n.gameId);a&&a.gameState.currentTrick.cards.length===4&&(a.gameState=Mt.clearTrick(a.gameState),this.broadcastGameState(n.gameId),this.scheduleBotMove(n.gameId))},1500):this.scheduleBotMove(n.gameId)}catch(a){this.sendError(e,a.message)}}handleLeaveLobby(e){let r=this.clients.get(e);if(r&&r.gameId){let n=this.gameRooms.get(r.gameId);n&&(n.clients.delete(r.playerId),n.clients.size===0&&(n.botTimer&&clearTimeout(n.botTimer),this.gameRooms.delete(r.gameId))),r.gameId=null}}handleDisconnect(e){this.clients.get(e)&&(this.handleLeaveLobby(e),this.clients.delete(e))}scheduleBotMove(e){let r=this.gameRooms.get(e);if(!r)return;let{gameState:n}=r,i=n.players[n.currentPlayerIndex];if(!i||!i.isBot||n.phase!==\"bidding\"&&n.phase!==\"playing\")return;r.botTimer&&clearTimeout(r.botTimer);let a=800+Math.random()*700;r.botTimer=setTimeout(()=>{let s=this.gameRooms.get(e);if(!s)return;let{gameState:o}=s,u=o.players[o.currentPlayerIndex];if(!(!u||!u.isBot))try{if(o.phase===\"bidding\"){let c=uo.calculateBid(u.hand,o.mode);s.gameState=Mt.placeBid(o,u.id,c)}else if(o.phase===\"playing\"){let c=uo.selectCard(o,o.currentPlayerIndex);s.gameState=Mt.playCard(o,u.id,c.id)}this.broadcastGameState(e),s.gameState.currentTrick.cards.length===4?setTimeout(()=>{let c=this.gameRooms.get(e);c&&c.gameState.currentTrick.cards.length===4&&(c.gameState=Mt.clearTrick(c.gameState),this.broadcastGameState(e),this.scheduleBotMove(e))},1500):this.scheduleBotMove(e)}catch(c){console.error(\"Bot move error:\",c)}},a)}broadcastGameState(e){let r=this.gameRooms.get(e);r&&(r.clients.forEach(n=>{let i=this.sanitizeGameState(r.gameState,n.playerId);this.sendMessage(n.ws,{type:\"game_state_update\",payload:i})}),r.gameState.phase===\"game_over\"&&!r.statsSaved&&r.isRanked&&(r.statsSaved=!0,this.saveGameStats(r.gameState)))}async saveGameStats(e){try{let r=e.teams.findIndex(s=>s.score>=e.winningScore);if(r===-1)return;let n=e.teams[r],i=e.teams[r===0?1:0],a=[];for(let s of e.players){let o=n.players.includes(s.id),u=n.players.includes(s.id)?r:r===0?1:0,c=o?25:-20;a.push({userId:null,isBot:s.isBot,teamIndex:u,ratingChange:s.isBot?0:c})}await Ee.recordMatch(e.mode,e.pointGoal,n.score,i.score,a),console.log(`Game ${e.id} stats saved - Winner: Team ${r+1}`)}catch(r){console.error(\"Failed to save game stats:\",r)}}sanitizeGameState(e,r){let n=e.players.map(i=>i.id===r?i:{...i,hand:i.hand.map(()=>({suit:\"spades\",value:\"?\",id:\"hidden\"}))});return{...e,players:n}}sendMessage(e,r){e.readyState===Xh.default.OPEN&&e.send(JSON.stringify(r))}sendError(e,r){this.sendMessage(e,{type:\"error\",payload:{message:r}})}};var tv=class{queue=new Map;matchingInterval=null;onMatchFound=null;start(e){this.onMatchFound=e,this.matchingInterval=setInterval(()=>this.tryMatch(),5e3)}stop(){this.matchingInterval&&(clearInterval(this.matchingInterval),this.matchingInterval=null)}addToQueue(e,r,n){let i={id:e.id,username:e.username,rating:e.rating,queuedAt:Date.now(),gameMode:r,pointGoal:n};this.queue.set(e.id,i)}removeFromQueue(e){this.queue.delete(e)}getQueueSize(){return this.queue.size}tryMatch(){let e=Array.from(this.queue.values()),r=new Map;for(let n of e){let i=`${n.gameMode}-${n.pointGoal}`;r.has(i)||r.set(i,[]),r.get(i).push(n)}for(let[,n]of Array.from(r.entries()))if(n.length>=4){let i=this.selectBestMatch(n);if(i&&this.onMatchFound){for(let a of i.players)this.queue.delete(a.id);this.onMatchFound(i)}}}selectBestMatch(e){if(e.length<4)return null;e.sort((a,s)=>a.rating-s.rating);let r=e.filter(a=>Date.now()-a.queuedAt>6e4),n;if(r.length>=4)n=r.slice(0,4);else{let a=this.groupByRatingTier(e),s=null;for(let o of a)o.length>=4&&(!s||o.length>s.length)&&(s=o);s?n=s.slice(0,4):n=e.slice(0,4)}let i=this.balanceTeams(n);return{players:n,teams:i,gameMode:n[0].gameMode,pointGoal:n[0].pointGoal}}groupByRatingTier(e){let r=[];for(let a of e){let s=Math.floor(a.rating/300);for(;r.length<=s;)r.push([]);r[s].push(a)}let i=[];for(let a=0;a<r.length;a++){let s=[...r[a]];a>0&&s.push(...r[a-1]),a<r.length-1&&s.push(...r[a+1]),s.length>=4&&i.push(s)}return i}balanceTeams(e){let r=[...e].sort((a,s)=>s.rating-a.rating),n=[r[0],r[3]],i=[r[1],r[2]];return[n,i]}fillWithBots(e){let r=[\"SpadeMaster\",\"TrickTaker\",\"CardShark\",\"AceHunter\"],n=new Set(e.map(o=>o.username)),i=e.length>0?Math.round(e.reduce((o,u)=>o+u.rating,0)/e.length):1e3,a=[...e],s=0;for(;a.length<4;){let o=r[s%r.length];for(;n.has(o);)s++,o=`Bot${s}`;n.add(o),a.push({id:-1*(s+1),username:o,rating:i+Math.floor(Math.random()*200)-100,queuedAt:Date.now(),gameMode:e[0]?.gameMode||\"ace_high\",pointGoal:e[0]?.pointGoal||\"300\"}),s++}return a}},lo=new tv;var LB={from:process.env.EMAIL_FROM||\"noreply@housespades.com\",apiKey:process.env.EMAIL_API_KEY,domain:process.env.EMAIL_DOMAIN};async function BB(t){let{to:e,subject:r,text:n,html:i}=t;if(!LB.apiKey)return console.log(\"=== Email would be sent (DEV MODE) ===\"),console.log(`To: ${e}`),console.log(`Subject: ${r}`),console.log(`Body: ${n}`),console.log(\"======================================\"),console.log(\"Configure EMAIL_API_KEY to enable real email sending\"),{success:!0,devMode:!0};try{return console.log(`Email sent to ${e}: ${r}`),{success:!0,devMode:!1}}catch(a){return console.error(\"Failed to send email:\",a),{success:!1,devMode:!1}}}async function Nk(t,e,r){let n=`${r}/reset-password?token=${e}`,i=await BB({to:t,subject:\"Reset Your House Spades Password\",text:`","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:18.577923904Z"}
{"message":"\t\t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:18.577933597Z"}
{"message":"","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:18.582783673Z"}
{"message":"Error: DATABASE_URL must be set. Did you forget to provision a database?","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:18.582792228Z"}
{"message":"    at Module.load (node:internal/modules/cjs/loader:1441:32)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:18.583280047Z"}
{"message":"    at Object.<anonymous> (/app/dist/index.cjs:100:43241)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:18.583293438Z"}
{"message":"    at Function._load (node:internal/modules/cjs/loader:1263:12)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:18.583295259Z"}
{"message":"    at TracingChannel.traceSync (node:diagnostics_channel:328:14)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:18.583307409Z"}
{"message":"    at Module._compile (node:internal/modules/cjs/loader:1706:14)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:18.583315035Z"}
{"message":"    at wrapModuleLoad (node:internal/modules/cjs/loader:237:24)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:18.583321302Z"}
{"message":"    at Object..js (node:internal/modules/cjs/loader:1839:10)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:18.583331146Z"}
{"message":"    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:171:5)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:18.583336929Z"}
{"message":"    at node:internal/main/run_main_module:36:49","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:18.583346460Z"}
{"message":"","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:18.583354607Z"}
{"message":"Node.js v22.21.1","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:18.583361852Z"}
{"message":"npm warn config production Use `--omit=dev` instead.","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:19.686951595Z"}
{"message":"","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:19.732964277Z"}
{"message":"> rest-express@1.0.0 start","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:19.732978712Z"}
{"message":"> NODE_ENV=production node dist/index.cjs","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:19.732988373Z"}
{"message":"","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:19.732997504Z"}
{"message":"/app/dist/index.cjs:100","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:20.398404702Z"}
{"message":"\t\t`;await r.execute(y`CREATE SCHEMA IF NOT EXISTS ${y.identifier(a)}`),await r.execute(s);let u=(await r.all(y`select id, hash, created_at from ${y.identifier(a)}.${y.identifier(i)} order by created_at desc limit 1`))[0];await r.transaction(async c=>{for await(let l of e)if(!u||Number(u.created_at)<l.folderMillis){for(let p of l.sql)await c.execute(y.raw(p));await c.execute(y`insert into ${y.identifier(a)}.${y.identifier(i)} (\"hash\", \"created_at\") values(${l.hash}, ${l.folderMillis})`)}})}escapeName(e){return`\"${e}\"`}escapeParam(e){return`$${e+1}`}escapeString(e){return`'${e.replace(/'/g,\"''\")}'`}buildWithCTE(e){if(!e?.length)return;let r=[y`with `];for(let[n,i]of e.entries())r.push(y`${y.identifier(i._.alias)} as (${i._.sql})`),n<e.length-1&&r.push(y`, `);return r.push(y` `),y.join(r)}buildDeleteQuery({table:e,where:r,returning:n,withList:i}){let a=this.buildWithCTE(i),s=n?y` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,o=r?y` where ${r}`:void 0;return y`${a}delete from ${e}${o}${s}`}buildUpdateSet(e,r){let n=e[P.Symbol.Columns],i=Object.keys(n).filter(s=>r[s]!==void 0||n[s]?.onUpdateFn!==void 0),a=i.length;return y.join(i.flatMap((s,o)=>{let u=n[s],c=r[s]??y.param(u.onUpdateFn(),u),l=y`${y.identifier(this.casing.getColumnCasing(u))} = ${c}`;return o<a-1?[l,y.raw(\", \")]:[l]}))}buildUpdateQuery({table:e,set:r,where:n,returning:i,withList:a,from:s,joins:o}){let u=this.buildWithCTE(a),c=e[Be.Symbol.Name],l=e[Be.Symbol.Schema],p=e[Be.Symbol.OriginalName],d=c===p?void 0:c,f=y`${l?y`${y.identifier(l)}.`:void 0}${y.identifier(p)}${d&&y` ${y.identifier(d)}`}`,h=this.buildUpdateSet(e,r),m=s&&y.join([y.raw(\" from \"),this.buildFromTable(s)]),x=this.buildJoins(o),w=i?y` returning ${this.buildSelection(i,{isSingleTable:!s})}`:void 0,C=n?y` where ${n}`:void 0;return y`${u}update ${f} set ${h}${m}${x}${C}${w}`}buildSelection(e,{isSingleTable:r=!1}={}){let n=e.length,i=e.flatMap(({field:a},s)=>{let o=[];if(b(a,N.Aliased)&&a.isSelectionField)o.push(y.identifier(a.fieldAlias));else if(b(a,N.Aliased)||b(a,N)){let u=b(a,N.Aliased)?a.sql:a;r?o.push(new N(u.queryChunks.map(c=>b(c,T)?y.identifier(this.casing.getColumnCasing(c)):c))):o.push(u),b(a,N.Aliased)&&o.push(y` as ${y.identifier(a.fieldAlias)}`)}else b(a,K)&&(r?o.push(y.identifier(this.casing.getColumnCasing(a))):o.push(a));return s<n-1&&o.push(y`, `),o});return y.join(i)}buildJoins(e){if(!e||e.length===0)return;let r=[];for(let[n,i]of e.entries()){n===0&&r.push(y` `);let a=i.table,s=i.lateral?y` lateral`:void 0;if(b(a,Be)){let o=a[Be.Symbol.Name],u=a[Be.Symbol.Schema],c=a[Be.Symbol.OriginalName],l=o===c?void 0:i.alias;r.push(y`${y.raw(i.joinType)} join${s} ${u?y`${y.identifier(u)}.`:void 0}${y.identifier(c)}${l&&y` ${y.identifier(l)}`} on ${i.on}`)}else if(b(a,et)){let o=a[se].name,u=a[se].schema,c=a[se].originalName,l=o===c?void 0:i.alias;r.push(y`${y.raw(i.joinType)} join${s} ${u?y`${y.identifier(u)}.`:void 0}${y.identifier(c)}${l&&y` ${y.identifier(l)}`} on ${i.on}`)}else r.push(y`${y.raw(i.joinType)} join${s} ${a} on ${i.on}`);n<e.length-1&&r.push(y` `)}return y.join(r)}buildFromTable(e){if(b(e,P)&&e[P.Symbol.OriginalName]!==e[P.Symbol.Name]){let r=y`${y.identifier(e[P.Symbol.OriginalName])}`;return e[P.Symbol.Schema]&&(r=y`${y.identifier(e[P.Symbol.Schema])}.${r}`),y`${r} ${y.identifier(e[P.Symbol.Name])}`}return e}buildSelectQuery({withList:e,fields:r,fieldsFlat:n,where:i,having:a,table:s,joins:o,orderBy:u,groupBy:c,limit:l,offset:p,lockingClause:d,distinct:f,setOperators:h}){let m=n??Ot(r);for(let le of m)if(b(le.field,K)&&ut(le.field.table)!==(b(s,Te)?s._.alias:b(s,$i)?s[se].name:b(s,N)?void 0:ut(s))&&!(xe=>o?.some(({alias:mt})=>mt===(xe[P.Symbol.IsAlias]?ut(xe):xe[P.Symbol.BaseName])))(le.field.table)){let xe=ut(le.field.table);throw new Error(`Your \"${le.path.join(\"->\")}\" field references a column \"${xe}\".\"${le.field.name}\", but the table \"${xe}\" is not part of the query! Did you forget to join it?`)}let x=!o||o.length===0,w=this.buildWithCTE(e),C;f&&(C=f===!0?y` distinct`:y` distinct on (${y.join(f.on,y`, `)})`);let _=this.buildSelection(m,{isSingleTable:x}),E=this.buildFromTable(s),R=this.buildJoins(o),M=i?y` where ${i}`:void 0,I=a?y` having ${a}`:void 0,D;u&&u.length>0&&(D=y` order by ${y.join(u,y`, `)}`);let Q;c&&c.length>0&&(Q=y` group by ${y.join(c,y`, `)}`);let ke=typeof l==\"object\"||typeof l==\"number\"&&l>=0?y` limit ${l}`:void 0,rt=p?y` offset ${p}`:void 0,$e=y.empty();if(d){let le=y` for ${y.raw(d.strength)}`;d.config.of&&le.append(y` of ${y.join(Array.isArray(d.config.of)?d.config.of:[d.config.of],y`, `)}`),d.config.noWait?le.append(y` no wait`):d.config.skipLocked&&le.append(y` skip locked`),$e.append(le)}let ye=y`${w}select${C} ${_} from ${E}${R}${M}${Q}${I}${D}${ke}${rt}${$e}`;return h.length>0?this.buildSetOperations(ye,h):ye}buildSetOperations(e,r){let[n,...i]=r;if(!n)throw new Error(\"Cannot pass undefined values to any set operator\");return i.length===0?this.buildSetOperationQuery({leftSelect:e,setOperator:n}):this.buildSetOperations(this.buildSetOperationQuery({leftSelect:e,setOperator:n}),i)}buildSetOperationQuery({leftSelect:e,setOperator:{type:r,isAll:n,rightSelect:i,limit:a,orderBy:s,offset:o}}){let u=y`(${e.getSQL()}) `,c=y`(${i.getSQL()})`,l;if(s&&s.length>0){let h=[];for(let m of s)if(b(m,T))h.push(y.identifier(m.name));else if(b(m,N)){for(let x=0;x<m.queryChunks.length;x++){let w=m.queryChunks[x];b(w,T)&&(m.queryChunks[x]=y.identifier(w.name))}h.push(y`${m}`)}else h.push(y`${m}`);l=y` order by ${y.join(h,y`, `)} `}let p=typeof a==\"object\"||typeof a==\"number\"&&a>=0?y` limit ${a}`:void 0,d=y.raw(`${r} ${n?\"all \":\"\"}`),f=o?y` offset ${o}`:void 0;return y`${u}${d}${c}${l}${p}${f}`}buildInsertQuery({table:e,values:r,onConflict:n,returning:i,withList:a,select:s,overridingSystemValue_:o}){let u=[],c=e[P.Symbol.Columns],l=Object.entries(c).filter(([w,C])=>!C.shouldDisableInsert()),p=l.map(([,w])=>y.identifier(this.casing.getColumnCasing(w)));if(s){let w=r;b(w,N)?u.push(w):u.push(w.getSQL())}else{let w=r;u.push(y.raw(\"values \"));for(let[C,_]of w.entries()){let E=[];for(let[R,M]of l){let I=_[R];if(I===void 0||b(I,lt)&&I.value===void 0)if(M.defaultFn!==void 0){let D=M.defaultFn(),Q=b(D,N)?D:y.param(D,M);E.push(Q)}else if(!M.default&&M.onUpdateFn!==void 0){let D=M.onUpdateFn(),Q=b(D,N)?D:y.param(D,M);E.push(Q)}else E.push(y`default`);else E.push(I)}u.push(E),C<w.length-1&&u.push(y`, `)}}let d=this.buildWithCTE(a),f=y.join(u),h=i?y` returning ${this.buildSelection(i,{isSingleTable:!0})}`:void 0,m=n?y` on conflict ${n}`:void 0,x=o===!0?y`overriding system value `:void 0;return y`${d}insert into ${e} ${p} ${x}${f}${m}${h}`}buildRefreshMaterializedViewQuery({view:e,concurrently:r,withNoData:n}){let i=r?y` concurrently`:void 0,a=n?y` with no data`:void 0;return y`refresh materialized view${i} ${e}${a}`}prepareTyping(e){return b(e,Os)||b(e,Ps)?\"json\":b(e,Is)?\"decimal\":b(e,Ns)?\"time\":b(e,qs)||b(e,js)?\"timestamp\":b(e,Ts)||b(e,As)?\"date\":b(e,Rs)?\"uuid\":\"none\"}sqlToQuery(e,r){return e.toQuery({casing:this.casing,escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString,prepareTyping:this.prepareTyping,invokeSource:r})}buildRelationalQueryWithoutPK({fullSchema:e,schema:r,tableNamesMap:n,table:i,tableConfig:a,queryConfig:s,tableAlias:o,nestedQueryRelation:u,joinOn:c}){let l=[],p,d,f=[],h,m=[];if(s===!0)l=Object.entries(a.columns).map(([C,_])=>({dbKey:_.name,tsKey:C,field:nr(_,o),relationTableTsKey:void 0,isJson:!1,selection:[]}));else{let w=Object.fromEntries(Object.entries(a.columns).map(([I,D])=>[I,nr(D,o)]));if(s.where){let I=typeof s.where==\"function\"?s.where(w,YS()):s.where;h=I&&Es(I,o)}let C=[],_=[];if(s.columns){let I=!1;for(let[D,Q]of Object.entries(s.columns))Q!==void 0&&D in a.columns&&(!I&&Q===!0&&(I=!0),_.push(D));_.length>0&&(_=I?_.filter(D=>s.columns?.[D]===!0):Object.keys(a.columns).filter(D=>!_.includes(D)))}else _=Object.keys(a.columns);for(let I of _){let D=a.columns[I];C.push({tsKey:I,value:D})}let E=[];s.with&&(E=Object.entries(s.with).filter(I=>!!I[1]).map(([I,D])=>({tsKey:I,queryConfig:D,relation:a.relations[I]})));let R;if(s.extras){R=typeof s.extras==\"function\"?s.extras(w,{sql:y}):s.extras;for(let[I,D]of Object.entries(R))C.push({tsKey:I,value:Bd(D,o)})}for(let{tsKey:I,value:D}of C)l.push({dbKey:b(D,N.Aliased)?D.fieldAlias:a.columns[I].name,tsKey:I,field:b(D,K)?nr(D,o):D,relationTableTsKey:void 0,isJson:!1,selection:[]});let M=typeof s.orderBy==\"function\"?s.orderBy(w,eE()):s.orderBy??[];Array.isArray(M)||(M=[M]),f=M.map(I=>b(I,K)?nr(I,o):Es(I,o)),p=s.limit,d=s.offset;for(let{tsKey:I,queryConfig:D,relation:Q}of E){let ke=rE(r,n,Q),rt=Rn(Q.referencedTable),$e=n[rt],ye=`${o}_${I}`,le=Bs(...ke.fields.map((Yr,oa)=>It(nr(ke.references[oa],ye),nr(Yr,o)))),xe=this.buildRelationalQueryWithoutPK({fullSchema:e,schema:r,tableNamesMap:n,table:e[$e],tableConfig:r[$e],queryConfig:b(Q,$r)?D===!0?{limit:1}:{...D,limit:1}:D,tableAlias:ye,joinOn:le,nestedQueryRelation:Q}),mt=y`${y.identifier(ye)}.${y.identifier(\"data\")}`.as(I);m.push({on:y`true`,table:new Te(xe.sql,{},ye),alias:ye,joinType:\"left\",lateral:!0}),l.push({dbKey:I,tsKey:I,field:mt,relationTableTsKey:$e,isJson:!0,selection:xe.selection})}}if(l.length===0)throw new Ms({message:`No fields selected for table \"${a.tsName}\" (\"${o}\")`});let x;if(h=Bs(c,h),u){let w=y`json_build_array(${y.join(l.map(({field:E,tsKey:R,isJson:M})=>M?y`${y.identifier(`${o}_${R}`)}.${y.identifier(\"data\")}`:b(E,N.Aliased)?E.sql:E),y`, `)})`;b(u,Fs)&&(w=y`coalesce(json_agg(${w}${f.length>0?y` order by ${y.join(f,y`, `)}`:void 0}), '[]'::json)`);let C=[{dbKey:\"data\",tsKey:\"data\",field:w.as(\"data\"),isJson:!0,relationTableTsKey:a.tsName,selection:l}];p!==void 0||d!==void 0||f.length>0?(x=this.buildSelectQuery({table:Ss(i,o),fields:{},fieldsFlat:[{path:[],field:y.raw(\"*\")}],where:h,limit:p,offset:d,orderBy:f,setOperators:[]}),h=void 0,p=void 0,d=void 0,f=[]):x=Ss(i,o),x=this.buildSelectQuery({table:b(x,Be)?x:new Te(x,{},o),fields:{},fieldsFlat:C.map(({field:E})=>({path:[],field:b(E,K)?nr(E,o):E})),joins:m,where:h,limit:p,offset:d,orderBy:f,setOperators:[]})}else x=this.buildSelectQuery({table:Ss(i,o),fields:{},fieldsFlat:l.map(({field:w})=>({path:[],field:b(w,K)?nr(w,o):w})),joins:m,where:h,limit:p,offset:d,orderBy:f,setOperators:[]});return{tableTsKey:a.tsName,sql:x,selection:l}}};var Wc=class{static[g]=\"TypedQueryBuilder\";getSelectedFields(){return this._.selectedFields}};var Ve=class{static[g]=\"PgSelectBuilder\";fields;session;dialect;withList=[];distinct;constructor(e){this.fields=e.fields,this.session=e.session,this.dialect=e.dialect,e.withList&&(this.withList=e.withList),this.distinct=e.distinct}authToken;setToken(e){return this.authToken=e,this}from(e){let r=!!this.fields,n=e,i;return this.fields?i=this.fields:b(n,Te)?i=Object.fromEntries(Object.keys(n._.selectedFields).map(a=>[a,n[a]])):b(n,$i)?i=n[se].selectedFields:b(n,N)?i={}:i=Fc(n),new Kc({table:n,fields:i,isPartialSelect:r,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct}).setToken(this.authToken)}},am=class extends Wc{static[g]=\"PgSelectQueryBuilder\";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;constructor({table:e,fields:r,isPartialSelect:n,session:i,dialect:a,withList:s,distinct:o}){super(),this.config={withList:s,table:e,fields:{...r},distinct:o,setOperators:[]},this.isPartialSelect=n,this.session=i,this.dialect=a,this._={selectedFields:r},this.tableName=yr(e),this.joinsNotNullableMap=typeof this.tableName==\"string\"?{[this.tableName]:!0}:{}}createJoin(e){return(r,n)=>{let i=this.tableName,a=yr(r);if(typeof a==\"string\"&&this.config.joins?.some(s=>s.alias===a))throw new Error(`Alias \"${a}\" is already used in this query`);if(!this.isPartialSelect&&(Object.keys(this.joinsNotNullableMap).length===1&&typeof i==\"string\"&&(this.config.fields={[i]:this.config.fields}),typeof a==\"string\"&&!b(r,N))){let s=b(r,Te)?r._.selectedFields:b(r,et)?r[se].selectedFields:r[P.Symbol.Columns];this.config.fields[a]=s}if(typeof n==\"function\"&&(n=n(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.joins||(this.config.joins=[]),this.config.joins.push({on:n,table:r,joinType:e,alias:a}),typeof a==\"string\")switch(e){case\"left\":{this.joinsNotNullableMap[a]=!1;break}case\"right\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([s])=>[s,!1])),this.joinsNotNullableMap[a]=!0;break}case\"inner\":{this.joinsNotNullableMap[a]=!0;break}case\"full\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([s])=>[s,!1])),this.joinsNotNullableMap[a]=!1;break}}return this}}leftJoin=this.createJoin(\"left\");rightJoin=this.createJoin(\"right\");innerJoin=this.createJoin(\"inner\");fullJoin=this.createJoin(\"full\");createSetOperator(e,r){return n=>{let i=typeof n==\"function\"?n(Tj()):n;if(!ks(this.getSelectedFields(),i.getSelectedFields()))throw new Error(\"Set operator error (union / intersect / except): selected fields are not the same or are in a different order\");return this.config.setOperators.push({type:e,isAll:r,rightSelect:i}),this}}union=this.createSetOperator(\"union\",!1);unionAll=this.createSetOperator(\"union\",!0);intersect=this.createSetOperator(\"intersect\",!1);intersectAll=this.createSetOperator(\"intersect\",!0);except=this.createSetOperator(\"except\",!1);exceptAll=this.createSetOperator(\"except\",!0);addSetOperators(e){return this.config.setOperators.push(...e),this}where(e){return typeof e==\"function\"&&(e=e(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.where=e,this}having(e){return typeof e==\"function\"&&(e=e(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.having=e,this}groupBy(...e){if(typeof e[0]==\"function\"){let r=e[0](new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"alias\",sqlBehavior:\"sql\"})));this.config.groupBy=Array.isArray(r)?r:[r]}else this.config.groupBy=e;return this}orderBy(...e){if(typeof e[0]==\"function\"){let r=e[0](new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"alias\",sqlBehavior:\"sql\"}))),n=Array.isArray(r)?r:[r];this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=n:this.config.orderBy=n}else{let r=e;this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=r:this.config.orderBy=r}return this}limit(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).limit=e:this.config.limit=e,this}offset(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).offset=e:this.config.offset=e,this}for(e,r={}){return this.config.lockingClause={strength:e,config:r},this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}as(e){return new Proxy(new Te(this.getSQL(),this.config.fields,e),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"}))}getSelectedFields(){return new Proxy(this.config.fields,new _e({alias:this.tableName,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"}))}$dynamic(){return this}},Kc=class extends am{static[g]=\"PgSelect\";_prepare(e){let{session:r,config:n,dialect:i,joinsNotNullableMap:a,authToken:s}=this;if(!r)throw new Error(\"Cannot execute a query on a query builder. Please use a database instance instead.\");return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>{let o=Ot(n.fields),u=r.prepareQuery(i.sqlToQuery(this.getSQL()),o,e,!0);return u.joinsNotNullableMap=a,u.setToken(s)})}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken))};Y_(Kc,[Ge]);function Ui(t,e){return(r,n,...i)=>{let a=[n,...i].map(s=>({type:t,isAll:e,rightSelect:s}));for(let s of a)if(!ks(r.getSelectedFields(),s.rightSelect.getSelectedFields()))throw new Error(\"Set operator error (union / intersect / except): selected fields are not the same or are in a different order\");return r.addSetOperators(a)}}var Tj=()=>({union:Aj,unionAll:Pj,intersect:Oj,intersectAll:Ij,except:Nj,exceptAll:qj}),Aj=Ui(\"union\",!1),Pj=Ui(\"union\",!0),Oj=Ui(\"intersect\",!1),Ij=Ui(\"intersect\",!0),Nj=Ui(\"except\",!1),qj=Ui(\"except\",!0);var Qi=class{static[g]=\"PgQueryBuilder\";dialect;dialectConfig;constructor(e){this.dialect=b(e,Ur)?e:void 0,this.dialectConfig=b(e,Ur)?void 0:e}$with=(e,r)=>{let n=this;return{as:a=>(typeof a==\"function\"&&(a=a(n)),new Proxy(new Bi(a.getSQL(),r??(\"getSelectedFields\"in a?a.getSelectedFields()??{}:{}),e,!0),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})))}};with(...e){let r=this;function n(s){return new Ve({fields:s??void 0,session:void 0,dialect:r.getDialect(),withList:e})}function i(s){return new Ve({fields:s??void 0,session:void 0,dialect:r.getDialect(),distinct:!0})}function a(s,o){return new Ve({fields:o??void 0,session:void 0,dialect:r.getDialect(),distinct:{on:s}})}return{select:n,selectDistinct:i,selectDistinctOn:a}}select(e){return new Ve({fields:e??void 0,session:void 0,dialect:this.getDialect()})}selectDistinct(e){return new Ve({fields:e??void 0,session:void 0,dialect:this.getDialect(),distinct:!0})}selectDistinctOn(e,r){return new Ve({fields:r??void 0,session:void 0,dialect:this.getDialect(),distinct:{on:e}})}getDialect(){return this.dialect||(this.dialect=new Ur(this.dialectConfig)),this.dialect}};var zs=class{constructor(e,r,n,i,a){this.table=e,this.session=r,this.dialect=n,this.withList=i,this.overridingSystemValue_=a}static[g]=\"PgInsertBuilder\";authToken;setToken(e){return this.authToken=e,this}overridingSystemValue(){return this.overridingSystemValue_=!0,this}values(e){if(e=Array.isArray(e)?e:[e],e.length===0)throw new Error(\"values() must be called with at least one value\");let r=e.map(n=>{let i={},a=this.table[P.Symbol.Columns];for(let s of Object.keys(n)){let o=n[s];i[s]=b(o,N)?o:new lt(o,a[s])}return i});return new Zc(this.table,r,this.session,this.dialect,this.withList,!1,this.overridingSystemValue_).setToken(this.authToken)}select(e){let r=typeof e==\"function\"?e(new Qi):e;if(!b(r,N)&&!ks(this.table[Lc],r._.selectedFields))throw new Error(\"Insert select error: selected fields are not the same or are in a different order compared to the table definition\");return new Zc(this.table,r,this.session,this.dialect,this.withList,!0)}},Zc=class extends Ge{constructor(e,r,n,i,a,s,o){super(),this.session=n,this.dialect=i,this.config={table:e,values:r,withList:a,select:s,overridingSystemValue_:o}}static[g]=\"PgInsert\";config;returning(e=this.config.table[P.Symbol.Columns]){return this.config.returningFields=e,this.config.returning=Ot(e),this}onConflictDoNothing(e={}){if(e.target===void 0)this.config.onConflict=y`do nothing`;else{let r=\"\";r=Array.isArray(e.target)?e.target.map(i=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(i))).join(\",\"):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target));let n=e.where?y` where ${e.where}`:void 0;this.config.onConflict=y`(${y.raw(r)})${n} do nothing`}return this}onConflictDoUpdate(e){if(e.where&&(e.targetWhere||e.setWhere))throw new Error('You cannot use both \"where\" and \"targetWhere\"/\"setWhere\" at the same time - \"where\" is deprecated, use \"targetWhere\" or \"setWhere\" instead.');let r=e.where?y` where ${e.where}`:void 0,n=e.targetWhere?y` where ${e.targetWhere}`:void 0,i=e.setWhere?y` where ${e.setWhere}`:void 0,a=this.dialect.buildUpdateSet(this.config.table,Bc(this.config.table,e.set)),s=\"\";return s=Array.isArray(e.target)?e.target.map(o=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(o))).join(\",\"):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target)),this.config.onConflict=y`(${y.raw(s)})${n} do update set ${a}${r}${i}`,this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken));getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new _e({alias:ut(this.config.table),sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})):void 0}$dynamic(){return this}};var Jc=class extends Ge{constructor(e,r,n){super(),this.session=r,this.dialect=n,this.config={view:e}}static[g]=\"PgRefreshMaterializedView\";config;concurrently(){if(this.config.withNoData!==void 0)throw new Error(\"Cannot use concurrently and withNoData together\");return this.config.concurrently=!0,this}withNoData(){if(this.config.concurrently!==void 0)throw new Error(\"Cannot use concurrently and withNoData together\");return this.config.withNoData=!0,this}getSQL(){return this.dialect.buildRefreshMaterializedViewQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),void 0,e,!0))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken))};var $s=class{constructor(e,r,n,i){this.table=e,this.session=r,this.dialect=n,this.withList=i}static[g]=\"PgUpdateBuilder\";authToken;setToken(e){return this.authToken=e,this}set(e){return new sm(this.table,Bc(this.table,e),this.session,this.dialect,this.withList).setToken(this.authToken)}},sm=class extends Ge{constructor(e,r,n,i,a){super(),this.session=n,this.dialect=i,this.config={set:r,table:e,withList:a,joins:[]},this.tableName=yr(e),this.joinsNotNullableMap=typeof this.tableName==\"string\"?{[this.tableName]:!0}:{}}static[g]=\"PgUpdate\";config;tableName;joinsNotNullableMap;from(e){let r=e,n=yr(r);return typeof n==\"string\"&&(this.joinsNotNullableMap[n]=!0),this.config.from=r,this}getTableLikeFields(e){return b(e,Be)?e[P.Symbol.Columns]:b(e,Te)?e._.selectedFields:e[se].selectedFields}createJoin(e){return(r,n)=>{let i=yr(r);if(typeof i==\"string\"&&this.config.joins.some(a=>a.alias===i))throw new Error(`Alias \"${i}\" is already used in this query`);if(typeof n==\"function\"){let a=this.config.from&&!b(this.config.from,N)?this.getTableLikeFields(this.config.from):void 0;n=n(new Proxy(this.config.table[P.Symbol.Columns],new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})),a&&new Proxy(a,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))}if(this.config.joins.push({on:n,table:r,joinType:e,alias:i}),typeof i==\"string\")switch(e){case\"left\":{this.joinsNotNullableMap[i]=!1;break}case\"right\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([a])=>[a,!1])),this.joinsNotNullableMap[i]=!0;break}case\"inner\":{this.joinsNotNullableMap[i]=!0;break}case\"full\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([a])=>[a,!1])),this.joinsNotNullableMap[i]=!1;break}}return this}}leftJoin=this.createJoin(\"left\");rightJoin=this.createJoin(\"right\");innerJoin=this.createJoin(\"inner\");fullJoin=this.createJoin(\"full\");where(e){return this.config.where=e,this}returning(e){if(!e&&(e=Object.assign({},this.config.table[P.Symbol.Columns]),this.config.from)){let r=yr(this.config.from);if(typeof r==\"string\"&&this.config.from&&!b(this.config.from,N)){let n=this.getTableLikeFields(this.config.from);e[r]=n}for(let n of this.config.joins){let i=yr(n.table);if(typeof i==\"string\"&&!b(n.table,N)){let a=this.getTableLikeFields(n.table);e[i]=a}}}return this.config.returningFields=e,this.config.returning=Ot(e),this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){let r=this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0);return r.joinsNotNullableMap=this.joinsNotNullableMap,r}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>this._prepare().execute(e,this.authToken);getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new _e({alias:ut(this.config.table),sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})):void 0}$dynamic(){return this}};var Xc=class t extends N{constructor(e){super(t.buildEmbeddedCount(e.source,e.filters).queryChunks),this.params=e,this.mapWith(Number),this.session=e.session,this.sql=t.buildCount(e.source,e.filters)}sql;token;static[g]=\"PgCountBuilder\";[Symbol.toStringTag]=\"PgCountBuilder\";session;static buildEmbeddedCount(e,r){return y`(select count(*) from ${e}${y.raw(\" where \").if(r)}${r})`}static buildCount(e,r){return y`select count(*) as count from ${e}${y.raw(\" where \").if(r)}${r};`}setToken(e){return this.token=e,this}then(e,r){return Promise.resolve(this.session.count(this.sql,this.token)).then(e,r)}catch(e){return this.then(void 0,e)}finally(e){return this.then(r=>(e?.(),r),r=>{throw e?.(),r})}};var Yc=class{constructor(e,r,n,i,a,s,o){this.fullSchema=e,this.schema=r,this.tableNamesMap=n,this.table=i,this.tableConfig=a,this.dialect=s,this.session=o}static[g]=\"PgRelationalQueryBuilder\";findMany(e){return new eu(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},\"many\")}findFirst(e){return new eu(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},\"first\")}},eu=class extends Ge{constructor(e,r,n,i,a,s,o,u,c){super(),this.fullSchema=e,this.schema=r,this.tableNamesMap=n,this.table=i,this.tableConfig=a,this.dialect=s,this.session=o,this.config=u,this.mode=c}static[g]=\"PgRelationalQuery\";_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>{let{query:r,builtQuery:n}=this._toSQL();return this.session.prepareQuery(n,void 0,e,!0,(i,a)=>{let s=i.map(o=>Vc(this.schema,this.tableConfig,o,r.selection,a));return this.mode===\"first\"?s[0]:s})})}prepare(e){return this._prepare(e)}_getQuery(){return this.dialect.buildRelationalQueryWithoutPK({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName})}getSQL(){return this._getQuery().sql}_toSQL(){let e=this._getQuery(),r=this.dialect.sqlToQuery(e.sql);return{query:e,builtQuery:r}}toSQL(){return this._toSQL().builtQuery}authToken;setToken(e){return this.authToken=e,this}execute(){return ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(void 0,this.authToken))}};var tu=class extends Ge{constructor(e,r,n,i){super(),this.execute=e,this.sql=r,this.query=n,this.mapBatchResult=i}static[g]=\"PgRaw\";getSQL(){return this.sql}getQuery(){return this.query}mapResult(e,r){return r?this.mapBatchResult(e):e}_prepare(){return this}isResponseInArrayMode(){return!1}};var Gi=class{constructor(e,r,n){if(this.dialect=e,this.session=r,this._=n?{schema:n.schema,fullSchema:n.fullSchema,tableNamesMap:n.tableNamesMap,session:r}:{schema:void 0,fullSchema:{},tableNamesMap:{},session:r},this.query={},this._.schema)for(let[i,a]of Object.entries(this._.schema))this.query[i]=new Yc(n.fullSchema,this._.schema,this._.tableNamesMap,n.fullSchema[i],a,e,r)}static[g]=\"PgDatabase\";query;$with=(e,r)=>{let n=this;return{as:a=>(typeof a==\"function\"&&(a=a(new Qi(n.dialect))),new Proxy(new Bi(a.getSQL(),r??(\"getSelectedFields\"in a?a.getSelectedFields()??{}:{}),e,!0),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})))}};$count(e,r){return new Xc({source:e,filters:r,session:this.session})}with(...e){let r=this;function n(c){return new Ve({fields:c??void 0,session:r.session,dialect:r.dialect,withList:e})}function i(c){return new Ve({fields:c??void 0,session:r.session,dialect:r.dialect,withList:e,distinct:!0})}function a(c,l){return new Ve({fields:l??void 0,session:r.session,dialect:r.dialect,withList:e,distinct:{on:c}})}function s(c){return new $s(c,r.session,r.dialect,e)}function o(c){return new zs(c,r.session,r.dialect,e)}function u(c){return new Ds(c,r.session,r.dialect,e)}return{select:n,selectDistinct:i,selectDistinctOn:a,update:s,insert:o,delete:u}}select(e){return new Ve({fields:e??void 0,session:this.session,dialect:this.dialect})}selectDistinct(e){return new Ve({fields:e??void 0,session:this.session,dialect:this.dialect,distinct:!0})}selectDistinctOn(e,r){return new Ve({fields:r??void 0,session:this.session,dialect:this.dialect,distinct:{on:e}})}update(e){return new $s(e,this.session,this.dialect)}insert(e){return new zs(e,this.session,this.dialect)}delete(e){return new Ds(e,this.session,this.dialect)}refreshMaterializedView(e){return new Jc(e,this.session,this.dialect)}authToken;execute(e){let r=typeof e==\"string\"?y.raw(e):e.getSQL(),n=this.dialect.sqlToQuery(r),i=this.session.prepareQuery(n,void 0,void 0,!1);return new tu(()=>i.execute(void 0,this.authToken),r,n,a=>i.mapResult(a,!0))}transaction(e,r){return this.session.transaction(e,r)}};var ru=class{constructor(e){this.query=e}authToken;getQuery(){return this.query}mapResult(e,r){return e}setToken(e){return this.authToken=e,this}static[g]=\"PgPreparedQuery\";joinsNotNullableMap},nu=class{constructor(e){this.dialect=e}static[g]=\"PgSession\";execute(e,r){return ae.startActiveSpan(\"drizzle.operation\",()=>ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1)).setToken(r).execute(void 0,r))}all(e){return this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1).all()}async count(e,r){let n=await this.execute(e,r);return Number(n[0].count)}},iu=class extends Gi{constructor(e,r,n,i=0){super(e,r,n),this.schema=n,this.nestedIndex=i}static[g]=\"PgTransaction\";rollback(){throw new $c}getTransactionConfigSQL(e){let r=[];return e.isolationLevel&&r.push(`isolation level ${e.isolationLevel}`),e.accessMode&&r.push(e.accessMode),typeof e.deferrable==\"boolean\"&&r.push(e.deferrable?\"deferrable\":\"not deferrable\"),y.raw(r.join(\" \"))}setTransaction(e){return this.session.execute(y`set transaction ${this.getTransactionConfigSQL(e)}`)}};var om=class{static[g]=\"ConsoleLogWriter\";write(e){console.log(e)}},au=class{static[g]=\"DefaultLogger\";writer;constructor(e){this.writer=e?.writer??new om}logQuery(e,r){let n=r.map(a=>{try{return JSON.stringify(a)}catch{return String(a)}}),i=n.length?` -- params: [${n.join(\", \")}]`:\"\";this.writer.write(`Query: ${e}${i}`)}},su=class{static[g]=\"NoopLogger\";logQuery(){}};var he={INT8_MIN:-128,INT8_MAX:127,INT8_UNSIGNED_MAX:255,INT16_MIN:-32768,INT16_MAX:32767,INT16_UNSIGNED_MAX:65535,INT24_MIN:-8388608,INT24_MAX:8388607,INT24_UNSIGNED_MAX:16777215,INT32_MIN:-2147483648,INT32_MAX:2147483647,INT32_UNSIGNED_MAX:4294967295,INT48_MIN:-0x800000000000,INT48_MAX:0x7fffffffffff,INT48_UNSIGNED_MAX:0xffffffffffff,INT64_MIN:-9223372036854775808n,INT64_MAX:9223372036854775807n,INT64_UNSIGNED_MAX:18446744073709551615n};function Se(t,e){return e.includes(t.columnType)}function jj(t){return\"enumValues\"in t&&Array.isArray(t.enumValues)&&t.enumValues.length>0}var Rj=k.union([k.string(),k.number(),k.boolean(),k.null()]),Dj=k.union([Rj,k.record(k.any()),k.array(k.any())]),Mj=k.custom(t=>t instanceof Buffer);function iE(t,e){let r=e?.zodInstance??k,n=e?.coerce??{},i;return jj(t)&&(i=t.enumValues.length?r.enum(t.enumValues):r.string()),i||(Se(t,[\"PgGeometry\",\"PgPointTuple\"])?i=r.tuple([r.number(),r.number()]):Se(t,[\"PgGeometryObject\",\"PgPointObject\"])?i=r.object({x:r.number(),y:r.number()}):Se(t,[\"PgHalfVector\",\"PgVector\"])?(i=r.array(r.number()),i=t.dimensions?i.length(t.dimensions):i):Se(t,[\"PgLine\"])?i=r.tuple([r.number(),r.number(),r.number()]):Se(t,[\"PgLineABC\"])?i=r.object({a:r.number(),b:r.number(),c:r.number()}):Se(t,[\"PgArray\"])?(i=r.array(iE(t.baseColumn,r)),i=t.size?i.length(t.size):i):t.dataType===\"array\"?i=r.array(r.any()):t.dataType===\"number\"?i=Lj(t,r,n):t.dataType===\"bigint\"?i=Bj(t,r,n):t.dataType===\"boolean\"?i=n===!0||n.boolean?r.coerce.boolean():r.boolean():t.dataType===\"date\"?i=n===!0||n.date?r.coerce.date():r.date():t.dataType===\"string\"?i=Fj(t,r,n):t.dataType===\"json\"?i=Dj:t.dataType===\"custom\"?i=r.any():t.dataType===\"buffer\"&&(i=Mj)),i||(i=r.any()),i}function Lj(t,e,r){let n=t.getSQLType().includes(\"unsigned\"),i,a,s=!1;Se(t,[\"MySqlTinyInt\",\"SingleStoreTinyInt\"])?(i=n?0:he.INT8_MIN,a=n?he.INT8_UNSIGNED_MAX:he.INT8_MAX,s=!0):Se(t,[\"PgSmallInt\",\"PgSmallSerial\",\"MySqlSmallInt\",\"SingleStoreSmallInt\"])?(i=n?0:he.INT16_MIN,a=n?he.INT16_UNSIGNED_MAX:he.INT16_MAX,s=!0):Se(t,[\"PgReal\",\"MySqlFloat\",\"MySqlMediumInt\",\"SingleStoreMediumInt\",\"SingleStoreFloat\"])?(i=n?0:he.INT24_MIN,a=n?he.INT24_UNSIGNED_MAX:he.INT24_MAX,s=Se(t,[\"MySqlMediumInt\",\"SingleStoreMediumInt\"])):Se(t,[\"PgInteger\",\"PgSerial\",\"MySqlInt\",\"SingleStoreInt\"])?(i=n?0:he.INT32_MIN,a=n?he.INT32_UNSIGNED_MAX:he.INT32_MAX,s=!0):Se(t,[\"PgDoublePrecision\",\"MySqlReal\",\"MySqlDouble\",\"SingleStoreReal\",\"SingleStoreDouble\",\"SQLiteReal\"])?(i=n?0:he.INT48_MIN,a=n?he.INT48_UNSIGNED_MAX:he.INT48_MAX):Se(t,[\"PgBigInt53\",\"PgBigSerial53\",\"MySqlBigInt53\",\"MySqlSerial\",\"SingleStoreBigInt53\",\"SingleStoreSerial\",\"SQLiteInteger\"])?(n=n||Se(t,[\"MySqlSerial\",\"SingleStoreSerial\"]),i=n?0:Number.MIN_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER,s=!0):Se(t,[\"MySqlYear\",\"SingleStoreYear\"])?(i=1901,a=2155,s=!0):(i=Number.MIN_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER);let o=r===!0||r?.number?e.coerce.number():e.number();return o=o.min(i).max(a),s?o.int():o}function Bj(t,e,r){let n=t.getSQLType().includes(\"unsigned\"),i=n?0n:he.INT64_MIN,a=n?he.INT64_UNSIGNED_MAX:he.INT64_MAX;return(r===!0||r?.bigint?e.coerce.bigint():e.bigint()).min(i).max(a)}function Fj(t,e,r){if(Se(t,[\"PgUUID\"]))return e.string().uuid();let n,i,a=!1;Se(t,[\"PgVarchar\",\"SQLiteText\"])?n=t.length:Se(t,[\"MySqlVarChar\",\"SingleStoreVarChar\"])?n=t.length??he.INT16_UNSIGNED_MAX:Se(t,[\"MySqlText\",\"SingleStoreText\"])&&(t.textType===\"longtext\"?n=he.INT32_UNSIGNED_MAX:t.textType===\"mediumtext\"?n=he.INT24_UNSIGNED_MAX:t.textType===\"text\"?n=he.INT16_UNSIGNED_MAX:n=he.INT8_UNSIGNED_MAX),Se(t,[\"PgChar\",\"MySqlChar\",\"SingleStoreChar\"])&&(n=t.length,a=!0),Se(t,[\"PgBinaryVector\"])&&(i=/^[01]+$/,n=t.dimensions);let s=r===!0||r?.string?e.coerce.string():e.string();return s=i?s.regex(i):s,n&&a?s.length(n):n?s.max(n):s}function aE(t){return Dd(t)?Fc(t):eS(t)}function sE(t,e,r,n){let i={};for(let[a,s]of Object.entries(t)){if(!b(s,K)&&!b(s,N)&&!b(s,N.Aliased)&&typeof s==\"object\"){let p=Dd(s)||Z_(s)?aE(s):s;i[a]=sE(p,e[a]??{},r,n);continue}let o=e[a];if(o!==void 0&&typeof o!=\"function\"){i[a]=o;continue}let u=b(s,K)?s:void 0,c=u?iE(u,n):k.any(),l=typeof o==\"function\"?o(c):c;r.never(u)||(i[a]=l,u&&(r.nullable(u)&&(i[a]=i[a].nullable()),r.optional(u)&&(i[a]=i[a].optional())))}return k.object(i)}var zj={never:t=>t?.generated?.type===\"always\"||t?.generatedIdentity?.type===\"always\",optional:t=>!t.notNull||t.notNull&&t.hasDefault,nullable:t=>!t.notNull};var oE=(t,e)=>{let r=aE(t);return sE(r,e??{},zj)};var Ie=Ls(\"users\",{id:Mn(\"id\").primaryKey(),username:br(\"username\").notNull().unique(),email:br(\"email\").notNull().unique(),passwordHash:br(\"password_hash\").notNull(),rating:wt(\"rating\").notNull().default(1e3),gamesPlayed:wt(\"games_played\").notNull().default(0),gamesWon:wt(\"games_won\").notNull().default(0),createdAt:zi(\"created_at\").defaultNow().notNull()}),$j=oE(Ie).omit({id:!0,rating:!0,gamesPlayed:!0,gamesWon:!0,createdAt:!0}),Gr=Ls(\"password_resets\",{id:Mn(\"id\").primaryKey(),userId:wt(\"user_id\").notNull().references(()=>Ie.id),token:br(\"token\").notNull().unique(),expiresAt:zi(\"expires_at\").notNull(),used:Cs(\"used\").notNull().default(!1)}),Ln=Ls(\"match_history\",{id:Mn(\"id\").primaryKey(),gameMode:br(\"game_mode\").notNull(),pointGoal:br(\"point_goal\").notNull(),winningTeamScore:wt(\"winning_team_score\").notNull(),losingTeamScore:wt(\"losing_team_score\").notNull(),completedAt:zi(\"completed_at\").defaultNow().notNull()}),Qr=Ls(\"match_players\",{id:Mn(\"id\").primaryKey(),matchId:wt(\"match_id\").notNull().references(()=>Ln.id),userId:wt(\"user_id\").references(()=>Ie.id),isBot:Cs(\"is_bot\").notNull().default(!1),teamIndex:wt(\"team_index\").notNull(),ratingChange:wt(\"rating_change\").notNull().default(0)}),Uj=Hc(Ie,({many:t})=>({matchPlayers:t(Qr),passwordResets:t(Gr)})),Qj=Hc(Ln,({many:t})=>({players:t(Qr)})),Gj=Hc(Qr,({one:t})=>({match:t(Ln,{fields:[Qr.matchId],references:[Ln.id]}),user:t(Ie,{fields:[Qr.userId],references:[Ie.id]})})),cm=[\"spades\",\"hearts\",\"diamonds\",\"clubs\"],cE=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"],Vj=[...cE,\"LJ\",\"BJ\"],um=[\"ace_high\",\"joker_joker_deuce_deuce\"],lm=[\"100\",\"300\",\"500\"],pm={100:100,300:300,500:500},uE=[\"south\",\"west\",\"north\",\"east\"],dm=k.object({suit:k.enum(cm),value:k.string(),id:k.string()}),lE=k.object({id:k.string(),name:k.string(),isBot:k.boolean(),position:k.enum(uE),hand:k.array(dm),bid:k.number().nullable(),tricks:k.number(),isReady:k.boolean()}),pE=k.object({id:k.string(),players:k.array(k.string()),score:k.number(),bags:k.number(),totalBid:k.number().nullable(),tricksWon:k.number()}),dE=k.object({cards:k.array(k.object({playerId:k.string(),card:dm})),leadSuit:k.enum(cm).nullable(),winnerId:k.string().nullable()}),fE=[\"waiting\",\"bidding\",\"playing\",\"round_end\",\"game_over\"],Hj=k.object({id:k.string(),mode:k.enum(um),pointGoal:k.enum(lm),phase:k.enum(fE),players:k.array(lE),teams:k.array(pE),currentTrick:dE,currentPlayerIndex:k.number(),dealerIndex:k.number(),roundNumber:k.number(),spadesBroken:k.boolean(),winningScore:k.number()}),Wj=k.object({id:k.string(),mode:k.enum(um),pointGoal:k.enum(lm),players:k.array(k.object({id:k.string(),name:k.string(),isBot:k.boolean(),isReady:k.boolean()})),hostId:k.string(),status:k.enum([\"waiting\",\"starting\",\"in_game\"])}),Kj=k.object({id:k.number(),username:k.string(),email:k.string(),rating:k.number(),gamesPlayed:k.number(),gamesWon:k.number()}),mE=[\"join_lobby\",\"leave_lobby\",\"start_game\",\"place_bid\",\"play_card\",\"game_state_update\",\"lobby_update\",\"error\",\"player_joined\",\"player_left\",\"chat_message\"],Zj=k.object({type:k.enum(mE),payload:k.any()});function wr(t,e,r){let n=t.suit===\"spades\",i=t.suit===r;if(e===\"ace_high\"){let s=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);return n?100+s:i?50+s:s}else{if(t.value===\"BJ\")return 200;if(t.value===\"LJ\")return 199;if(n&&t.value===\"2\")return 198;if(t.suit===\"diamonds\"&&t.value===\"2\")return 197;if(n)return 100+[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);let s=[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);return i?50+s:s}}function ou(t,e){return t.suit===\"spades\"||e===\"joker_joker_deuce_deuce\"&&(t.value===\"LJ\"||t.value===\"BJ\"||t.suit===\"diamonds\"&&t.value===\"2\")}function Jj(t){if(t.value===\"LJ\")return\"Little Joker\";if(t.value===\"BJ\")return\"Big Joker\";let e={J:\"Jack\",Q:\"Queen\",K:\"King\",A:\"Ace\"},r={spades:\"Spades\",hearts:\"Hearts\",diamonds:\"Diamonds\",clubs:\"Clubs\"};return`${e[t.value]||t.value} of ${r[t.suit]}`}var _t=ht(fh(),1),YW=_t.default.Client,eK=_t.default.Pool,tK=_t.default.Connection,rK=_t.default.types,nK=_t.default.Query,iK=_t.default.DatabaseError,aK=_t.default.escapeIdentifier,sK=_t.default.escapeLiteral,oK=_t.default.Result,cK=_t.default.TypeOverrides,uK=_t.default.defaults,Kr=_t.default;var{Pool:r4,types:ar}=Kr,gh=class extends ru{constructor(e,r,n,i,a,s,o,u){super({sql:r,params:n}),this.client=e,this.params=n,this.logger=i,this.fields=a,this._isResponseInArrayMode=o,this.customResultMapper=u,this.rawQueryConfig={name:s,text:r,types:{getTypeParser:(c,l)=>c===ar.builtins.TIMESTAMPTZ?p=>p:c===ar.builtins.TIMESTAMP?p=>p:c===ar.builtins.DATE?p=>p:c===ar.builtins.INTERVAL?p=>p:ar.getTypeParser(c,l)}},this.queryConfig={name:s,text:r,rowMode:\"array\",types:{getTypeParser:(c,l)=>c===ar.builtins.TIMESTAMPTZ?p=>p:c===ar.builtins.TIMESTAMP?p=>p:c===ar.builtins.DATE?p=>p:c===ar.builtins.INTERVAL?p=>p:ar.getTypeParser(c,l)}}}static[g]=\"NodePgPreparedQuery\";rawQueryConfig;queryConfig;async execute(e={}){return ae.startActiveSpan(\"drizzle.execute\",async()=>{let r=Ld(this.params,e);this.logger.logQuery(this.rawQueryConfig.text,r);let{fields:n,rawQueryConfig:i,client:a,queryConfig:s,joinsNotNullableMap:o,customResultMapper:u}=this;if(!n&&!u)return ae.startActiveSpan(\"drizzle.driver.execute\",async l=>(l?.setAttributes({\"drizzle.query.name\":i.name,\"drizzle.query.text\":i.text,\"drizzle.query.params\":JSON.stringify(r)}),a.query(i,r)));let c=await ae.startActiveSpan(\"drizzle.driver.execute\",l=>(l?.setAttributes({\"drizzle.query.name\":s.name,\"drizzle.query.text\":s.text,\"drizzle.query.params\":JSON.stringify(r)}),a.query(s,r)));return ae.startActiveSpan(\"drizzle.mapResponse\",()=>u?u(c.rows):c.rows.map(l=>X_(n,l,o)))})}all(e={}){return ae.startActiveSpan(\"drizzle.execute\",()=>{let r=Ld(this.params,e);return this.logger.logQuery(this.rawQueryConfig.text,r),ae.startActiveSpan(\"drizzle.driver.execute\",n=>(n?.setAttributes({\"drizzle.query.name\":this.rawQueryConfig.name,\"drizzle.query.text\":this.rawQueryConfig.text,\"drizzle.query.params\":JSON.stringify(r)}),this.client.query(this.rawQueryConfig,r).then(i=>i.rows)))})}isResponseInArrayMode(){return this._isResponseInArrayMode}},Su=class t extends nu{constructor(e,r,n,i={}){super(r),this.client=e,this.schema=n,this.options=i,this.logger=i.logger??new su}static[g]=\"NodePgSession\";logger;prepareQuery(e,r,n,i,a){return new gh(this.client,e.sql,e.params,this.logger,r,n,i,a)}async transaction(e,r){let n=this.client instanceof r4?new t(await this.client.connect(),this.dialect,this.schema,this.options):this,i=new yh(this.dialect,n,this.schema);await i.execute(y`begin${r?y` ${i.getTransactionConfigSQL(r)}`:void 0}`);try{let a=await e(i);return await i.execute(y`commit`),a}catch(a){throw await i.execute(y`rollback`),a}finally{this.client instanceof r4&&n.client.release()}}async count(e){let r=await this.execute(e);return Number(r.rows[0].count)}},yh=class t extends iu{static[g]=\"NodePgTransaction\";async transaction(e){let r=`sp${this.nestedIndex+1}`,n=new t(this.dialect,this.session,this.schema,this.nestedIndex+1);await n.execute(y.raw(`savepoint ${r}`));try{let i=await e(n);return await n.execute(y.raw(`release savepoint ${r}`)),i}catch(i){throw await n.execute(y.raw(`rollback to savepoint ${r}`)),i}}};var xh=class{constructor(e,r,n={}){this.client=e,this.dialect=r,this.options=n}static[g]=\"NodePgDriver\";createSession(e){return new Su(this.client,this.dialect,e,{logger:this.options.logger})}},bh=class extends Gi{static[g]=\"NodePgDatabase\"};function Ys(t,e={}){let r=new Ur({casing:e.casing}),n;e.logger===!0?n=new au:e.logger!==!1&&(n=e.logger);let i;if(e.schema){let u=tE(e.schema,nE);i={fullSchema:e.schema,schema:u.tables,tableNamesMap:u.tableNamesMap}}let s=new xh(t,r,{logger:n}).createSession(i),o=new bh(r,s,i);return o.$client=t,o}function Eu(...t){if(typeof t[0]==\"string\"){let e=new Kr.Pool({connectionString:t[0]});return Ys(e,t[1])}if(tS(t[0])){let{connection:e,client:r,...n}=t[0];if(r)return Ys(r,n);let i=typeof e==\"string\"?new Kr.Pool({connectionString:e}):new Kr.Pool(e);return Ys(i,n)}return Ys(t[0],t[1])}(t=>{function e(r){return Ys({},r)}t.mock=e})(Eu||(Eu={}));var{Pool:sL}=Kr;if(!process.env.DATABASE_URL)throw new Error(\"DATABASE_URL must be set. Did you forget to provision a database?\");var oL=new sL({connectionString:process.env.DATABASE_URL}),jt=Eu(oL,{schema:fm});var n4=require(\"crypto\"),wh=class{lobbies;games;constructor(){this.lobbies=new Map,this.games=new Map}async getUser(e){let[r]=await jt.select().from(Ie).where(It(Ie.id,e));return r||void 0}async getUserByEmail(e){let[r]=await jt.select().from(Ie).where(It(Ie.email,e));return r||void 0}async getUserByUsername(e){let[r]=await jt.select().from(Ie).where(It(Ie.username,e));return r||void 0}async createUser(e){let[r]=await jt.insert(Ie).values(e).returning();return r}async updateUserStats(e,r,n){let i=await this.getUser(e);if(!i)return;let[a]=await jt.update(Ie).set({gamesPlayed:i.gamesPlayed+1,gamesWon:i.gamesWon+(r?1:0),rating:Math.max(0,i.rating+n)}).where(It(Ie.id,e)).returning();return a}async updateUserPassword(e,r){let[n]=await jt.update(Ie).set({passwordHash:r}).where(It(Ie.id,e)).returning();return n||void 0}async createPasswordReset(e,r,n){await jt.insert(Gr).values({userId:e,token:r,expiresAt:n})}async getPasswordReset(e){let[r]=await jt.select().from(Gr).where(It(Gr.token,e));return r||void 0}async markPasswordResetUsed(e){await jt.update(Gr).set({used:!0}).where(It(Gr.token,e))}async getLobby(e){return this.lobbies.get(e)}async createLobby(e){let r=(0,n4.randomUUID)(),n={...e,id:r};return this.lobbies.set(r,n),n}async updateLobby(e,r){let n=this.lobbies.get(e);if(!n)return;let i={...n,...r};return this.lobbies.set(e,i),i}async deleteLobby(e){return this.lobbies.delete(e)}async getActiveLobbies(){return Array.from(this.lobbies.values()).filter(e=>e.status===\"waiting\")}async getGame(e){return this.games.get(e)}async saveGame(e){return this.games.set(e.id,e),e}async deleteGame(e){return this.games.delete(e)}async recordMatch(e,r,n,i,a){let[s]=await jt.insert(Ln).values({gameMode:e,pointGoal:r,winningTeamScore:n,losingTeamScore:i}).returning();for(let o of a)await jt.insert(Qr).values({matchId:s.id,userId:o.userId,isBot:o.isBot,teamIndex:o.teamIndex,ratingChange:o.ratingChange})}},Ee=new wh;var jB=ht(o4(),1),RB=ht(Fh(),1),DB=ht(Uh(),1),Xh=ht(Zh(),1),Yh=ht(Tk(),1);var Ik=require(\"crypto\"),MB=[\"south\",\"west\",\"north\",\"east\"];function ev(){let t=[\"spades\",\"hearts\",\"diamonds\",\"clubs\"],e=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"],r=[];for(let n of t)for(let i of e)r.push({suit:n,value:i,id:`${i}-${n}`});return r}function Ak(){let e=ev().filter(r=>!(r.value===\"2\"&&(r.suit===\"hearts\"||r.suit===\"clubs\")));return e.push({suit:\"spades\",value:\"LJ\",id:\"LJ-joker\"},{suit:\"spades\",value:\"BJ\",id:\"BJ-joker\"}),e}function Pk(t){let e=[...t];for(let r=e.length-1;r>0;r--){let n=Math.floor(Math.random()*(r+1));[e[r],e[n]]=[e[n],e[r]]}return e}function Ok(t,e){let r=[\"spades\",\"hearts\",\"clubs\",\"diamonds\"],n=e===\"ace_high\"?[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"]:[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\",\"2\",\"LJ\",\"BJ\"],i=a=>a.value===\"LJ\"||a.value===\"BJ\";return[...t].sort((a,s)=>{if(i(a)&&!i(s))return-1;if(!i(a)&&i(s))return 1;if(i(a)&&i(s))return a.value===\"BJ\"?-1:1;let o=r.indexOf(a.suit)-r.indexOf(s.suit);return o!==0?o:n.indexOf(s.value)-n.indexOf(a.value)})}var Mt=class{static createGame(e,r,n){if(e.length!==4)throw new Error(\"Spades requires exactly 4 players\");let i=r===\"ace_high\"?ev():Ak(),a=Pk(i),s=e.map((u,c)=>({id:u.id,name:u.name,isBot:u.isBot,position:MB[c],hand:Ok(a.slice(c*13,(c+1)*13),r),bid:null,tricks:0,isReady:!0})),o=[{id:\"team-1\",players:[s[0].id,s[2].id],score:0,bags:0,totalBid:null,tricksWon:0},{id:\"team-2\",players:[s[1].id,s[3].id],score:0,bags:0,totalBid:null,tricksWon:0}];return{id:(0,Ik.randomUUID)(),mode:r,pointGoal:n,phase:\"bidding\",players:s,teams:o,currentTrick:{cards:[],leadSuit:null,winnerId:null},currentPlayerIndex:0,dealerIndex:0,roundNumber:1,spadesBroken:!1,winningScore:pm[n]}}static getPlayableCards(e,r){let n=e.players[r];if(!n)return[];let i=n.hand,a=e.currentTrick.leadSuit;if(!a){if(!e.spadesBroken){let o=i.filter(u=>!ou(u,e.mode));if(o.length>0)return o}return i}let s=i.filter(o=>o.suit===a);return s.length>0?s:i}static placeBid(e,r,n){let i=e.players.findIndex(c=>c.id===r);if(i===-1)throw new Error(\"Player not found\");if(e.phase!==\"bidding\")throw new Error(\"Not in bidding phase\");if(i!==e.currentPlayerIndex)throw new Error(\"Not your turn\");let a=e.players.map((c,l)=>l===i?{...c,bid:n}:c),s=a.every(c=>c.bid!==null),o=e.teams,u=e.phase;return s&&(o=e.teams.map(c=>{let l=c.players.reduce((p,d)=>{let f=a.find(h=>h.id===d);return p+(f?.bid||0)},0);return{...c,totalBid:l}}),u=\"playing\"),{...e,players:a,teams:o,phase:u,currentPlayerIndex:s?0:(e.currentPlayerIndex+1)%4}}static playCard(e,r,n){let i=e.players.findIndex(d=>d.id===r);if(i===-1)throw new Error(\"Player not found\");if(e.phase!==\"playing\")throw new Error(\"Not in playing phase\");if(i!==e.currentPlayerIndex)throw new Error(\"Not your turn\");let s=e.players[i].hand.find(d=>d.id===n);if(!s)throw new Error(\"Card not in hand\");if(!this.getPlayableCards(e,i).some(d=>d.id===n))throw new Error(\"Card is not playable\");let u=e.players.map((d,f)=>f===i?{...d,hand:d.hand.filter(h=>h.id!==n)}:d),c=[...e.currentTrick.cards,{playerId:r,card:s}],l=e.currentTrick.leadSuit||s.suit,p=e.spadesBroken;return ou(s,e.mode)&&(p=!0),c.length===4?this.completeTrick(e,u,c,l,p):{...e,players:u,currentTrick:{cards:c,leadSuit:l,winnerId:null},currentPlayerIndex:(e.currentPlayerIndex+1)%4,spadesBroken:p}}static completeTrick(e,r,n,i,a){let s=0,o=0;n.forEach(({card:f},h)=>{let m=wr(f,e.mode,i);m>o&&(o=m,s=h)});let u=n[s].playerId,c=r.findIndex(f=>f.id===u),l=r.map(f=>f.id===u?{...f,tricks:f.tricks+1}:f),p=e.teams.map(f=>f.players.includes(u)?{...f,tricksWon:f.tricksWon+1}:f);return l.reduce((f,h)=>f+h.hand.length,0)===0?this.completeRound(e,l,p,u,c):{...e,players:l,teams:p,currentTrick:{cards:n,leadSuit:i,winnerId:u},currentPlayerIndex:c,spadesBroken:a}}static completeRound(e,r,n,i,a){let s=n.map(p=>{let d=p.totalBid||0,f=p.tricksWon,h=0,m=p.bags,x=p.players.map(E=>r.find(R=>R.id===E)),w=0;x.forEach(E=>{E.bid===0&&(E.tricks===0?w+=100:(w-=100,m+=E.tricks))});let C=x.reduce((E,R)=>E+(R.bid===0?0:R.bid||0),0),_=f-x.reduce((E,R)=>E+(R.bid===0?R.tricks:0),0);if(C>0)if(_>=C){let E=_-C;h=C*10+E,m+=E}else h=-C*10;return m>=10&&(h-=100,m=m%10),h+=w,{...p,score:p.score+h,bags:m,tricksWon:0,totalBid:null}});if(s.findIndex(p=>p.score>=e.winningScore)!==-1)return{...e,players:r.map(p=>({...p,bid:null,tricks:0})),teams:s,currentTrick:{cards:[],leadSuit:null,winnerId:i},phase:\"game_over\",currentPlayerIndex:a};let u=e.mode===\"ace_high\"?ev():Ak(),c=Pk(u),l=r.map((p,d)=>({...p,hand:Ok(c.slice(d*13,(d+1)*13),e.mode),bid:null,tricks:0}));return{...e,players:l,teams:s,currentTrick:{cards:[],leadSuit:null,winnerId:null},phase:\"bidding\",currentPlayerIndex:(e.dealerIndex+1)%4,dealerIndex:(e.dealerIndex+1)%4,roundNumber:e.roundNumber+1,spadesBroken:!1}}static clearTrick(e){return{...e,currentTrick:{cards:[],leadSuit:null,winnerId:null}}}};var uo=class{static calculateBid(e,r){let n=0;e.forEach(a=>{a.value===\"A\"&&(n+=1),a.value===\"K\"&&(n+=.5),a.value===\"Q\"&&(n+=.25),a.suit===\"spades\"&&(n+=.5),a.value===\"BJ\"&&(n+=2),a.value===\"LJ\"&&(n+=1.5),a.suit===\"spades\"&&a.value===\"2\"&&r===\"joker_joker_deuce_deuce\"&&(n+=1.5)});let i=e.filter(a=>a.suit===\"spades\"||a.value===\"LJ\"||a.value===\"BJ\").length;return n+=Math.max(0,i-2)*.5,n+=Math.random()-.5,Math.max(1,Math.min(6,Math.round(n)))}static selectCard(e,r){let i=e.players[r].hand,a=Mt.getPlayableCards(e,r);if(a.length===1)return a[0];let s=e.currentTrick,o=s.leadSuit,u=!o,c=e.players[(r+2)%4],l=s.cards.find(m=>m.playerId===c.id),p=[...a].sort((m,x)=>wr(m,e.mode,o)-wr(x,e.mode,o));if(u){let m={spades:0,hearts:0,diamonds:0,clubs:0};i.forEach(w=>{w.suit in m&&m[w.suit]++});let x=[\"hearts\",\"diamonds\",\"clubs\"].filter(w=>m[w]>0);if(x.length>0){let w=x.reduce((_,E)=>m[_]>=m[E]?_:E),C=a.filter(_=>_.suit===w);if(C.length>0){let _=C.filter(E=>[\"A\",\"K\",\"Q\"].includes(E.value));return _.length>0?_[0]:C[Math.floor(C.length/2)]}}return p[Math.floor(p.length/2)]}let d=s.cards.reduce((m,{card:x})=>Math.max(m,wr(x,e.mode,o)),0),f=!1;l&&(f=wr(l.card,e.mode,o)>=d);let h=p.filter(m=>wr(m,e.mode,o)>d);return f&&s.cards.length===3?p[0]:h.length>0?h[0]:p[0]}static shouldBreakSpades(e,r){return e.filter(i=>i.suit===\"spades\"||i.value===\"LJ\"||i.value===\"BJ\").length>=5}};var Lu=class{wss;clients=new Map;gameRooms=new Map;constructor(e){this.wss=new Yh.default({server:e,path:\"/ws\"}),this.setupConnectionHandler()}setupConnectionHandler(){this.wss.on(\"connection\",e=>{let r=`player-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,n={ws:e,playerId:r,gameId:null,lobbyId:null};this.clients.set(e,n),this.sendMessage(e,{type:\"player_joined\",payload:{playerId:r}}),e.on(\"message\",i=>{try{let a=JSON.parse(i.toString());this.handleMessage(e,a)}catch{this.sendError(e,\"Invalid message format\")}}),e.on(\"close\",()=>{this.handleDisconnect(e)}),e.on(\"error\",i=>{console.error(\"WebSocket error:\",i)})})}handleMessage(e,r){if(this.clients.get(e))switch(r.type){case\"start_game\":this.handleStartGame(e,r.payload);break;case\"place_bid\":this.handleBid(e,r.payload);break;case\"play_card\":this.handlePlayCard(e,r.payload);break;case\"leave_lobby\":this.handleLeaveLobby(e);break}}handleStartGame(e,r){let n=this.clients.get(e);if(!n)return;let{mode:i,pointGoal:a,players:s}=r;try{let o=s.map((d,f)=>f===0&&!d.isBot?{...d,id:n.playerId}:d),u=Mt.createGame(o,i,a),l=o.filter(d=>!d.isBot&&d.userId).length>=2,p={gameState:u,clients:new Map,botTimer:null,statsSaved:!1,isRanked:l};p.clients.set(n.playerId,n),n.gameId=u.id,this.gameRooms.set(u.id,p),this.broadcastGameState(u.id),this.scheduleBotMove(u.id)}catch(o){this.sendError(e,o.message)}}handleBid(e,r){let n=this.clients.get(e);if(!n||!n.gameId)return;let i=this.gameRooms.get(n.gameId);if(i)try{i.gameState=Mt.placeBid(i.gameState,n.playerId,r.bid),this.broadcastGameState(n.gameId),this.scheduleBotMove(n.gameId)}catch(a){this.sendError(e,a.message)}}handlePlayCard(e,r){let n=this.clients.get(e);if(!n||!n.gameId)return;let i=this.gameRooms.get(n.gameId);if(i)try{i.gameState=Mt.playCard(i.gameState,n.playerId,r.cardId),this.broadcastGameState(n.gameId),i.gameState.currentTrick.cards.length===4?setTimeout(()=>{let a=this.gameRooms.get(n.gameId);a&&a.gameState.currentTrick.cards.length===4&&(a.gameState=Mt.clearTrick(a.gameState),this.broadcastGameState(n.gameId),this.scheduleBotMove(n.gameId))},1500):this.scheduleBotMove(n.gameId)}catch(a){this.sendError(e,a.message)}}handleLeaveLobby(e){let r=this.clients.get(e);if(r&&r.gameId){let n=this.gameRooms.get(r.gameId);n&&(n.clients.delete(r.playerId),n.clients.size===0&&(n.botTimer&&clearTimeout(n.botTimer),this.gameRooms.delete(r.gameId))),r.gameId=null}}handleDisconnect(e){this.clients.get(e)&&(this.handleLeaveLobby(e),this.clients.delete(e))}scheduleBotMove(e){let r=this.gameRooms.get(e);if(!r)return;let{gameState:n}=r,i=n.players[n.currentPlayerIndex];if(!i||!i.isBot||n.phase!==\"bidding\"&&n.phase!==\"playing\")return;r.botTimer&&clearTimeout(r.botTimer);let a=800+Math.random()*700;r.botTimer=setTimeout(()=>{let s=this.gameRooms.get(e);if(!s)return;let{gameState:o}=s,u=o.players[o.currentPlayerIndex];if(!(!u||!u.isBot))try{if(o.phase===\"bidding\"){let c=uo.calculateBid(u.hand,o.mode);s.gameState=Mt.placeBid(o,u.id,c)}else if(o.phase===\"playing\"){let c=uo.selectCard(o,o.currentPlayerIndex);s.gameState=Mt.playCard(o,u.id,c.id)}this.broadcastGameState(e),s.gameState.currentTrick.cards.length===4?setTimeout(()=>{let c=this.gameRooms.get(e);c&&c.gameState.currentTrick.cards.length===4&&(c.gameState=Mt.clearTrick(c.gameState),this.broadcastGameState(e),this.scheduleBotMove(e))},1500):this.scheduleBotMove(e)}catch(c){console.error(\"Bot move error:\",c)}},a)}broadcastGameState(e){let r=this.gameRooms.get(e);r&&(r.clients.forEach(n=>{let i=this.sanitizeGameState(r.gameState,n.playerId);this.sendMessage(n.ws,{type:\"game_state_update\",payload:i})}),r.gameState.phase===\"game_over\"&&!r.statsSaved&&r.isRanked&&(r.statsSaved=!0,this.saveGameStats(r.gameState)))}async saveGameStats(e){try{let r=e.teams.findIndex(s=>s.score>=e.winningScore);if(r===-1)return;let n=e.teams[r],i=e.teams[r===0?1:0],a=[];for(let s of e.players){let o=n.players.includes(s.id),u=n.players.includes(s.id)?r:r===0?1:0,c=o?25:-20;a.push({userId:null,isBot:s.isBot,teamIndex:u,ratingChange:s.isBot?0:c})}await Ee.recordMatch(e.mode,e.pointGoal,n.score,i.score,a),console.log(`Game ${e.id} stats saved - Winner: Team ${r+1}`)}catch(r){console.error(\"Failed to save game stats:\",r)}}sanitizeGameState(e,r){let n=e.players.map(i=>i.id===r?i:{...i,hand:i.hand.map(()=>({suit:\"spades\",value:\"?\",id:\"hidden\"}))});return{...e,players:n}}sendMessage(e,r){e.readyState===Xh.default.OPEN&&e.send(JSON.stringify(r))}sendError(e,r){this.sendMessage(e,{type:\"error\",payload:{message:r}})}};var tv=class{queue=new Map;matchingInterval=null;onMatchFound=null;start(e){this.onMatchFound=e,this.matchingInterval=setInterval(()=>this.tryMatch(),5e3)}stop(){this.matchingInterval&&(clearInterval(this.matchingInterval),this.matchingInterval=null)}addToQueue(e,r,n){let i={id:e.id,username:e.username,rating:e.rating,queuedAt:Date.now(),gameMode:r,pointGoal:n};this.queue.set(e.id,i)}removeFromQueue(e){this.queue.delete(e)}getQueueSize(){return this.queue.size}tryMatch(){let e=Array.from(this.queue.values()),r=new Map;for(let n of e){let i=`${n.gameMode}-${n.pointGoal}`;r.has(i)||r.set(i,[]),r.get(i).push(n)}for(let[,n]of Array.from(r.entries()))if(n.length>=4){let i=this.selectBestMatch(n);if(i&&this.onMatchFound){for(let a of i.players)this.queue.delete(a.id);this.onMatchFound(i)}}}selectBestMatch(e){if(e.length<4)return null;e.sort((a,s)=>a.rating-s.rating);let r=e.filter(a=>Date.now()-a.queuedAt>6e4),n;if(r.length>=4)n=r.slice(0,4);else{let a=this.groupByRatingTier(e),s=null;for(let o of a)o.length>=4&&(!s||o.length>s.length)&&(s=o);s?n=s.slice(0,4):n=e.slice(0,4)}let i=this.balanceTeams(n);return{players:n,teams:i,gameMode:n[0].gameMode,pointGoal:n[0].pointGoal}}groupByRatingTier(e){let r=[];for(let a of e){let s=Math.floor(a.rating/300);for(;r.length<=s;)r.push([]);r[s].push(a)}let i=[];for(let a=0;a<r.length;a++){let s=[...r[a]];a>0&&s.push(...r[a-1]),a<r.length-1&&s.push(...r[a+1]),s.length>=4&&i.push(s)}return i}balanceTeams(e){let r=[...e].sort((a,s)=>s.rating-a.rating),n=[r[0],r[3]],i=[r[1],r[2]];return[n,i]}fillWithBots(e){let r=[\"SpadeMaster\",\"TrickTaker\",\"CardShark\",\"AceHunter\"],n=new Set(e.map(o=>o.username)),i=e.length>0?Math.round(e.reduce((o,u)=>o+u.rating,0)/e.length):1e3,a=[...e],s=0;for(;a.length<4;){let o=r[s%r.length];for(;n.has(o);)s++,o=`Bot${s}`;n.add(o),a.push({id:-1*(s+1),username:o,rating:i+Math.floor(Math.random()*200)-100,queuedAt:Date.now(),gameMode:e[0]?.gameMode||\"ace_high\",pointGoal:e[0]?.pointGoal||\"300\"}),s++}return a}},lo=new tv;var LB={from:process.env.EMAIL_FROM||\"noreply@housespades.com\",apiKey:process.env.EMAIL_API_KEY,domain:process.env.EMAIL_DOMAIN};async function BB(t){let{to:e,subject:r,text:n,html:i}=t;if(!LB.apiKey)return console.log(\"=== Email would be sent (DEV MODE) ===\"),console.log(`To: ${e}`),console.log(`Subject: ${r}`),console.log(`Body: ${n}`),console.log(\"======================================\"),console.log(\"Configure EMAIL_API_KEY to enable real email sending\"),{success:!0,devMode:!0};try{return console.log(`Email sent to ${e}: ${r}`),{success:!0,devMode:!1}}catch(a){return console.error(\"Failed to send email:\",a),{success:!1,devMode:!1}}}async function Nk(t,e,r){let n=`${r}/reset-password?token=${e}`,i=await BB({to:t,subject:\"Reset Your House Spades Password\",text:`","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:20.463708196Z"}
{"message":"\t\t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:20.463716803Z"}
{"message":"    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:171:5)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:20.467393189Z"}
{"message":"    at node:internal/main/run_main_module:36:49","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:20.467397416Z"}
{"message":"","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:20.467402153Z"}
{"message":"Node.js v22.21.1","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:20.467407405Z"}
{"message":"","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:20.467452762Z"}
{"message":"Error: DATABASE_URL must be set. Did you forget to provision a database?","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:20.467465077Z"}
{"message":"    at Object.<anonymous> (/app/dist/index.cjs:100:43241)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:20.467472965Z"}
{"message":"    at Module._compile (node:internal/modules/cjs/loader:1706:14)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:20.467481219Z"}
{"message":"    at Object..js (node:internal/modules/cjs/loader:1839:10)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:20.467487283Z"}
{"message":"    at Module.load (node:internal/modules/cjs/loader:1441:32)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:20.467499551Z"}
{"message":"    at Function._load (node:internal/modules/cjs/loader:1263:12)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:20.467505497Z"}
{"message":"    at TracingChannel.traceSync (node:diagnostics_channel:328:14)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:20.467510958Z"}
{"message":"    at wrapModuleLoad (node:internal/modules/cjs/loader:237:24)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:20.467517631Z"}
{"message":"npm warn config production Use `--omit=dev` instead.","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:21.367530025Z"}
{"message":"","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:21.367548451Z"}
{"message":"> rest-express@1.0.0 start","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:21.367557564Z"}
{"message":"> NODE_ENV=production node dist/index.cjs","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:21.367566708Z"}
{"message":"","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:21.367575021Z"}
{"message":"/app/dist/index.cjs:100","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:21.367582038Z"}
{"message":"\t\t`;await r.execute(y`CREATE SCHEMA IF NOT EXISTS ${y.identifier(a)}`),await r.execute(s);let u=(await r.all(y`select id, hash, created_at from ${y.identifier(a)}.${y.identifier(i)} order by created_at desc limit 1`))[0];await r.transaction(async c=>{for await(let l of e)if(!u||Number(u.created_at)<l.folderMillis){for(let p of l.sql)await c.execute(y.raw(p));await c.execute(y`insert into ${y.identifier(a)}.${y.identifier(i)} (\"hash\", \"created_at\") values(${l.hash}, ${l.folderMillis})`)}})}escapeName(e){return`\"${e}\"`}escapeParam(e){return`$${e+1}`}escapeString(e){return`'${e.replace(/'/g,\"''\")}'`}buildWithCTE(e){if(!e?.length)return;let r=[y`with `];for(let[n,i]of e.entries())r.push(y`${y.identifier(i._.alias)} as (${i._.sql})`),n<e.length-1&&r.push(y`, `);return r.push(y` `),y.join(r)}buildDeleteQuery({table:e,where:r,returning:n,withList:i}){let a=this.buildWithCTE(i),s=n?y` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,o=r?y` where ${r}`:void 0;return y`${a}delete from ${e}${o}${s}`}buildUpdateSet(e,r){let n=e[P.Symbol.Columns],i=Object.keys(n).filter(s=>r[s]!==void 0||n[s]?.onUpdateFn!==void 0),a=i.length;return y.join(i.flatMap((s,o)=>{let u=n[s],c=r[s]??y.param(u.onUpdateFn(),u),l=y`${y.identifier(this.casing.getColumnCasing(u))} = ${c}`;return o<a-1?[l,y.raw(\", \")]:[l]}))}buildUpdateQuery({table:e,set:r,where:n,returning:i,withList:a,from:s,joins:o}){let u=this.buildWithCTE(a),c=e[Be.Symbol.Name],l=e[Be.Symbol.Schema],p=e[Be.Symbol.OriginalName],d=c===p?void 0:c,f=y`${l?y`${y.identifier(l)}.`:void 0}${y.identifier(p)}${d&&y` ${y.identifier(d)}`}`,h=this.buildUpdateSet(e,r),m=s&&y.join([y.raw(\" from \"),this.buildFromTable(s)]),x=this.buildJoins(o),w=i?y` returning ${this.buildSelection(i,{isSingleTable:!s})}`:void 0,C=n?y` where ${n}`:void 0;return y`${u}update ${f} set ${h}${m}${x}${C}${w}`}buildSelection(e,{isSingleTable:r=!1}={}){let n=e.length,i=e.flatMap(({field:a},s)=>{let o=[];if(b(a,N.Aliased)&&a.isSelectionField)o.push(y.identifier(a.fieldAlias));else if(b(a,N.Aliased)||b(a,N)){let u=b(a,N.Aliased)?a.sql:a;r?o.push(new N(u.queryChunks.map(c=>b(c,T)?y.identifier(this.casing.getColumnCasing(c)):c))):o.push(u),b(a,N.Aliased)&&o.push(y` as ${y.identifier(a.fieldAlias)}`)}else b(a,K)&&(r?o.push(y.identifier(this.casing.getColumnCasing(a))):o.push(a));return s<n-1&&o.push(y`, `),o});return y.join(i)}buildJoins(e){if(!e||e.length===0)return;let r=[];for(let[n,i]of e.entries()){n===0&&r.push(y` `);let a=i.table,s=i.lateral?y` lateral`:void 0;if(b(a,Be)){let o=a[Be.Symbol.Name],u=a[Be.Symbol.Schema],c=a[Be.Symbol.OriginalName],l=o===c?void 0:i.alias;r.push(y`${y.raw(i.joinType)} join${s} ${u?y`${y.identifier(u)}.`:void 0}${y.identifier(c)}${l&&y` ${y.identifier(l)}`} on ${i.on}`)}else if(b(a,et)){let o=a[se].name,u=a[se].schema,c=a[se].originalName,l=o===c?void 0:i.alias;r.push(y`${y.raw(i.joinType)} join${s} ${u?y`${y.identifier(u)}.`:void 0}${y.identifier(c)}${l&&y` ${y.identifier(l)}`} on ${i.on}`)}else r.push(y`${y.raw(i.joinType)} join${s} ${a} on ${i.on}`);n<e.length-1&&r.push(y` `)}return y.join(r)}buildFromTable(e){if(b(e,P)&&e[P.Symbol.OriginalName]!==e[P.Symbol.Name]){let r=y`${y.identifier(e[P.Symbol.OriginalName])}`;return e[P.Symbol.Schema]&&(r=y`${y.identifier(e[P.Symbol.Schema])}.${r}`),y`${r} ${y.identifier(e[P.Symbol.Name])}`}return e}buildSelectQuery({withList:e,fields:r,fieldsFlat:n,where:i,having:a,table:s,joins:o,orderBy:u,groupBy:c,limit:l,offset:p,lockingClause:d,distinct:f,setOperators:h}){let m=n??Ot(r);for(let le of m)if(b(le.field,K)&&ut(le.field.table)!==(b(s,Te)?s._.alias:b(s,$i)?s[se].name:b(s,N)?void 0:ut(s))&&!(xe=>o?.some(({alias:mt})=>mt===(xe[P.Symbol.IsAlias]?ut(xe):xe[P.Symbol.BaseName])))(le.field.table)){let xe=ut(le.field.table);throw new Error(`Your \"${le.path.join(\"->\")}\" field references a column \"${xe}\".\"${le.field.name}\", but the table \"${xe}\" is not part of the query! Did you forget to join it?`)}let x=!o||o.length===0,w=this.buildWithCTE(e),C;f&&(C=f===!0?y` distinct`:y` distinct on (${y.join(f.on,y`, `)})`);let _=this.buildSelection(m,{isSingleTable:x}),E=this.buildFromTable(s),R=this.buildJoins(o),M=i?y` where ${i}`:void 0,I=a?y` having ${a}`:void 0,D;u&&u.length>0&&(D=y` order by ${y.join(u,y`, `)}`);let Q;c&&c.length>0&&(Q=y` group by ${y.join(c,y`, `)}`);let ke=typeof l==\"object\"||typeof l==\"number\"&&l>=0?y` limit ${l}`:void 0,rt=p?y` offset ${p}`:void 0,$e=y.empty();if(d){let le=y` for ${y.raw(d.strength)}`;d.config.of&&le.append(y` of ${y.join(Array.isArray(d.config.of)?d.config.of:[d.config.of],y`, `)}`),d.config.noWait?le.append(y` no wait`):d.config.skipLocked&&le.append(y` skip locked`),$e.append(le)}let ye=y`${w}select${C} ${_} from ${E}${R}${M}${Q}${I}${D}${ke}${rt}${$e}`;return h.length>0?this.buildSetOperations(ye,h):ye}buildSetOperations(e,r){let[n,...i]=r;if(!n)throw new Error(\"Cannot pass undefined values to any set operator\");return i.length===0?this.buildSetOperationQuery({leftSelect:e,setOperator:n}):this.buildSetOperations(this.buildSetOperationQuery({leftSelect:e,setOperator:n}),i)}buildSetOperationQuery({leftSelect:e,setOperator:{type:r,isAll:n,rightSelect:i,limit:a,orderBy:s,offset:o}}){let u=y`(${e.getSQL()}) `,c=y`(${i.getSQL()})`,l;if(s&&s.length>0){let h=[];for(let m of s)if(b(m,T))h.push(y.identifier(m.name));else if(b(m,N)){for(let x=0;x<m.queryChunks.length;x++){let w=m.queryChunks[x];b(w,T)&&(m.queryChunks[x]=y.identifier(w.name))}h.push(y`${m}`)}else h.push(y`${m}`);l=y` order by ${y.join(h,y`, `)} `}let p=typeof a==\"object\"||typeof a==\"number\"&&a>=0?y` limit ${a}`:void 0,d=y.raw(`${r} ${n?\"all \":\"\"}`),f=o?y` offset ${o}`:void 0;return y`${u}${d}${c}${l}${p}${f}`}buildInsertQuery({table:e,values:r,onConflict:n,returning:i,withList:a,select:s,overridingSystemValue_:o}){let u=[],c=e[P.Symbol.Columns],l=Object.entries(c).filter(([w,C])=>!C.shouldDisableInsert()),p=l.map(([,w])=>y.identifier(this.casing.getColumnCasing(w)));if(s){let w=r;b(w,N)?u.push(w):u.push(w.getSQL())}else{let w=r;u.push(y.raw(\"values \"));for(let[C,_]of w.entries()){let E=[];for(let[R,M]of l){let I=_[R];if(I===void 0||b(I,lt)&&I.value===void 0)if(M.defaultFn!==void 0){let D=M.defaultFn(),Q=b(D,N)?D:y.param(D,M);E.push(Q)}else if(!M.default&&M.onUpdateFn!==void 0){let D=M.onUpdateFn(),Q=b(D,N)?D:y.param(D,M);E.push(Q)}else E.push(y`default`);else E.push(I)}u.push(E),C<w.length-1&&u.push(y`, `)}}let d=this.buildWithCTE(a),f=y.join(u),h=i?y` returning ${this.buildSelection(i,{isSingleTable:!0})}`:void 0,m=n?y` on conflict ${n}`:void 0,x=o===!0?y`overriding system value `:void 0;return y`${d}insert into ${e} ${p} ${x}${f}${m}${h}`}buildRefreshMaterializedViewQuery({view:e,concurrently:r,withNoData:n}){let i=r?y` concurrently`:void 0,a=n?y` with no data`:void 0;return y`refresh materialized view${i} ${e}${a}`}prepareTyping(e){return b(e,Os)||b(e,Ps)?\"json\":b(e,Is)?\"decimal\":b(e,Ns)?\"time\":b(e,qs)||b(e,js)?\"timestamp\":b(e,Ts)||b(e,As)?\"date\":b(e,Rs)?\"uuid\":\"none\"}sqlToQuery(e,r){return e.toQuery({casing:this.casing,escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString,prepareTyping:this.prepareTyping,invokeSource:r})}buildRelationalQueryWithoutPK({fullSchema:e,schema:r,tableNamesMap:n,table:i,tableConfig:a,queryConfig:s,tableAlias:o,nestedQueryRelation:u,joinOn:c}){let l=[],p,d,f=[],h,m=[];if(s===!0)l=Object.entries(a.columns).map(([C,_])=>({dbKey:_.name,tsKey:C,field:nr(_,o),relationTableTsKey:void 0,isJson:!1,selection:[]}));else{let w=Object.fromEntries(Object.entries(a.columns).map(([I,D])=>[I,nr(D,o)]));if(s.where){let I=typeof s.where==\"function\"?s.where(w,YS()):s.where;h=I&&Es(I,o)}let C=[],_=[];if(s.columns){let I=!1;for(let[D,Q]of Object.entries(s.columns))Q!==void 0&&D in a.columns&&(!I&&Q===!0&&(I=!0),_.push(D));_.length>0&&(_=I?_.filter(D=>s.columns?.[D]===!0):Object.keys(a.columns).filter(D=>!_.includes(D)))}else _=Object.keys(a.columns);for(let I of _){let D=a.columns[I];C.push({tsKey:I,value:D})}let E=[];s.with&&(E=Object.entries(s.with).filter(I=>!!I[1]).map(([I,D])=>({tsKey:I,queryConfig:D,relation:a.relations[I]})));let R;if(s.extras){R=typeof s.extras==\"function\"?s.extras(w,{sql:y}):s.extras;for(let[I,D]of Object.entries(R))C.push({tsKey:I,value:Bd(D,o)})}for(let{tsKey:I,value:D}of C)l.push({dbKey:b(D,N.Aliased)?D.fieldAlias:a.columns[I].name,tsKey:I,field:b(D,K)?nr(D,o):D,relationTableTsKey:void 0,isJson:!1,selection:[]});let M=typeof s.orderBy==\"function\"?s.orderBy(w,eE()):s.orderBy??[];Array.isArray(M)||(M=[M]),f=M.map(I=>b(I,K)?nr(I,o):Es(I,o)),p=s.limit,d=s.offset;for(let{tsKey:I,queryConfig:D,relation:Q}of E){let ke=rE(r,n,Q),rt=Rn(Q.referencedTable),$e=n[rt],ye=`${o}_${I}`,le=Bs(...ke.fields.map((Yr,oa)=>It(nr(ke.references[oa],ye),nr(Yr,o)))),xe=this.buildRelationalQueryWithoutPK({fullSchema:e,schema:r,tableNamesMap:n,table:e[$e],tableConfig:r[$e],queryConfig:b(Q,$r)?D===!0?{limit:1}:{...D,limit:1}:D,tableAlias:ye,joinOn:le,nestedQueryRelation:Q}),mt=y`${y.identifier(ye)}.${y.identifier(\"data\")}`.as(I);m.push({on:y`true`,table:new Te(xe.sql,{},ye),alias:ye,joinType:\"left\",lateral:!0}),l.push({dbKey:I,tsKey:I,field:mt,relationTableTsKey:$e,isJson:!0,selection:xe.selection})}}if(l.length===0)throw new Ms({message:`No fields selected for table \"${a.tsName}\" (\"${o}\")`});let x;if(h=Bs(c,h),u){let w=y`json_build_array(${y.join(l.map(({field:E,tsKey:R,isJson:M})=>M?y`${y.identifier(`${o}_${R}`)}.${y.identifier(\"data\")}`:b(E,N.Aliased)?E.sql:E),y`, `)})`;b(u,Fs)&&(w=y`coalesce(json_agg(${w}${f.length>0?y` order by ${y.join(f,y`, `)}`:void 0}), '[]'::json)`);let C=[{dbKey:\"data\",tsKey:\"data\",field:w.as(\"data\"),isJson:!0,relationTableTsKey:a.tsName,selection:l}];p!==void 0||d!==void 0||f.length>0?(x=this.buildSelectQuery({table:Ss(i,o),fields:{},fieldsFlat:[{path:[],field:y.raw(\"*\")}],where:h,limit:p,offset:d,orderBy:f,setOperators:[]}),h=void 0,p=void 0,d=void 0,f=[]):x=Ss(i,o),x=this.buildSelectQuery({table:b(x,Be)?x:new Te(x,{},o),fields:{},fieldsFlat:C.map(({field:E})=>({path:[],field:b(E,K)?nr(E,o):E})),joins:m,where:h,limit:p,offset:d,orderBy:f,setOperators:[]})}else x=this.buildSelectQuery({table:Ss(i,o),fields:{},fieldsFlat:l.map(({field:w})=>({path:[],field:b(w,K)?nr(w,o):w})),joins:m,where:h,limit:p,offset:d,orderBy:f,setOperators:[]});return{tableTsKey:a.tsName,sql:x,selection:l}}};var Wc=class{static[g]=\"TypedQueryBuilder\";getSelectedFields(){return this._.selectedFields}};var Ve=class{static[g]=\"PgSelectBuilder\";fields;session;dialect;withList=[];distinct;constructor(e){this.fields=e.fields,this.session=e.session,this.dialect=e.dialect,e.withList&&(this.withList=e.withList),this.distinct=e.distinct}authToken;setToken(e){return this.authToken=e,this}from(e){let r=!!this.fields,n=e,i;return this.fields?i=this.fields:b(n,Te)?i=Object.fromEntries(Object.keys(n._.selectedFields).map(a=>[a,n[a]])):b(n,$i)?i=n[se].selectedFields:b(n,N)?i={}:i=Fc(n),new Kc({table:n,fields:i,isPartialSelect:r,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct}).setToken(this.authToken)}},am=class extends Wc{static[g]=\"PgSelectQueryBuilder\";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;constructor({table:e,fields:r,isPartialSelect:n,session:i,dialect:a,withList:s,distinct:o}){super(),this.config={withList:s,table:e,fields:{...r},distinct:o,setOperators:[]},this.isPartialSelect=n,this.session=i,this.dialect=a,this._={selectedFields:r},this.tableName=yr(e),this.joinsNotNullableMap=typeof this.tableName==\"string\"?{[this.tableName]:!0}:{}}createJoin(e){return(r,n)=>{let i=this.tableName,a=yr(r);if(typeof a==\"string\"&&this.config.joins?.some(s=>s.alias===a))throw new Error(`Alias \"${a}\" is already used in this query`);if(!this.isPartialSelect&&(Object.keys(this.joinsNotNullableMap).length===1&&typeof i==\"string\"&&(this.config.fields={[i]:this.config.fields}),typeof a==\"string\"&&!b(r,N))){let s=b(r,Te)?r._.selectedFields:b(r,et)?r[se].selectedFields:r[P.Symbol.Columns];this.config.fields[a]=s}if(typeof n==\"function\"&&(n=n(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.joins||(this.config.joins=[]),this.config.joins.push({on:n,table:r,joinType:e,alias:a}),typeof a==\"string\")switch(e){case\"left\":{this.joinsNotNullableMap[a]=!1;break}case\"right\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([s])=>[s,!1])),this.joinsNotNullableMap[a]=!0;break}case\"inner\":{this.joinsNotNullableMap[a]=!0;break}case\"full\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([s])=>[s,!1])),this.joinsNotNullableMap[a]=!1;break}}return this}}leftJoin=this.createJoin(\"left\");rightJoin=this.createJoin(\"right\");innerJoin=this.createJoin(\"inner\");fullJoin=this.createJoin(\"full\");createSetOperator(e,r){return n=>{let i=typeof n==\"function\"?n(Tj()):n;if(!ks(this.getSelectedFields(),i.getSelectedFields()))throw new Error(\"Set operator error (union / intersect / except): selected fields are not the same or are in a different order\");return this.config.setOperators.push({type:e,isAll:r,rightSelect:i}),this}}union=this.createSetOperator(\"union\",!1);unionAll=this.createSetOperator(\"union\",!0);intersect=this.createSetOperator(\"intersect\",!1);intersectAll=this.createSetOperator(\"intersect\",!0);except=this.createSetOperator(\"except\",!1);exceptAll=this.createSetOperator(\"except\",!0);addSetOperators(e){return this.config.setOperators.push(...e),this}where(e){return typeof e==\"function\"&&(e=e(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.where=e,this}having(e){return typeof e==\"function\"&&(e=e(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.having=e,this}groupBy(...e){if(typeof e[0]==\"function\"){let r=e[0](new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"alias\",sqlBehavior:\"sql\"})));this.config.groupBy=Array.isArray(r)?r:[r]}else this.config.groupBy=e;return this}orderBy(...e){if(typeof e[0]==\"function\"){let r=e[0](new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"alias\",sqlBehavior:\"sql\"}))),n=Array.isArray(r)?r:[r];this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=n:this.config.orderBy=n}else{let r=e;this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=r:this.config.orderBy=r}return this}limit(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).limit=e:this.config.limit=e,this}offset(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).offset=e:this.config.offset=e,this}for(e,r={}){return this.config.lockingClause={strength:e,config:r},this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}as(e){return new Proxy(new Te(this.getSQL(),this.config.fields,e),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"}))}getSelectedFields(){return new Proxy(this.config.fields,new _e({alias:this.tableName,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"}))}$dynamic(){return this}},Kc=class extends am{static[g]=\"PgSelect\";_prepare(e){let{session:r,config:n,dialect:i,joinsNotNullableMap:a,authToken:s}=this;if(!r)throw new Error(\"Cannot execute a query on a query builder. Please use a database instance instead.\");return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>{let o=Ot(n.fields),u=r.prepareQuery(i.sqlToQuery(this.getSQL()),o,e,!0);return u.joinsNotNullableMap=a,u.setToken(s)})}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken))};Y_(Kc,[Ge]);function Ui(t,e){return(r,n,...i)=>{let a=[n,...i].map(s=>({type:t,isAll:e,rightSelect:s}));for(let s of a)if(!ks(r.getSelectedFields(),s.rightSelect.getSelectedFields()))throw new Error(\"Set operator error (union / intersect / except): selected fields are not the same or are in a different order\");return r.addSetOperators(a)}}var Tj=()=>({union:Aj,unionAll:Pj,intersect:Oj,intersectAll:Ij,except:Nj,exceptAll:qj}),Aj=Ui(\"union\",!1),Pj=Ui(\"union\",!0),Oj=Ui(\"intersect\",!1),Ij=Ui(\"intersect\",!0),Nj=Ui(\"except\",!1),qj=Ui(\"except\",!0);var Qi=class{static[g]=\"PgQueryBuilder\";dialect;dialectConfig;constructor(e){this.dialect=b(e,Ur)?e:void 0,this.dialectConfig=b(e,Ur)?void 0:e}$with=(e,r)=>{let n=this;return{as:a=>(typeof a==\"function\"&&(a=a(n)),new Proxy(new Bi(a.getSQL(),r??(\"getSelectedFields\"in a?a.getSelectedFields()??{}:{}),e,!0),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})))}};with(...e){let r=this;function n(s){return new Ve({fields:s??void 0,session:void 0,dialect:r.getDialect(),withList:e})}function i(s){return new Ve({fields:s??void 0,session:void 0,dialect:r.getDialect(),distinct:!0})}function a(s,o){return new Ve({fields:o??void 0,session:void 0,dialect:r.getDialect(),distinct:{on:s}})}return{select:n,selectDistinct:i,selectDistinctOn:a}}select(e){return new Ve({fields:e??void 0,session:void 0,dialect:this.getDialect()})}selectDistinct(e){return new Ve({fields:e??void 0,session:void 0,dialect:this.getDialect(),distinct:!0})}selectDistinctOn(e,r){return new Ve({fields:r??void 0,session:void 0,dialect:this.getDialect(),distinct:{on:e}})}getDialect(){return this.dialect||(this.dialect=new Ur(this.dialectConfig)),this.dialect}};var zs=class{constructor(e,r,n,i,a){this.table=e,this.session=r,this.dialect=n,this.withList=i,this.overridingSystemValue_=a}static[g]=\"PgInsertBuilder\";authToken;setToken(e){return this.authToken=e,this}overridingSystemValue(){return this.overridingSystemValue_=!0,this}values(e){if(e=Array.isArray(e)?e:[e],e.length===0)throw new Error(\"values() must be called with at least one value\");let r=e.map(n=>{let i={},a=this.table[P.Symbol.Columns];for(let s of Object.keys(n)){let o=n[s];i[s]=b(o,N)?o:new lt(o,a[s])}return i});return new Zc(this.table,r,this.session,this.dialect,this.withList,!1,this.overridingSystemValue_).setToken(this.authToken)}select(e){let r=typeof e==\"function\"?e(new Qi):e;if(!b(r,N)&&!ks(this.table[Lc],r._.selectedFields))throw new Error(\"Insert select error: selected fields are not the same or are in a different order compared to the table definition\");return new Zc(this.table,r,this.session,this.dialect,this.withList,!0)}},Zc=class extends Ge{constructor(e,r,n,i,a,s,o){super(),this.session=n,this.dialect=i,this.config={table:e,values:r,withList:a,select:s,overridingSystemValue_:o}}static[g]=\"PgInsert\";config;returning(e=this.config.table[P.Symbol.Columns]){return this.config.returningFields=e,this.config.returning=Ot(e),this}onConflictDoNothing(e={}){if(e.target===void 0)this.config.onConflict=y`do nothing`;else{let r=\"\";r=Array.isArray(e.target)?e.target.map(i=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(i))).join(\",\"):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target));let n=e.where?y` where ${e.where}`:void 0;this.config.onConflict=y`(${y.raw(r)})${n} do nothing`}return this}onConflictDoUpdate(e){if(e.where&&(e.targetWhere||e.setWhere))throw new Error('You cannot use both \"where\" and \"targetWhere\"/\"setWhere\" at the same time - \"where\" is deprecated, use \"targetWhere\" or \"setWhere\" instead.');let r=e.where?y` where ${e.where}`:void 0,n=e.targetWhere?y` where ${e.targetWhere}`:void 0,i=e.setWhere?y` where ${e.setWhere}`:void 0,a=this.dialect.buildUpdateSet(this.config.table,Bc(this.config.table,e.set)),s=\"\";return s=Array.isArray(e.target)?e.target.map(o=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(o))).join(\",\"):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target)),this.config.onConflict=y`(${y.raw(s)})${n} do update set ${a}${r}${i}`,this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken));getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new _e({alias:ut(this.config.table),sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})):void 0}$dynamic(){return this}};var Jc=class extends Ge{constructor(e,r,n){super(),this.session=r,this.dialect=n,this.config={view:e}}static[g]=\"PgRefreshMaterializedView\";config;concurrently(){if(this.config.withNoData!==void 0)throw new Error(\"Cannot use concurrently and withNoData together\");return this.config.concurrently=!0,this}withNoData(){if(this.config.concurrently!==void 0)throw new Error(\"Cannot use concurrently and withNoData together\");return this.config.withNoData=!0,this}getSQL(){return this.dialect.buildRefreshMaterializedViewQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),void 0,e,!0))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken))};var $s=class{constructor(e,r,n,i){this.table=e,this.session=r,this.dialect=n,this.withList=i}static[g]=\"PgUpdateBuilder\";authToken;setToken(e){return this.authToken=e,this}set(e){return new sm(this.table,Bc(this.table,e),this.session,this.dialect,this.withList).setToken(this.authToken)}},sm=class extends Ge{constructor(e,r,n,i,a){super(),this.session=n,this.dialect=i,this.config={set:r,table:e,withList:a,joins:[]},this.tableName=yr(e),this.joinsNotNullableMap=typeof this.tableName==\"string\"?{[this.tableName]:!0}:{}}static[g]=\"PgUpdate\";config;tableName;joinsNotNullableMap;from(e){let r=e,n=yr(r);return typeof n==\"string\"&&(this.joinsNotNullableMap[n]=!0),this.config.from=r,this}getTableLikeFields(e){return b(e,Be)?e[P.Symbol.Columns]:b(e,Te)?e._.selectedFields:e[se].selectedFields}createJoin(e){return(r,n)=>{let i=yr(r);if(typeof i==\"string\"&&this.config.joins.some(a=>a.alias===i))throw new Error(`Alias \"${i}\" is already used in this query`);if(typeof n==\"function\"){let a=this.config.from&&!b(this.config.from,N)?this.getTableLikeFields(this.config.from):void 0;n=n(new Proxy(this.config.table[P.Symbol.Columns],new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})),a&&new Proxy(a,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))}if(this.config.joins.push({on:n,table:r,joinType:e,alias:i}),typeof i==\"string\")switch(e){case\"left\":{this.joinsNotNullableMap[i]=!1;break}case\"right\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([a])=>[a,!1])),this.joinsNotNullableMap[i]=!0;break}case\"inner\":{this.joinsNotNullableMap[i]=!0;break}case\"full\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([a])=>[a,!1])),this.joinsNotNullableMap[i]=!1;break}}return this}}leftJoin=this.createJoin(\"left\");rightJoin=this.createJoin(\"right\");innerJoin=this.createJoin(\"inner\");fullJoin=this.createJoin(\"full\");where(e){return this.config.where=e,this}returning(e){if(!e&&(e=Object.assign({},this.config.table[P.Symbol.Columns]),this.config.from)){let r=yr(this.config.from);if(typeof r==\"string\"&&this.config.from&&!b(this.config.from,N)){let n=this.getTableLikeFields(this.config.from);e[r]=n}for(let n of this.config.joins){let i=yr(n.table);if(typeof i==\"string\"&&!b(n.table,N)){let a=this.getTableLikeFields(n.table);e[i]=a}}}return this.config.returningFields=e,this.config.returning=Ot(e),this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){let r=this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0);return r.joinsNotNullableMap=this.joinsNotNullableMap,r}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>this._prepare().execute(e,this.authToken);getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new _e({alias:ut(this.config.table),sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})):void 0}$dynamic(){return this}};var Xc=class t extends N{constructor(e){super(t.buildEmbeddedCount(e.source,e.filters).queryChunks),this.params=e,this.mapWith(Number),this.session=e.session,this.sql=t.buildCount(e.source,e.filters)}sql;token;static[g]=\"PgCountBuilder\";[Symbol.toStringTag]=\"PgCountBuilder\";session;static buildEmbeddedCount(e,r){return y`(select count(*) from ${e}${y.raw(\" where \").if(r)}${r})`}static buildCount(e,r){return y`select count(*) as count from ${e}${y.raw(\" where \").if(r)}${r};`}setToken(e){return this.token=e,this}then(e,r){return Promise.resolve(this.session.count(this.sql,this.token)).then(e,r)}catch(e){return this.then(void 0,e)}finally(e){return this.then(r=>(e?.(),r),r=>{throw e?.(),r})}};var Yc=class{constructor(e,r,n,i,a,s,o){this.fullSchema=e,this.schema=r,this.tableNamesMap=n,this.table=i,this.tableConfig=a,this.dialect=s,this.session=o}static[g]=\"PgRelationalQueryBuilder\";findMany(e){return new eu(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},\"many\")}findFirst(e){return new eu(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},\"first\")}},eu=class extends Ge{constructor(e,r,n,i,a,s,o,u,c){super(),this.fullSchema=e,this.schema=r,this.tableNamesMap=n,this.table=i,this.tableConfig=a,this.dialect=s,this.session=o,this.config=u,this.mode=c}static[g]=\"PgRelationalQuery\";_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>{let{query:r,builtQuery:n}=this._toSQL();return this.session.prepareQuery(n,void 0,e,!0,(i,a)=>{let s=i.map(o=>Vc(this.schema,this.tableConfig,o,r.selection,a));return this.mode===\"first\"?s[0]:s})})}prepare(e){return this._prepare(e)}_getQuery(){return this.dialect.buildRelationalQueryWithoutPK({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName})}getSQL(){return this._getQuery().sql}_toSQL(){let e=this._getQuery(),r=this.dialect.sqlToQuery(e.sql);return{query:e,builtQuery:r}}toSQL(){return this._toSQL().builtQuery}authToken;setToken(e){return this.authToken=e,this}execute(){return ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(void 0,this.authToken))}};var tu=class extends Ge{constructor(e,r,n,i){super(),this.execute=e,this.sql=r,this.query=n,this.mapBatchResult=i}static[g]=\"PgRaw\";getSQL(){return this.sql}getQuery(){return this.query}mapResult(e,r){return r?this.mapBatchResult(e):e}_prepare(){return this}isResponseInArrayMode(){return!1}};var Gi=class{constructor(e,r,n){if(this.dialect=e,this.session=r,this._=n?{schema:n.schema,fullSchema:n.fullSchema,tableNamesMap:n.tableNamesMap,session:r}:{schema:void 0,fullSchema:{},tableNamesMap:{},session:r},this.query={},this._.schema)for(let[i,a]of Object.entries(this._.schema))this.query[i]=new Yc(n.fullSchema,this._.schema,this._.tableNamesMap,n.fullSchema[i],a,e,r)}static[g]=\"PgDatabase\";query;$with=(e,r)=>{let n=this;return{as:a=>(typeof a==\"function\"&&(a=a(new Qi(n.dialect))),new Proxy(new Bi(a.getSQL(),r??(\"getSelectedFields\"in a?a.getSelectedFields()??{}:{}),e,!0),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})))}};$count(e,r){return new Xc({source:e,filters:r,session:this.session})}with(...e){let r=this;function n(c){return new Ve({fields:c??void 0,session:r.session,dialect:r.dialect,withList:e})}function i(c){return new Ve({fields:c??void 0,session:r.session,dialect:r.dialect,withList:e,distinct:!0})}function a(c,l){return new Ve({fields:l??void 0,session:r.session,dialect:r.dialect,withList:e,distinct:{on:c}})}function s(c){return new $s(c,r.session,r.dialect,e)}function o(c){return new zs(c,r.session,r.dialect,e)}function u(c){return new Ds(c,r.session,r.dialect,e)}return{select:n,selectDistinct:i,selectDistinctOn:a,update:s,insert:o,delete:u}}select(e){return new Ve({fields:e??void 0,session:this.session,dialect:this.dialect})}selectDistinct(e){return new Ve({fields:e??void 0,session:this.session,dialect:this.dialect,distinct:!0})}selectDistinctOn(e,r){return new Ve({fields:r??void 0,session:this.session,dialect:this.dialect,distinct:{on:e}})}update(e){return new $s(e,this.session,this.dialect)}insert(e){return new zs(e,this.session,this.dialect)}delete(e){return new Ds(e,this.session,this.dialect)}refreshMaterializedView(e){return new Jc(e,this.session,this.dialect)}authToken;execute(e){let r=typeof e==\"string\"?y.raw(e):e.getSQL(),n=this.dialect.sqlToQuery(r),i=this.session.prepareQuery(n,void 0,void 0,!1);return new tu(()=>i.execute(void 0,this.authToken),r,n,a=>i.mapResult(a,!0))}transaction(e,r){return this.session.transaction(e,r)}};var ru=class{constructor(e){this.query=e}authToken;getQuery(){return this.query}mapResult(e,r){return e}setToken(e){return this.authToken=e,this}static[g]=\"PgPreparedQuery\";joinsNotNullableMap},nu=class{constructor(e){this.dialect=e}static[g]=\"PgSession\";execute(e,r){return ae.startActiveSpan(\"drizzle.operation\",()=>ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1)).setToken(r).execute(void 0,r))}all(e){return this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1).all()}async count(e,r){let n=await this.execute(e,r);return Number(n[0].count)}},iu=class extends Gi{constructor(e,r,n,i=0){super(e,r,n),this.schema=n,this.nestedIndex=i}static[g]=\"PgTransaction\";rollback(){throw new $c}getTransactionConfigSQL(e){let r=[];return e.isolationLevel&&r.push(`isolation level ${e.isolationLevel}`),e.accessMode&&r.push(e.accessMode),typeof e.deferrable==\"boolean\"&&r.push(e.deferrable?\"deferrable\":\"not deferrable\"),y.raw(r.join(\" \"))}setTransaction(e){return this.session.execute(y`set transaction ${this.getTransactionConfigSQL(e)}`)}};var om=class{static[g]=\"ConsoleLogWriter\";write(e){console.log(e)}},au=class{static[g]=\"DefaultLogger\";writer;constructor(e){this.writer=e?.writer??new om}logQuery(e,r){let n=r.map(a=>{try{return JSON.stringify(a)}catch{return String(a)}}),i=n.length?` -- params: [${n.join(\", \")}]`:\"\";this.writer.write(`Query: ${e}${i}`)}},su=class{static[g]=\"NoopLogger\";logQuery(){}};var he={INT8_MIN:-128,INT8_MAX:127,INT8_UNSIGNED_MAX:255,INT16_MIN:-32768,INT16_MAX:32767,INT16_UNSIGNED_MAX:65535,INT24_MIN:-8388608,INT24_MAX:8388607,INT24_UNSIGNED_MAX:16777215,INT32_MIN:-2147483648,INT32_MAX:2147483647,INT32_UNSIGNED_MAX:4294967295,INT48_MIN:-0x800000000000,INT48_MAX:0x7fffffffffff,INT48_UNSIGNED_MAX:0xffffffffffff,INT64_MIN:-9223372036854775808n,INT64_MAX:9223372036854775807n,INT64_UNSIGNED_MAX:18446744073709551615n};function Se(t,e){return e.includes(t.columnType)}function jj(t){return\"enumValues\"in t&&Array.isArray(t.enumValues)&&t.enumValues.length>0}var Rj=k.union([k.string(),k.number(),k.boolean(),k.null()]),Dj=k.union([Rj,k.record(k.any()),k.array(k.any())]),Mj=k.custom(t=>t instanceof Buffer);function iE(t,e){let r=e?.zodInstance??k,n=e?.coerce??{},i;return jj(t)&&(i=t.enumValues.length?r.enum(t.enumValues):r.string()),i||(Se(t,[\"PgGeometry\",\"PgPointTuple\"])?i=r.tuple([r.number(),r.number()]):Se(t,[\"PgGeometryObject\",\"PgPointObject\"])?i=r.object({x:r.number(),y:r.number()}):Se(t,[\"PgHalfVector\",\"PgVector\"])?(i=r.array(r.number()),i=t.dimensions?i.length(t.dimensions):i):Se(t,[\"PgLine\"])?i=r.tuple([r.number(),r.number(),r.number()]):Se(t,[\"PgLineABC\"])?i=r.object({a:r.number(),b:r.number(),c:r.number()}):Se(t,[\"PgArray\"])?(i=r.array(iE(t.baseColumn,r)),i=t.size?i.length(t.size):i):t.dataType===\"array\"?i=r.array(r.any()):t.dataType===\"number\"?i=Lj(t,r,n):t.dataType===\"bigint\"?i=Bj(t,r,n):t.dataType===\"boolean\"?i=n===!0||n.boolean?r.coerce.boolean():r.boolean():t.dataType===\"date\"?i=n===!0||n.date?r.coerce.date():r.date():t.dataType===\"string\"?i=Fj(t,r,n):t.dataType===\"json\"?i=Dj:t.dataType===\"custom\"?i=r.any():t.dataType===\"buffer\"&&(i=Mj)),i||(i=r.any()),i}function Lj(t,e,r){let n=t.getSQLType().includes(\"unsigned\"),i,a,s=!1;Se(t,[\"MySqlTinyInt\",\"SingleStoreTinyInt\"])?(i=n?0:he.INT8_MIN,a=n?he.INT8_UNSIGNED_MAX:he.INT8_MAX,s=!0):Se(t,[\"PgSmallInt\",\"PgSmallSerial\",\"MySqlSmallInt\",\"SingleStoreSmallInt\"])?(i=n?0:he.INT16_MIN,a=n?he.INT16_UNSIGNED_MAX:he.INT16_MAX,s=!0):Se(t,[\"PgReal\",\"MySqlFloat\",\"MySqlMediumInt\",\"SingleStoreMediumInt\",\"SingleStoreFloat\"])?(i=n?0:he.INT24_MIN,a=n?he.INT24_UNSIGNED_MAX:he.INT24_MAX,s=Se(t,[\"MySqlMediumInt\",\"SingleStoreMediumInt\"])):Se(t,[\"PgInteger\",\"PgSerial\",\"MySqlInt\",\"SingleStoreInt\"])?(i=n?0:he.INT32_MIN,a=n?he.INT32_UNSIGNED_MAX:he.INT32_MAX,s=!0):Se(t,[\"PgDoublePrecision\",\"MySqlReal\",\"MySqlDouble\",\"SingleStoreReal\",\"SingleStoreDouble\",\"SQLiteReal\"])?(i=n?0:he.INT48_MIN,a=n?he.INT48_UNSIGNED_MAX:he.INT48_MAX):Se(t,[\"PgBigInt53\",\"PgBigSerial53\",\"MySqlBigInt53\",\"MySqlSerial\",\"SingleStoreBigInt53\",\"SingleStoreSerial\",\"SQLiteInteger\"])?(n=n||Se(t,[\"MySqlSerial\",\"SingleStoreSerial\"]),i=n?0:Number.MIN_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER,s=!0):Se(t,[\"MySqlYear\",\"SingleStoreYear\"])?(i=1901,a=2155,s=!0):(i=Number.MIN_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER);let o=r===!0||r?.number?e.coerce.number():e.number();return o=o.min(i).max(a),s?o.int():o}function Bj(t,e,r){let n=t.getSQLType().includes(\"unsigned\"),i=n?0n:he.INT64_MIN,a=n?he.INT64_UNSIGNED_MAX:he.INT64_MAX;return(r===!0||r?.bigint?e.coerce.bigint():e.bigint()).min(i).max(a)}function Fj(t,e,r){if(Se(t,[\"PgUUID\"]))return e.string().uuid();let n,i,a=!1;Se(t,[\"PgVarchar\",\"SQLiteText\"])?n=t.length:Se(t,[\"MySqlVarChar\",\"SingleStoreVarChar\"])?n=t.length??he.INT16_UNSIGNED_MAX:Se(t,[\"MySqlText\",\"SingleStoreText\"])&&(t.textType===\"longtext\"?n=he.INT32_UNSIGNED_MAX:t.textType===\"mediumtext\"?n=he.INT24_UNSIGNED_MAX:t.textType===\"text\"?n=he.INT16_UNSIGNED_MAX:n=he.INT8_UNSIGNED_MAX),Se(t,[\"PgChar\",\"MySqlChar\",\"SingleStoreChar\"])&&(n=t.length,a=!0),Se(t,[\"PgBinaryVector\"])&&(i=/^[01]+$/,n=t.dimensions);let s=r===!0||r?.string?e.coerce.string():e.string();return s=i?s.regex(i):s,n&&a?s.length(n):n?s.max(n):s}function aE(t){return Dd(t)?Fc(t):eS(t)}function sE(t,e,r,n){let i={};for(let[a,s]of Object.entries(t)){if(!b(s,K)&&!b(s,N)&&!b(s,N.Aliased)&&typeof s==\"object\"){let p=Dd(s)||Z_(s)?aE(s):s;i[a]=sE(p,e[a]??{},r,n);continue}let o=e[a];if(o!==void 0&&typeof o!=\"function\"){i[a]=o;continue}let u=b(s,K)?s:void 0,c=u?iE(u,n):k.any(),l=typeof o==\"function\"?o(c):c;r.never(u)||(i[a]=l,u&&(r.nullable(u)&&(i[a]=i[a].nullable()),r.optional(u)&&(i[a]=i[a].optional())))}return k.object(i)}var zj={never:t=>t?.generated?.type===\"always\"||t?.generatedIdentity?.type===\"always\",optional:t=>!t.notNull||t.notNull&&t.hasDefault,nullable:t=>!t.notNull};var oE=(t,e)=>{let r=aE(t);return sE(r,e??{},zj)};var Ie=Ls(\"users\",{id:Mn(\"id\").primaryKey(),username:br(\"username\").notNull().unique(),email:br(\"email\").notNull().unique(),passwordHash:br(\"password_hash\").notNull(),rating:wt(\"rating\").notNull().default(1e3),gamesPlayed:wt(\"games_played\").notNull().default(0),gamesWon:wt(\"games_won\").notNull().default(0),createdAt:zi(\"created_at\").defaultNow().notNull()}),$j=oE(Ie).omit({id:!0,rating:!0,gamesPlayed:!0,gamesWon:!0,createdAt:!0}),Gr=Ls(\"password_resets\",{id:Mn(\"id\").primaryKey(),userId:wt(\"user_id\").notNull().references(()=>Ie.id),token:br(\"token\").notNull().unique(),expiresAt:zi(\"expires_at\").notNull(),used:Cs(\"used\").notNull().default(!1)}),Ln=Ls(\"match_history\",{id:Mn(\"id\").primaryKey(),gameMode:br(\"game_mode\").notNull(),pointGoal:br(\"point_goal\").notNull(),winningTeamScore:wt(\"winning_team_score\").notNull(),losingTeamScore:wt(\"losing_team_score\").notNull(),completedAt:zi(\"completed_at\").defaultNow().notNull()}),Qr=Ls(\"match_players\",{id:Mn(\"id\").primaryKey(),matchId:wt(\"match_id\").notNull().references(()=>Ln.id),userId:wt(\"user_id\").references(()=>Ie.id),isBot:Cs(\"is_bot\").notNull().default(!1),teamIndex:wt(\"team_index\").notNull(),ratingChange:wt(\"rating_change\").notNull().default(0)}),Uj=Hc(Ie,({many:t})=>({matchPlayers:t(Qr),passwordResets:t(Gr)})),Qj=Hc(Ln,({many:t})=>({players:t(Qr)})),Gj=Hc(Qr,({one:t})=>({match:t(Ln,{fields:[Qr.matchId],references:[Ln.id]}),user:t(Ie,{fields:[Qr.userId],references:[Ie.id]})})),cm=[\"spades\",\"hearts\",\"diamonds\",\"clubs\"],cE=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"],Vj=[...cE,\"LJ\",\"BJ\"],um=[\"ace_high\",\"joker_joker_deuce_deuce\"],lm=[\"100\",\"300\",\"500\"],pm={100:100,300:300,500:500},uE=[\"south\",\"west\",\"north\",\"east\"],dm=k.object({suit:k.enum(cm),value:k.string(),id:k.string()}),lE=k.object({id:k.string(),name:k.string(),isBot:k.boolean(),position:k.enum(uE),hand:k.array(dm),bid:k.number().nullable(),tricks:k.number(),isReady:k.boolean()}),pE=k.object({id:k.string(),players:k.array(k.string()),score:k.number(),bags:k.number(),totalBid:k.number().nullable(),tricksWon:k.number()}),dE=k.object({cards:k.array(k.object({playerId:k.string(),card:dm})),leadSuit:k.enum(cm).nullable(),winnerId:k.string().nullable()}),fE=[\"waiting\",\"bidding\",\"playing\",\"round_end\",\"game_over\"],Hj=k.object({id:k.string(),mode:k.enum(um),pointGoal:k.enum(lm),phase:k.enum(fE),players:k.array(lE),teams:k.array(pE),currentTrick:dE,currentPlayerIndex:k.number(),dealerIndex:k.number(),roundNumber:k.number(),spadesBroken:k.boolean(),winningScore:k.number()}),Wj=k.object({id:k.string(),mode:k.enum(um),pointGoal:k.enum(lm),players:k.array(k.object({id:k.string(),name:k.string(),isBot:k.boolean(),isReady:k.boolean()})),hostId:k.string(),status:k.enum([\"waiting\",\"starting\",\"in_game\"])}),Kj=k.object({id:k.number(),username:k.string(),email:k.string(),rating:k.number(),gamesPlayed:k.number(),gamesWon:k.number()}),mE=[\"join_lobby\",\"leave_lobby\",\"start_game\",\"place_bid\",\"play_card\",\"game_state_update\",\"lobby_update\",\"error\",\"player_joined\",\"player_left\",\"chat_message\"],Zj=k.object({type:k.enum(mE),payload:k.any()});function wr(t,e,r){let n=t.suit===\"spades\",i=t.suit===r;if(e===\"ace_high\"){let s=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);return n?100+s:i?50+s:s}else{if(t.value===\"BJ\")return 200;if(t.value===\"LJ\")return 199;if(n&&t.value===\"2\")return 198;if(t.suit===\"diamonds\"&&t.value===\"2\")return 197;if(n)return 100+[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);let s=[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);return i?50+s:s}}function ou(t,e){return t.suit===\"spades\"||e===\"joker_joker_deuce_deuce\"&&(t.value===\"LJ\"||t.value===\"BJ\"||t.suit===\"diamonds\"&&t.value===\"2\")}function Jj(t){if(t.value===\"LJ\")return\"Little Joker\";if(t.value===\"BJ\")return\"Big Joker\";let e={J:\"Jack\",Q:\"Queen\",K:\"King\",A:\"Ace\"},r={spades:\"Spades\",hearts:\"Hearts\",diamonds:\"Diamonds\",clubs:\"Clubs\"};return`${e[t.value]||t.value} of ${r[t.suit]}`}var _t=ht(fh(),1),YW=_t.default.Client,eK=_t.default.Pool,tK=_t.default.Connection,rK=_t.default.types,nK=_t.default.Query,iK=_t.default.DatabaseError,aK=_t.default.escapeIdentifier,sK=_t.default.escapeLiteral,oK=_t.default.Result,cK=_t.default.TypeOverrides,uK=_t.default.defaults,Kr=_t.default;var{Pool:r4,types:ar}=Kr,gh=class extends ru{constructor(e,r,n,i,a,s,o,u){super({sql:r,params:n}),this.client=e,this.params=n,this.logger=i,this.fields=a,this._isResponseInArrayMode=o,this.customResultMapper=u,this.rawQueryConfig={name:s,text:r,types:{getTypeParser:(c,l)=>c===ar.builtins.TIMESTAMPTZ?p=>p:c===ar.builtins.TIMESTAMP?p=>p:c===ar.builtins.DATE?p=>p:c===ar.builtins.INTERVAL?p=>p:ar.getTypeParser(c,l)}},this.queryConfig={name:s,text:r,rowMode:\"array\",types:{getTypeParser:(c,l)=>c===ar.builtins.TIMESTAMPTZ?p=>p:c===ar.builtins.TIMESTAMP?p=>p:c===ar.builtins.DATE?p=>p:c===ar.builtins.INTERVAL?p=>p:ar.getTypeParser(c,l)}}}static[g]=\"NodePgPreparedQuery\";rawQueryConfig;queryConfig;async execute(e={}){return ae.startActiveSpan(\"drizzle.execute\",async()=>{let r=Ld(this.params,e);this.logger.logQuery(this.rawQueryConfig.text,r);let{fields:n,rawQueryConfig:i,client:a,queryConfig:s,joinsNotNullableMap:o,customResultMapper:u}=this;if(!n&&!u)return ae.startActiveSpan(\"drizzle.driver.execute\",async l=>(l?.setAttributes({\"drizzle.query.name\":i.name,\"drizzle.query.text\":i.text,\"drizzle.query.params\":JSON.stringify(r)}),a.query(i,r)));let c=await ae.startActiveSpan(\"drizzle.driver.execute\",l=>(l?.setAttributes({\"drizzle.query.name\":s.name,\"drizzle.query.text\":s.text,\"drizzle.query.params\":JSON.stringify(r)}),a.query(s,r)));return ae.startActiveSpan(\"drizzle.mapResponse\",()=>u?u(c.rows):c.rows.map(l=>X_(n,l,o)))})}all(e={}){return ae.startActiveSpan(\"drizzle.execute\",()=>{let r=Ld(this.params,e);return this.logger.logQuery(this.rawQueryConfig.text,r),ae.startActiveSpan(\"drizzle.driver.execute\",n=>(n?.setAttributes({\"drizzle.query.name\":this.rawQueryConfig.name,\"drizzle.query.text\":this.rawQueryConfig.text,\"drizzle.query.params\":JSON.stringify(r)}),this.client.query(this.rawQueryConfig,r).then(i=>i.rows)))})}isResponseInArrayMode(){return this._isResponseInArrayMode}},Su=class t extends nu{constructor(e,r,n,i={}){super(r),this.client=e,this.schema=n,this.options=i,this.logger=i.logger??new su}static[g]=\"NodePgSession\";logger;prepareQuery(e,r,n,i,a){return new gh(this.client,e.sql,e.params,this.logger,r,n,i,a)}async transaction(e,r){let n=this.client instanceof r4?new t(await this.client.connect(),this.dialect,this.schema,this.options):this,i=new yh(this.dialect,n,this.schema);await i.execute(y`begin${r?y` ${i.getTransactionConfigSQL(r)}`:void 0}`);try{let a=await e(i);return await i.execute(y`commit`),a}catch(a){throw await i.execute(y`rollback`),a}finally{this.client instanceof r4&&n.client.release()}}async count(e){let r=await this.execute(e);return Number(r.rows[0].count)}},yh=class t extends iu{static[g]=\"NodePgTransaction\";async transaction(e){let r=`sp${this.nestedIndex+1}`,n=new t(this.dialect,this.session,this.schema,this.nestedIndex+1);await n.execute(y.raw(`savepoint ${r}`));try{let i=await e(n);return await n.execute(y.raw(`release savepoint ${r}`)),i}catch(i){throw await n.execute(y.raw(`rollback to savepoint ${r}`)),i}}};var xh=class{constructor(e,r,n={}){this.client=e,this.dialect=r,this.options=n}static[g]=\"NodePgDriver\";createSession(e){return new Su(this.client,this.dialect,e,{logger:this.options.logger})}},bh=class extends Gi{static[g]=\"NodePgDatabase\"};function Ys(t,e={}){let r=new Ur({casing:e.casing}),n;e.logger===!0?n=new au:e.logger!==!1&&(n=e.logger);let i;if(e.schema){let u=tE(e.schema,nE);i={fullSchema:e.schema,schema:u.tables,tableNamesMap:u.tableNamesMap}}let s=new xh(t,r,{logger:n}).createSession(i),o=new bh(r,s,i);return o.$client=t,o}function Eu(...t){if(typeof t[0]==\"string\"){let e=new Kr.Pool({connectionString:t[0]});return Ys(e,t[1])}if(tS(t[0])){let{connection:e,client:r,...n}=t[0];if(r)return Ys(r,n);let i=typeof e==\"string\"?new Kr.Pool({connectionString:e}):new Kr.Pool(e);return Ys(i,n)}return Ys(t[0],t[1])}(t=>{function e(r){return Ys({},r)}t.mock=e})(Eu||(Eu={}));var{Pool:sL}=Kr;if(!process.env.DATABASE_URL)throw new Error(\"DATABASE_URL must be set. Did you forget to provision a database?\");var oL=new sL({connectionString:process.env.DATABASE_URL}),jt=Eu(oL,{schema:fm});var n4=require(\"crypto\"),wh=class{lobbies;games;constructor(){this.lobbies=new Map,this.games=new Map}async getUser(e){let[r]=await jt.select().from(Ie).where(It(Ie.id,e));return r||void 0}async getUserByEmail(e){let[r]=await jt.select().from(Ie).where(It(Ie.email,e));return r||void 0}async getUserByUsername(e){let[r]=await jt.select().from(Ie).where(It(Ie.username,e));return r||void 0}async createUser(e){let[r]=await jt.insert(Ie).values(e).returning();return r}async updateUserStats(e,r,n){let i=await this.getUser(e);if(!i)return;let[a]=await jt.update(Ie).set({gamesPlayed:i.gamesPlayed+1,gamesWon:i.gamesWon+(r?1:0),rating:Math.max(0,i.rating+n)}).where(It(Ie.id,e)).returning();return a}async updateUserPassword(e,r){let[n]=await jt.update(Ie).set({passwordHash:r}).where(It(Ie.id,e)).returning();return n||void 0}async createPasswordReset(e,r,n){await jt.insert(Gr).values({userId:e,token:r,expiresAt:n})}async getPasswordReset(e){let[r]=await jt.select().from(Gr).where(It(Gr.token,e));return r||void 0}async markPasswordResetUsed(e){await jt.update(Gr).set({used:!0}).where(It(Gr.token,e))}async getLobby(e){return this.lobbies.get(e)}async createLobby(e){let r=(0,n4.randomUUID)(),n={...e,id:r};return this.lobbies.set(r,n),n}async updateLobby(e,r){let n=this.lobbies.get(e);if(!n)return;let i={...n,...r};return this.lobbies.set(e,i),i}async deleteLobby(e){return this.lobbies.delete(e)}async getActiveLobbies(){return Array.from(this.lobbies.values()).filter(e=>e.status===\"waiting\")}async getGame(e){return this.games.get(e)}async saveGame(e){return this.games.set(e.id,e),e}async deleteGame(e){return this.games.delete(e)}async recordMatch(e,r,n,i,a){let[s]=await jt.insert(Ln).values({gameMode:e,pointGoal:r,winningTeamScore:n,losingTeamScore:i}).returning();for(let o of a)await jt.insert(Qr).values({matchId:s.id,userId:o.userId,isBot:o.isBot,teamIndex:o.teamIndex,ratingChange:o.ratingChange})}},Ee=new wh;var jB=ht(o4(),1),RB=ht(Fh(),1),DB=ht(Uh(),1),Xh=ht(Zh(),1),Yh=ht(Tk(),1);var Ik=require(\"crypto\"),MB=[\"south\",\"west\",\"north\",\"east\"];function ev(){let t=[\"spades\",\"hearts\",\"diamonds\",\"clubs\"],e=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"],r=[];for(let n of t)for(let i of e)r.push({suit:n,value:i,id:`${i}-${n}`});return r}function Ak(){let e=ev().filter(r=>!(r.value===\"2\"&&(r.suit===\"hearts\"||r.suit===\"clubs\")));return e.push({suit:\"spades\",value:\"LJ\",id:\"LJ-joker\"},{suit:\"spades\",value:\"BJ\",id:\"BJ-joker\"}),e}function Pk(t){let e=[...t];for(let r=e.length-1;r>0;r--){let n=Math.floor(Math.random()*(r+1));[e[r],e[n]]=[e[n],e[r]]}return e}function Ok(t,e){let r=[\"spades\",\"hearts\",\"clubs\",\"diamonds\"],n=e===\"ace_high\"?[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"]:[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\",\"2\",\"LJ\",\"BJ\"],i=a=>a.value===\"LJ\"||a.value===\"BJ\";return[...t].sort((a,s)=>{if(i(a)&&!i(s))return-1;if(!i(a)&&i(s))return 1;if(i(a)&&i(s))return a.value===\"BJ\"?-1:1;let o=r.indexOf(a.suit)-r.indexOf(s.suit);return o!==0?o:n.indexOf(s.value)-n.indexOf(a.value)})}var Mt=class{static createGame(e,r,n){if(e.length!==4)throw new Error(\"Spades requires exactly 4 players\");let i=r===\"ace_high\"?ev():Ak(),a=Pk(i),s=e.map((u,c)=>({id:u.id,name:u.name,isBot:u.isBot,position:MB[c],hand:Ok(a.slice(c*13,(c+1)*13),r),bid:null,tricks:0,isReady:!0})),o=[{id:\"team-1\",players:[s[0].id,s[2].id],score:0,bags:0,totalBid:null,tricksWon:0},{id:\"team-2\",players:[s[1].id,s[3].id],score:0,bags:0,totalBid:null,tricksWon:0}];return{id:(0,Ik.randomUUID)(),mode:r,pointGoal:n,phase:\"bidding\",players:s,teams:o,currentTrick:{cards:[],leadSuit:null,winnerId:null},currentPlayerIndex:0,dealerIndex:0,roundNumber:1,spadesBroken:!1,winningScore:pm[n]}}static getPlayableCards(e,r){let n=e.players[r];if(!n)return[];let i=n.hand,a=e.currentTrick.leadSuit;if(!a){if(!e.spadesBroken){let o=i.filter(u=>!ou(u,e.mode));if(o.length>0)return o}return i}let s=i.filter(o=>o.suit===a);return s.length>0?s:i}static placeBid(e,r,n){let i=e.players.findIndex(c=>c.id===r);if(i===-1)throw new Error(\"Player not found\");if(e.phase!==\"bidding\")throw new Error(\"Not in bidding phase\");if(i!==e.currentPlayerIndex)throw new Error(\"Not your turn\");let a=e.players.map((c,l)=>l===i?{...c,bid:n}:c),s=a.every(c=>c.bid!==null),o=e.teams,u=e.phase;return s&&(o=e.teams.map(c=>{let l=c.players.reduce((p,d)=>{let f=a.find(h=>h.id===d);return p+(f?.bid||0)},0);return{...c,totalBid:l}}),u=\"playing\"),{...e,players:a,teams:o,phase:u,currentPlayerIndex:s?0:(e.currentPlayerIndex+1)%4}}static playCard(e,r,n){let i=e.players.findIndex(d=>d.id===r);if(i===-1)throw new Error(\"Player not found\");if(e.phase!==\"playing\")throw new Error(\"Not in playing phase\");if(i!==e.currentPlayerIndex)throw new Error(\"Not your turn\");let s=e.players[i].hand.find(d=>d.id===n);if(!s)throw new Error(\"Card not in hand\");if(!this.getPlayableCards(e,i).some(d=>d.id===n))throw new Error(\"Card is not playable\");let u=e.players.map((d,f)=>f===i?{...d,hand:d.hand.filter(h=>h.id!==n)}:d),c=[...e.currentTrick.cards,{playerId:r,card:s}],l=e.currentTrick.leadSuit||s.suit,p=e.spadesBroken;return ou(s,e.mode)&&(p=!0),c.length===4?this.completeTrick(e,u,c,l,p):{...e,players:u,currentTrick:{cards:c,leadSuit:l,winnerId:null},currentPlayerIndex:(e.currentPlayerIndex+1)%4,spadesBroken:p}}static completeTrick(e,r,n,i,a){let s=0,o=0;n.forEach(({card:f},h)=>{let m=wr(f,e.mode,i);m>o&&(o=m,s=h)});let u=n[s].playerId,c=r.findIndex(f=>f.id===u),l=r.map(f=>f.id===u?{...f,tricks:f.tricks+1}:f),p=e.teams.map(f=>f.players.includes(u)?{...f,tricksWon:f.tricksWon+1}:f);return l.reduce((f,h)=>f+h.hand.length,0)===0?this.completeRound(e,l,p,u,c):{...e,players:l,teams:p,currentTrick:{cards:n,leadSuit:i,winnerId:u},currentPlayerIndex:c,spadesBroken:a}}static completeRound(e,r,n,i,a){let s=n.map(p=>{let d=p.totalBid||0,f=p.tricksWon,h=0,m=p.bags,x=p.players.map(E=>r.find(R=>R.id===E)),w=0;x.forEach(E=>{E.bid===0&&(E.tricks===0?w+=100:(w-=100,m+=E.tricks))});let C=x.reduce((E,R)=>E+(R.bid===0?0:R.bid||0),0),_=f-x.reduce((E,R)=>E+(R.bid===0?R.tricks:0),0);if(C>0)if(_>=C){let E=_-C;h=C*10+E,m+=E}else h=-C*10;return m>=10&&(h-=100,m=m%10),h+=w,{...p,score:p.score+h,bags:m,tricksWon:0,totalBid:null}});if(s.findIndex(p=>p.score>=e.winningScore)!==-1)return{...e,players:r.map(p=>({...p,bid:null,tricks:0})),teams:s,currentTrick:{cards:[],leadSuit:null,winnerId:i},phase:\"game_over\",currentPlayerIndex:a};let u=e.mode===\"ace_high\"?ev():Ak(),c=Pk(u),l=r.map((p,d)=>({...p,hand:Ok(c.slice(d*13,(d+1)*13),e.mode),bid:null,tricks:0}));return{...e,players:l,teams:s,currentTrick:{cards:[],leadSuit:null,winnerId:null},phase:\"bidding\",currentPlayerIndex:(e.dealerIndex+1)%4,dealerIndex:(e.dealerIndex+1)%4,roundNumber:e.roundNumber+1,spadesBroken:!1}}static clearTrick(e){return{...e,currentTrick:{cards:[],leadSuit:null,winnerId:null}}}};var uo=class{static calculateBid(e,r){let n=0;e.forEach(a=>{a.value===\"A\"&&(n+=1),a.value===\"K\"&&(n+=.5),a.value===\"Q\"&&(n+=.25),a.suit===\"spades\"&&(n+=.5),a.value===\"BJ\"&&(n+=2),a.value===\"LJ\"&&(n+=1.5),a.suit===\"spades\"&&a.value===\"2\"&&r===\"joker_joker_deuce_deuce\"&&(n+=1.5)});let i=e.filter(a=>a.suit===\"spades\"||a.value===\"LJ\"||a.value===\"BJ\").length;return n+=Math.max(0,i-2)*.5,n+=Math.random()-.5,Math.max(1,Math.min(6,Math.round(n)))}static selectCard(e,r){let i=e.players[r].hand,a=Mt.getPlayableCards(e,r);if(a.length===1)return a[0];let s=e.currentTrick,o=s.leadSuit,u=!o,c=e.players[(r+2)%4],l=s.cards.find(m=>m.playerId===c.id),p=[...a].sort((m,x)=>wr(m,e.mode,o)-wr(x,e.mode,o));if(u){let m={spades:0,hearts:0,diamonds:0,clubs:0};i.forEach(w=>{w.suit in m&&m[w.suit]++});let x=[\"hearts\",\"diamonds\",\"clubs\"].filter(w=>m[w]>0);if(x.length>0){let w=x.reduce((_,E)=>m[_]>=m[E]?_:E),C=a.filter(_=>_.suit===w);if(C.length>0){let _=C.filter(E=>[\"A\",\"K\",\"Q\"].includes(E.value));return _.length>0?_[0]:C[Math.floor(C.length/2)]}}return p[Math.floor(p.length/2)]}let d=s.cards.reduce((m,{card:x})=>Math.max(m,wr(x,e.mode,o)),0),f=!1;l&&(f=wr(l.card,e.mode,o)>=d);let h=p.filter(m=>wr(m,e.mode,o)>d);return f&&s.cards.length===3?p[0]:h.length>0?h[0]:p[0]}static shouldBreakSpades(e,r){return e.filter(i=>i.suit===\"spades\"||i.value===\"LJ\"||i.value===\"BJ\").length>=5}};var Lu=class{wss;clients=new Map;gameRooms=new Map;constructor(e){this.wss=new Yh.default({server:e,path:\"/ws\"}),this.setupConnectionHandler()}setupConnectionHandler(){this.wss.on(\"connection\",e=>{let r=`player-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,n={ws:e,playerId:r,gameId:null,lobbyId:null};this.clients.set(e,n),this.sendMessage(e,{type:\"player_joined\",payload:{playerId:r}}),e.on(\"message\",i=>{try{let a=JSON.parse(i.toString());this.handleMessage(e,a)}catch{this.sendError(e,\"Invalid message format\")}}),e.on(\"close\",()=>{this.handleDisconnect(e)}),e.on(\"error\",i=>{console.error(\"WebSocket error:\",i)})})}handleMessage(e,r){if(this.clients.get(e))switch(r.type){case\"start_game\":this.handleStartGame(e,r.payload);break;case\"place_bid\":this.handleBid(e,r.payload);break;case\"play_card\":this.handlePlayCard(e,r.payload);break;case\"leave_lobby\":this.handleLeaveLobby(e);break}}handleStartGame(e,r){let n=this.clients.get(e);if(!n)return;let{mode:i,pointGoal:a,players:s}=r;try{let o=s.map((d,f)=>f===0&&!d.isBot?{...d,id:n.playerId}:d),u=Mt.createGame(o,i,a),l=o.filter(d=>!d.isBot&&d.userId).length>=2,p={gameState:u,clients:new Map,botTimer:null,statsSaved:!1,isRanked:l};p.clients.set(n.playerId,n),n.gameId=u.id,this.gameRooms.set(u.id,p),this.broadcastGameState(u.id),this.scheduleBotMove(u.id)}catch(o){this.sendError(e,o.message)}}handleBid(e,r){let n=this.clients.get(e);if(!n||!n.gameId)return;let i=this.gameRooms.get(n.gameId);if(i)try{i.gameState=Mt.placeBid(i.gameState,n.playerId,r.bid),this.broadcastGameState(n.gameId),this.scheduleBotMove(n.gameId)}catch(a){this.sendError(e,a.message)}}handlePlayCard(e,r){let n=this.clients.get(e);if(!n||!n.gameId)return;let i=this.gameRooms.get(n.gameId);if(i)try{i.gameState=Mt.playCard(i.gameState,n.playerId,r.cardId),this.broadcastGameState(n.gameId),i.gameState.currentTrick.cards.length===4?setTimeout(()=>{let a=this.gameRooms.get(n.gameId);a&&a.gameState.currentTrick.cards.length===4&&(a.gameState=Mt.clearTrick(a.gameState),this.broadcastGameState(n.gameId),this.scheduleBotMove(n.gameId))},1500):this.scheduleBotMove(n.gameId)}catch(a){this.sendError(e,a.message)}}handleLeaveLobby(e){let r=this.clients.get(e);if(r&&r.gameId){let n=this.gameRooms.get(r.gameId);n&&(n.clients.delete(r.playerId),n.clients.size===0&&(n.botTimer&&clearTimeout(n.botTimer),this.gameRooms.delete(r.gameId))),r.gameId=null}}handleDisconnect(e){this.clients.get(e)&&(this.handleLeaveLobby(e),this.clients.delete(e))}scheduleBotMove(e){let r=this.gameRooms.get(e);if(!r)return;let{gameState:n}=r,i=n.players[n.currentPlayerIndex];if(!i||!i.isBot||n.phase!==\"bidding\"&&n.phase!==\"playing\")return;r.botTimer&&clearTimeout(r.botTimer);let a=800+Math.random()*700;r.botTimer=setTimeout(()=>{let s=this.gameRooms.get(e);if(!s)return;let{gameState:o}=s,u=o.players[o.currentPlayerIndex];if(!(!u||!u.isBot))try{if(o.phase===\"bidding\"){let c=uo.calculateBid(u.hand,o.mode);s.gameState=Mt.placeBid(o,u.id,c)}else if(o.phase===\"playing\"){let c=uo.selectCard(o,o.currentPlayerIndex);s.gameState=Mt.playCard(o,u.id,c.id)}this.broadcastGameState(e),s.gameState.currentTrick.cards.length===4?setTimeout(()=>{let c=this.gameRooms.get(e);c&&c.gameState.currentTrick.cards.length===4&&(c.gameState=Mt.clearTrick(c.gameState),this.broadcastGameState(e),this.scheduleBotMove(e))},1500):this.scheduleBotMove(e)}catch(c){console.error(\"Bot move error:\",c)}},a)}broadcastGameState(e){let r=this.gameRooms.get(e);r&&(r.clients.forEach(n=>{let i=this.sanitizeGameState(r.gameState,n.playerId);this.sendMessage(n.ws,{type:\"game_state_update\",payload:i})}),r.gameState.phase===\"game_over\"&&!r.statsSaved&&r.isRanked&&(r.statsSaved=!0,this.saveGameStats(r.gameState)))}async saveGameStats(e){try{let r=e.teams.findIndex(s=>s.score>=e.winningScore);if(r===-1)return;let n=e.teams[r],i=e.teams[r===0?1:0],a=[];for(let s of e.players){let o=n.players.includes(s.id),u=n.players.includes(s.id)?r:r===0?1:0,c=o?25:-20;a.push({userId:null,isBot:s.isBot,teamIndex:u,ratingChange:s.isBot?0:c})}await Ee.recordMatch(e.mode,e.pointGoal,n.score,i.score,a),console.log(`Game ${e.id} stats saved - Winner: Team ${r+1}`)}catch(r){console.error(\"Failed to save game stats:\",r)}}sanitizeGameState(e,r){let n=e.players.map(i=>i.id===r?i:{...i,hand:i.hand.map(()=>({suit:\"spades\",value:\"?\",id:\"hidden\"}))});return{...e,players:n}}sendMessage(e,r){e.readyState===Xh.default.OPEN&&e.send(JSON.stringify(r))}sendError(e,r){this.sendMessage(e,{type:\"error\",payload:{message:r}})}};var tv=class{queue=new Map;matchingInterval=null;onMatchFound=null;start(e){this.onMatchFound=e,this.matchingInterval=setInterval(()=>this.tryMatch(),5e3)}stop(){this.matchingInterval&&(clearInterval(this.matchingInterval),this.matchingInterval=null)}addToQueue(e,r,n){let i={id:e.id,username:e.username,rating:e.rating,queuedAt:Date.now(),gameMode:r,pointGoal:n};this.queue.set(e.id,i)}removeFromQueue(e){this.queue.delete(e)}getQueueSize(){return this.queue.size}tryMatch(){let e=Array.from(this.queue.values()),r=new Map;for(let n of e){let i=`${n.gameMode}-${n.pointGoal}`;r.has(i)||r.set(i,[]),r.get(i).push(n)}for(let[,n]of Array.from(r.entries()))if(n.length>=4){let i=this.selectBestMatch(n);if(i&&this.onMatchFound){for(let a of i.players)this.queue.delete(a.id);this.onMatchFound(i)}}}selectBestMatch(e){if(e.length<4)return null;e.sort((a,s)=>a.rating-s.rating);let r=e.filter(a=>Date.now()-a.queuedAt>6e4),n;if(r.length>=4)n=r.slice(0,4);else{let a=this.groupByRatingTier(e),s=null;for(let o of a)o.length>=4&&(!s||o.length>s.length)&&(s=o);s?n=s.slice(0,4):n=e.slice(0,4)}let i=this.balanceTeams(n);return{players:n,teams:i,gameMode:n[0].gameMode,pointGoal:n[0].pointGoal}}groupByRatingTier(e){let r=[];for(let a of e){let s=Math.floor(a.rating/300);for(;r.length<=s;)r.push([]);r[s].push(a)}let i=[];for(let a=0;a<r.length;a++){let s=[...r[a]];a>0&&s.push(...r[a-1]),a<r.length-1&&s.push(...r[a+1]),s.length>=4&&i.push(s)}return i}balanceTeams(e){let r=[...e].sort((a,s)=>s.rating-a.rating),n=[r[0],r[3]],i=[r[1],r[2]];return[n,i]}fillWithBots(e){let r=[\"SpadeMaster\",\"TrickTaker\",\"CardShark\",\"AceHunter\"],n=new Set(e.map(o=>o.username)),i=e.length>0?Math.round(e.reduce((o,u)=>o+u.rating,0)/e.length):1e3,a=[...e],s=0;for(;a.length<4;){let o=r[s%r.length];for(;n.has(o);)s++,o=`Bot${s}`;n.add(o),a.push({id:-1*(s+1),username:o,rating:i+Math.floor(Math.random()*200)-100,queuedAt:Date.now(),gameMode:e[0]?.gameMode||\"ace_high\",pointGoal:e[0]?.pointGoal||\"300\"}),s++}return a}},lo=new tv;var LB={from:process.env.EMAIL_FROM||\"noreply@housespades.com\",apiKey:process.env.EMAIL_API_KEY,domain:process.env.EMAIL_DOMAIN};async function BB(t){let{to:e,subject:r,text:n,html:i}=t;if(!LB.apiKey)return console.log(\"=== Email would be sent (DEV MODE) ===\"),console.log(`To: ${e}`),console.log(`Subject: ${r}`),console.log(`Body: ${n}`),console.log(\"======================================\"),console.log(\"Configure EMAIL_API_KEY to enable real email sending\"),{success:!0,devMode:!0};try{return console.log(`Email sent to ${e}: ${r}`),{success:!0,devMode:!1}}catch(a){return console.error(\"Failed to send email:\",a),{success:!1,devMode:!1}}}async function Nk(t,e,r){let n=`${r}/reset-password?token=${e}`,i=await BB({to:t,subject:\"Reset Your House Spades Password\",text:`","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:21.410329437Z"}
{"message":"\t\t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:21.410341276Z"}
{"message":"","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:21.414232550Z"}
{"message":"Error: DATABASE_URL must be set. Did you forget to provision a database?","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:21.414241094Z"}
{"message":"    at Object.<anonymous> (/app/dist/index.cjs:100:43241)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:21.414247463Z"}
{"message":"    at Module._compile (node:internal/modules/cjs/loader:1706:14)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:21.414258195Z"}
{"message":"    at Object..js (node:internal/modules/cjs/loader:1839:10)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:21.414269452Z"}
{"message":"    at Module.load (node:internal/modules/cjs/loader:1441:32)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:21.414277978Z"}
{"message":"    at Function._load (node:internal/modules/cjs/loader:1263:12)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:21.414284863Z"}
{"message":"    at TracingChannel.traceSync (node:diagnostics_channel:328:14)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:21.414291116Z"}
{"message":"    at wrapModuleLoad (node:internal/modules/cjs/loader:237:24)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:21.414297256Z"}
{"message":"    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:171:5)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:21.414304109Z"}
{"message":"    at node:internal/main/run_main_module:36:49","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:21.414310459Z"}
{"message":"","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:21.414317515Z"}
{"message":"Node.js v22.21.1","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:21.414323778Z"}
{"message":"npm warn config production Use `--omit=dev` instead.","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:22.366786364Z"}
{"message":"","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:22.402781655Z"}
{"message":"> rest-express@1.0.0 start","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:22.402790703Z"}
{"message":"> NODE_ENV=production node dist/index.cjs","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:22.402797553Z"}
{"message":"","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:22.402802968Z"}
{"message":"/app/dist/index.cjs:100","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:22.550121452Z"}
{"message":"\t\t`;await r.execute(y`CREATE SCHEMA IF NOT EXISTS ${y.identifier(a)}`),await r.execute(s);let u=(await r.all(y`select id, hash, created_at from ${y.identifier(a)}.${y.identifier(i)} order by created_at desc limit 1`))[0];await r.transaction(async c=>{for await(let l of e)if(!u||Number(u.created_at)<l.folderMillis){for(let p of l.sql)await c.execute(y.raw(p));await c.execute(y`insert into ${y.identifier(a)}.${y.identifier(i)} (\"hash\", \"created_at\") values(${l.hash}, ${l.folderMillis})`)}})}escapeName(e){return`\"${e}\"`}escapeParam(e){return`$${e+1}`}escapeString(e){return`'${e.replace(/'/g,\"''\")}'`}buildWithCTE(e){if(!e?.length)return;let r=[y`with `];for(let[n,i]of e.entries())r.push(y`${y.identifier(i._.alias)} as (${i._.sql})`),n<e.length-1&&r.push(y`, `);return r.push(y` `),y.join(r)}buildDeleteQuery({table:e,where:r,returning:n,withList:i}){let a=this.buildWithCTE(i),s=n?y` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,o=r?y` where ${r}`:void 0;return y`${a}delete from ${e}${o}${s}`}buildUpdateSet(e,r){let n=e[P.Symbol.Columns],i=Object.keys(n).filter(s=>r[s]!==void 0||n[s]?.onUpdateFn!==void 0),a=i.length;return y.join(i.flatMap((s,o)=>{let u=n[s],c=r[s]??y.param(u.onUpdateFn(),u),l=y`${y.identifier(this.casing.getColumnCasing(u))} = ${c}`;return o<a-1?[l,y.raw(\", \")]:[l]}))}buildUpdateQuery({table:e,set:r,where:n,returning:i,withList:a,from:s,joins:o}){let u=this.buildWithCTE(a),c=e[Be.Symbol.Name],l=e[Be.Symbol.Schema],p=e[Be.Symbol.OriginalName],d=c===p?void 0:c,f=y`${l?y`${y.identifier(l)}.`:void 0}${y.identifier(p)}${d&&y` ${y.identifier(d)}`}`,h=this.buildUpdateSet(e,r),m=s&&y.join([y.raw(\" from \"),this.buildFromTable(s)]),x=this.buildJoins(o),w=i?y` returning ${this.buildSelection(i,{isSingleTable:!s})}`:void 0,C=n?y` where ${n}`:void 0;return y`${u}update ${f} set ${h}${m}${x}${C}${w}`}buildSelection(e,{isSingleTable:r=!1}={}){let n=e.length,i=e.flatMap(({field:a},s)=>{let o=[];if(b(a,N.Aliased)&&a.isSelectionField)o.push(y.identifier(a.fieldAlias));else if(b(a,N.Aliased)||b(a,N)){let u=b(a,N.Aliased)?a.sql:a;r?o.push(new N(u.queryChunks.map(c=>b(c,T)?y.identifier(this.casing.getColumnCasing(c)):c))):o.push(u),b(a,N.Aliased)&&o.push(y` as ${y.identifier(a.fieldAlias)}`)}else b(a,K)&&(r?o.push(y.identifier(this.casing.getColumnCasing(a))):o.push(a));return s<n-1&&o.push(y`, `),o});return y.join(i)}buildJoins(e){if(!e||e.length===0)return;let r=[];for(let[n,i]of e.entries()){n===0&&r.push(y` `);let a=i.table,s=i.lateral?y` lateral`:void 0;if(b(a,Be)){let o=a[Be.Symbol.Name],u=a[Be.Symbol.Schema],c=a[Be.Symbol.OriginalName],l=o===c?void 0:i.alias;r.push(y`${y.raw(i.joinType)} join${s} ${u?y`${y.identifier(u)}.`:void 0}${y.identifier(c)}${l&&y` ${y.identifier(l)}`} on ${i.on}`)}else if(b(a,et)){let o=a[se].name,u=a[se].schema,c=a[se].originalName,l=o===c?void 0:i.alias;r.push(y`${y.raw(i.joinType)} join${s} ${u?y`${y.identifier(u)}.`:void 0}${y.identifier(c)}${l&&y` ${y.identifier(l)}`} on ${i.on}`)}else r.push(y`${y.raw(i.joinType)} join${s} ${a} on ${i.on}`);n<e.length-1&&r.push(y` `)}return y.join(r)}buildFromTable(e){if(b(e,P)&&e[P.Symbol.OriginalName]!==e[P.Symbol.Name]){let r=y`${y.identifier(e[P.Symbol.OriginalName])}`;return e[P.Symbol.Schema]&&(r=y`${y.identifier(e[P.Symbol.Schema])}.${r}`),y`${r} ${y.identifier(e[P.Symbol.Name])}`}return e}buildSelectQuery({withList:e,fields:r,fieldsFlat:n,where:i,having:a,table:s,joins:o,orderBy:u,groupBy:c,limit:l,offset:p,lockingClause:d,distinct:f,setOperators:h}){let m=n??Ot(r);for(let le of m)if(b(le.field,K)&&ut(le.field.table)!==(b(s,Te)?s._.alias:b(s,$i)?s[se].name:b(s,N)?void 0:ut(s))&&!(xe=>o?.some(({alias:mt})=>mt===(xe[P.Symbol.IsAlias]?ut(xe):xe[P.Symbol.BaseName])))(le.field.table)){let xe=ut(le.field.table);throw new Error(`Your \"${le.path.join(\"->\")}\" field references a column \"${xe}\".\"${le.field.name}\", but the table \"${xe}\" is not part of the query! Did you forget to join it?`)}let x=!o||o.length===0,w=this.buildWithCTE(e),C;f&&(C=f===!0?y` distinct`:y` distinct on (${y.join(f.on,y`, `)})`);let _=this.buildSelection(m,{isSingleTable:x}),E=this.buildFromTable(s),R=this.buildJoins(o),M=i?y` where ${i}`:void 0,I=a?y` having ${a}`:void 0,D;u&&u.length>0&&(D=y` order by ${y.join(u,y`, `)}`);let Q;c&&c.length>0&&(Q=y` group by ${y.join(c,y`, `)}`);let ke=typeof l==\"object\"||typeof l==\"number\"&&l>=0?y` limit ${l}`:void 0,rt=p?y` offset ${p}`:void 0,$e=y.empty();if(d){let le=y` for ${y.raw(d.strength)}`;d.config.of&&le.append(y` of ${y.join(Array.isArray(d.config.of)?d.config.of:[d.config.of],y`, `)}`),d.config.noWait?le.append(y` no wait`):d.config.skipLocked&&le.append(y` skip locked`),$e.append(le)}let ye=y`${w}select${C} ${_} from ${E}${R}${M}${Q}${I}${D}${ke}${rt}${$e}`;return h.length>0?this.buildSetOperations(ye,h):ye}buildSetOperations(e,r){let[n,...i]=r;if(!n)throw new Error(\"Cannot pass undefined values to any set operator\");return i.length===0?this.buildSetOperationQuery({leftSelect:e,setOperator:n}):this.buildSetOperations(this.buildSetOperationQuery({leftSelect:e,setOperator:n}),i)}buildSetOperationQuery({leftSelect:e,setOperator:{type:r,isAll:n,rightSelect:i,limit:a,orderBy:s,offset:o}}){let u=y`(${e.getSQL()}) `,c=y`(${i.getSQL()})`,l;if(s&&s.length>0){let h=[];for(let m of s)if(b(m,T))h.push(y.identifier(m.name));else if(b(m,N)){for(let x=0;x<m.queryChunks.length;x++){let w=m.queryChunks[x];b(w,T)&&(m.queryChunks[x]=y.identifier(w.name))}h.push(y`${m}`)}else h.push(y`${m}`);l=y` order by ${y.join(h,y`, `)} `}let p=typeof a==\"object\"||typeof a==\"number\"&&a>=0?y` limit ${a}`:void 0,d=y.raw(`${r} ${n?\"all \":\"\"}`),f=o?y` offset ${o}`:void 0;return y`${u}${d}${c}${l}${p}${f}`}buildInsertQuery({table:e,values:r,onConflict:n,returning:i,withList:a,select:s,overridingSystemValue_:o}){let u=[],c=e[P.Symbol.Columns],l=Object.entries(c).filter(([w,C])=>!C.shouldDisableInsert()),p=l.map(([,w])=>y.identifier(this.casing.getColumnCasing(w)));if(s){let w=r;b(w,N)?u.push(w):u.push(w.getSQL())}else{let w=r;u.push(y.raw(\"values \"));for(let[C,_]of w.entries()){let E=[];for(let[R,M]of l){let I=_[R];if(I===void 0||b(I,lt)&&I.value===void 0)if(M.defaultFn!==void 0){let D=M.defaultFn(),Q=b(D,N)?D:y.param(D,M);E.push(Q)}else if(!M.default&&M.onUpdateFn!==void 0){let D=M.onUpdateFn(),Q=b(D,N)?D:y.param(D,M);E.push(Q)}else E.push(y`default`);else E.push(I)}u.push(E),C<w.length-1&&u.push(y`, `)}}let d=this.buildWithCTE(a),f=y.join(u),h=i?y` returning ${this.buildSelection(i,{isSingleTable:!0})}`:void 0,m=n?y` on conflict ${n}`:void 0,x=o===!0?y`overriding system value `:void 0;return y`${d}insert into ${e} ${p} ${x}${f}${m}${h}`}buildRefreshMaterializedViewQuery({view:e,concurrently:r,withNoData:n}){let i=r?y` concurrently`:void 0,a=n?y` with no data`:void 0;return y`refresh materialized view${i} ${e}${a}`}prepareTyping(e){return b(e,Os)||b(e,Ps)?\"json\":b(e,Is)?\"decimal\":b(e,Ns)?\"time\":b(e,qs)||b(e,js)?\"timestamp\":b(e,Ts)||b(e,As)?\"date\":b(e,Rs)?\"uuid\":\"none\"}sqlToQuery(e,r){return e.toQuery({casing:this.casing,escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString,prepareTyping:this.prepareTyping,invokeSource:r})}buildRelationalQueryWithoutPK({fullSchema:e,schema:r,tableNamesMap:n,table:i,tableConfig:a,queryConfig:s,tableAlias:o,nestedQueryRelation:u,joinOn:c}){let l=[],p,d,f=[],h,m=[];if(s===!0)l=Object.entries(a.columns).map(([C,_])=>({dbKey:_.name,tsKey:C,field:nr(_,o),relationTableTsKey:void 0,isJson:!1,selection:[]}));else{let w=Object.fromEntries(Object.entries(a.columns).map(([I,D])=>[I,nr(D,o)]));if(s.where){let I=typeof s.where==\"function\"?s.where(w,YS()):s.where;h=I&&Es(I,o)}let C=[],_=[];if(s.columns){let I=!1;for(let[D,Q]of Object.entries(s.columns))Q!==void 0&&D in a.columns&&(!I&&Q===!0&&(I=!0),_.push(D));_.length>0&&(_=I?_.filter(D=>s.columns?.[D]===!0):Object.keys(a.columns).filter(D=>!_.includes(D)))}else _=Object.keys(a.columns);for(let I of _){let D=a.columns[I];C.push({tsKey:I,value:D})}let E=[];s.with&&(E=Object.entries(s.with).filter(I=>!!I[1]).map(([I,D])=>({tsKey:I,queryConfig:D,relation:a.relations[I]})));let R;if(s.extras){R=typeof s.extras==\"function\"?s.extras(w,{sql:y}):s.extras;for(let[I,D]of Object.entries(R))C.push({tsKey:I,value:Bd(D,o)})}for(let{tsKey:I,value:D}of C)l.push({dbKey:b(D,N.Aliased)?D.fieldAlias:a.columns[I].name,tsKey:I,field:b(D,K)?nr(D,o):D,relationTableTsKey:void 0,isJson:!1,selection:[]});let M=typeof s.orderBy==\"function\"?s.orderBy(w,eE()):s.orderBy??[];Array.isArray(M)||(M=[M]),f=M.map(I=>b(I,K)?nr(I,o):Es(I,o)),p=s.limit,d=s.offset;for(let{tsKey:I,queryConfig:D,relation:Q}of E){let ke=rE(r,n,Q),rt=Rn(Q.referencedTable),$e=n[rt],ye=`${o}_${I}`,le=Bs(...ke.fields.map((Yr,oa)=>It(nr(ke.references[oa],ye),nr(Yr,o)))),xe=this.buildRelationalQueryWithoutPK({fullSchema:e,schema:r,tableNamesMap:n,table:e[$e],tableConfig:r[$e],queryConfig:b(Q,$r)?D===!0?{limit:1}:{...D,limit:1}:D,tableAlias:ye,joinOn:le,nestedQueryRelation:Q}),mt=y`${y.identifier(ye)}.${y.identifier(\"data\")}`.as(I);m.push({on:y`true`,table:new Te(xe.sql,{},ye),alias:ye,joinType:\"left\",lateral:!0}),l.push({dbKey:I,tsKey:I,field:mt,relationTableTsKey:$e,isJson:!0,selection:xe.selection})}}if(l.length===0)throw new Ms({message:`No fields selected for table \"${a.tsName}\" (\"${o}\")`});let x;if(h=Bs(c,h),u){let w=y`json_build_array(${y.join(l.map(({field:E,tsKey:R,isJson:M})=>M?y`${y.identifier(`${o}_${R}`)}.${y.identifier(\"data\")}`:b(E,N.Aliased)?E.sql:E),y`, `)})`;b(u,Fs)&&(w=y`coalesce(json_agg(${w}${f.length>0?y` order by ${y.join(f,y`, `)}`:void 0}), '[]'::json)`);let C=[{dbKey:\"data\",tsKey:\"data\",field:w.as(\"data\"),isJson:!0,relationTableTsKey:a.tsName,selection:l}];p!==void 0||d!==void 0||f.length>0?(x=this.buildSelectQuery({table:Ss(i,o),fields:{},fieldsFlat:[{path:[],field:y.raw(\"*\")}],where:h,limit:p,offset:d,orderBy:f,setOperators:[]}),h=void 0,p=void 0,d=void 0,f=[]):x=Ss(i,o),x=this.buildSelectQuery({table:b(x,Be)?x:new Te(x,{},o),fields:{},fieldsFlat:C.map(({field:E})=>({path:[],field:b(E,K)?nr(E,o):E})),joins:m,where:h,limit:p,offset:d,orderBy:f,setOperators:[]})}else x=this.buildSelectQuery({table:Ss(i,o),fields:{},fieldsFlat:l.map(({field:w})=>({path:[],field:b(w,K)?nr(w,o):w})),joins:m,where:h,limit:p,offset:d,orderBy:f,setOperators:[]});return{tableTsKey:a.tsName,sql:x,selection:l}}};var Wc=class{static[g]=\"TypedQueryBuilder\";getSelectedFields(){return this._.selectedFields}};var Ve=class{static[g]=\"PgSelectBuilder\";fields;session;dialect;withList=[];distinct;constructor(e){this.fields=e.fields,this.session=e.session,this.dialect=e.dialect,e.withList&&(this.withList=e.withList),this.distinct=e.distinct}authToken;setToken(e){return this.authToken=e,this}from(e){let r=!!this.fields,n=e,i;return this.fields?i=this.fields:b(n,Te)?i=Object.fromEntries(Object.keys(n._.selectedFields).map(a=>[a,n[a]])):b(n,$i)?i=n[se].selectedFields:b(n,N)?i={}:i=Fc(n),new Kc({table:n,fields:i,isPartialSelect:r,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct}).setToken(this.authToken)}},am=class extends Wc{static[g]=\"PgSelectQueryBuilder\";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;constructor({table:e,fields:r,isPartialSelect:n,session:i,dialect:a,withList:s,distinct:o}){super(),this.config={withList:s,table:e,fields:{...r},distinct:o,setOperators:[]},this.isPartialSelect=n,this.session=i,this.dialect=a,this._={selectedFields:r},this.tableName=yr(e),this.joinsNotNullableMap=typeof this.tableName==\"string\"?{[this.tableName]:!0}:{}}createJoin(e){return(r,n)=>{let i=this.tableName,a=yr(r);if(typeof a==\"string\"&&this.config.joins?.some(s=>s.alias===a))throw new Error(`Alias \"${a}\" is already used in this query`);if(!this.isPartialSelect&&(Object.keys(this.joinsNotNullableMap).length===1&&typeof i==\"string\"&&(this.config.fields={[i]:this.config.fields}),typeof a==\"string\"&&!b(r,N))){let s=b(r,Te)?r._.selectedFields:b(r,et)?r[se].selectedFields:r[P.Symbol.Columns];this.config.fields[a]=s}if(typeof n==\"function\"&&(n=n(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.joins||(this.config.joins=[]),this.config.joins.push({on:n,table:r,joinType:e,alias:a}),typeof a==\"string\")switch(e){case\"left\":{this.joinsNotNullableMap[a]=!1;break}case\"right\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([s])=>[s,!1])),this.joinsNotNullableMap[a]=!0;break}case\"inner\":{this.joinsNotNullableMap[a]=!0;break}case\"full\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([s])=>[s,!1])),this.joinsNotNullableMap[a]=!1;break}}return this}}leftJoin=this.createJoin(\"left\");rightJoin=this.createJoin(\"right\");innerJoin=this.createJoin(\"inner\");fullJoin=this.createJoin(\"full\");createSetOperator(e,r){return n=>{let i=typeof n==\"function\"?n(Tj()):n;if(!ks(this.getSelectedFields(),i.getSelectedFields()))throw new Error(\"Set operator error (union / intersect / except): selected fields are not the same or are in a different order\");return this.config.setOperators.push({type:e,isAll:r,rightSelect:i}),this}}union=this.createSetOperator(\"union\",!1);unionAll=this.createSetOperator(\"union\",!0);intersect=this.createSetOperator(\"intersect\",!1);intersectAll=this.createSetOperator(\"intersect\",!0);except=this.createSetOperator(\"except\",!1);exceptAll=this.createSetOperator(\"except\",!0);addSetOperators(e){return this.config.setOperators.push(...e),this}where(e){return typeof e==\"function\"&&(e=e(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.where=e,this}having(e){return typeof e==\"function\"&&(e=e(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.having=e,this}groupBy(...e){if(typeof e[0]==\"function\"){let r=e[0](new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"alias\",sqlBehavior:\"sql\"})));this.config.groupBy=Array.isArray(r)?r:[r]}else this.config.groupBy=e;return this}orderBy(...e){if(typeof e[0]==\"function\"){let r=e[0](new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"alias\",sqlBehavior:\"sql\"}))),n=Array.isArray(r)?r:[r];this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=n:this.config.orderBy=n}else{let r=e;this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=r:this.config.orderBy=r}return this}limit(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).limit=e:this.config.limit=e,this}offset(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).offset=e:this.config.offset=e,this}for(e,r={}){return this.config.lockingClause={strength:e,config:r},this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}as(e){return new Proxy(new Te(this.getSQL(),this.config.fields,e),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"}))}getSelectedFields(){return new Proxy(this.config.fields,new _e({alias:this.tableName,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"}))}$dynamic(){return this}},Kc=class extends am{static[g]=\"PgSelect\";_prepare(e){let{session:r,config:n,dialect:i,joinsNotNullableMap:a,authToken:s}=this;if(!r)throw new Error(\"Cannot execute a query on a query builder. Please use a database instance instead.\");return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>{let o=Ot(n.fields),u=r.prepareQuery(i.sqlToQuery(this.getSQL()),o,e,!0);return u.joinsNotNullableMap=a,u.setToken(s)})}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken))};Y_(Kc,[Ge]);function Ui(t,e){return(r,n,...i)=>{let a=[n,...i].map(s=>({type:t,isAll:e,rightSelect:s}));for(let s of a)if(!ks(r.getSelectedFields(),s.rightSelect.getSelectedFields()))throw new Error(\"Set operator error (union / intersect / except): selected fields are not the same or are in a different order\");return r.addSetOperators(a)}}var Tj=()=>({union:Aj,unionAll:Pj,intersect:Oj,intersectAll:Ij,except:Nj,exceptAll:qj}),Aj=Ui(\"union\",!1),Pj=Ui(\"union\",!0),Oj=Ui(\"intersect\",!1),Ij=Ui(\"intersect\",!0),Nj=Ui(\"except\",!1),qj=Ui(\"except\",!0);var Qi=class{static[g]=\"PgQueryBuilder\";dialect;dialectConfig;constructor(e){this.dialect=b(e,Ur)?e:void 0,this.dialectConfig=b(e,Ur)?void 0:e}$with=(e,r)=>{let n=this;return{as:a=>(typeof a==\"function\"&&(a=a(n)),new Proxy(new Bi(a.getSQL(),r??(\"getSelectedFields\"in a?a.getSelectedFields()??{}:{}),e,!0),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})))}};with(...e){let r=this;function n(s){return new Ve({fields:s??void 0,session:void 0,dialect:r.getDialect(),withList:e})}function i(s){return new Ve({fields:s??void 0,session:void 0,dialect:r.getDialect(),distinct:!0})}function a(s,o){return new Ve({fields:o??void 0,session:void 0,dialect:r.getDialect(),distinct:{on:s}})}return{select:n,selectDistinct:i,selectDistinctOn:a}}select(e){return new Ve({fields:e??void 0,session:void 0,dialect:this.getDialect()})}selectDistinct(e){return new Ve({fields:e??void 0,session:void 0,dialect:this.getDialect(),distinct:!0})}selectDistinctOn(e,r){return new Ve({fields:r??void 0,session:void 0,dialect:this.getDialect(),distinct:{on:e}})}getDialect(){return this.dialect||(this.dialect=new Ur(this.dialectConfig)),this.dialect}};var zs=class{constructor(e,r,n,i,a){this.table=e,this.session=r,this.dialect=n,this.withList=i,this.overridingSystemValue_=a}static[g]=\"PgInsertBuilder\";authToken;setToken(e){return this.authToken=e,this}overridingSystemValue(){return this.overridingSystemValue_=!0,this}values(e){if(e=Array.isArray(e)?e:[e],e.length===0)throw new Error(\"values() must be called with at least one value\");let r=e.map(n=>{let i={},a=this.table[P.Symbol.Columns];for(let s of Object.keys(n)){let o=n[s];i[s]=b(o,N)?o:new lt(o,a[s])}return i});return new Zc(this.table,r,this.session,this.dialect,this.withList,!1,this.overridingSystemValue_).setToken(this.authToken)}select(e){let r=typeof e==\"function\"?e(new Qi):e;if(!b(r,N)&&!ks(this.table[Lc],r._.selectedFields))throw new Error(\"Insert select error: selected fields are not the same or are in a different order compared to the table definition\");return new Zc(this.table,r,this.session,this.dialect,this.withList,!0)}},Zc=class extends Ge{constructor(e,r,n,i,a,s,o){super(),this.session=n,this.dialect=i,this.config={table:e,values:r,withList:a,select:s,overridingSystemValue_:o}}static[g]=\"PgInsert\";config;returning(e=this.config.table[P.Symbol.Columns]){return this.config.returningFields=e,this.config.returning=Ot(e),this}onConflictDoNothing(e={}){if(e.target===void 0)this.config.onConflict=y`do nothing`;else{let r=\"\";r=Array.isArray(e.target)?e.target.map(i=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(i))).join(\",\"):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target));let n=e.where?y` where ${e.where}`:void 0;this.config.onConflict=y`(${y.raw(r)})${n} do nothing`}return this}onConflictDoUpdate(e){if(e.where&&(e.targetWhere||e.setWhere))throw new Error('You cannot use both \"where\" and \"targetWhere\"/\"setWhere\" at the same time - \"where\" is deprecated, use \"targetWhere\" or \"setWhere\" instead.');let r=e.where?y` where ${e.where}`:void 0,n=e.targetWhere?y` where ${e.targetWhere}`:void 0,i=e.setWhere?y` where ${e.setWhere}`:void 0,a=this.dialect.buildUpdateSet(this.config.table,Bc(this.config.table,e.set)),s=\"\";return s=Array.isArray(e.target)?e.target.map(o=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(o))).join(\",\"):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target)),this.config.onConflict=y`(${y.raw(s)})${n} do update set ${a}${r}${i}`,this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken));getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new _e({alias:ut(this.config.table),sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})):void 0}$dynamic(){return this}};var Jc=class extends Ge{constructor(e,r,n){super(),this.session=r,this.dialect=n,this.config={view:e}}static[g]=\"PgRefreshMaterializedView\";config;concurrently(){if(this.config.withNoData!==void 0)throw new Error(\"Cannot use concurrently and withNoData together\");return this.config.concurrently=!0,this}withNoData(){if(this.config.concurrently!==void 0)throw new Error(\"Cannot use concurrently and withNoData together\");return this.config.withNoData=!0,this}getSQL(){return this.dialect.buildRefreshMaterializedViewQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),void 0,e,!0))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken))};var $s=class{constructor(e,r,n,i){this.table=e,this.session=r,this.dialect=n,this.withList=i}static[g]=\"PgUpdateBuilder\";authToken;setToken(e){return this.authToken=e,this}set(e){return new sm(this.table,Bc(this.table,e),this.session,this.dialect,this.withList).setToken(this.authToken)}},sm=class extends Ge{constructor(e,r,n,i,a){super(),this.session=n,this.dialect=i,this.config={set:r,table:e,withList:a,joins:[]},this.tableName=yr(e),this.joinsNotNullableMap=typeof this.tableName==\"string\"?{[this.tableName]:!0}:{}}static[g]=\"PgUpdate\";config;tableName;joinsNotNullableMap;from(e){let r=e,n=yr(r);return typeof n==\"string\"&&(this.joinsNotNullableMap[n]=!0),this.config.from=r,this}getTableLikeFields(e){return b(e,Be)?e[P.Symbol.Columns]:b(e,Te)?e._.selectedFields:e[se].selectedFields}createJoin(e){return(r,n)=>{let i=yr(r);if(typeof i==\"string\"&&this.config.joins.some(a=>a.alias===i))throw new Error(`Alias \"${i}\" is already used in this query`);if(typeof n==\"function\"){let a=this.config.from&&!b(this.config.from,N)?this.getTableLikeFields(this.config.from):void 0;n=n(new Proxy(this.config.table[P.Symbol.Columns],new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})),a&&new Proxy(a,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))}if(this.config.joins.push({on:n,table:r,joinType:e,alias:i}),typeof i==\"string\")switch(e){case\"left\":{this.joinsNotNullableMap[i]=!1;break}case\"right\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([a])=>[a,!1])),this.joinsNotNullableMap[i]=!0;break}case\"inner\":{this.joinsNotNullableMap[i]=!0;break}case\"full\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([a])=>[a,!1])),this.joinsNotNullableMap[i]=!1;break}}return this}}leftJoin=this.createJoin(\"left\");rightJoin=this.createJoin(\"right\");innerJoin=this.createJoin(\"inner\");fullJoin=this.createJoin(\"full\");where(e){return this.config.where=e,this}returning(e){if(!e&&(e=Object.assign({},this.config.table[P.Symbol.Columns]),this.config.from)){let r=yr(this.config.from);if(typeof r==\"string\"&&this.config.from&&!b(this.config.from,N)){let n=this.getTableLikeFields(this.config.from);e[r]=n}for(let n of this.config.joins){let i=yr(n.table);if(typeof i==\"string\"&&!b(n.table,N)){let a=this.getTableLikeFields(n.table);e[i]=a}}}return this.config.returningFields=e,this.config.returning=Ot(e),this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){let r=this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0);return r.joinsNotNullableMap=this.joinsNotNullableMap,r}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>this._prepare().execute(e,this.authToken);getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new _e({alias:ut(this.config.table),sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})):void 0}$dynamic(){return this}};var Xc=class t extends N{constructor(e){super(t.buildEmbeddedCount(e.source,e.filters).queryChunks),this.params=e,this.mapWith(Number),this.session=e.session,this.sql=t.buildCount(e.source,e.filters)}sql;token;static[g]=\"PgCountBuilder\";[Symbol.toStringTag]=\"PgCountBuilder\";session;static buildEmbeddedCount(e,r){return y`(select count(*) from ${e}${y.raw(\" where \").if(r)}${r})`}static buildCount(e,r){return y`select count(*) as count from ${e}${y.raw(\" where \").if(r)}${r};`}setToken(e){return this.token=e,this}then(e,r){return Promise.resolve(this.session.count(this.sql,this.token)).then(e,r)}catch(e){return this.then(void 0,e)}finally(e){return this.then(r=>(e?.(),r),r=>{throw e?.(),r})}};var Yc=class{constructor(e,r,n,i,a,s,o){this.fullSchema=e,this.schema=r,this.tableNamesMap=n,this.table=i,this.tableConfig=a,this.dialect=s,this.session=o}static[g]=\"PgRelationalQueryBuilder\";findMany(e){return new eu(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},\"many\")}findFirst(e){return new eu(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},\"first\")}},eu=class extends Ge{constructor(e,r,n,i,a,s,o,u,c){super(),this.fullSchema=e,this.schema=r,this.tableNamesMap=n,this.table=i,this.tableConfig=a,this.dialect=s,this.session=o,this.config=u,this.mode=c}static[g]=\"PgRelationalQuery\";_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>{let{query:r,builtQuery:n}=this._toSQL();return this.session.prepareQuery(n,void 0,e,!0,(i,a)=>{let s=i.map(o=>Vc(this.schema,this.tableConfig,o,r.selection,a));return this.mode===\"first\"?s[0]:s})})}prepare(e){return this._prepare(e)}_getQuery(){return this.dialect.buildRelationalQueryWithoutPK({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName})}getSQL(){return this._getQuery().sql}_toSQL(){let e=this._getQuery(),r=this.dialect.sqlToQuery(e.sql);return{query:e,builtQuery:r}}toSQL(){return this._toSQL().builtQuery}authToken;setToken(e){return this.authToken=e,this}execute(){return ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(void 0,this.authToken))}};var tu=class extends Ge{constructor(e,r,n,i){super(),this.execute=e,this.sql=r,this.query=n,this.mapBatchResult=i}static[g]=\"PgRaw\";getSQL(){return this.sql}getQuery(){return this.query}mapResult(e,r){return r?this.mapBatchResult(e):e}_prepare(){return this}isResponseInArrayMode(){return!1}};var Gi=class{constructor(e,r,n){if(this.dialect=e,this.session=r,this._=n?{schema:n.schema,fullSchema:n.fullSchema,tableNamesMap:n.tableNamesMap,session:r}:{schema:void 0,fullSchema:{},tableNamesMap:{},session:r},this.query={},this._.schema)for(let[i,a]of Object.entries(this._.schema))this.query[i]=new Yc(n.fullSchema,this._.schema,this._.tableNamesMap,n.fullSchema[i],a,e,r)}static[g]=\"PgDatabase\";query;$with=(e,r)=>{let n=this;return{as:a=>(typeof a==\"function\"&&(a=a(new Qi(n.dialect))),new Proxy(new Bi(a.getSQL(),r??(\"getSelectedFields\"in a?a.getSelectedFields()??{}:{}),e,!0),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})))}};$count(e,r){return new Xc({source:e,filters:r,session:this.session})}with(...e){let r=this;function n(c){return new Ve({fields:c??void 0,session:r.session,dialect:r.dialect,withList:e})}function i(c){return new Ve({fields:c??void 0,session:r.session,dialect:r.dialect,withList:e,distinct:!0})}function a(c,l){return new Ve({fields:l??void 0,session:r.session,dialect:r.dialect,withList:e,distinct:{on:c}})}function s(c){return new $s(c,r.session,r.dialect,e)}function o(c){return new zs(c,r.session,r.dialect,e)}function u(c){return new Ds(c,r.session,r.dialect,e)}return{select:n,selectDistinct:i,selectDistinctOn:a,update:s,insert:o,delete:u}}select(e){return new Ve({fields:e??void 0,session:this.session,dialect:this.dialect})}selectDistinct(e){return new Ve({fields:e??void 0,session:this.session,dialect:this.dialect,distinct:!0})}selectDistinctOn(e,r){return new Ve({fields:r??void 0,session:this.session,dialect:this.dialect,distinct:{on:e}})}update(e){return new $s(e,this.session,this.dialect)}insert(e){return new zs(e,this.session,this.dialect)}delete(e){return new Ds(e,this.session,this.dialect)}refreshMaterializedView(e){return new Jc(e,this.session,this.dialect)}authToken;execute(e){let r=typeof e==\"string\"?y.raw(e):e.getSQL(),n=this.dialect.sqlToQuery(r),i=this.session.prepareQuery(n,void 0,void 0,!1);return new tu(()=>i.execute(void 0,this.authToken),r,n,a=>i.mapResult(a,!0))}transaction(e,r){return this.session.transaction(e,r)}};var ru=class{constructor(e){this.query=e}authToken;getQuery(){return this.query}mapResult(e,r){return e}setToken(e){return this.authToken=e,this}static[g]=\"PgPreparedQuery\";joinsNotNullableMap},nu=class{constructor(e){this.dialect=e}static[g]=\"PgSession\";execute(e,r){return ae.startActiveSpan(\"drizzle.operation\",()=>ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1)).setToken(r).execute(void 0,r))}all(e){return this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1).all()}async count(e,r){let n=await this.execute(e,r);return Number(n[0].count)}},iu=class extends Gi{constructor(e,r,n,i=0){super(e,r,n),this.schema=n,this.nestedIndex=i}static[g]=\"PgTransaction\";rollback(){throw new $c}getTransactionConfigSQL(e){let r=[];return e.isolationLevel&&r.push(`isolation level ${e.isolationLevel}`),e.accessMode&&r.push(e.accessMode),typeof e.deferrable==\"boolean\"&&r.push(e.deferrable?\"deferrable\":\"not deferrable\"),y.raw(r.join(\" \"))}setTransaction(e){return this.session.execute(y`set transaction ${this.getTransactionConfigSQL(e)}`)}};var om=class{static[g]=\"ConsoleLogWriter\";write(e){console.log(e)}},au=class{static[g]=\"DefaultLogger\";writer;constructor(e){this.writer=e?.writer??new om}logQuery(e,r){let n=r.map(a=>{try{return JSON.stringify(a)}catch{return String(a)}}),i=n.length?` -- params: [${n.join(\", \")}]`:\"\";this.writer.write(`Query: ${e}${i}`)}},su=class{static[g]=\"NoopLogger\";logQuery(){}};var he={INT8_MIN:-128,INT8_MAX:127,INT8_UNSIGNED_MAX:255,INT16_MIN:-32768,INT16_MAX:32767,INT16_UNSIGNED_MAX:65535,INT24_MIN:-8388608,INT24_MAX:8388607,INT24_UNSIGNED_MAX:16777215,INT32_MIN:-2147483648,INT32_MAX:2147483647,INT32_UNSIGNED_MAX:4294967295,INT48_MIN:-0x800000000000,INT48_MAX:0x7fffffffffff,INT48_UNSIGNED_MAX:0xffffffffffff,INT64_MIN:-9223372036854775808n,INT64_MAX:9223372036854775807n,INT64_UNSIGNED_MAX:18446744073709551615n};function Se(t,e){return e.includes(t.columnType)}function jj(t){return\"enumValues\"in t&&Array.isArray(t.enumValues)&&t.enumValues.length>0}var Rj=k.union([k.string(),k.number(),k.boolean(),k.null()]),Dj=k.union([Rj,k.record(k.any()),k.array(k.any())]),Mj=k.custom(t=>t instanceof Buffer);function iE(t,e){let r=e?.zodInstance??k,n=e?.coerce??{},i;return jj(t)&&(i=t.enumValues.length?r.enum(t.enumValues):r.string()),i||(Se(t,[\"PgGeometry\",\"PgPointTuple\"])?i=r.tuple([r.number(),r.number()]):Se(t,[\"PgGeometryObject\",\"PgPointObject\"])?i=r.object({x:r.number(),y:r.number()}):Se(t,[\"PgHalfVector\",\"PgVector\"])?(i=r.array(r.number()),i=t.dimensions?i.length(t.dimensions):i):Se(t,[\"PgLine\"])?i=r.tuple([r.number(),r.number(),r.number()]):Se(t,[\"PgLineABC\"])?i=r.object({a:r.number(),b:r.number(),c:r.number()}):Se(t,[\"PgArray\"])?(i=r.array(iE(t.baseColumn,r)),i=t.size?i.length(t.size):i):t.dataType===\"array\"?i=r.array(r.any()):t.dataType===\"number\"?i=Lj(t,r,n):t.dataType===\"bigint\"?i=Bj(t,r,n):t.dataType===\"boolean\"?i=n===!0||n.boolean?r.coerce.boolean():r.boolean():t.dataType===\"date\"?i=n===!0||n.date?r.coerce.date():r.date():t.dataType===\"string\"?i=Fj(t,r,n):t.dataType===\"json\"?i=Dj:t.dataType===\"custom\"?i=r.any():t.dataType===\"buffer\"&&(i=Mj)),i||(i=r.any()),i}function Lj(t,e,r){let n=t.getSQLType().includes(\"unsigned\"),i,a,s=!1;Se(t,[\"MySqlTinyInt\",\"SingleStoreTinyInt\"])?(i=n?0:he.INT8_MIN,a=n?he.INT8_UNSIGNED_MAX:he.INT8_MAX,s=!0):Se(t,[\"PgSmallInt\",\"PgSmallSerial\",\"MySqlSmallInt\",\"SingleStoreSmallInt\"])?(i=n?0:he.INT16_MIN,a=n?he.INT16_UNSIGNED_MAX:he.INT16_MAX,s=!0):Se(t,[\"PgReal\",\"MySqlFloat\",\"MySqlMediumInt\",\"SingleStoreMediumInt\",\"SingleStoreFloat\"])?(i=n?0:he.INT24_MIN,a=n?he.INT24_UNSIGNED_MAX:he.INT24_MAX,s=Se(t,[\"MySqlMediumInt\",\"SingleStoreMediumInt\"])):Se(t,[\"PgInteger\",\"PgSerial\",\"MySqlInt\",\"SingleStoreInt\"])?(i=n?0:he.INT32_MIN,a=n?he.INT32_UNSIGNED_MAX:he.INT32_MAX,s=!0):Se(t,[\"PgDoublePrecision\",\"MySqlReal\",\"MySqlDouble\",\"SingleStoreReal\",\"SingleStoreDouble\",\"SQLiteReal\"])?(i=n?0:he.INT48_MIN,a=n?he.INT48_UNSIGNED_MAX:he.INT48_MAX):Se(t,[\"PgBigInt53\",\"PgBigSerial53\",\"MySqlBigInt53\",\"MySqlSerial\",\"SingleStoreBigInt53\",\"SingleStoreSerial\",\"SQLiteInteger\"])?(n=n||Se(t,[\"MySqlSerial\",\"SingleStoreSerial\"]),i=n?0:Number.MIN_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER,s=!0):Se(t,[\"MySqlYear\",\"SingleStoreYear\"])?(i=1901,a=2155,s=!0):(i=Number.MIN_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER);let o=r===!0||r?.number?e.coerce.number():e.number();return o=o.min(i).max(a),s?o.int():o}function Bj(t,e,r){let n=t.getSQLType().includes(\"unsigned\"),i=n?0n:he.INT64_MIN,a=n?he.INT64_UNSIGNED_MAX:he.INT64_MAX;return(r===!0||r?.bigint?e.coerce.bigint():e.bigint()).min(i).max(a)}function Fj(t,e,r){if(Se(t,[\"PgUUID\"]))return e.string().uuid();let n,i,a=!1;Se(t,[\"PgVarchar\",\"SQLiteText\"])?n=t.length:Se(t,[\"MySqlVarChar\",\"SingleStoreVarChar\"])?n=t.length??he.INT16_UNSIGNED_MAX:Se(t,[\"MySqlText\",\"SingleStoreText\"])&&(t.textType===\"longtext\"?n=he.INT32_UNSIGNED_MAX:t.textType===\"mediumtext\"?n=he.INT24_UNSIGNED_MAX:t.textType===\"text\"?n=he.INT16_UNSIGNED_MAX:n=he.INT8_UNSIGNED_MAX),Se(t,[\"PgChar\",\"MySqlChar\",\"SingleStoreChar\"])&&(n=t.length,a=!0),Se(t,[\"PgBinaryVector\"])&&(i=/^[01]+$/,n=t.dimensions);let s=r===!0||r?.string?e.coerce.string():e.string();return s=i?s.regex(i):s,n&&a?s.length(n):n?s.max(n):s}function aE(t){return Dd(t)?Fc(t):eS(t)}function sE(t,e,r,n){let i={};for(let[a,s]of Object.entries(t)){if(!b(s,K)&&!b(s,N)&&!b(s,N.Aliased)&&typeof s==\"object\"){let p=Dd(s)||Z_(s)?aE(s):s;i[a]=sE(p,e[a]??{},r,n);continue}let o=e[a];if(o!==void 0&&typeof o!=\"function\"){i[a]=o;continue}let u=b(s,K)?s:void 0,c=u?iE(u,n):k.any(),l=typeof o==\"function\"?o(c):c;r.never(u)||(i[a]=l,u&&(r.nullable(u)&&(i[a]=i[a].nullable()),r.optional(u)&&(i[a]=i[a].optional())))}return k.object(i)}var zj={never:t=>t?.generated?.type===\"always\"||t?.generatedIdentity?.type===\"always\",optional:t=>!t.notNull||t.notNull&&t.hasDefault,nullable:t=>!t.notNull};var oE=(t,e)=>{let r=aE(t);return sE(r,e??{},zj)};var Ie=Ls(\"users\",{id:Mn(\"id\").primaryKey(),username:br(\"username\").notNull().unique(),email:br(\"email\").notNull().unique(),passwordHash:br(\"password_hash\").notNull(),rating:wt(\"rating\").notNull().default(1e3),gamesPlayed:wt(\"games_played\").notNull().default(0),gamesWon:wt(\"games_won\").notNull().default(0),createdAt:zi(\"created_at\").defaultNow().notNull()}),$j=oE(Ie).omit({id:!0,rating:!0,gamesPlayed:!0,gamesWon:!0,createdAt:!0}),Gr=Ls(\"password_resets\",{id:Mn(\"id\").primaryKey(),userId:wt(\"user_id\").notNull().references(()=>Ie.id),token:br(\"token\").notNull().unique(),expiresAt:zi(\"expires_at\").notNull(),used:Cs(\"used\").notNull().default(!1)}),Ln=Ls(\"match_history\",{id:Mn(\"id\").primaryKey(),gameMode:br(\"game_mode\").notNull(),pointGoal:br(\"point_goal\").notNull(),winningTeamScore:wt(\"winning_team_score\").notNull(),losingTeamScore:wt(\"losing_team_score\").notNull(),completedAt:zi(\"completed_at\").defaultNow().notNull()}),Qr=Ls(\"match_players\",{id:Mn(\"id\").primaryKey(),matchId:wt(\"match_id\").notNull().references(()=>Ln.id),userId:wt(\"user_id\").references(()=>Ie.id),isBot:Cs(\"is_bot\").notNull().default(!1),teamIndex:wt(\"team_index\").notNull(),ratingChange:wt(\"rating_change\").notNull().default(0)}),Uj=Hc(Ie,({many:t})=>({matchPlayers:t(Qr),passwordResets:t(Gr)})),Qj=Hc(Ln,({many:t})=>({players:t(Qr)})),Gj=Hc(Qr,({one:t})=>({match:t(Ln,{fields:[Qr.matchId],references:[Ln.id]}),user:t(Ie,{fields:[Qr.userId],references:[Ie.id]})})),cm=[\"spades\",\"hearts\",\"diamonds\",\"clubs\"],cE=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"],Vj=[...cE,\"LJ\",\"BJ\"],um=[\"ace_high\",\"joker_joker_deuce_deuce\"],lm=[\"100\",\"300\",\"500\"],pm={100:100,300:300,500:500},uE=[\"south\",\"west\",\"north\",\"east\"],dm=k.object({suit:k.enum(cm),value:k.string(),id:k.string()}),lE=k.object({id:k.string(),name:k.string(),isBot:k.boolean(),position:k.enum(uE),hand:k.array(dm),bid:k.number().nullable(),tricks:k.number(),isReady:k.boolean()}),pE=k.object({id:k.string(),players:k.array(k.string()),score:k.number(),bags:k.number(),totalBid:k.number().nullable(),tricksWon:k.number()}),dE=k.object({cards:k.array(k.object({playerId:k.string(),card:dm})),leadSuit:k.enum(cm).nullable(),winnerId:k.string().nullable()}),fE=[\"waiting\",\"bidding\",\"playing\",\"round_end\",\"game_over\"],Hj=k.object({id:k.string(),mode:k.enum(um),pointGoal:k.enum(lm),phase:k.enum(fE),players:k.array(lE),teams:k.array(pE),currentTrick:dE,currentPlayerIndex:k.number(),dealerIndex:k.number(),roundNumber:k.number(),spadesBroken:k.boolean(),winningScore:k.number()}),Wj=k.object({id:k.string(),mode:k.enum(um),pointGoal:k.enum(lm),players:k.array(k.object({id:k.string(),name:k.string(),isBot:k.boolean(),isReady:k.boolean()})),hostId:k.string(),status:k.enum([\"waiting\",\"starting\",\"in_game\"])}),Kj=k.object({id:k.number(),username:k.string(),email:k.string(),rating:k.number(),gamesPlayed:k.number(),gamesWon:k.number()}),mE=[\"join_lobby\",\"leave_lobby\",\"start_game\",\"place_bid\",\"play_card\",\"game_state_update\",\"lobby_update\",\"error\",\"player_joined\",\"player_left\",\"chat_message\"],Zj=k.object({type:k.enum(mE),payload:k.any()});function wr(t,e,r){let n=t.suit===\"spades\",i=t.suit===r;if(e===\"ace_high\"){let s=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);return n?100+s:i?50+s:s}else{if(t.value===\"BJ\")return 200;if(t.value===\"LJ\")return 199;if(n&&t.value===\"2\")return 198;if(t.suit===\"diamonds\"&&t.value===\"2\")return 197;if(n)return 100+[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);let s=[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);return i?50+s:s}}function ou(t,e){return t.suit===\"spades\"||e===\"joker_joker_deuce_deuce\"&&(t.value===\"LJ\"||t.value===\"BJ\"||t.suit===\"diamonds\"&&t.value===\"2\")}function Jj(t){if(t.value===\"LJ\")return\"Little Joker\";if(t.value===\"BJ\")return\"Big Joker\";let e={J:\"Jack\",Q:\"Queen\",K:\"King\",A:\"Ace\"},r={spades:\"Spades\",hearts:\"Hearts\",diamonds:\"Diamonds\",clubs:\"Clubs\"};return`${e[t.value]||t.value} of ${r[t.suit]}`}var _t=ht(fh(),1),YW=_t.default.Client,eK=_t.default.Pool,tK=_t.default.Connection,rK=_t.default.types,nK=_t.default.Query,iK=_t.default.DatabaseError,aK=_t.default.escapeIdentifier,sK=_t.default.escapeLiteral,oK=_t.default.Result,cK=_t.default.TypeOverrides,uK=_t.default.defaults,Kr=_t.default;var{Pool:r4,types:ar}=Kr,gh=class extends ru{constructor(e,r,n,i,a,s,o,u){super({sql:r,params:n}),this.client=e,this.params=n,this.logger=i,this.fields=a,this._isResponseInArrayMode=o,this.customResultMapper=u,this.rawQueryConfig={name:s,text:r,types:{getTypeParser:(c,l)=>c===ar.builtins.TIMESTAMPTZ?p=>p:c===ar.builtins.TIMESTAMP?p=>p:c===ar.builtins.DATE?p=>p:c===ar.builtins.INTERVAL?p=>p:ar.getTypeParser(c,l)}},this.queryConfig={name:s,text:r,rowMode:\"array\",types:{getTypeParser:(c,l)=>c===ar.builtins.TIMESTAMPTZ?p=>p:c===ar.builtins.TIMESTAMP?p=>p:c===ar.builtins.DATE?p=>p:c===ar.builtins.INTERVAL?p=>p:ar.getTypeParser(c,l)}}}static[g]=\"NodePgPreparedQuery\";rawQueryConfig;queryConfig;async execute(e={}){return ae.startActiveSpan(\"drizzle.execute\",async()=>{let r=Ld(this.params,e);this.logger.logQuery(this.rawQueryConfig.text,r);let{fields:n,rawQueryConfig:i,client:a,queryConfig:s,joinsNotNullableMap:o,customResultMapper:u}=this;if(!n&&!u)return ae.startActiveSpan(\"drizzle.driver.execute\",async l=>(l?.setAttributes({\"drizzle.query.name\":i.name,\"drizzle.query.text\":i.text,\"drizzle.query.params\":JSON.stringify(r)}),a.query(i,r)));let c=await ae.startActiveSpan(\"drizzle.driver.execute\",l=>(l?.setAttributes({\"drizzle.query.name\":s.name,\"drizzle.query.text\":s.text,\"drizzle.query.params\":JSON.stringify(r)}),a.query(s,r)));return ae.startActiveSpan(\"drizzle.mapResponse\",()=>u?u(c.rows):c.rows.map(l=>X_(n,l,o)))})}all(e={}){return ae.startActiveSpan(\"drizzle.execute\",()=>{let r=Ld(this.params,e);return this.logger.logQuery(this.rawQueryConfig.text,r),ae.startActiveSpan(\"drizzle.driver.execute\",n=>(n?.setAttributes({\"drizzle.query.name\":this.rawQueryConfig.name,\"drizzle.query.text\":this.rawQueryConfig.text,\"drizzle.query.params\":JSON.stringify(r)}),this.client.query(this.rawQueryConfig,r).then(i=>i.rows)))})}isResponseInArrayMode(){return this._isResponseInArrayMode}},Su=class t extends nu{constructor(e,r,n,i={}){super(r),this.client=e,this.schema=n,this.options=i,this.logger=i.logger??new su}static[g]=\"NodePgSession\";logger;prepareQuery(e,r,n,i,a){return new gh(this.client,e.sql,e.params,this.logger,r,n,i,a)}async transaction(e,r){let n=this.client instanceof r4?new t(await this.client.connect(),this.dialect,this.schema,this.options):this,i=new yh(this.dialect,n,this.schema);await i.execute(y`begin${r?y` ${i.getTransactionConfigSQL(r)}`:void 0}`);try{let a=await e(i);return await i.execute(y`commit`),a}catch(a){throw await i.execute(y`rollback`),a}finally{this.client instanceof r4&&n.client.release()}}async count(e){let r=await this.execute(e);return Number(r.rows[0].count)}},yh=class t extends iu{static[g]=\"NodePgTransaction\";async transaction(e){let r=`sp${this.nestedIndex+1}`,n=new t(this.dialect,this.session,this.schema,this.nestedIndex+1);await n.execute(y.raw(`savepoint ${r}`));try{let i=await e(n);return await n.execute(y.raw(`release savepoint ${r}`)),i}catch(i){throw await n.execute(y.raw(`rollback to savepoint ${r}`)),i}}};var xh=class{constructor(e,r,n={}){this.client=e,this.dialect=r,this.options=n}static[g]=\"NodePgDriver\";createSession(e){return new Su(this.client,this.dialect,e,{logger:this.options.logger})}},bh=class extends Gi{static[g]=\"NodePgDatabase\"};function Ys(t,e={}){let r=new Ur({casing:e.casing}),n;e.logger===!0?n=new au:e.logger!==!1&&(n=e.logger);let i;if(e.schema){let u=tE(e.schema,nE);i={fullSchema:e.schema,schema:u.tables,tableNamesMap:u.tableNamesMap}}let s=new xh(t,r,{logger:n}).createSession(i),o=new bh(r,s,i);return o.$client=t,o}function Eu(...t){if(typeof t[0]==\"string\"){let e=new Kr.Pool({connectionString:t[0]});return Ys(e,t[1])}if(tS(t[0])){let{connection:e,client:r,...n}=t[0];if(r)return Ys(r,n);let i=typeof e==\"string\"?new Kr.Pool({connectionString:e}):new Kr.Pool(e);return Ys(i,n)}return Ys(t[0],t[1])}(t=>{function e(r){return Ys({},r)}t.mock=e})(Eu||(Eu={}));var{Pool:sL}=Kr;if(!process.env.DATABASE_URL)throw new Error(\"DATABASE_URL must be set. Did you forget to provision a database?\");var oL=new sL({connectionString:process.env.DATABASE_URL}),jt=Eu(oL,{schema:fm});var n4=require(\"crypto\"),wh=class{lobbies;games;constructor(){this.lobbies=new Map,this.games=new Map}async getUser(e){let[r]=await jt.select().from(Ie).where(It(Ie.id,e));return r||void 0}async getUserByEmail(e){let[r]=await jt.select().from(Ie).where(It(Ie.email,e));return r||void 0}async getUserByUsername(e){let[r]=await jt.select().from(Ie).where(It(Ie.username,e));return r||void 0}async createUser(e){let[r]=await jt.insert(Ie).values(e).returning();return r}async updateUserStats(e,r,n){let i=await this.getUser(e);if(!i)return;let[a]=await jt.update(Ie).set({gamesPlayed:i.gamesPlayed+1,gamesWon:i.gamesWon+(r?1:0),rating:Math.max(0,i.rating+n)}).where(It(Ie.id,e)).returning();return a}async updateUserPassword(e,r){let[n]=await jt.update(Ie).set({passwordHash:r}).where(It(Ie.id,e)).returning();return n||void 0}async createPasswordReset(e,r,n){await jt.insert(Gr).values({userId:e,token:r,expiresAt:n})}async getPasswordReset(e){let[r]=await jt.select().from(Gr).where(It(Gr.token,e));return r||void 0}async markPasswordResetUsed(e){await jt.update(Gr).set({used:!0}).where(It(Gr.token,e))}async getLobby(e){return this.lobbies.get(e)}async createLobby(e){let r=(0,n4.randomUUID)(),n={...e,id:r};return this.lobbies.set(r,n),n}async updateLobby(e,r){let n=this.lobbies.get(e);if(!n)return;let i={...n,...r};return this.lobbies.set(e,i),i}async deleteLobby(e){return this.lobbies.delete(e)}async getActiveLobbies(){return Array.from(this.lobbies.values()).filter(e=>e.status===\"waiting\")}async getGame(e){return this.games.get(e)}async saveGame(e){return this.games.set(e.id,e),e}async deleteGame(e){return this.games.delete(e)}async recordMatch(e,r,n,i,a){let[s]=await jt.insert(Ln).values({gameMode:e,pointGoal:r,winningTeamScore:n,losingTeamScore:i}).returning();for(let o of a)await jt.insert(Qr).values({matchId:s.id,userId:o.userId,isBot:o.isBot,teamIndex:o.teamIndex,ratingChange:o.ratingChange})}},Ee=new wh;var jB=ht(o4(),1),RB=ht(Fh(),1),DB=ht(Uh(),1),Xh=ht(Zh(),1),Yh=ht(Tk(),1);var Ik=require(\"crypto\"),MB=[\"south\",\"west\",\"north\",\"east\"];function ev(){let t=[\"spades\",\"hearts\",\"diamonds\",\"clubs\"],e=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"],r=[];for(let n of t)for(let i of e)r.push({suit:n,value:i,id:`${i}-${n}`});return r}function Ak(){let e=ev().filter(r=>!(r.value===\"2\"&&(r.suit===\"hearts\"||r.suit===\"clubs\")));return e.push({suit:\"spades\",value:\"LJ\",id:\"LJ-joker\"},{suit:\"spades\",value:\"BJ\",id:\"BJ-joker\"}),e}function Pk(t){let e=[...t];for(let r=e.length-1;r>0;r--){let n=Math.floor(Math.random()*(r+1));[e[r],e[n]]=[e[n],e[r]]}return e}function Ok(t,e){let r=[\"spades\",\"hearts\",\"clubs\",\"diamonds\"],n=e===\"ace_high\"?[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"]:[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\",\"2\",\"LJ\",\"BJ\"],i=a=>a.value===\"LJ\"||a.value===\"BJ\";return[...t].sort((a,s)=>{if(i(a)&&!i(s))return-1;if(!i(a)&&i(s))return 1;if(i(a)&&i(s))return a.value===\"BJ\"?-1:1;let o=r.indexOf(a.suit)-r.indexOf(s.suit);return o!==0?o:n.indexOf(s.value)-n.indexOf(a.value)})}var Mt=class{static createGame(e,r,n){if(e.length!==4)throw new Error(\"Spades requires exactly 4 players\");let i=r===\"ace_high\"?ev():Ak(),a=Pk(i),s=e.map((u,c)=>({id:u.id,name:u.name,isBot:u.isBot,position:MB[c],hand:Ok(a.slice(c*13,(c+1)*13),r),bid:null,tricks:0,isReady:!0})),o=[{id:\"team-1\",players:[s[0].id,s[2].id],score:0,bags:0,totalBid:null,tricksWon:0},{id:\"team-2\",players:[s[1].id,s[3].id],score:0,bags:0,totalBid:null,tricksWon:0}];return{id:(0,Ik.randomUUID)(),mode:r,pointGoal:n,phase:\"bidding\",players:s,teams:o,currentTrick:{cards:[],leadSuit:null,winnerId:null},currentPlayerIndex:0,dealerIndex:0,roundNumber:1,spadesBroken:!1,winningScore:pm[n]}}static getPlayableCards(e,r){let n=e.players[r];if(!n)return[];let i=n.hand,a=e.currentTrick.leadSuit;if(!a){if(!e.spadesBroken){let o=i.filter(u=>!ou(u,e.mode));if(o.length>0)return o}return i}let s=i.filter(o=>o.suit===a);return s.length>0?s:i}static placeBid(e,r,n){let i=e.players.findIndex(c=>c.id===r);if(i===-1)throw new Error(\"Player not found\");if(e.phase!==\"bidding\")throw new Error(\"Not in bidding phase\");if(i!==e.currentPlayerIndex)throw new Error(\"Not your turn\");let a=e.players.map((c,l)=>l===i?{...c,bid:n}:c),s=a.every(c=>c.bid!==null),o=e.teams,u=e.phase;return s&&(o=e.teams.map(c=>{let l=c.players.reduce((p,d)=>{let f=a.find(h=>h.id===d);return p+(f?.bid||0)},0);return{...c,totalBid:l}}),u=\"playing\"),{...e,players:a,teams:o,phase:u,currentPlayerIndex:s?0:(e.currentPlayerIndex+1)%4}}static playCard(e,r,n){let i=e.players.findIndex(d=>d.id===r);if(i===-1)throw new Error(\"Player not found\");if(e.phase!==\"playing\")throw new Error(\"Not in playing phase\");if(i!==e.currentPlayerIndex)throw new Error(\"Not your turn\");let s=e.players[i].hand.find(d=>d.id===n);if(!s)throw new Error(\"Card not in hand\");if(!this.getPlayableCards(e,i).some(d=>d.id===n))throw new Error(\"Card is not playable\");let u=e.players.map((d,f)=>f===i?{...d,hand:d.hand.filter(h=>h.id!==n)}:d),c=[...e.currentTrick.cards,{playerId:r,card:s}],l=e.currentTrick.leadSuit||s.suit,p=e.spadesBroken;return ou(s,e.mode)&&(p=!0),c.length===4?this.completeTrick(e,u,c,l,p):{...e,players:u,currentTrick:{cards:c,leadSuit:l,winnerId:null},currentPlayerIndex:(e.currentPlayerIndex+1)%4,spadesBroken:p}}static completeTrick(e,r,n,i,a){let s=0,o=0;n.forEach(({card:f},h)=>{let m=wr(f,e.mode,i);m>o&&(o=m,s=h)});let u=n[s].playerId,c=r.findIndex(f=>f.id===u),l=r.map(f=>f.id===u?{...f,tricks:f.tricks+1}:f),p=e.teams.map(f=>f.players.includes(u)?{...f,tricksWon:f.tricksWon+1}:f);return l.reduce((f,h)=>f+h.hand.length,0)===0?this.completeRound(e,l,p,u,c):{...e,players:l,teams:p,currentTrick:{cards:n,leadSuit:i,winnerId:u},currentPlayerIndex:c,spadesBroken:a}}static completeRound(e,r,n,i,a){let s=n.map(p=>{let d=p.totalBid||0,f=p.tricksWon,h=0,m=p.bags,x=p.players.map(E=>r.find(R=>R.id===E)),w=0;x.forEach(E=>{E.bid===0&&(E.tricks===0?w+=100:(w-=100,m+=E.tricks))});let C=x.reduce((E,R)=>E+(R.bid===0?0:R.bid||0),0),_=f-x.reduce((E,R)=>E+(R.bid===0?R.tricks:0),0);if(C>0)if(_>=C){let E=_-C;h=C*10+E,m+=E}else h=-C*10;return m>=10&&(h-=100,m=m%10),h+=w,{...p,score:p.score+h,bags:m,tricksWon:0,totalBid:null}});if(s.findIndex(p=>p.score>=e.winningScore)!==-1)return{...e,players:r.map(p=>({...p,bid:null,tricks:0})),teams:s,currentTrick:{cards:[],leadSuit:null,winnerId:i},phase:\"game_over\",currentPlayerIndex:a};let u=e.mode===\"ace_high\"?ev():Ak(),c=Pk(u),l=r.map((p,d)=>({...p,hand:Ok(c.slice(d*13,(d+1)*13),e.mode),bid:null,tricks:0}));return{...e,players:l,teams:s,currentTrick:{cards:[],leadSuit:null,winnerId:null},phase:\"bidding\",currentPlayerIndex:(e.dealerIndex+1)%4,dealerIndex:(e.dealerIndex+1)%4,roundNumber:e.roundNumber+1,spadesBroken:!1}}static clearTrick(e){return{...e,currentTrick:{cards:[],leadSuit:null,winnerId:null}}}};var uo=class{static calculateBid(e,r){let n=0;e.forEach(a=>{a.value===\"A\"&&(n+=1),a.value===\"K\"&&(n+=.5),a.value===\"Q\"&&(n+=.25),a.suit===\"spades\"&&(n+=.5),a.value===\"BJ\"&&(n+=2),a.value===\"LJ\"&&(n+=1.5),a.suit===\"spades\"&&a.value===\"2\"&&r===\"joker_joker_deuce_deuce\"&&(n+=1.5)});let i=e.filter(a=>a.suit===\"spades\"||a.value===\"LJ\"||a.value===\"BJ\").length;return n+=Math.max(0,i-2)*.5,n+=Math.random()-.5,Math.max(1,Math.min(6,Math.round(n)))}static selectCard(e,r){let i=e.players[r].hand,a=Mt.getPlayableCards(e,r);if(a.length===1)return a[0];let s=e.currentTrick,o=s.leadSuit,u=!o,c=e.players[(r+2)%4],l=s.cards.find(m=>m.playerId===c.id),p=[...a].sort((m,x)=>wr(m,e.mode,o)-wr(x,e.mode,o));if(u){let m={spades:0,hearts:0,diamonds:0,clubs:0};i.forEach(w=>{w.suit in m&&m[w.suit]++});let x=[\"hearts\",\"diamonds\",\"clubs\"].filter(w=>m[w]>0);if(x.length>0){let w=x.reduce((_,E)=>m[_]>=m[E]?_:E),C=a.filter(_=>_.suit===w);if(C.length>0){let _=C.filter(E=>[\"A\",\"K\",\"Q\"].includes(E.value));return _.length>0?_[0]:C[Math.floor(C.length/2)]}}return p[Math.floor(p.length/2)]}let d=s.cards.reduce((m,{card:x})=>Math.max(m,wr(x,e.mode,o)),0),f=!1;l&&(f=wr(l.card,e.mode,o)>=d);let h=p.filter(m=>wr(m,e.mode,o)>d);return f&&s.cards.length===3?p[0]:h.length>0?h[0]:p[0]}static shouldBreakSpades(e,r){return e.filter(i=>i.suit===\"spades\"||i.value===\"LJ\"||i.value===\"BJ\").length>=5}};var Lu=class{wss;clients=new Map;gameRooms=new Map;constructor(e){this.wss=new Yh.default({server:e,path:\"/ws\"}),this.setupConnectionHandler()}setupConnectionHandler(){this.wss.on(\"connection\",e=>{let r=`player-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,n={ws:e,playerId:r,gameId:null,lobbyId:null};this.clients.set(e,n),this.sendMessage(e,{type:\"player_joined\",payload:{playerId:r}}),e.on(\"message\",i=>{try{let a=JSON.parse(i.toString());this.handleMessage(e,a)}catch{this.sendError(e,\"Invalid message format\")}}),e.on(\"close\",()=>{this.handleDisconnect(e)}),e.on(\"error\",i=>{console.error(\"WebSocket error:\",i)})})}handleMessage(e,r){if(this.clients.get(e))switch(r.type){case\"start_game\":this.handleStartGame(e,r.payload);break;case\"place_bid\":this.handleBid(e,r.payload);break;case\"play_card\":this.handlePlayCard(e,r.payload);break;case\"leave_lobby\":this.handleLeaveLobby(e);break}}handleStartGame(e,r){let n=this.clients.get(e);if(!n)return;let{mode:i,pointGoal:a,players:s}=r;try{let o=s.map((d,f)=>f===0&&!d.isBot?{...d,id:n.playerId}:d),u=Mt.createGame(o,i,a),l=o.filter(d=>!d.isBot&&d.userId).length>=2,p={gameState:u,clients:new Map,botTimer:null,statsSaved:!1,isRanked:l};p.clients.set(n.playerId,n),n.gameId=u.id,this.gameRooms.set(u.id,p),this.broadcastGameState(u.id),this.scheduleBotMove(u.id)}catch(o){this.sendError(e,o.message)}}handleBid(e,r){let n=this.clients.get(e);if(!n||!n.gameId)return;let i=this.gameRooms.get(n.gameId);if(i)try{i.gameState=Mt.placeBid(i.gameState,n.playerId,r.bid),this.broadcastGameState(n.gameId),this.scheduleBotMove(n.gameId)}catch(a){this.sendError(e,a.message)}}handlePlayCard(e,r){let n=this.clients.get(e);if(!n||!n.gameId)return;let i=this.gameRooms.get(n.gameId);if(i)try{i.gameState=Mt.playCard(i.gameState,n.playerId,r.cardId),this.broadcastGameState(n.gameId),i.gameState.currentTrick.cards.length===4?setTimeout(()=>{let a=this.gameRooms.get(n.gameId);a&&a.gameState.currentTrick.cards.length===4&&(a.gameState=Mt.clearTrick(a.gameState),this.broadcastGameState(n.gameId),this.scheduleBotMove(n.gameId))},1500):this.scheduleBotMove(n.gameId)}catch(a){this.sendError(e,a.message)}}handleLeaveLobby(e){let r=this.clients.get(e);if(r&&r.gameId){let n=this.gameRooms.get(r.gameId);n&&(n.clients.delete(r.playerId),n.clients.size===0&&(n.botTimer&&clearTimeout(n.botTimer),this.gameRooms.delete(r.gameId))),r.gameId=null}}handleDisconnect(e){this.clients.get(e)&&(this.handleLeaveLobby(e),this.clients.delete(e))}scheduleBotMove(e){let r=this.gameRooms.get(e);if(!r)return;let{gameState:n}=r,i=n.players[n.currentPlayerIndex];if(!i||!i.isBot||n.phase!==\"bidding\"&&n.phase!==\"playing\")return;r.botTimer&&clearTimeout(r.botTimer);let a=800+Math.random()*700;r.botTimer=setTimeout(()=>{let s=this.gameRooms.get(e);if(!s)return;let{gameState:o}=s,u=o.players[o.currentPlayerIndex];if(!(!u||!u.isBot))try{if(o.phase===\"bidding\"){let c=uo.calculateBid(u.hand,o.mode);s.gameState=Mt.placeBid(o,u.id,c)}else if(o.phase===\"playing\"){let c=uo.selectCard(o,o.currentPlayerIndex);s.gameState=Mt.playCard(o,u.id,c.id)}this.broadcastGameState(e),s.gameState.currentTrick.cards.length===4?setTimeout(()=>{let c=this.gameRooms.get(e);c&&c.gameState.currentTrick.cards.length===4&&(c.gameState=Mt.clearTrick(c.gameState),this.broadcastGameState(e),this.scheduleBotMove(e))},1500):this.scheduleBotMove(e)}catch(c){console.error(\"Bot move error:\",c)}},a)}broadcastGameState(e){let r=this.gameRooms.get(e);r&&(r.clients.forEach(n=>{let i=this.sanitizeGameState(r.gameState,n.playerId);this.sendMessage(n.ws,{type:\"game_state_update\",payload:i})}),r.gameState.phase===\"game_over\"&&!r.statsSaved&&r.isRanked&&(r.statsSaved=!0,this.saveGameStats(r.gameState)))}async saveGameStats(e){try{let r=e.teams.findIndex(s=>s.score>=e.winningScore);if(r===-1)return;let n=e.teams[r],i=e.teams[r===0?1:0],a=[];for(let s of e.players){let o=n.players.includes(s.id),u=n.players.includes(s.id)?r:r===0?1:0,c=o?25:-20;a.push({userId:null,isBot:s.isBot,teamIndex:u,ratingChange:s.isBot?0:c})}await Ee.recordMatch(e.mode,e.pointGoal,n.score,i.score,a),console.log(`Game ${e.id} stats saved - Winner: Team ${r+1}`)}catch(r){console.error(\"Failed to save game stats:\",r)}}sanitizeGameState(e,r){let n=e.players.map(i=>i.id===r?i:{...i,hand:i.hand.map(()=>({suit:\"spades\",value:\"?\",id:\"hidden\"}))});return{...e,players:n}}sendMessage(e,r){e.readyState===Xh.default.OPEN&&e.send(JSON.stringify(r))}sendError(e,r){this.sendMessage(e,{type:\"error\",payload:{message:r}})}};var tv=class{queue=new Map;matchingInterval=null;onMatchFound=null;start(e){this.onMatchFound=e,this.matchingInterval=setInterval(()=>this.tryMatch(),5e3)}stop(){this.matchingInterval&&(clearInterval(this.matchingInterval),this.matchingInterval=null)}addToQueue(e,r,n){let i={id:e.id,username:e.username,rating:e.rating,queuedAt:Date.now(),gameMode:r,pointGoal:n};this.queue.set(e.id,i)}removeFromQueue(e){this.queue.delete(e)}getQueueSize(){return this.queue.size}tryMatch(){let e=Array.from(this.queue.values()),r=new Map;for(let n of e){let i=`${n.gameMode}-${n.pointGoal}`;r.has(i)||r.set(i,[]),r.get(i).push(n)}for(let[,n]of Array.from(r.entries()))if(n.length>=4){let i=this.selectBestMatch(n);if(i&&this.onMatchFound){for(let a of i.players)this.queue.delete(a.id);this.onMatchFound(i)}}}selectBestMatch(e){if(e.length<4)return null;e.sort((a,s)=>a.rating-s.rating);let r=e.filter(a=>Date.now()-a.queuedAt>6e4),n;if(r.length>=4)n=r.slice(0,4);else{let a=this.groupByRatingTier(e),s=null;for(let o of a)o.length>=4&&(!s||o.length>s.length)&&(s=o);s?n=s.slice(0,4):n=e.slice(0,4)}let i=this.balanceTeams(n);return{players:n,teams:i,gameMode:n[0].gameMode,pointGoal:n[0].pointGoal}}groupByRatingTier(e){let r=[];for(let a of e){let s=Math.floor(a.rating/300);for(;r.length<=s;)r.push([]);r[s].push(a)}let i=[];for(let a=0;a<r.length;a++){let s=[...r[a]];a>0&&s.push(...r[a-1]),a<r.length-1&&s.push(...r[a+1]),s.length>=4&&i.push(s)}return i}balanceTeams(e){let r=[...e].sort((a,s)=>s.rating-a.rating),n=[r[0],r[3]],i=[r[1],r[2]];return[n,i]}fillWithBots(e){let r=[\"SpadeMaster\",\"TrickTaker\",\"CardShark\",\"AceHunter\"],n=new Set(e.map(o=>o.username)),i=e.length>0?Math.round(e.reduce((o,u)=>o+u.rating,0)/e.length):1e3,a=[...e],s=0;for(;a.length<4;){let o=r[s%r.length];for(;n.has(o);)s++,o=`Bot${s}`;n.add(o),a.push({id:-1*(s+1),username:o,rating:i+Math.floor(Math.random()*200)-100,queuedAt:Date.now(),gameMode:e[0]?.gameMode||\"ace_high\",pointGoal:e[0]?.pointGoal||\"300\"}),s++}return a}},lo=new tv;var LB={from:process.env.EMAIL_FROM||\"noreply@housespades.com\",apiKey:process.env.EMAIL_API_KEY,domain:process.env.EMAIL_DOMAIN};async function BB(t){let{to:e,subject:r,text:n,html:i}=t;if(!LB.apiKey)return console.log(\"=== Email would be sent (DEV MODE) ===\"),console.log(`To: ${e}`),console.log(`Subject: ${r}`),console.log(`Body: ${n}`),console.log(\"======================================\"),console.log(\"Configure EMAIL_API_KEY to enable real email sending\"),{success:!0,devMode:!0};try{return console.log(`Email sent to ${e}: ${r}`),{success:!0,devMode:!1}}catch(a){return console.error(\"Failed to send email:\",a),{success:!1,devMode:!1}}}async function Nk(t,e,r){let n=`${r}/reset-password?token=${e}`,i=await BB({to:t,subject:\"Reset Your House Spades Password\",text:`","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:22.577812144Z"}
{"message":"\t\t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:22.577825337Z"}
{"message":"","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:22.581752158Z"}
{"message":"Error: DATABASE_URL must be set. Did you forget to provision a database?","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:22.581760245Z"}
{"message":"    at Object.<anonymous> (/app/dist/index.cjs:100:43241)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:22.581766370Z"}
{"message":"    at Module._compile (node:internal/modules/cjs/loader:1706:14)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:22.581771513Z"}
{"message":"    at Object..js (node:internal/modules/cjs/loader:1839:10)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:22.581776226Z"}
{"message":"    at Module.load (node:internal/modules/cjs/loader:1441:32)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:22.581781229Z"}
{"message":"    at Function._load (node:internal/modules/cjs/loader:1263:12)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:22.581785816Z"}
{"message":"    at TracingChannel.traceSync (node:diagnostics_channel:328:14)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:22.581791705Z"}
{"message":"    at wrapModuleLoad (node:internal/modules/cjs/loader:237:24)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:22.581796053Z"}
{"message":"    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:171:5)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:22.581802873Z"}
{"message":"    at node:internal/main/run_main_module:36:49","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:22.581807830Z"}
{"message":"","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:22.581812873Z"}
{"message":"Node.js v22.21.1","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:22.581818221Z"}
{"message":"npm warn config production Use `--omit=dev` instead.","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:24.361921357Z"}
{"message":"","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:24.361930017Z"}
{"message":"> rest-express@1.0.0 start","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:24.361937445Z"}
{"message":"> NODE_ENV=production node dist/index.cjs","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:24.361944762Z"}
{"message":"","attributes":{"level":"info"},"timestamp":"2026-01-10T05:00:24.361952073Z"}
{"message":"/app/dist/index.cjs:100","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:24.361959387Z"}
{"message":"\t\t`;await r.execute(y`CREATE SCHEMA IF NOT EXISTS ${y.identifier(a)}`),await r.execute(s);let u=(await r.all(y`select id, hash, created_at from ${y.identifier(a)}.${y.identifier(i)} order by created_at desc limit 1`))[0];await r.transaction(async c=>{for await(let l of e)if(!u||Number(u.created_at)<l.folderMillis){for(let p of l.sql)await c.execute(y.raw(p));await c.execute(y`insert into ${y.identifier(a)}.${y.identifier(i)} (\"hash\", \"created_at\") values(${l.hash}, ${l.folderMillis})`)}})}escapeName(e){return`\"${e}\"`}escapeParam(e){return`$${e+1}`}escapeString(e){return`'${e.replace(/'/g,\"''\")}'`}buildWithCTE(e){if(!e?.length)return;let r=[y`with `];for(let[n,i]of e.entries())r.push(y`${y.identifier(i._.alias)} as (${i._.sql})`),n<e.length-1&&r.push(y`, `);return r.push(y` `),y.join(r)}buildDeleteQuery({table:e,where:r,returning:n,withList:i}){let a=this.buildWithCTE(i),s=n?y` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,o=r?y` where ${r}`:void 0;return y`${a}delete from ${e}${o}${s}`}buildUpdateSet(e,r){let n=e[P.Symbol.Columns],i=Object.keys(n).filter(s=>r[s]!==void 0||n[s]?.onUpdateFn!==void 0),a=i.length;return y.join(i.flatMap((s,o)=>{let u=n[s],c=r[s]??y.param(u.onUpdateFn(),u),l=y`${y.identifier(this.casing.getColumnCasing(u))} = ${c}`;return o<a-1?[l,y.raw(\", \")]:[l]}))}buildUpdateQuery({table:e,set:r,where:n,returning:i,withList:a,from:s,joins:o}){let u=this.buildWithCTE(a),c=e[Be.Symbol.Name],l=e[Be.Symbol.Schema],p=e[Be.Symbol.OriginalName],d=c===p?void 0:c,f=y`${l?y`${y.identifier(l)}.`:void 0}${y.identifier(p)}${d&&y` ${y.identifier(d)}`}`,h=this.buildUpdateSet(e,r),m=s&&y.join([y.raw(\" from \"),this.buildFromTable(s)]),x=this.buildJoins(o),w=i?y` returning ${this.buildSelection(i,{isSingleTable:!s})}`:void 0,C=n?y` where ${n}`:void 0;return y`${u}update ${f} set ${h}${m}${x}${C}${w}`}buildSelection(e,{isSingleTable:r=!1}={}){let n=e.length,i=e.flatMap(({field:a},s)=>{let o=[];if(b(a,N.Aliased)&&a.isSelectionField)o.push(y.identifier(a.fieldAlias));else if(b(a,N.Aliased)||b(a,N)){let u=b(a,N.Aliased)?a.sql:a;r?o.push(new N(u.queryChunks.map(c=>b(c,T)?y.identifier(this.casing.getColumnCasing(c)):c))):o.push(u),b(a,N.Aliased)&&o.push(y` as ${y.identifier(a.fieldAlias)}`)}else b(a,K)&&(r?o.push(y.identifier(this.casing.getColumnCasing(a))):o.push(a));return s<n-1&&o.push(y`, `),o});return y.join(i)}buildJoins(e){if(!e||e.length===0)return;let r=[];for(let[n,i]of e.entries()){n===0&&r.push(y` `);let a=i.table,s=i.lateral?y` lateral`:void 0;if(b(a,Be)){let o=a[Be.Symbol.Name],u=a[Be.Symbol.Schema],c=a[Be.Symbol.OriginalName],l=o===c?void 0:i.alias;r.push(y`${y.raw(i.joinType)} join${s} ${u?y`${y.identifier(u)}.`:void 0}${y.identifier(c)}${l&&y` ${y.identifier(l)}`} on ${i.on}`)}else if(b(a,et)){let o=a[se].name,u=a[se].schema,c=a[se].originalName,l=o===c?void 0:i.alias;r.push(y`${y.raw(i.joinType)} join${s} ${u?y`${y.identifier(u)}.`:void 0}${y.identifier(c)}${l&&y` ${y.identifier(l)}`} on ${i.on}`)}else r.push(y`${y.raw(i.joinType)} join${s} ${a} on ${i.on}`);n<e.length-1&&r.push(y` `)}return y.join(r)}buildFromTable(e){if(b(e,P)&&e[P.Symbol.OriginalName]!==e[P.Symbol.Name]){let r=y`${y.identifier(e[P.Symbol.OriginalName])}`;return e[P.Symbol.Schema]&&(r=y`${y.identifier(e[P.Symbol.Schema])}.${r}`),y`${r} ${y.identifier(e[P.Symbol.Name])}`}return e}buildSelectQuery({withList:e,fields:r,fieldsFlat:n,where:i,having:a,table:s,joins:o,orderBy:u,groupBy:c,limit:l,offset:p,lockingClause:d,distinct:f,setOperators:h}){let m=n??Ot(r);for(let le of m)if(b(le.field,K)&&ut(le.field.table)!==(b(s,Te)?s._.alias:b(s,$i)?s[se].name:b(s,N)?void 0:ut(s))&&!(xe=>o?.some(({alias:mt})=>mt===(xe[P.Symbol.IsAlias]?ut(xe):xe[P.Symbol.BaseName])))(le.field.table)){let xe=ut(le.field.table);throw new Error(`Your \"${le.path.join(\"->\")}\" field references a column \"${xe}\".\"${le.field.name}\", but the table \"${xe}\" is not part of the query! Did you forget to join it?`)}let x=!o||o.length===0,w=this.buildWithCTE(e),C;f&&(C=f===!0?y` distinct`:y` distinct on (${y.join(f.on,y`, `)})`);let _=this.buildSelection(m,{isSingleTable:x}),E=this.buildFromTable(s),R=this.buildJoins(o),M=i?y` where ${i}`:void 0,I=a?y` having ${a}`:void 0,D;u&&u.length>0&&(D=y` order by ${y.join(u,y`, `)}`);let Q;c&&c.length>0&&(Q=y` group by ${y.join(c,y`, `)}`);let ke=typeof l==\"object\"||typeof l==\"number\"&&l>=0?y` limit ${l}`:void 0,rt=p?y` offset ${p}`:void 0,$e=y.empty();if(d){let le=y` for ${y.raw(d.strength)}`;d.config.of&&le.append(y` of ${y.join(Array.isArray(d.config.of)?d.config.of:[d.config.of],y`, `)}`),d.config.noWait?le.append(y` no wait`):d.config.skipLocked&&le.append(y` skip locked`),$e.append(le)}let ye=y`${w}select${C} ${_} from ${E}${R}${M}${Q}${I}${D}${ke}${rt}${$e}`;return h.length>0?this.buildSetOperations(ye,h):ye}buildSetOperations(e,r){let[n,...i]=r;if(!n)throw new Error(\"Cannot pass undefined values to any set operator\");return i.length===0?this.buildSetOperationQuery({leftSelect:e,setOperator:n}):this.buildSetOperations(this.buildSetOperationQuery({leftSelect:e,setOperator:n}),i)}buildSetOperationQuery({leftSelect:e,setOperator:{type:r,isAll:n,rightSelect:i,limit:a,orderBy:s,offset:o}}){let u=y`(${e.getSQL()}) `,c=y`(${i.getSQL()})`,l;if(s&&s.length>0){let h=[];for(let m of s)if(b(m,T))h.push(y.identifier(m.name));else if(b(m,N)){for(let x=0;x<m.queryChunks.length;x++){let w=m.queryChunks[x];b(w,T)&&(m.queryChunks[x]=y.identifier(w.name))}h.push(y`${m}`)}else h.push(y`${m}`);l=y` order by ${y.join(h,y`, `)} `}let p=typeof a==\"object\"||typeof a==\"number\"&&a>=0?y` limit ${a}`:void 0,d=y.raw(`${r} ${n?\"all \":\"\"}`),f=o?y` offset ${o}`:void 0;return y`${u}${d}${c}${l}${p}${f}`}buildInsertQuery({table:e,values:r,onConflict:n,returning:i,withList:a,select:s,overridingSystemValue_:o}){let u=[],c=e[P.Symbol.Columns],l=Object.entries(c).filter(([w,C])=>!C.shouldDisableInsert()),p=l.map(([,w])=>y.identifier(this.casing.getColumnCasing(w)));if(s){let w=r;b(w,N)?u.push(w):u.push(w.getSQL())}else{let w=r;u.push(y.raw(\"values \"));for(let[C,_]of w.entries()){let E=[];for(let[R,M]of l){let I=_[R];if(I===void 0||b(I,lt)&&I.value===void 0)if(M.defaultFn!==void 0){let D=M.defaultFn(),Q=b(D,N)?D:y.param(D,M);E.push(Q)}else if(!M.default&&M.onUpdateFn!==void 0){let D=M.onUpdateFn(),Q=b(D,N)?D:y.param(D,M);E.push(Q)}else E.push(y`default`);else E.push(I)}u.push(E),C<w.length-1&&u.push(y`, `)}}let d=this.buildWithCTE(a),f=y.join(u),h=i?y` returning ${this.buildSelection(i,{isSingleTable:!0})}`:void 0,m=n?y` on conflict ${n}`:void 0,x=o===!0?y`overriding system value `:void 0;return y`${d}insert into ${e} ${p} ${x}${f}${m}${h}`}buildRefreshMaterializedViewQuery({view:e,concurrently:r,withNoData:n}){let i=r?y` concurrently`:void 0,a=n?y` with no data`:void 0;return y`refresh materialized view${i} ${e}${a}`}prepareTyping(e){return b(e,Os)||b(e,Ps)?\"json\":b(e,Is)?\"decimal\":b(e,Ns)?\"time\":b(e,qs)||b(e,js)?\"timestamp\":b(e,Ts)||b(e,As)?\"date\":b(e,Rs)?\"uuid\":\"none\"}sqlToQuery(e,r){return e.toQuery({casing:this.casing,escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString,prepareTyping:this.prepareTyping,invokeSource:r})}buildRelationalQueryWithoutPK({fullSchema:e,schema:r,tableNamesMap:n,table:i,tableConfig:a,queryConfig:s,tableAlias:o,nestedQueryRelation:u,joinOn:c}){let l=[],p,d,f=[],h,m=[];if(s===!0)l=Object.entries(a.columns).map(([C,_])=>({dbKey:_.name,tsKey:C,field:nr(_,o),relationTableTsKey:void 0,isJson:!1,selection:[]}));else{let w=Object.fromEntries(Object.entries(a.columns).map(([I,D])=>[I,nr(D,o)]));if(s.where){let I=typeof s.where==\"function\"?s.where(w,YS()):s.where;h=I&&Es(I,o)}let C=[],_=[];if(s.columns){let I=!1;for(let[D,Q]of Object.entries(s.columns))Q!==void 0&&D in a.columns&&(!I&&Q===!0&&(I=!0),_.push(D));_.length>0&&(_=I?_.filter(D=>s.columns?.[D]===!0):Object.keys(a.columns).filter(D=>!_.includes(D)))}else _=Object.keys(a.columns);for(let I of _){let D=a.columns[I];C.push({tsKey:I,value:D})}let E=[];s.with&&(E=Object.entries(s.with).filter(I=>!!I[1]).map(([I,D])=>({tsKey:I,queryConfig:D,relation:a.relations[I]})));let R;if(s.extras){R=typeof s.extras==\"function\"?s.extras(w,{sql:y}):s.extras;for(let[I,D]of Object.entries(R))C.push({tsKey:I,value:Bd(D,o)})}for(let{tsKey:I,value:D}of C)l.push({dbKey:b(D,N.Aliased)?D.fieldAlias:a.columns[I].name,tsKey:I,field:b(D,K)?nr(D,o):D,relationTableTsKey:void 0,isJson:!1,selection:[]});let M=typeof s.orderBy==\"function\"?s.orderBy(w,eE()):s.orderBy??[];Array.isArray(M)||(M=[M]),f=M.map(I=>b(I,K)?nr(I,o):Es(I,o)),p=s.limit,d=s.offset;for(let{tsKey:I,queryConfig:D,relation:Q}of E){let ke=rE(r,n,Q),rt=Rn(Q.referencedTable),$e=n[rt],ye=`${o}_${I}`,le=Bs(...ke.fields.map((Yr,oa)=>It(nr(ke.references[oa],ye),nr(Yr,o)))),xe=this.buildRelationalQueryWithoutPK({fullSchema:e,schema:r,tableNamesMap:n,table:e[$e],tableConfig:r[$e],queryConfig:b(Q,$r)?D===!0?{limit:1}:{...D,limit:1}:D,tableAlias:ye,joinOn:le,nestedQueryRelation:Q}),mt=y`${y.identifier(ye)}.${y.identifier(\"data\")}`.as(I);m.push({on:y`true`,table:new Te(xe.sql,{},ye),alias:ye,joinType:\"left\",lateral:!0}),l.push({dbKey:I,tsKey:I,field:mt,relationTableTsKey:$e,isJson:!0,selection:xe.selection})}}if(l.length===0)throw new Ms({message:`No fields selected for table \"${a.tsName}\" (\"${o}\")`});let x;if(h=Bs(c,h),u){let w=y`json_build_array(${y.join(l.map(({field:E,tsKey:R,isJson:M})=>M?y`${y.identifier(`${o}_${R}`)}.${y.identifier(\"data\")}`:b(E,N.Aliased)?E.sql:E),y`, `)})`;b(u,Fs)&&(w=y`coalesce(json_agg(${w}${f.length>0?y` order by ${y.join(f,y`, `)}`:void 0}), '[]'::json)`);let C=[{dbKey:\"data\",tsKey:\"data\",field:w.as(\"data\"),isJson:!0,relationTableTsKey:a.tsName,selection:l}];p!==void 0||d!==void 0||f.length>0?(x=this.buildSelectQuery({table:Ss(i,o),fields:{},fieldsFlat:[{path:[],field:y.raw(\"*\")}],where:h,limit:p,offset:d,orderBy:f,setOperators:[]}),h=void 0,p=void 0,d=void 0,f=[]):x=Ss(i,o),x=this.buildSelectQuery({table:b(x,Be)?x:new Te(x,{},o),fields:{},fieldsFlat:C.map(({field:E})=>({path:[],field:b(E,K)?nr(E,o):E})),joins:m,where:h,limit:p,offset:d,orderBy:f,setOperators:[]})}else x=this.buildSelectQuery({table:Ss(i,o),fields:{},fieldsFlat:l.map(({field:w})=>({path:[],field:b(w,K)?nr(w,o):w})),joins:m,where:h,limit:p,offset:d,orderBy:f,setOperators:[]});return{tableTsKey:a.tsName,sql:x,selection:l}}};var Wc=class{static[g]=\"TypedQueryBuilder\";getSelectedFields(){return this._.selectedFields}};var Ve=class{static[g]=\"PgSelectBuilder\";fields;session;dialect;withList=[];distinct;constructor(e){this.fields=e.fields,this.session=e.session,this.dialect=e.dialect,e.withList&&(this.withList=e.withList),this.distinct=e.distinct}authToken;setToken(e){return this.authToken=e,this}from(e){let r=!!this.fields,n=e,i;return this.fields?i=this.fields:b(n,Te)?i=Object.fromEntries(Object.keys(n._.selectedFields).map(a=>[a,n[a]])):b(n,$i)?i=n[se].selectedFields:b(n,N)?i={}:i=Fc(n),new Kc({table:n,fields:i,isPartialSelect:r,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct}).setToken(this.authToken)}},am=class extends Wc{static[g]=\"PgSelectQueryBuilder\";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;constructor({table:e,fields:r,isPartialSelect:n,session:i,dialect:a,withList:s,distinct:o}){super(),this.config={withList:s,table:e,fields:{...r},distinct:o,setOperators:[]},this.isPartialSelect=n,this.session=i,this.dialect=a,this._={selectedFields:r},this.tableName=yr(e),this.joinsNotNullableMap=typeof this.tableName==\"string\"?{[this.tableName]:!0}:{}}createJoin(e){return(r,n)=>{let i=this.tableName,a=yr(r);if(typeof a==\"string\"&&this.config.joins?.some(s=>s.alias===a))throw new Error(`Alias \"${a}\" is already used in this query`);if(!this.isPartialSelect&&(Object.keys(this.joinsNotNullableMap).length===1&&typeof i==\"string\"&&(this.config.fields={[i]:this.config.fields}),typeof a==\"string\"&&!b(r,N))){let s=b(r,Te)?r._.selectedFields:b(r,et)?r[se].selectedFields:r[P.Symbol.Columns];this.config.fields[a]=s}if(typeof n==\"function\"&&(n=n(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.joins||(this.config.joins=[]),this.config.joins.push({on:n,table:r,joinType:e,alias:a}),typeof a==\"string\")switch(e){case\"left\":{this.joinsNotNullableMap[a]=!1;break}case\"right\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([s])=>[s,!1])),this.joinsNotNullableMap[a]=!0;break}case\"inner\":{this.joinsNotNullableMap[a]=!0;break}case\"full\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([s])=>[s,!1])),this.joinsNotNullableMap[a]=!1;break}}return this}}leftJoin=this.createJoin(\"left\");rightJoin=this.createJoin(\"right\");innerJoin=this.createJoin(\"inner\");fullJoin=this.createJoin(\"full\");createSetOperator(e,r){return n=>{let i=typeof n==\"function\"?n(Tj()):n;if(!ks(this.getSelectedFields(),i.getSelectedFields()))throw new Error(\"Set operator error (union / intersect / except): selected fields are not the same or are in a different order\");return this.config.setOperators.push({type:e,isAll:r,rightSelect:i}),this}}union=this.createSetOperator(\"union\",!1);unionAll=this.createSetOperator(\"union\",!0);intersect=this.createSetOperator(\"intersect\",!1);intersectAll=this.createSetOperator(\"intersect\",!0);except=this.createSetOperator(\"except\",!1);exceptAll=this.createSetOperator(\"except\",!0);addSetOperators(e){return this.config.setOperators.push(...e),this}where(e){return typeof e==\"function\"&&(e=e(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.where=e,this}having(e){return typeof e==\"function\"&&(e=e(new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))),this.config.having=e,this}groupBy(...e){if(typeof e[0]==\"function\"){let r=e[0](new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"alias\",sqlBehavior:\"sql\"})));this.config.groupBy=Array.isArray(r)?r:[r]}else this.config.groupBy=e;return this}orderBy(...e){if(typeof e[0]==\"function\"){let r=e[0](new Proxy(this.config.fields,new _e({sqlAliasedBehavior:\"alias\",sqlBehavior:\"sql\"}))),n=Array.isArray(r)?r:[r];this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=n:this.config.orderBy=n}else{let r=e;this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=r:this.config.orderBy=r}return this}limit(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).limit=e:this.config.limit=e,this}offset(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).offset=e:this.config.offset=e,this}for(e,r={}){return this.config.lockingClause={strength:e,config:r},this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}as(e){return new Proxy(new Te(this.getSQL(),this.config.fields,e),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"}))}getSelectedFields(){return new Proxy(this.config.fields,new _e({alias:this.tableName,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"}))}$dynamic(){return this}},Kc=class extends am{static[g]=\"PgSelect\";_prepare(e){let{session:r,config:n,dialect:i,joinsNotNullableMap:a,authToken:s}=this;if(!r)throw new Error(\"Cannot execute a query on a query builder. Please use a database instance instead.\");return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>{let o=Ot(n.fields),u=r.prepareQuery(i.sqlToQuery(this.getSQL()),o,e,!0);return u.joinsNotNullableMap=a,u.setToken(s)})}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken))};Y_(Kc,[Ge]);function Ui(t,e){return(r,n,...i)=>{let a=[n,...i].map(s=>({type:t,isAll:e,rightSelect:s}));for(let s of a)if(!ks(r.getSelectedFields(),s.rightSelect.getSelectedFields()))throw new Error(\"Set operator error (union / intersect / except): selected fields are not the same or are in a different order\");return r.addSetOperators(a)}}var Tj=()=>({union:Aj,unionAll:Pj,intersect:Oj,intersectAll:Ij,except:Nj,exceptAll:qj}),Aj=Ui(\"union\",!1),Pj=Ui(\"union\",!0),Oj=Ui(\"intersect\",!1),Ij=Ui(\"intersect\",!0),Nj=Ui(\"except\",!1),qj=Ui(\"except\",!0);var Qi=class{static[g]=\"PgQueryBuilder\";dialect;dialectConfig;constructor(e){this.dialect=b(e,Ur)?e:void 0,this.dialectConfig=b(e,Ur)?void 0:e}$with=(e,r)=>{let n=this;return{as:a=>(typeof a==\"function\"&&(a=a(n)),new Proxy(new Bi(a.getSQL(),r??(\"getSelectedFields\"in a?a.getSelectedFields()??{}:{}),e,!0),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})))}};with(...e){let r=this;function n(s){return new Ve({fields:s??void 0,session:void 0,dialect:r.getDialect(),withList:e})}function i(s){return new Ve({fields:s??void 0,session:void 0,dialect:r.getDialect(),distinct:!0})}function a(s,o){return new Ve({fields:o??void 0,session:void 0,dialect:r.getDialect(),distinct:{on:s}})}return{select:n,selectDistinct:i,selectDistinctOn:a}}select(e){return new Ve({fields:e??void 0,session:void 0,dialect:this.getDialect()})}selectDistinct(e){return new Ve({fields:e??void 0,session:void 0,dialect:this.getDialect(),distinct:!0})}selectDistinctOn(e,r){return new Ve({fields:r??void 0,session:void 0,dialect:this.getDialect(),distinct:{on:e}})}getDialect(){return this.dialect||(this.dialect=new Ur(this.dialectConfig)),this.dialect}};var zs=class{constructor(e,r,n,i,a){this.table=e,this.session=r,this.dialect=n,this.withList=i,this.overridingSystemValue_=a}static[g]=\"PgInsertBuilder\";authToken;setToken(e){return this.authToken=e,this}overridingSystemValue(){return this.overridingSystemValue_=!0,this}values(e){if(e=Array.isArray(e)?e:[e],e.length===0)throw new Error(\"values() must be called with at least one value\");let r=e.map(n=>{let i={},a=this.table[P.Symbol.Columns];for(let s of Object.keys(n)){let o=n[s];i[s]=b(o,N)?o:new lt(o,a[s])}return i});return new Zc(this.table,r,this.session,this.dialect,this.withList,!1,this.overridingSystemValue_).setToken(this.authToken)}select(e){let r=typeof e==\"function\"?e(new Qi):e;if(!b(r,N)&&!ks(this.table[Lc],r._.selectedFields))throw new Error(\"Insert select error: selected fields are not the same or are in a different order compared to the table definition\");return new Zc(this.table,r,this.session,this.dialect,this.withList,!0)}},Zc=class extends Ge{constructor(e,r,n,i,a,s,o){super(),this.session=n,this.dialect=i,this.config={table:e,values:r,withList:a,select:s,overridingSystemValue_:o}}static[g]=\"PgInsert\";config;returning(e=this.config.table[P.Symbol.Columns]){return this.config.returningFields=e,this.config.returning=Ot(e),this}onConflictDoNothing(e={}){if(e.target===void 0)this.config.onConflict=y`do nothing`;else{let r=\"\";r=Array.isArray(e.target)?e.target.map(i=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(i))).join(\",\"):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target));let n=e.where?y` where ${e.where}`:void 0;this.config.onConflict=y`(${y.raw(r)})${n} do nothing`}return this}onConflictDoUpdate(e){if(e.where&&(e.targetWhere||e.setWhere))throw new Error('You cannot use both \"where\" and \"targetWhere\"/\"setWhere\" at the same time - \"where\" is deprecated, use \"targetWhere\" or \"setWhere\" instead.');let r=e.where?y` where ${e.where}`:void 0,n=e.targetWhere?y` where ${e.targetWhere}`:void 0,i=e.setWhere?y` where ${e.setWhere}`:void 0,a=this.dialect.buildUpdateSet(this.config.table,Bc(this.config.table,e.set)),s=\"\";return s=Array.isArray(e.target)?e.target.map(o=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(o))).join(\",\"):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target)),this.config.onConflict=y`(${y.raw(s)})${n} do update set ${a}${r}${i}`,this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken));getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new _e({alias:ut(this.config.table),sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})):void 0}$dynamic(){return this}};var Jc=class extends Ge{constructor(e,r,n){super(),this.session=r,this.dialect=n,this.config={view:e}}static[g]=\"PgRefreshMaterializedView\";config;concurrently(){if(this.config.withNoData!==void 0)throw new Error(\"Cannot use concurrently and withNoData together\");return this.config.concurrently=!0,this}withNoData(){if(this.config.concurrently!==void 0)throw new Error(\"Cannot use concurrently and withNoData together\");return this.config.withNoData=!0,this}getSQL(){return this.dialect.buildRefreshMaterializedViewQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),void 0,e,!0))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(e,this.authToken))};var $s=class{constructor(e,r,n,i){this.table=e,this.session=r,this.dialect=n,this.withList=i}static[g]=\"PgUpdateBuilder\";authToken;setToken(e){return this.authToken=e,this}set(e){return new sm(this.table,Bc(this.table,e),this.session,this.dialect,this.withList).setToken(this.authToken)}},sm=class extends Ge{constructor(e,r,n,i,a){super(),this.session=n,this.dialect=i,this.config={set:r,table:e,withList:a,joins:[]},this.tableName=yr(e),this.joinsNotNullableMap=typeof this.tableName==\"string\"?{[this.tableName]:!0}:{}}static[g]=\"PgUpdate\";config;tableName;joinsNotNullableMap;from(e){let r=e,n=yr(r);return typeof n==\"string\"&&(this.joinsNotNullableMap[n]=!0),this.config.from=r,this}getTableLikeFields(e){return b(e,Be)?e[P.Symbol.Columns]:b(e,Te)?e._.selectedFields:e[se].selectedFields}createJoin(e){return(r,n)=>{let i=yr(r);if(typeof i==\"string\"&&this.config.joins.some(a=>a.alias===i))throw new Error(`Alias \"${i}\" is already used in this query`);if(typeof n==\"function\"){let a=this.config.from&&!b(this.config.from,N)?this.getTableLikeFields(this.config.from):void 0;n=n(new Proxy(this.config.table[P.Symbol.Columns],new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})),a&&new Proxy(a,new _e({sqlAliasedBehavior:\"sql\",sqlBehavior:\"sql\"})))}if(this.config.joins.push({on:n,table:r,joinType:e,alias:i}),typeof i==\"string\")switch(e){case\"left\":{this.joinsNotNullableMap[i]=!1;break}case\"right\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([a])=>[a,!1])),this.joinsNotNullableMap[i]=!0;break}case\"inner\":{this.joinsNotNullableMap[i]=!0;break}case\"full\":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([a])=>[a,!1])),this.joinsNotNullableMap[i]=!1;break}}return this}}leftJoin=this.createJoin(\"left\");rightJoin=this.createJoin(\"right\");innerJoin=this.createJoin(\"inner\");fullJoin=this.createJoin(\"full\");where(e){return this.config.where=e,this}returning(e){if(!e&&(e=Object.assign({},this.config.table[P.Symbol.Columns]),this.config.from)){let r=yr(this.config.from);if(typeof r==\"string\"&&this.config.from&&!b(this.config.from,N)){let n=this.getTableLikeFields(this.config.from);e[r]=n}for(let n of this.config.joins){let i=yr(n.table);if(typeof i==\"string\"&&!b(n.table,N)){let a=this.getTableLikeFields(n.table);e[i]=a}}}return this.config.returningFields=e,this.config.returning=Ot(e),this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){let r=this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0);return r.joinsNotNullableMap=this.joinsNotNullableMap,r}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>this._prepare().execute(e,this.authToken);getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new _e({alias:ut(this.config.table),sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})):void 0}$dynamic(){return this}};var Xc=class t extends N{constructor(e){super(t.buildEmbeddedCount(e.source,e.filters).queryChunks),this.params=e,this.mapWith(Number),this.session=e.session,this.sql=t.buildCount(e.source,e.filters)}sql;token;static[g]=\"PgCountBuilder\";[Symbol.toStringTag]=\"PgCountBuilder\";session;static buildEmbeddedCount(e,r){return y`(select count(*) from ${e}${y.raw(\" where \").if(r)}${r})`}static buildCount(e,r){return y`select count(*) as count from ${e}${y.raw(\" where \").if(r)}${r};`}setToken(e){return this.token=e,this}then(e,r){return Promise.resolve(this.session.count(this.sql,this.token)).then(e,r)}catch(e){return this.then(void 0,e)}finally(e){return this.then(r=>(e?.(),r),r=>{throw e?.(),r})}};var Yc=class{constructor(e,r,n,i,a,s,o){this.fullSchema=e,this.schema=r,this.tableNamesMap=n,this.table=i,this.tableConfig=a,this.dialect=s,this.session=o}static[g]=\"PgRelationalQueryBuilder\";findMany(e){return new eu(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},\"many\")}findFirst(e){return new eu(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},\"first\")}},eu=class extends Ge{constructor(e,r,n,i,a,s,o,u,c){super(),this.fullSchema=e,this.schema=r,this.tableNamesMap=n,this.table=i,this.tableConfig=a,this.dialect=s,this.session=o,this.config=u,this.mode=c}static[g]=\"PgRelationalQuery\";_prepare(e){return ae.startActiveSpan(\"drizzle.prepareQuery\",()=>{let{query:r,builtQuery:n}=this._toSQL();return this.session.prepareQuery(n,void 0,e,!0,(i,a)=>{let s=i.map(o=>Vc(this.schema,this.tableConfig,o,r.selection,a));return this.mode===\"first\"?s[0]:s})})}prepare(e){return this._prepare(e)}_getQuery(){return this.dialect.buildRelationalQueryWithoutPK({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName})}getSQL(){return this._getQuery().sql}_toSQL(){let e=this._getQuery(),r=this.dialect.sqlToQuery(e.sql);return{query:e,builtQuery:r}}toSQL(){return this._toSQL().builtQuery}authToken;setToken(e){return this.authToken=e,this}execute(){return ae.startActiveSpan(\"drizzle.operation\",()=>this._prepare().execute(void 0,this.authToken))}};var tu=class extends Ge{constructor(e,r,n,i){super(),this.execute=e,this.sql=r,this.query=n,this.mapBatchResult=i}static[g]=\"PgRaw\";getSQL(){return this.sql}getQuery(){return this.query}mapResult(e,r){return r?this.mapBatchResult(e):e}_prepare(){return this}isResponseInArrayMode(){return!1}};var Gi=class{constructor(e,r,n){if(this.dialect=e,this.session=r,this._=n?{schema:n.schema,fullSchema:n.fullSchema,tableNamesMap:n.tableNamesMap,session:r}:{schema:void 0,fullSchema:{},tableNamesMap:{},session:r},this.query={},this._.schema)for(let[i,a]of Object.entries(this._.schema))this.query[i]=new Yc(n.fullSchema,this._.schema,this._.tableNamesMap,n.fullSchema[i],a,e,r)}static[g]=\"PgDatabase\";query;$with=(e,r)=>{let n=this;return{as:a=>(typeof a==\"function\"&&(a=a(new Qi(n.dialect))),new Proxy(new Bi(a.getSQL(),r??(\"getSelectedFields\"in a?a.getSelectedFields()??{}:{}),e,!0),new _e({alias:e,sqlAliasedBehavior:\"alias\",sqlBehavior:\"error\"})))}};$count(e,r){return new Xc({source:e,filters:r,session:this.session})}with(...e){let r=this;function n(c){return new Ve({fields:c??void 0,session:r.session,dialect:r.dialect,withList:e})}function i(c){return new Ve({fields:c??void 0,session:r.session,dialect:r.dialect,withList:e,distinct:!0})}function a(c,l){return new Ve({fields:l??void 0,session:r.session,dialect:r.dialect,withList:e,distinct:{on:c}})}function s(c){return new $s(c,r.session,r.dialect,e)}function o(c){return new zs(c,r.session,r.dialect,e)}function u(c){return new Ds(c,r.session,r.dialect,e)}return{select:n,selectDistinct:i,selectDistinctOn:a,update:s,insert:o,delete:u}}select(e){return new Ve({fields:e??void 0,session:this.session,dialect:this.dialect})}selectDistinct(e){return new Ve({fields:e??void 0,session:this.session,dialect:this.dialect,distinct:!0})}selectDistinctOn(e,r){return new Ve({fields:r??void 0,session:this.session,dialect:this.dialect,distinct:{on:e}})}update(e){return new $s(e,this.session,this.dialect)}insert(e){return new zs(e,this.session,this.dialect)}delete(e){return new Ds(e,this.session,this.dialect)}refreshMaterializedView(e){return new Jc(e,this.session,this.dialect)}authToken;execute(e){let r=typeof e==\"string\"?y.raw(e):e.getSQL(),n=this.dialect.sqlToQuery(r),i=this.session.prepareQuery(n,void 0,void 0,!1);return new tu(()=>i.execute(void 0,this.authToken),r,n,a=>i.mapResult(a,!0))}transaction(e,r){return this.session.transaction(e,r)}};var ru=class{constructor(e){this.query=e}authToken;getQuery(){return this.query}mapResult(e,r){return e}setToken(e){return this.authToken=e,this}static[g]=\"PgPreparedQuery\";joinsNotNullableMap},nu=class{constructor(e){this.dialect=e}static[g]=\"PgSession\";execute(e,r){return ae.startActiveSpan(\"drizzle.operation\",()=>ae.startActiveSpan(\"drizzle.prepareQuery\",()=>this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1)).setToken(r).execute(void 0,r))}all(e){return this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1).all()}async count(e,r){let n=await this.execute(e,r);return Number(n[0].count)}},iu=class extends Gi{constructor(e,r,n,i=0){super(e,r,n),this.schema=n,this.nestedIndex=i}static[g]=\"PgTransaction\";rollback(){throw new $c}getTransactionConfigSQL(e){let r=[];return e.isolationLevel&&r.push(`isolation level ${e.isolationLevel}`),e.accessMode&&r.push(e.accessMode),typeof e.deferrable==\"boolean\"&&r.push(e.deferrable?\"deferrable\":\"not deferrable\"),y.raw(r.join(\" \"))}setTransaction(e){return this.session.execute(y`set transaction ${this.getTransactionConfigSQL(e)}`)}};var om=class{static[g]=\"ConsoleLogWriter\";write(e){console.log(e)}},au=class{static[g]=\"DefaultLogger\";writer;constructor(e){this.writer=e?.writer??new om}logQuery(e,r){let n=r.map(a=>{try{return JSON.stringify(a)}catch{return String(a)}}),i=n.length?` -- params: [${n.join(\", \")}]`:\"\";this.writer.write(`Query: ${e}${i}`)}},su=class{static[g]=\"NoopLogger\";logQuery(){}};var he={INT8_MIN:-128,INT8_MAX:127,INT8_UNSIGNED_MAX:255,INT16_MIN:-32768,INT16_MAX:32767,INT16_UNSIGNED_MAX:65535,INT24_MIN:-8388608,INT24_MAX:8388607,INT24_UNSIGNED_MAX:16777215,INT32_MIN:-2147483648,INT32_MAX:2147483647,INT32_UNSIGNED_MAX:4294967295,INT48_MIN:-0x800000000000,INT48_MAX:0x7fffffffffff,INT48_UNSIGNED_MAX:0xffffffffffff,INT64_MIN:-9223372036854775808n,INT64_MAX:9223372036854775807n,INT64_UNSIGNED_MAX:18446744073709551615n};function Se(t,e){return e.includes(t.columnType)}function jj(t){return\"enumValues\"in t&&Array.isArray(t.enumValues)&&t.enumValues.length>0}var Rj=k.union([k.string(),k.number(),k.boolean(),k.null()]),Dj=k.union([Rj,k.record(k.any()),k.array(k.any())]),Mj=k.custom(t=>t instanceof Buffer);function iE(t,e){let r=e?.zodInstance??k,n=e?.coerce??{},i;return jj(t)&&(i=t.enumValues.length?r.enum(t.enumValues):r.string()),i||(Se(t,[\"PgGeometry\",\"PgPointTuple\"])?i=r.tuple([r.number(),r.number()]):Se(t,[\"PgGeometryObject\",\"PgPointObject\"])?i=r.object({x:r.number(),y:r.number()}):Se(t,[\"PgHalfVector\",\"PgVector\"])?(i=r.array(r.number()),i=t.dimensions?i.length(t.dimensions):i):Se(t,[\"PgLine\"])?i=r.tuple([r.number(),r.number(),r.number()]):Se(t,[\"PgLineABC\"])?i=r.object({a:r.number(),b:r.number(),c:r.number()}):Se(t,[\"PgArray\"])?(i=r.array(iE(t.baseColumn,r)),i=t.size?i.length(t.size):i):t.dataType===\"array\"?i=r.array(r.any()):t.dataType===\"number\"?i=Lj(t,r,n):t.dataType===\"bigint\"?i=Bj(t,r,n):t.dataType===\"boolean\"?i=n===!0||n.boolean?r.coerce.boolean():r.boolean():t.dataType===\"date\"?i=n===!0||n.date?r.coerce.date():r.date():t.dataType===\"string\"?i=Fj(t,r,n):t.dataType===\"json\"?i=Dj:t.dataType===\"custom\"?i=r.any():t.dataType===\"buffer\"&&(i=Mj)),i||(i=r.any()),i}function Lj(t,e,r){let n=t.getSQLType().includes(\"unsigned\"),i,a,s=!1;Se(t,[\"MySqlTinyInt\",\"SingleStoreTinyInt\"])?(i=n?0:he.INT8_MIN,a=n?he.INT8_UNSIGNED_MAX:he.INT8_MAX,s=!0):Se(t,[\"PgSmallInt\",\"PgSmallSerial\",\"MySqlSmallInt\",\"SingleStoreSmallInt\"])?(i=n?0:he.INT16_MIN,a=n?he.INT16_UNSIGNED_MAX:he.INT16_MAX,s=!0):Se(t,[\"PgReal\",\"MySqlFloat\",\"MySqlMediumInt\",\"SingleStoreMediumInt\",\"SingleStoreFloat\"])?(i=n?0:he.INT24_MIN,a=n?he.INT24_UNSIGNED_MAX:he.INT24_MAX,s=Se(t,[\"MySqlMediumInt\",\"SingleStoreMediumInt\"])):Se(t,[\"PgInteger\",\"PgSerial\",\"MySqlInt\",\"SingleStoreInt\"])?(i=n?0:he.INT32_MIN,a=n?he.INT32_UNSIGNED_MAX:he.INT32_MAX,s=!0):Se(t,[\"PgDoublePrecision\",\"MySqlReal\",\"MySqlDouble\",\"SingleStoreReal\",\"SingleStoreDouble\",\"SQLiteReal\"])?(i=n?0:he.INT48_MIN,a=n?he.INT48_UNSIGNED_MAX:he.INT48_MAX):Se(t,[\"PgBigInt53\",\"PgBigSerial53\",\"MySqlBigInt53\",\"MySqlSerial\",\"SingleStoreBigInt53\",\"SingleStoreSerial\",\"SQLiteInteger\"])?(n=n||Se(t,[\"MySqlSerial\",\"SingleStoreSerial\"]),i=n?0:Number.MIN_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER,s=!0):Se(t,[\"MySqlYear\",\"SingleStoreYear\"])?(i=1901,a=2155,s=!0):(i=Number.MIN_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER);let o=r===!0||r?.number?e.coerce.number():e.number();return o=o.min(i).max(a),s?o.int():o}function Bj(t,e,r){let n=t.getSQLType().includes(\"unsigned\"),i=n?0n:he.INT64_MIN,a=n?he.INT64_UNSIGNED_MAX:he.INT64_MAX;return(r===!0||r?.bigint?e.coerce.bigint():e.bigint()).min(i).max(a)}function Fj(t,e,r){if(Se(t,[\"PgUUID\"]))return e.string().uuid();let n,i,a=!1;Se(t,[\"PgVarchar\",\"SQLiteText\"])?n=t.length:Se(t,[\"MySqlVarChar\",\"SingleStoreVarChar\"])?n=t.length??he.INT16_UNSIGNED_MAX:Se(t,[\"MySqlText\",\"SingleStoreText\"])&&(t.textType===\"longtext\"?n=he.INT32_UNSIGNED_MAX:t.textType===\"mediumtext\"?n=he.INT24_UNSIGNED_MAX:t.textType===\"text\"?n=he.INT16_UNSIGNED_MAX:n=he.INT8_UNSIGNED_MAX),Se(t,[\"PgChar\",\"MySqlChar\",\"SingleStoreChar\"])&&(n=t.length,a=!0),Se(t,[\"PgBinaryVector\"])&&(i=/^[01]+$/,n=t.dimensions);let s=r===!0||r?.string?e.coerce.string():e.string();return s=i?s.regex(i):s,n&&a?s.length(n):n?s.max(n):s}function aE(t){return Dd(t)?Fc(t):eS(t)}function sE(t,e,r,n){let i={};for(let[a,s]of Object.entries(t)){if(!b(s,K)&&!b(s,N)&&!b(s,N.Aliased)&&typeof s==\"object\"){let p=Dd(s)||Z_(s)?aE(s):s;i[a]=sE(p,e[a]??{},r,n);continue}let o=e[a];if(o!==void 0&&typeof o!=\"function\"){i[a]=o;continue}let u=b(s,K)?s:void 0,c=u?iE(u,n):k.any(),l=typeof o==\"function\"?o(c):c;r.never(u)||(i[a]=l,u&&(r.nullable(u)&&(i[a]=i[a].nullable()),r.optional(u)&&(i[a]=i[a].optional())))}return k.object(i)}var zj={never:t=>t?.generated?.type===\"always\"||t?.generatedIdentity?.type===\"always\",optional:t=>!t.notNull||t.notNull&&t.hasDefault,nullable:t=>!t.notNull};var oE=(t,e)=>{let r=aE(t);return sE(r,e??{},zj)};var Ie=Ls(\"users\",{id:Mn(\"id\").primaryKey(),username:br(\"username\").notNull().unique(),email:br(\"email\").notNull().unique(),passwordHash:br(\"password_hash\").notNull(),rating:wt(\"rating\").notNull().default(1e3),gamesPlayed:wt(\"games_played\").notNull().default(0),gamesWon:wt(\"games_won\").notNull().default(0),createdAt:zi(\"created_at\").defaultNow().notNull()}),$j=oE(Ie).omit({id:!0,rating:!0,gamesPlayed:!0,gamesWon:!0,createdAt:!0}),Gr=Ls(\"password_resets\",{id:Mn(\"id\").primaryKey(),userId:wt(\"user_id\").notNull().references(()=>Ie.id),token:br(\"token\").notNull().unique(),expiresAt:zi(\"expires_at\").notNull(),used:Cs(\"used\").notNull().default(!1)}),Ln=Ls(\"match_history\",{id:Mn(\"id\").primaryKey(),gameMode:br(\"game_mode\").notNull(),pointGoal:br(\"point_goal\").notNull(),winningTeamScore:wt(\"winning_team_score\").notNull(),losingTeamScore:wt(\"losing_team_score\").notNull(),completedAt:zi(\"completed_at\").defaultNow().notNull()}),Qr=Ls(\"match_players\",{id:Mn(\"id\").primaryKey(),matchId:wt(\"match_id\").notNull().references(()=>Ln.id),userId:wt(\"user_id\").references(()=>Ie.id),isBot:Cs(\"is_bot\").notNull().default(!1),teamIndex:wt(\"team_index\").notNull(),ratingChange:wt(\"rating_change\").notNull().default(0)}),Uj=Hc(Ie,({many:t})=>({matchPlayers:t(Qr),passwordResets:t(Gr)})),Qj=Hc(Ln,({many:t})=>({players:t(Qr)})),Gj=Hc(Qr,({one:t})=>({match:t(Ln,{fields:[Qr.matchId],references:[Ln.id]}),user:t(Ie,{fields:[Qr.userId],references:[Ie.id]})})),cm=[\"spades\",\"hearts\",\"diamonds\",\"clubs\"],cE=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"],Vj=[...cE,\"LJ\",\"BJ\"],um=[\"ace_high\",\"joker_joker_deuce_deuce\"],lm=[\"100\",\"300\",\"500\"],pm={100:100,300:300,500:500},uE=[\"south\",\"west\",\"north\",\"east\"],dm=k.object({suit:k.enum(cm),value:k.string(),id:k.string()}),lE=k.object({id:k.string(),name:k.string(),isBot:k.boolean(),position:k.enum(uE),hand:k.array(dm),bid:k.number().nullable(),tricks:k.number(),isReady:k.boolean()}),pE=k.object({id:k.string(),players:k.array(k.string()),score:k.number(),bags:k.number(),totalBid:k.number().nullable(),tricksWon:k.number()}),dE=k.object({cards:k.array(k.object({playerId:k.string(),card:dm})),leadSuit:k.enum(cm).nullable(),winnerId:k.string().nullable()}),fE=[\"waiting\",\"bidding\",\"playing\",\"round_end\",\"game_over\"],Hj=k.object({id:k.string(),mode:k.enum(um),pointGoal:k.enum(lm),phase:k.enum(fE),players:k.array(lE),teams:k.array(pE),currentTrick:dE,currentPlayerIndex:k.number(),dealerIndex:k.number(),roundNumber:k.number(),spadesBroken:k.boolean(),winningScore:k.number()}),Wj=k.object({id:k.string(),mode:k.enum(um),pointGoal:k.enum(lm),players:k.array(k.object({id:k.string(),name:k.string(),isBot:k.boolean(),isReady:k.boolean()})),hostId:k.string(),status:k.enum([\"waiting\",\"starting\",\"in_game\"])}),Kj=k.object({id:k.number(),username:k.string(),email:k.string(),rating:k.number(),gamesPlayed:k.number(),gamesWon:k.number()}),mE=[\"join_lobby\",\"leave_lobby\",\"start_game\",\"place_bid\",\"play_card\",\"game_state_update\",\"lobby_update\",\"error\",\"player_joined\",\"player_left\",\"chat_message\"],Zj=k.object({type:k.enum(mE),payload:k.any()});function wr(t,e,r){let n=t.suit===\"spades\",i=t.suit===r;if(e===\"ace_high\"){let s=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);return n?100+s:i?50+s:s}else{if(t.value===\"BJ\")return 200;if(t.value===\"LJ\")return 199;if(n&&t.value===\"2\")return 198;if(t.suit===\"diamonds\"&&t.value===\"2\")return 197;if(n)return 100+[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);let s=[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"].indexOf(t.value);return i?50+s:s}}function ou(t,e){return t.suit===\"spades\"||e===\"joker_joker_deuce_deuce\"&&(t.value===\"LJ\"||t.value===\"BJ\"||t.suit===\"diamonds\"&&t.value===\"2\")}function Jj(t){if(t.value===\"LJ\")return\"Little Joker\";if(t.value===\"BJ\")return\"Big Joker\";let e={J:\"Jack\",Q:\"Queen\",K:\"King\",A:\"Ace\"},r={spades:\"Spades\",hearts:\"Hearts\",diamonds:\"Diamonds\",clubs:\"Clubs\"};return`${e[t.value]||t.value} of ${r[t.suit]}`}var _t=ht(fh(),1),YW=_t.default.Client,eK=_t.default.Pool,tK=_t.default.Connection,rK=_t.default.types,nK=_t.default.Query,iK=_t.default.DatabaseError,aK=_t.default.escapeIdentifier,sK=_t.default.escapeLiteral,oK=_t.default.Result,cK=_t.default.TypeOverrides,uK=_t.default.defaults,Kr=_t.default;var{Pool:r4,types:ar}=Kr,gh=class extends ru{constructor(e,r,n,i,a,s,o,u){super({sql:r,params:n}),this.client=e,this.params=n,this.logger=i,this.fields=a,this._isResponseInArrayMode=o,this.customResultMapper=u,this.rawQueryConfig={name:s,text:r,types:{getTypeParser:(c,l)=>c===ar.builtins.TIMESTAMPTZ?p=>p:c===ar.builtins.TIMESTAMP?p=>p:c===ar.builtins.DATE?p=>p:c===ar.builtins.INTERVAL?p=>p:ar.getTypeParser(c,l)}},this.queryConfig={name:s,text:r,rowMode:\"array\",types:{getTypeParser:(c,l)=>c===ar.builtins.TIMESTAMPTZ?p=>p:c===ar.builtins.TIMESTAMP?p=>p:c===ar.builtins.DATE?p=>p:c===ar.builtins.INTERVAL?p=>p:ar.getTypeParser(c,l)}}}static[g]=\"NodePgPreparedQuery\";rawQueryConfig;queryConfig;async execute(e={}){return ae.startActiveSpan(\"drizzle.execute\",async()=>{let r=Ld(this.params,e);this.logger.logQuery(this.rawQueryConfig.text,r);let{fields:n,rawQueryConfig:i,client:a,queryConfig:s,joinsNotNullableMap:o,customResultMapper:u}=this;if(!n&&!u)return ae.startActiveSpan(\"drizzle.driver.execute\",async l=>(l?.setAttributes({\"drizzle.query.name\":i.name,\"drizzle.query.text\":i.text,\"drizzle.query.params\":JSON.stringify(r)}),a.query(i,r)));let c=await ae.startActiveSpan(\"drizzle.driver.execute\",l=>(l?.setAttributes({\"drizzle.query.name\":s.name,\"drizzle.query.text\":s.text,\"drizzle.query.params\":JSON.stringify(r)}),a.query(s,r)));return ae.startActiveSpan(\"drizzle.mapResponse\",()=>u?u(c.rows):c.rows.map(l=>X_(n,l,o)))})}all(e={}){return ae.startActiveSpan(\"drizzle.execute\",()=>{let r=Ld(this.params,e);return this.logger.logQuery(this.rawQueryConfig.text,r),ae.startActiveSpan(\"drizzle.driver.execute\",n=>(n?.setAttributes({\"drizzle.query.name\":this.rawQueryConfig.name,\"drizzle.query.text\":this.rawQueryConfig.text,\"drizzle.query.params\":JSON.stringify(r)}),this.client.query(this.rawQueryConfig,r).then(i=>i.rows)))})}isResponseInArrayMode(){return this._isResponseInArrayMode}},Su=class t extends nu{constructor(e,r,n,i={}){super(r),this.client=e,this.schema=n,this.options=i,this.logger=i.logger??new su}static[g]=\"NodePgSession\";logger;prepareQuery(e,r,n,i,a){return new gh(this.client,e.sql,e.params,this.logger,r,n,i,a)}async transaction(e,r){let n=this.client instanceof r4?new t(await this.client.connect(),this.dialect,this.schema,this.options):this,i=new yh(this.dialect,n,this.schema);await i.execute(y`begin${r?y` ${i.getTransactionConfigSQL(r)}`:void 0}`);try{let a=await e(i);return await i.execute(y`commit`),a}catch(a){throw await i.execute(y`rollback`),a}finally{this.client instanceof r4&&n.client.release()}}async count(e){let r=await this.execute(e);return Number(r.rows[0].count)}},yh=class t extends iu{static[g]=\"NodePgTransaction\";async transaction(e){let r=`sp${this.nestedIndex+1}`,n=new t(this.dialect,this.session,this.schema,this.nestedIndex+1);await n.execute(y.raw(`savepoint ${r}`));try{let i=await e(n);return await n.execute(y.raw(`release savepoint ${r}`)),i}catch(i){throw await n.execute(y.raw(`rollback to savepoint ${r}`)),i}}};var xh=class{constructor(e,r,n={}){this.client=e,this.dialect=r,this.options=n}static[g]=\"NodePgDriver\";createSession(e){return new Su(this.client,this.dialect,e,{logger:this.options.logger})}},bh=class extends Gi{static[g]=\"NodePgDatabase\"};function Ys(t,e={}){let r=new Ur({casing:e.casing}),n;e.logger===!0?n=new au:e.logger!==!1&&(n=e.logger);let i;if(e.schema){let u=tE(e.schema,nE);i={fullSchema:e.schema,schema:u.tables,tableNamesMap:u.tableNamesMap}}let s=new xh(t,r,{logger:n}).createSession(i),o=new bh(r,s,i);return o.$client=t,o}function Eu(...t){if(typeof t[0]==\"string\"){let e=new Kr.Pool({connectionString:t[0]});return Ys(e,t[1])}if(tS(t[0])){let{connection:e,client:r,...n}=t[0];if(r)return Ys(r,n);let i=typeof e==\"string\"?new Kr.Pool({connectionString:e}):new Kr.Pool(e);return Ys(i,n)}return Ys(t[0],t[1])}(t=>{function e(r){return Ys({},r)}t.mock=e})(Eu||(Eu={}));var{Pool:sL}=Kr;if(!process.env.DATABASE_URL)throw new Error(\"DATABASE_URL must be set. Did you forget to provision a database?\");var oL=new sL({connectionString:process.env.DATABASE_URL}),jt=Eu(oL,{schema:fm});var n4=require(\"crypto\"),wh=class{lobbies;games;constructor(){this.lobbies=new Map,this.games=new Map}async getUser(e){let[r]=await jt.select().from(Ie).where(It(Ie.id,e));return r||void 0}async getUserByEmail(e){let[r]=await jt.select().from(Ie).where(It(Ie.email,e));return r||void 0}async getUserByUsername(e){let[r]=await jt.select().from(Ie).where(It(Ie.username,e));return r||void 0}async createUser(e){let[r]=await jt.insert(Ie).values(e).returning();return r}async updateUserStats(e,r,n){let i=await this.getUser(e);if(!i)return;let[a]=await jt.update(Ie).set({gamesPlayed:i.gamesPlayed+1,gamesWon:i.gamesWon+(r?1:0),rating:Math.max(0,i.rating+n)}).where(It(Ie.id,e)).returning();return a}async updateUserPassword(e,r){let[n]=await jt.update(Ie).set({passwordHash:r}).where(It(Ie.id,e)).returning();return n||void 0}async createPasswordReset(e,r,n){await jt.insert(Gr).values({userId:e,token:r,expiresAt:n})}async getPasswordReset(e){let[r]=await jt.select().from(Gr).where(It(Gr.token,e));return r||void 0}async markPasswordResetUsed(e){await jt.update(Gr).set({used:!0}).where(It(Gr.token,e))}async getLobby(e){return this.lobbies.get(e)}async createLobby(e){let r=(0,n4.randomUUID)(),n={...e,id:r};return this.lobbies.set(r,n),n}async updateLobby(e,r){let n=this.lobbies.get(e);if(!n)return;let i={...n,...r};return this.lobbies.set(e,i),i}async deleteLobby(e){return this.lobbies.delete(e)}async getActiveLobbies(){return Array.from(this.lobbies.values()).filter(e=>e.status===\"waiting\")}async getGame(e){return this.games.get(e)}async saveGame(e){return this.games.set(e.id,e),e}async deleteGame(e){return this.games.delete(e)}async recordMatch(e,r,n,i,a){let[s]=await jt.insert(Ln).values({gameMode:e,pointGoal:r,winningTeamScore:n,losingTeamScore:i}).returning();for(let o of a)await jt.insert(Qr).values({matchId:s.id,userId:o.userId,isBot:o.isBot,teamIndex:o.teamIndex,ratingChange:o.ratingChange})}},Ee=new wh;var jB=ht(o4(),1),RB=ht(Fh(),1),DB=ht(Uh(),1),Xh=ht(Zh(),1),Yh=ht(Tk(),1);var Ik=require(\"crypto\"),MB=[\"south\",\"west\",\"north\",\"east\"];function ev(){let t=[\"spades\",\"hearts\",\"diamonds\",\"clubs\"],e=[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"],r=[];for(let n of t)for(let i of e)r.push({suit:n,value:i,id:`${i}-${n}`});return r}function Ak(){let e=ev().filter(r=>!(r.value===\"2\"&&(r.suit===\"hearts\"||r.suit===\"clubs\")));return e.push({suit:\"spades\",value:\"LJ\",id:\"LJ-joker\"},{suit:\"spades\",value:\"BJ\",id:\"BJ-joker\"}),e}function Pk(t){let e=[...t];for(let r=e.length-1;r>0;r--){let n=Math.floor(Math.random()*(r+1));[e[r],e[n]]=[e[n],e[r]]}return e}function Ok(t,e){let r=[\"spades\",\"hearts\",\"clubs\",\"diamonds\"],n=e===\"ace_high\"?[\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\"]:[\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"J\",\"Q\",\"K\",\"A\",\"2\",\"LJ\",\"BJ\"],i=a=>a.value===\"LJ\"||a.value===\"BJ\";return[...t].sort((a,s)=>{if(i(a)&&!i(s))return-1;if(!i(a)&&i(s))return 1;if(i(a)&&i(s))return a.value===\"BJ\"?-1:1;let o=r.indexOf(a.suit)-r.indexOf(s.suit);return o!==0?o:n.indexOf(s.value)-n.indexOf(a.value)})}var Mt=class{static createGame(e,r,n){if(e.length!==4)throw new Error(\"Spades requires exactly 4 players\");let i=r===\"ace_high\"?ev():Ak(),a=Pk(i),s=e.map((u,c)=>({id:u.id,name:u.name,isBot:u.isBot,position:MB[c],hand:Ok(a.slice(c*13,(c+1)*13),r),bid:null,tricks:0,isReady:!0})),o=[{id:\"team-1\",players:[s[0].id,s[2].id],score:0,bags:0,totalBid:null,tricksWon:0},{id:\"team-2\",players:[s[1].id,s[3].id],score:0,bags:0,totalBid:null,tricksWon:0}];return{id:(0,Ik.randomUUID)(),mode:r,pointGoal:n,phase:\"bidding\",players:s,teams:o,currentTrick:{cards:[],leadSuit:null,winnerId:null},currentPlayerIndex:0,dealerIndex:0,roundNumber:1,spadesBroken:!1,winningScore:pm[n]}}static getPlayableCards(e,r){let n=e.players[r];if(!n)return[];let i=n.hand,a=e.currentTrick.leadSuit;if(!a){if(!e.spadesBroken){let o=i.filter(u=>!ou(u,e.mode));if(o.length>0)return o}return i}let s=i.filter(o=>o.suit===a);return s.length>0?s:i}static placeBid(e,r,n){let i=e.players.findIndex(c=>c.id===r);if(i===-1)throw new Error(\"Player not found\");if(e.phase!==\"bidding\")throw new Error(\"Not in bidding phase\");if(i!==e.currentPlayerIndex)throw new Error(\"Not your turn\");let a=e.players.map((c,l)=>l===i?{...c,bid:n}:c),s=a.every(c=>c.bid!==null),o=e.teams,u=e.phase;return s&&(o=e.teams.map(c=>{let l=c.players.reduce((p,d)=>{let f=a.find(h=>h.id===d);return p+(f?.bid||0)},0);return{...c,totalBid:l}}),u=\"playing\"),{...e,players:a,teams:o,phase:u,currentPlayerIndex:s?0:(e.currentPlayerIndex+1)%4}}static playCard(e,r,n){let i=e.players.findIndex(d=>d.id===r);if(i===-1)throw new Error(\"Player not found\");if(e.phase!==\"playing\")throw new Error(\"Not in playing phase\");if(i!==e.currentPlayerIndex)throw new Error(\"Not your turn\");let s=e.players[i].hand.find(d=>d.id===n);if(!s)throw new Error(\"Card not in hand\");if(!this.getPlayableCards(e,i).some(d=>d.id===n))throw new Error(\"Card is not playable\");let u=e.players.map((d,f)=>f===i?{...d,hand:d.hand.filter(h=>h.id!==n)}:d),c=[...e.currentTrick.cards,{playerId:r,card:s}],l=e.currentTrick.leadSuit||s.suit,p=e.spadesBroken;return ou(s,e.mode)&&(p=!0),c.length===4?this.completeTrick(e,u,c,l,p):{...e,players:u,currentTrick:{cards:c,leadSuit:l,winnerId:null},currentPlayerIndex:(e.currentPlayerIndex+1)%4,spadesBroken:p}}static completeTrick(e,r,n,i,a){let s=0,o=0;n.forEach(({card:f},h)=>{let m=wr(f,e.mode,i);m>o&&(o=m,s=h)});let u=n[s].playerId,c=r.findIndex(f=>f.id===u),l=r.map(f=>f.id===u?{...f,tricks:f.tricks+1}:f),p=e.teams.map(f=>f.players.includes(u)?{...f,tricksWon:f.tricksWon+1}:f);return l.reduce((f,h)=>f+h.hand.length,0)===0?this.completeRound(e,l,p,u,c):{...e,players:l,teams:p,currentTrick:{cards:n,leadSuit:i,winnerId:u},currentPlayerIndex:c,spadesBroken:a}}static completeRound(e,r,n,i,a){let s=n.map(p=>{let d=p.totalBid||0,f=p.tricksWon,h=0,m=p.bags,x=p.players.map(E=>r.find(R=>R.id===E)),w=0;x.forEach(E=>{E.bid===0&&(E.tricks===0?w+=100:(w-=100,m+=E.tricks))});let C=x.reduce((E,R)=>E+(R.bid===0?0:R.bid||0),0),_=f-x.reduce((E,R)=>E+(R.bid===0?R.tricks:0),0);if(C>0)if(_>=C){let E=_-C;h=C*10+E,m+=E}else h=-C*10;return m>=10&&(h-=100,m=m%10),h+=w,{...p,score:p.score+h,bags:m,tricksWon:0,totalBid:null}});if(s.findIndex(p=>p.score>=e.winningScore)!==-1)return{...e,players:r.map(p=>({...p,bid:null,tricks:0})),teams:s,currentTrick:{cards:[],leadSuit:null,winnerId:i},phase:\"game_over\",currentPlayerIndex:a};let u=e.mode===\"ace_high\"?ev():Ak(),c=Pk(u),l=r.map((p,d)=>({...p,hand:Ok(c.slice(d*13,(d+1)*13),e.mode),bid:null,tricks:0}));return{...e,players:l,teams:s,currentTrick:{cards:[],leadSuit:null,winnerId:null},phase:\"bidding\",currentPlayerIndex:(e.dealerIndex+1)%4,dealerIndex:(e.dealerIndex+1)%4,roundNumber:e.roundNumber+1,spadesBroken:!1}}static clearTrick(e){return{...e,currentTrick:{cards:[],leadSuit:null,winnerId:null}}}};var uo=class{static calculateBid(e,r){let n=0;e.forEach(a=>{a.value===\"A\"&&(n+=1),a.value===\"K\"&&(n+=.5),a.value===\"Q\"&&(n+=.25),a.suit===\"spades\"&&(n+=.5),a.value===\"BJ\"&&(n+=2),a.value===\"LJ\"&&(n+=1.5),a.suit===\"spades\"&&a.value===\"2\"&&r===\"joker_joker_deuce_deuce\"&&(n+=1.5)});let i=e.filter(a=>a.suit===\"spades\"||a.value===\"LJ\"||a.value===\"BJ\").length;return n+=Math.max(0,i-2)*.5,n+=Math.random()-.5,Math.max(1,Math.min(6,Math.round(n)))}static selectCard(e,r){let i=e.players[r].hand,a=Mt.getPlayableCards(e,r);if(a.length===1)return a[0];let s=e.currentTrick,o=s.leadSuit,u=!o,c=e.players[(r+2)%4],l=s.cards.find(m=>m.playerId===c.id),p=[...a].sort((m,x)=>wr(m,e.mode,o)-wr(x,e.mode,o));if(u){let m={spades:0,hearts:0,diamonds:0,clubs:0};i.forEach(w=>{w.suit in m&&m[w.suit]++});let x=[\"hearts\",\"diamonds\",\"clubs\"].filter(w=>m[w]>0);if(x.length>0){let w=x.reduce((_,E)=>m[_]>=m[E]?_:E),C=a.filter(_=>_.suit===w);if(C.length>0){let _=C.filter(E=>[\"A\",\"K\",\"Q\"].includes(E.value));return _.length>0?_[0]:C[Math.floor(C.length/2)]}}return p[Math.floor(p.length/2)]}let d=s.cards.reduce((m,{card:x})=>Math.max(m,wr(x,e.mode,o)),0),f=!1;l&&(f=wr(l.card,e.mode,o)>=d);let h=p.filter(m=>wr(m,e.mode,o)>d);return f&&s.cards.length===3?p[0]:h.length>0?h[0]:p[0]}static shouldBreakSpades(e,r){return e.filter(i=>i.suit===\"spades\"||i.value===\"LJ\"||i.value===\"BJ\").length>=5}};var Lu=class{wss;clients=new Map;gameRooms=new Map;constructor(e){this.wss=new Yh.default({server:e,path:\"/ws\"}),this.setupConnectionHandler()}setupConnectionHandler(){this.wss.on(\"connection\",e=>{let r=`player-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,n={ws:e,playerId:r,gameId:null,lobbyId:null};this.clients.set(e,n),this.sendMessage(e,{type:\"player_joined\",payload:{playerId:r}}),e.on(\"message\",i=>{try{let a=JSON.parse(i.toString());this.handleMessage(e,a)}catch{this.sendError(e,\"Invalid message format\")}}),e.on(\"close\",()=>{this.handleDisconnect(e)}),e.on(\"error\",i=>{console.error(\"WebSocket error:\",i)})})}handleMessage(e,r){if(this.clients.get(e))switch(r.type){case\"start_game\":this.handleStartGame(e,r.payload);break;case\"place_bid\":this.handleBid(e,r.payload);break;case\"play_card\":this.handlePlayCard(e,r.payload);break;case\"leave_lobby\":this.handleLeaveLobby(e);break}}handleStartGame(e,r){let n=this.clients.get(e);if(!n)return;let{mode:i,pointGoal:a,players:s}=r;try{let o=s.map((d,f)=>f===0&&!d.isBot?{...d,id:n.playerId}:d),u=Mt.createGame(o,i,a),l=o.filter(d=>!d.isBot&&d.userId).length>=2,p={gameState:u,clients:new Map,botTimer:null,statsSaved:!1,isRanked:l};p.clients.set(n.playerId,n),n.gameId=u.id,this.gameRooms.set(u.id,p),this.broadcastGameState(u.id),this.scheduleBotMove(u.id)}catch(o){this.sendError(e,o.message)}}handleBid(e,r){let n=this.clients.get(e);if(!n||!n.gameId)return;let i=this.gameRooms.get(n.gameId);if(i)try{i.gameState=Mt.placeBid(i.gameState,n.playerId,r.bid),this.broadcastGameState(n.gameId),this.scheduleBotMove(n.gameId)}catch(a){this.sendError(e,a.message)}}handlePlayCard(e,r){let n=this.clients.get(e);if(!n||!n.gameId)return;let i=this.gameRooms.get(n.gameId);if(i)try{i.gameState=Mt.playCard(i.gameState,n.playerId,r.cardId),this.broadcastGameState(n.gameId),i.gameState.currentTrick.cards.length===4?setTimeout(()=>{let a=this.gameRooms.get(n.gameId);a&&a.gameState.currentTrick.cards.length===4&&(a.gameState=Mt.clearTrick(a.gameState),this.broadcastGameState(n.gameId),this.scheduleBotMove(n.gameId))},1500):this.scheduleBotMove(n.gameId)}catch(a){this.sendError(e,a.message)}}handleLeaveLobby(e){let r=this.clients.get(e);if(r&&r.gameId){let n=this.gameRooms.get(r.gameId);n&&(n.clients.delete(r.playerId),n.clients.size===0&&(n.botTimer&&clearTimeout(n.botTimer),this.gameRooms.delete(r.gameId))),r.gameId=null}}handleDisconnect(e){this.clients.get(e)&&(this.handleLeaveLobby(e),this.clients.delete(e))}scheduleBotMove(e){let r=this.gameRooms.get(e);if(!r)return;let{gameState:n}=r,i=n.players[n.currentPlayerIndex];if(!i||!i.isBot||n.phase!==\"bidding\"&&n.phase!==\"playing\")return;r.botTimer&&clearTimeout(r.botTimer);let a=800+Math.random()*700;r.botTimer=setTimeout(()=>{let s=this.gameRooms.get(e);if(!s)return;let{gameState:o}=s,u=o.players[o.currentPlayerIndex];if(!(!u||!u.isBot))try{if(o.phase===\"bidding\"){let c=uo.calculateBid(u.hand,o.mode);s.gameState=Mt.placeBid(o,u.id,c)}else if(o.phase===\"playing\"){let c=uo.selectCard(o,o.currentPlayerIndex);s.gameState=Mt.playCard(o,u.id,c.id)}this.broadcastGameState(e),s.gameState.currentTrick.cards.length===4?setTimeout(()=>{let c=this.gameRooms.get(e);c&&c.gameState.currentTrick.cards.length===4&&(c.gameState=Mt.clearTrick(c.gameState),this.broadcastGameState(e),this.scheduleBotMove(e))},1500):this.scheduleBotMove(e)}catch(c){console.error(\"Bot move error:\",c)}},a)}broadcastGameState(e){let r=this.gameRooms.get(e);r&&(r.clients.forEach(n=>{let i=this.sanitizeGameState(r.gameState,n.playerId);this.sendMessage(n.ws,{type:\"game_state_update\",payload:i})}),r.gameState.phase===\"game_over\"&&!r.statsSaved&&r.isRanked&&(r.statsSaved=!0,this.saveGameStats(r.gameState)))}async saveGameStats(e){try{let r=e.teams.findIndex(s=>s.score>=e.winningScore);if(r===-1)return;let n=e.teams[r],i=e.teams[r===0?1:0],a=[];for(let s of e.players){let o=n.players.includes(s.id),u=n.players.includes(s.id)?r:r===0?1:0,c=o?25:-20;a.push({userId:null,isBot:s.isBot,teamIndex:u,ratingChange:s.isBot?0:c})}await Ee.recordMatch(e.mode,e.pointGoal,n.score,i.score,a),console.log(`Game ${e.id} stats saved - Winner: Team ${r+1}`)}catch(r){console.error(\"Failed to save game stats:\",r)}}sanitizeGameState(e,r){let n=e.players.map(i=>i.id===r?i:{...i,hand:i.hand.map(()=>({suit:\"spades\",value:\"?\",id:\"hidden\"}))});return{...e,players:n}}sendMessage(e,r){e.readyState===Xh.default.OPEN&&e.send(JSON.stringify(r))}sendError(e,r){this.sendMessage(e,{type:\"error\",payload:{message:r}})}};var tv=class{queue=new Map;matchingInterval=null;onMatchFound=null;start(e){this.onMatchFound=e,this.matchingInterval=setInterval(()=>this.tryMatch(),5e3)}stop(){this.matchingInterval&&(clearInterval(this.matchingInterval),this.matchingInterval=null)}addToQueue(e,r,n){let i={id:e.id,username:e.username,rating:e.rating,queuedAt:Date.now(),gameMode:r,pointGoal:n};this.queue.set(e.id,i)}removeFromQueue(e){this.queue.delete(e)}getQueueSize(){return this.queue.size}tryMatch(){let e=Array.from(this.queue.values()),r=new Map;for(let n of e){let i=`${n.gameMode}-${n.pointGoal}`;r.has(i)||r.set(i,[]),r.get(i).push(n)}for(let[,n]of Array.from(r.entries()))if(n.length>=4){let i=this.selectBestMatch(n);if(i&&this.onMatchFound){for(let a of i.players)this.queue.delete(a.id);this.onMatchFound(i)}}}selectBestMatch(e){if(e.length<4)return null;e.sort((a,s)=>a.rating-s.rating);let r=e.filter(a=>Date.now()-a.queuedAt>6e4),n;if(r.length>=4)n=r.slice(0,4);else{let a=this.groupByRatingTier(e),s=null;for(let o of a)o.length>=4&&(!s||o.length>s.length)&&(s=o);s?n=s.slice(0,4):n=e.slice(0,4)}let i=this.balanceTeams(n);return{players:n,teams:i,gameMode:n[0].gameMode,pointGoal:n[0].pointGoal}}groupByRatingTier(e){let r=[];for(let a of e){let s=Math.floor(a.rating/300);for(;r.length<=s;)r.push([]);r[s].push(a)}let i=[];for(let a=0;a<r.length;a++){let s=[...r[a]];a>0&&s.push(...r[a-1]),a<r.length-1&&s.push(...r[a+1]),s.length>=4&&i.push(s)}return i}balanceTeams(e){let r=[...e].sort((a,s)=>s.rating-a.rating),n=[r[0],r[3]],i=[r[1],r[2]];return[n,i]}fillWithBots(e){let r=[\"SpadeMaster\",\"TrickTaker\",\"CardShark\",\"AceHunter\"],n=new Set(e.map(o=>o.username)),i=e.length>0?Math.round(e.reduce((o,u)=>o+u.rating,0)/e.length):1e3,a=[...e],s=0;for(;a.length<4;){let o=r[s%r.length];for(;n.has(o);)s++,o=`Bot${s}`;n.add(o),a.push({id:-1*(s+1),username:o,rating:i+Math.floor(Math.random()*200)-100,queuedAt:Date.now(),gameMode:e[0]?.gameMode||\"ace_high\",pointGoal:e[0]?.pointGoal||\"300\"}),s++}return a}},lo=new tv;var LB={from:process.env.EMAIL_FROM||\"noreply@housespades.com\",apiKey:process.env.EMAIL_API_KEY,domain:process.env.EMAIL_DOMAIN};async function BB(t){let{to:e,subject:r,text:n,html:i}=t;if(!LB.apiKey)return console.log(\"=== Email would be sent (DEV MODE) ===\"),console.log(`To: ${e}`),console.log(`Subject: ${r}`),console.log(`Body: ${n}`),console.log(\"======================================\"),console.log(\"Configure EMAIL_API_KEY to enable real email sending\"),{success:!0,devMode:!0};try{return console.log(`Email sent to ${e}: ${r}`),{success:!0,devMode:!1}}catch(a){return console.error(\"Failed to send email:\",a),{success:!1,devMode:!1}}}async function Nk(t,e,r){let n=`${r}/reset-password?token=${e}`,i=await BB({to:t,subject:\"Reset Your House Spades Password\",text:`","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:24.401550042Z"}
{"message":"\t\t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:24.401565566Z"}
{"message":"","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:24.413228348Z"}
{"message":"Error: DATABASE_URL must be set. Did you forget to provision a database?","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:24.413237703Z"}
{"message":"    at Object.<anonymous> (/app/dist/index.cjs:100:43241)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:24.413243529Z"}
{"message":"    at Module._compile (node:internal/modules/cjs/loader:1706:14)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:24.413249009Z"}
{"message":"    at Object..js (node:internal/modules/cjs/loader:1839:10)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:24.413255762Z"}
{"message":"    at Module.load (node:internal/modules/cjs/loader:1441:32)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:24.413261950Z"}
{"message":"    at Function._load (node:internal/modules/cjs/loader:1263:12)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:24.413267237Z"}
{"message":"    at TracingChannel.traceSync (node:diagnostics_channel:328:14)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:24.413273417Z"}
{"message":"    at wrapModuleLoad (node:internal/modules/cjs/loader:237:24)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:24.413278628Z"}
{"message":"    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:171:5)","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:24.413284089Z"}
{"message":"    at node:internal/main/run_main_module:36:49","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:24.413291432Z"}
{"message":"","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:24.413298201Z"}
{"message":"Node.js v22.21.1","attributes":{"level":"error"},"timestamp":"2026-01-10T05:00:24.413303604Z"}